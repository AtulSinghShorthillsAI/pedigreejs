{"version":3,"file":"pedigreejs.v3.0.0-rc7.min.js","sources":["../es/pedcache.js","../es/utils.js","../es/zoom.js","../es/pbuttons.js","../es/canrisk_file.js","../es/io.js","../es/twins.js","../es/popup_form.js","../es/widgets.js","../es/labels.js","../es/dragging.js","../es/pedigree.js","../es/extras.js"],"sourcesContent":["/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n//store a history of pedigree\n\nlet max_limit = 25;\nlet dict_cache = {};\n\n// test if browser storage is supported\nfunction has_browser_storage(opts) {\n\ttry {\n\t\tif(opts.store_type === 'array')\n\t\t\treturn false;\n\n\t\tif(opts.store_type !== 'local' && opts.store_type !== 'session' && opts.store_type !== undefined)\n\t\t\treturn false;\n\n\t\tlet mod = 'test';\n\t\tlocalStorage.setItem(mod, mod);\n\t\tlocalStorage.removeItem(mod);\n\t\treturn true;\n\t} catch(e) {\n\t\treturn false;\n\t}\n}\n\nfunction get_prefix(opts) {\n\treturn \"PEDIGREE_\"+opts.btn_target+\"_\";\n}\n\n// use dict_cache to store cache as an array\nfunction get_arr(opts) {\n\treturn dict_cache[get_prefix(opts)];\n}\n\nfunction get_browser_store(opts, item) {\n\tif(opts.store_type === 'local')\n\t\treturn localStorage.getItem(item);\n\telse\n\t\treturn sessionStorage.getItem(item);\n}\n\nfunction set_browser_store(opts, name, item) {\n\tif(opts.store_type === 'local')\n\t\treturn localStorage.setItem(name, item);\n\telse\n\t\treturn sessionStorage.setItem(name, item);\n}\n\n// clear all storage items\nfunction clear_browser_store(opts) {\n\tif(opts.store_type === 'local')\n\t\treturn localStorage.clear();\n\telse\n\t\treturn sessionStorage.clear();\n}\n\n// remove all storage items with keys that have the pedigree history prefix\nexport function clear_pedigree_data(opts) {\n\tlet prefix = get_prefix(opts);\n\tlet store = (opts.store_type === 'local' ? localStorage : sessionStorage);\n\tlet items = [];\n\tfor(let i = 0; i < store.length; i++){\n\t\tif(store.key(i).indexOf(prefix) === 0)\n\t\t\titems.push(store.key(i));\n\t}\n\tfor(let i = 0; i < items.length; i++)\n\t\tstore.removeItem(items[i]);\n}\n\nexport function get_count(opts) {\n\tlet count;\n\tif (has_browser_storage(opts))\n\t\tcount = get_browser_store(opts, get_prefix(opts)+'COUNT');\n\telse\n\t\tcount = dict_cache[get_prefix(opts)+'COUNT'];\n\tif(count !== null && count !== undefined)\n\t\treturn count;\n\treturn 0;\n}\n\nfunction set_count(opts, count) {\n\tif (has_browser_storage(opts))\n\t\tset_browser_store(opts, get_prefix(opts)+'COUNT', count);\n\telse\n\t\tdict_cache[get_prefix(opts)+'COUNT'] = count;\n}\n\nexport function init_cache(opts) {\n\tif(!opts.dataset)\n\t\treturn;\n\tlet count = get_count(opts);\n\tif (has_browser_storage(opts)) {   // local storage\n\t\tset_browser_store(opts, get_prefix(opts)+count, JSON.stringify(opts.dataset));\n\t} else {   // TODO :: array cache\n\t\tconsole.warn('Local storage not found/supported for this browser!', opts.store_type);\n\t\tmax_limit = 500;\n\t\tif(get_arr(opts) === undefined)\n\t\t\tdict_cache[get_prefix(opts)] = [];\n\t\tget_arr(opts).push(JSON.stringify(opts.dataset));\n\t}\n\tif(count < max_limit)\n\t\tcount++;\n\telse\n\t\tcount = 0;\n\tset_count(opts, count);\n}\n\nexport function nstore(opts) {\n\tif(has_browser_storage(opts)) {\n\t\tfor(let i=max_limit; i>0; i--) {\n\t\t\tif(get_browser_store(opts, get_prefix(opts)+(i-1)) !== null)\n\t\t\t\treturn i;\n\t\t}\n\t} else {\n\t\treturn (get_arr(opts) && get_arr(opts).length > 0 ? get_arr(opts).length : -1);\n\t}\n\treturn -1;\n}\n\nexport function current(opts) {\n\tlet current = get_count(opts)-1;\n\tif(current === -1)\n\t\tcurrent = max_limit;\n\tif(has_browser_storage(opts))\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+current));\n\telse if(get_arr(opts))\n\t\treturn JSON.parse(get_arr(opts)[current]);\n}\n\nexport function last(opts) {\n\tif(has_browser_storage(opts)) {\n\t\tfor(let i=max_limit; i>0; i--) {\n\t\t\tlet it = get_browser_store(opts, get_prefix(opts)+(i-1));\n\t\t\tif(it !== null) {\n\t\t\t\tset_count(opts, i);\n\t\t\t\treturn JSON.parse(it);\n\t\t\t}\n\t\t}\n\t} else {\n\t\tlet arr = get_arr(opts);\n\t\tif(arr)\n\t\t\treturn JSON.parse(arr(arr.length-1));\n\t}\n\treturn undefined;\n}\n\nexport function previous(opts, previous) {\n\tif(previous === undefined)\n\t\tprevious = get_count(opts) - 2;\n\n\tif(previous < 0) {\n\t\tlet nst = nstore(opts);\n\t\tif(nst < max_limit)\n\t\t\tprevious = nst - 1;\n\t\telse\n\t\t\tprevious = max_limit - 1;\n\t}\n\tset_count(opts, previous + 1);\n\tif(has_browser_storage(opts))\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+previous));\n\telse\n\t\treturn JSON.parse(get_arr(opts)[previous]);\n}\n\nexport function next(opts, next) {\n\tif(next === undefined)\n\t\tnext = get_count(opts);\n\tif(next >= max_limit)\n\t\tnext = 0;\n\n\tset_count(opts, parseInt(next) + 1);\n\tif(has_browser_storage(opts))\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+next));\n\telse\n\t\treturn JSON.parse(get_arr(opts)[next]);\n}\n\nexport function clear(opts) {\n\tif(has_browser_storage(opts))\n\t\tclear_browser_store(opts);\n\tdict_cache = {};\n}\n\n// zoom - store translation coords\nexport function setposition(opts, x, y, zoom) {\n\tif(has_browser_storage(opts)) {\n\t\tlet store = (opts.store_type === 'local' ? localStorage : sessionStorage);\n\t\tif(x) {\n\t\t\tset_browser_store(opts, get_prefix(opts)+'_X', x);\n\t\t\tset_browser_store(opts, get_prefix(opts)+'_Y', y);\n\t\t} else {\n\t\t\tstore.removeItem(get_prefix(opts)+'_X');\n\t\t\tstore.removeItem(get_prefix(opts)+'_Y');\n\t\t}\n\n\t\tlet zoomName = get_prefix(opts)+'_ZOOM';\n\t\tif(zoom)\n\t\t\tset_browser_store(opts, zoomName, zoom);\n\t\telse\n\t\t\tstore.removeItem(zoomName);\n\t} else {\n\t\t//TODO\n\t}\n}\n\nexport function getposition(opts) {\n\tif(!has_browser_storage(opts) ||\n\t\t(localStorage.getItem(get_prefix(opts)+'_X') === null &&\n\t\t sessionStorage.getItem(get_prefix(opts)+'_X') === null))\n\t\treturn [null, null];\n\tlet pos = [ parseInt(get_browser_store(opts, get_prefix(opts)+'_X')),\n\t\t\t\tparseInt(get_browser_store(opts, get_prefix(opts)+'_Y')) ];\n\tif(get_browser_store(opts, get_prefix(opts)+'_ZOOM') !== null)\n\t\tpos.push(parseFloat(get_browser_store(opts, get_prefix(opts)+'_ZOOM')));\n\treturn pos;\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// Pedigree Tree Utils\nimport * as pedcache from './pedcache.js';\nimport { check_ptr_link_clashes } from './pedigree.js';\n\n\nexport let roots = {};\n\nexport function isIE() {\n\t let ua = navigator.userAgent;\n\t /* MSIE used to detect old browsers and Trident used to newer ones*/\n\t return ua.indexOf(\"MSIE \") > -1 || ua.indexOf(\"Trident/\") > -1;\n}\n\nexport function isEdge() {\n\t return navigator.userAgent.match(/Edge/g);\n}\n\nexport function create_err(err) {\n\tconsole.error(err);\n\treturn new Error(err);\n}\n\n// validate pedigree data\nexport function validate_pedigree(opts){\n\tif(opts.validate) {\n\t\tif (typeof opts.validate == 'function') {\n\t\t\tif(opts.DEBUG)\n\t\t\t\tconsole.log('CALLING CONFIGURED VALIDATION FUNCTION');\n\t\t\treturn opts.validate.call(this, opts);\n\t\t}\n\n\t\t// check consistency of parents sex\n\t\tlet uniquenames = [];\n\t\tlet famids = [];\n\t\tlet display_name;\n\t\tfor(let p=0; p<opts.dataset.length; p++) {\n\t\t\tif(!p.hidden) {\n\t\t\t\tif(opts.dataset[p].mother || opts.dataset[p].father) {\n\t\t\t\t\tdisplay_name = opts.dataset[p].display_name;\n\t\t\t\t\tif(!display_name)\n\t\t\t\t\t\tdisplay_name = 'unnamed';\n\t\t\t\t\tdisplay_name += ' (IndivID: '+opts.dataset[p].name+')';\n\t\t\t\t\tlet mother = opts.dataset[p].mother;\n\t\t\t\t\tlet father = opts.dataset[p].father;\n\t\t\t\t\tif(!mother || !father) {\n\t\t\t\t\t\tthrow create_err('Missing parent for '+display_name);\n\t\t\t\t\t}\n\n\t\t\t\t\tlet midx = getIdxByName(opts.dataset, mother);\n\t\t\t\t\tlet fidx = getIdxByName(opts.dataset, father);\n\t\t\t\t\tif(midx === -1)\n\t\t\t\t\t\tthrow create_err('The mother (IndivID: '+mother+') of family member '+\n\t\t\t\t\t\t\t\t\t\t display_name+' is missing from the pedigree.');\n\t\t\t\t\tif(fidx === -1)\n\t\t\t\t\t\tthrow create_err('The father (IndivID: '+father+') of family member '+\n\t\t\t\t\t\t\t\t\t\t display_name+' is missing from the pedigree.');\n\t\t\t\t\tif(opts.dataset[midx].sex !== \"F\")\n\t\t\t\t\t\tthrow create_err(\"The mother of family member \"+display_name+\n\t\t\t\t\t\t\t\t\" is not specified as female. All mothers in the pedigree must have sex specified as 'F'.\");\n\t\t\t\t\tif(opts.dataset[fidx].sex !== \"M\")\n\t\t\t\t\t\tthrow create_err(\"The father of family member \"+display_name+\n\t\t\t\t\t\t\t\t\" is not specified as male. All fathers in the pedigree must have sex specified as 'M'.\");\n\t\t\t\t}\n\t\t\t}\n\n\n\t\t\tif(!opts.dataset[p].name)\n\t\t\t\tthrow create_err(display_name+' has no IndivID.');\n\t\t\tif($.inArray(opts.dataset[p].name, uniquenames) > -1)\n\t\t\t\tthrow create_err('IndivID for family member '+display_name+' is not unique.');\n\t\t\tuniquenames.push(opts.dataset[p].name);\n\n\t\t\tif($.inArray(opts.dataset[p].famid, famids) === -1 && opts.dataset[p].famid) {\n\t\t\t\tfamids.push(opts.dataset[p].famid);\n\t\t\t}\n\t\t}\n\n\t\tif(famids.length > 1) {\n\t\t\tthrow create_err('More than one family found: '+famids.join(\", \")+'.');\n\t\t}\n\t\t// warn if there is a break in the pedigree\n\t\tlet uc = unconnected(opts.dataset);\n\t\tif(uc.length > 0)\n\t\t\tconsole.warn(\"individuals unconnected to pedigree \", uc);\n\t}\n}\n\nexport function copy_dataset(dataset) {\n\tif(dataset[0].id) { // sort by id\n\t\tdataset.sort(function(a,b){return (!a.id || !b.id ? 0: (a.id > b.id) ? 1 : ((b.id > a.id) ? -1 : 0));});\n\t}\n\n\tlet disallowed = [\"id\", \"parent_node\"];\n\tlet newdataset = [];\n\tfor(let i=0; i<dataset.length; i++){\n\t\tlet obj = {};\n\t\tfor(let key in dataset[i]) {\n\t\t\tif(disallowed.indexOf(key) === -1)\n\t\t\t\tobj[key] = dataset[i][key];\n\t\t}\n\t\tnewdataset.push(obj);\n\t}\n\treturn newdataset;\n}\n\n// check if the object contains a key with a given prefix\nexport function prefixInObj(prefix, obj) {\n\tlet found = false;\n\tif(obj)\n\t\t$.each(obj, function(k, _n){\n\t\t\tif(k.indexOf(prefix+\"_\") === 0 || k === prefix) {\n\t\t\t\tfound = true;\n\t\t\t\treturn found;\n\t\t\t}\n\t\t});\n\treturn found;\n}\n\n/**\n *  Get formatted time or data & time\n */\nexport function getFormattedDate(time){\n\tlet d = new Date();\n\tif(time)\n\t\treturn ('0' + d.getHours()).slice(-2) + \":\" + ('0' + d.getMinutes()).slice(-2) + \":\" + ('0' + d.getSeconds()).slice(-2);\n\telse\n\t\treturn d.getFullYear() + \"-\" + ('0' + (d.getMonth() + 1)).slice(-2) + \"-\" + ('0' + d.getDate()).slice(-2) + \" \" + ('0' + d.getHours()).slice(-2) + \":\" + ('0' + d.getMinutes()).slice(-2) + \":\" + ('0' + d.getSeconds()).slice(-2);\n }\n\nfunction showDialog(title, msg, onConfirm, opts, dataset) {\n\tconst errModalEl = document.getElementById('errModal');\n\tconst modalTitle = errModalEl.querySelector('.modal-title');\n\tconst modalBodyInput = errModalEl.querySelector('.modal-body');\n\tif(onConfirm) {\n\t\t$('#errModal button.hidden').removeClass(\"hidden\");\n\t\t$('#errModal button:contains(\"OK\")').on( \"click\", function() {\n\t\t\tonConfirm(opts, dataset);\n\t\t\t$('#errModal button:contains(\"OK\")').off('click');\n\t\t});\n\t} else {\n\t\tconst cancelBtn = $('#errModal button:contains(\"CANCEL\")');\n\t\tif(!cancelBtn.hasClass(\"hidden\")) cancelBtn.addClass(\"hidden\");\n\t\t$('#errModal button:contains(\"OK\")').off('click');\n\t}\n\n\tmodalTitle.textContent = title;\n\tmodalBodyInput.textContent = msg;\n\t$(\"#errModal\").modal(\"show\");\n}\n\n/**\n * Show message or confirmation dialog.\n * @param title\t - dialog window title\n * @param msg\t   - message to diasplay\n * @param onConfirm - function to call in a confirmation dialog\n * @param opts\t  - pedigreejs options\n * @param dataset\t- pedigree dataset\n */\nexport function messages(title, msg, onConfirm, opts, dataset) {\n\ttry {\n\t\t\n\t\tif(onConfirm) {\n\t\t\t$('<div id=\"msgDialog\">'+msg+'</div>').dialog({\n\t\t\t\t\tmodal: true,\n\t\t\t\t\ttitle: title,\n\t\t\t\t\t\n\t\t\t\t\twidth: 350,\n\t\t\t\t\tbuttons: {\n\t\t\t\t\t\t\"Yes\": function () {\n\t\t\t\t\t\t\t$(this).dialog('close');\n\t\t\t\t\t\t\tonConfirm(opts, dataset);\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"No\": function () {\n\t\t\t\t\t\t\t$(this).dialog('close');\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\topen: function() {\n\t\t\t\t\t\t// Set custom styles for \"Yes\" button\n\t\t\t\t\t\t$(this).parent().find('.ui-dialog-buttonpane button:contains(\"Yes\")').css({\n\t\t\t\t\t\t\t'background': '#ffffff', // Green\n\t\t\t\t\t\t\t'color': '#000000',\n\n\t\t\t\t\t\t});\n\t\n\t\t\t\t\t\t// Set custom styles for \"No\" button\n\t\t\t\t\t\t$(this).parent().find('.ui-dialog-buttonpane button:contains(\"No\")').css({\n\t\t\t\t\t\t\t'background': '#eb6c67', // Red\n\t\t\t\t\t\t\t'color': '#ffffff',\n\t\t\t\t\t\t\t'border': '0.5px solid #ffffff',\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t});\n\t\t} else {\n\t\t\t$('<div id=\"msgDialog\">'+msg+'</div>').dialog({\n\t\t\t\ttitle: title,\n\t\t\t\twidth: 350,\n\t\t\t\tbuttons: [{\n\t\t\t\t\ttext: \"OK\",\n\t\t\t\t\tclick: function() { $( this ).dialog( \"close\" );}\n\t\t\t\t}]\n\t\t\t});\n\t\t}\n\t} catch(err) {\n\t\tshowDialog(title, msg, onConfirm, opts, dataset);\n\t}\n}\n\n/**\n * Validate age and yob is consistent with current year. The sum of age and\n * yob should not be greater than or equal to current year. If alive the\n * absolute difference between the sum of age and year of birth and the\n * current year should be <= 1.\n * @param age\t- age in years.\n * @param yob\t- year of birth.\n * @param status - 0 = alive, 1 = dead.\n * @return true if age and yob are consistent with current year otherwise false.\n */\nexport function validate_age_yob(age, yob, status) {\n\tlet year = new Date().getFullYear();\n\tlet sum = parseInt(age) + parseInt(yob);\n\t// check status is an expected string\n\tif (status !== \"1\" && status !== \"0\")\n\t\treturn false\n\n\tif(status === \"1\") {   // deceased\n\t\treturn year >= sum;\n\t}\n\treturn Math.abs(year - sum) <= 1 && year >= sum;\n}\n\nexport function capitaliseFirstLetter(string) {\n\treturn string.charAt(0).toUpperCase() + string.slice(1);\n}\n\n\nexport function makeid(len) {\n\tlet text = \"\";\n\tlet possible = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\";\n\tfor( let i=0; i < len; i++ )\n\t\ttext += possible.charAt(Math.floor(Math.random() * possible.length));\n\treturn text;\n}\n\nexport function buildTree(opts, person, root, partnerLinks, id) {\n\tif (typeof person.children === typeof undefined)\n\t\tperson.children = getChildren(opts.dataset, person);\n\n\tif (typeof partnerLinks === typeof undefined) {\n\t\tpartnerLinks = [];\n\t\tid = 1;\n\t}\n\n\tlet nodes = flatten(root);\n\t//console.log('NAME='+person.name+' NO. CHILDREN='+person.children.length);\n\tlet partners = [];\n\t$.each(person.children, function(_i, child) {\n\t\t$.each(opts.dataset, function(_j, p) {\n\t\t\tif (((child.name === p.mother) || (child.name === p.father)) && child.id === undefined) {\n\t\t\t\tlet m = getNodeByName(nodes, p.mother);\n\t\t\t\tlet f = getNodeByName(nodes, p.father);\n\t\t\t\tm = (m !== undefined? m : getNodeByName(opts.dataset, p.mother));\n\t\t\t\tf = (f !== undefined? f : getNodeByName(opts.dataset, p.father));\n\t\t\t\tif(!contains_parent(partners, m, f))\n\t\t\t\t\tpartners.push({'mother': m, 'father': f});\n\t\t\t}\n\t\t});\n\t});\n\t$.merge(partnerLinks, partners);\n\n\t$.each(partners, function(_i, ptr) {\n\t\tlet mother = ptr.mother;\n\t\tlet father = ptr.father;\n\t\tmother.children = [];\n\t\tlet parent = {\n\t\t\t\tname : makeid(4),\n\t\t\t\thidden : true,\n\t\t\t\tparent : null,\n\t\t\t\tfather : father,\n\t\t\t\tmother : mother,\n\t\t\t\tchildren : getChildren(opts.dataset, mother, father)\n\t\t};\n\n\t\tlet midx = getIdxByName(opts.dataset, mother.name);\n\t\tlet fidx = getIdxByName(opts.dataset, father.name);\n\t\tif(!('id' in father) && !('id' in mother))\n\t\t\tid = setChildrenId(person.children, id);\n\n\t\t// look at grandparents index\n\t\tlet gp = get_grandparents_idx(opts.dataset, midx, fidx);\n\t\tif(gp.fidx < gp.midx) {\n\t\t\tfather.id = id++;\n\t\t\tparent.id = id++;\n\t\t\tmother.id = id++;\n\t\t} else {\n\t\t\tmother.id = id++;\n\t\t\tparent.id = id++;\n\t\t\tfather.id = id++;\n\t\t}\n\t\tid = updateParent(mother, parent, id, nodes, opts);\n\t\tid = updateParent(father, parent, id, nodes, opts);\n\t\tperson.children.push(parent);\n\t});\n\tid = setChildrenId(person.children, id);\n\n\t$.each(person.children, function(_i, p) {\n\t\tid = buildTree(opts, p, root, partnerLinks, id)[1];\n\t});\n\treturn [partnerLinks, id];\n}\n\n\n// update parent node and sort twins\nfunction updateParent(p, parent, id, nodes, opts) {\n\t// add to parent node\n\tif('parent_node' in p)\n\t\tp.parent_node.push(parent);\n\telse\n\t\tp.parent_node = [parent];\n\n\t// check twins lie next to each other\n\tif(p.mztwin || p.dztwins) {\n\t\tlet twins = getTwins(opts.dataset, p);\n\t\tfor(let i=0; i<twins.length; i++) {\n\t\t\tlet twin = getNodeByName(nodes, twins[i].name);\n\t\t\tif(twin)\n\t\t\t\ttwin.id = id++;\n\t\t}\n\t}\n\treturn id;\n}\n\nfunction setChildrenId(children, id) {\n\t// sort twins to lie next to each other\n\tchildren.sort(function(a, b) {\n\t\tif(a.mztwin && b.mztwin && a.mztwin === b.mztwin)\n\t\t\treturn 0;\n\t\telse if(a.dztwin && b.dztwin && a.dztwin === b.dztwin)\n\t\t\treturn 0;\n\t\telse if(a.mztwin || b.mztwin || a.dztwin || b.dztwin)\n\t\t\treturn 1;\n\t\treturn 0;\n\t});\n\n\t$.each(children, function(_i, p) {\n\t\tif(p.id === undefined) p.id = id++;\n\t});\n\treturn id;\n}\n\nexport function isProband(obj) {\n\treturn typeof $(obj).attr('proband') !== typeof undefined && $(obj).attr('proband') !== false;\n}\n\nexport function setProband(dataset, name, is_proband) {\n\t$.each(dataset, function(_i, p) {\n\t\tif (name === p.name)\n\t\t\tp.proband = is_proband;\n\t\telse\n\t\t\tdelete p.proband;\n\t});\n}\n\n//combine arrays ignoring duplicates\nfunction combineArrays(arr1, arr2) {\n\tfor(let i=0; i<arr2.length; i++)\n\t\tif($.inArray( arr2[i], arr1 ) === -1) arr1.push(arr2[i]);\n}\n\nfunction include_children(connected, p, dataset) {\n\tif($.inArray( p.name, connected ) === -1)\n\t\treturn;\n\tcombineArrays(connected, get_partners(dataset, p));\n\tlet children = getAllChildren(dataset, p);\n\t$.each(children, function( _child_idx, child ) {\n\t\tif($.inArray( child.name, connected ) === -1) {\n\t\t\tconnected.push(child.name);\n\t\t\tcombineArrays(connected, get_partners(dataset, child));\n\t\t}\n\t});\n}\n\n//get the partners for a given node\nexport function get_partners(dataset, anode) {\n\tlet ptrs = [];\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tlet bnode = dataset[i];\n\t\tif(anode.name === bnode.mother && $.inArray(bnode.father, ptrs) === -1)\n\t\t\tptrs.push(bnode.father);\n\t\telse if(anode.name === bnode.father && $.inArray(bnode.mother, ptrs) === -1)\n\t\t\tptrs.push(bnode.mother);\n\t}\n\treturn ptrs;\n}\n\n//return a list of individuals that aren't connected to the target\nexport function unconnected(dataset){\n\tlet target = dataset[ getProbandIndex(dataset) ];\n\tif(!target){\n\t\tconsole.warn(\"No target defined\");\n\t\tif(dataset.length === 0) {\n\t\t\tthrow new Error(\"empty pedigree data set\");\n\t\t}\n\t\ttarget = dataset[0];\n\t}\n\tlet connected = [target.name];\n\tlet change = true;\n\tlet ii = 0;\n\twhile(change && ii < 200) {\n\t\tii++;\n\t\tlet nconnect = connected.length;\n\t\t$.each(dataset, function( _idx, p ) {\n\t\t\tif($.inArray( p.name, connected ) !== -1) {\n\t\t\t\t// check if this person or a partner has a parent\n\t\t\t\tlet ptrs = get_partners(dataset, p);\n\t\t\t\tlet has_parent = (p.name === target.name || !p.noparents);\n\t\t\t\tfor(let i=0; i<ptrs.length; i++){\n\t\t\t\t\tif(!getNodeByName(dataset, ptrs[i]).noparents)\n\t\t\t\t\t\thas_parent = true;\n\t\t\t\t}\n\n\t\t\t\tif(has_parent){\n\t\t\t\t\tif(p.mother && $.inArray( p.mother, connected ) === -1)\n\t\t\t\t\t\tconnected.push(p.mother);\n\t\t\t\t\tif(p.father && $.inArray( p.father, connected ) === -1)\n\t\t\t\t\t\tconnected.push(p.father);\n\t\t\t\t}\n\t\t\t} else if( !p.noparents &&\n\t\t\t\t\t  ((p.mother && $.inArray( p.mother, connected ) !== -1) ||\n\t\t\t\t\t   (p.father && $.inArray( p.father, connected ) !== -1))){\n\t\t\t\tconnected.push(p.name);\n\t\t\t}\n\t\t\t// include any children\n\t\t\tinclude_children(connected, p, dataset);\n\t\t});\n\t\tchange = (nconnect !== connected.length);\n\t}\n\tlet names = $.map(dataset, function(val, _i){return val.name;});\n\treturn $.map(names, function(name, _i){return $.inArray(name, connected) === -1 ? name : null;});\n}\n\nexport function getProbandIndex(dataset) {\n\tlet proband;\n\t$.each(dataset, function(i, val) {\n\t\tif (isProband(val)) {\n\t\t\tproband = i;\n\t\t\treturn proband;\n\t\t}\n\t});\n\treturn proband;\n}\n\nexport function getChildren(dataset, mother, father) {\n\tlet children = [];\n\tlet names = [];\n\tif(mother.sex === 'F')\n\t\t$.each(dataset, function(_i, p) {\n\t\t\tif(mother.name === p.mother)\n\t\t\t\tif(!father || father.name === p.father) {\n\t\t\t\t\tif($.inArray(p.name, names) === -1){\n\t\t\t\t\t\tchildren.push(p);\n\t\t\t\t\t\tnames.push(p.name);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t});\n\treturn children;\n}\n\nfunction contains_parent(arr, m, f) {\n\tfor(let i=0; i<arr.length; i++)\n\t\tif(arr[i].mother === m && arr[i].father === f)\n\t\t\treturn true;\n\treturn false;\n}\n\n// get the mono/di-zygotic twin(s)\nexport function getTwins(dataset, person) {\n\tlet sibs = getSiblings(dataset, person);\n\tlet twin_type = (person.mztwin ? \"mztwin\" : \"dztwin\");\n\treturn $.map(sibs, function(p, _i){\n\t\treturn p.name !== person.name && p[twin_type] === person[twin_type] ? p : null;\n\t});\n}\n\n// get the siblings - sex is an optional parameter\n// for only returning brothers or sisters\nexport function getSiblings(dataset, person, sex) {\n\tif(person === undefined || !person.mother || person.noparents)\n\t\treturn [];\n\n\treturn $.map(dataset, function(p, _i){\n\t\treturn  p.name !== person.name && !('noparents' in p) && p.mother &&\n\t\t\t   (p.mother === person.mother && p.father === person.father) &&\n\t\t\t   (!sex || p.sex === sex) ? p : null;\n\t});\n}\n\n// get the siblings + adopted siblings - sex is an optional parameter\n// for only returning brothers or sisters\nexport function getAllSiblings(dataset, person, sex) {\n\treturn $.map(dataset, function(p, _i){\n\t\treturn  p.name !== person.name && !('noparents' in p) && p.mother &&\n\t\t\t   (p.mother === person.mother && p.father === person.father) &&\n\t\t\t   (!sex || p.sex === sex) ? p : null;\n\t});\n}\n\n// get the adopted siblings of a given individual\nexport function getAdoptedSiblings(dataset, person) {\n\treturn $.map(dataset, function(p, _i){\n\t\treturn  p.name !== person.name && 'noparents' in p &&\n\t\t\t   (p.mother === person.mother && p.father === person.father) ? p : null;\n\t});\n}\n\nexport function getAllChildren(dataset, person, sex) {\n\treturn $.map(dataset, function(p, _i){\n\t\treturn !('noparents' in p) &&\n\t\t\t   (p.mother === person.name || p.father === person.name) &&\n\t\t\t   (!sex || p.sex === sex) ? p : null;\n\t});\n}\n\n// get the depth of the given person from the root\nexport function getDepth(dataset, name) {\n\tlet idx = getIdxByName(dataset, name);\n\tlet depth = 1;\n\n\twhile(idx >= 0 && ('mother' in dataset[idx] || dataset[idx].top_level)){\n\t\tidx = getIdxByName(dataset, dataset[idx].mother);\n\t\tdepth++;\n\t}\n\treturn depth;\n}\n\n// given an array of people get an index for a given person\nexport function getIdxByName(arr, name) {\n\tlet idx = -1;\n\t$.each(arr, function(i, p) {\n\t\tif (name === p.name) {\n\t\t\tidx = i;\n\t\t\treturn idx;\n\t\t}\n\t});\n\treturn idx;\n}\n\n// get the nodes at a given depth sorted by their x position\nexport function getNodesAtDepth(fnodes, depth, exclude_names) {\n\treturn $.map(fnodes, function(p, _i){\n\t\treturn p.depth === depth && !p.data.hidden && $.inArray(p.data.name, exclude_names) === -1 ? p : null;\n\t}).sort(function (a,b) {return a.x - b.x;});\n}\n\n// convert the partner names into corresponding tree nodes\nexport function linkNodes(flattenNodes, partners) {\n\tlet links = [];\n\tfor(let i=0; i< partners.length; i++)\n\t\tlinks.push({'mother': getNodeByName(flattenNodes, partners[i].mother.name),\n\t\t\t\t\t'father': getNodeByName(flattenNodes, partners[i].father.name)});\n\treturn links;\n}\n\n// get ancestors of a node\nexport function ancestors(dataset, node) {\n\tlet ancestors = [];\n\tfunction recurse(node) {\n\t\tif(node.data) node = node.data;\n\t\tif('mother' in node && 'father' in node && !('noparents' in node)){\n\t\t\trecurse(getNodeByName(dataset, node.mother));\n\t\t\trecurse(getNodeByName(dataset, node.father));\n\t\t}\n\t\tancestors.push(node);\n\t}\n\trecurse(node);\n\treturn ancestors;\n}\n\n// test if two nodes are consanguinous partners\nexport function consanguity(node1, node2, opts) {\n\tif(node1.depth !== node2.depth) // parents at different depths\n\t\treturn true;\n\tlet ancestors1 = ancestors(opts.dataset, node1);\n\tlet ancestors2 = ancestors(opts.dataset, node2);\n\tlet names1 = $.map(ancestors1, function(ancestor, _i){return ancestor.name;});\n\tlet names2 = $.map(ancestors2, function(ancestor, _i){return ancestor.name;});\n\tlet consanguity = false;\n\t$.each(names1, function( _index, name ) {\n\t\tif($.inArray(name, names2) !== -1){\n\t\t\tconsanguity = true;\n\t\t\treturn false;\n\t\t}\n\t});\n\treturn consanguity;\n}\n\n// return a flattened representation of the tree\nexport function flatten(root) {\n\tlet flat = [];\n\tfunction recurse(node) {\n\t\tif(node.children)\n\t\t\tnode.children.forEach(recurse);\n\t\tflat.push(node);\n\t}\n\trecurse(root);\n\treturn flat;\n}\n\n// Adjust D3 layout positioning.\n// Position hidden parent node centring them between father and mother nodes. Remove kinks\n// from links - e.g. where there is a single child plus a hidden child\nexport function adjust_coords(opts, root, flattenNodes) {\n\tfunction recurse(node) {\n\t\tif (node.children) {\n\t\t\tnode.children.forEach(recurse);\n\n\t\t\tif(node.data.father !== undefined) { \t// hidden nodes\n\t\t\t\tlet father = getNodeByName(flattenNodes, node.data.father.name);\n\t\t\t\tlet mother = getNodeByName(flattenNodes, node.data.mother.name);\n\n\t\t\t\tadjustConnection(node, father, mother);\n\t\t\t} \t\n\n\t\t}\n\t}\n\n\tfunction adjustConnection(node, father, mother){\n\t\t/*\n\t\t\t\tPrevious Logic -> place hidden parent node at the midpoint of the two parents ie father.x + mother.x/2\n\t\t\t\tObviously, this doesn't take into account the positions of the children which leads to kinks and irregular connections.\n\t\t\t\tWe replace this logic with \n\t\t\t\thidden parent node = midpoint of all the real children ie children with hidden false and noparents also false (or not existing)\n\t\t\t\t*/\n\t\t\t\tlet xReal =  0;\n\t\t\t\tlet nReal = 0;\n\t\t\t\tnode.children.forEach((child) => {\n\t\t\t\t\tif(!child.data.hidden && !child.data.noparents){\n\t\t\t\t\t\txReal = xReal + child.x;\n\t\t\t\t\t\tnReal++;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tlet xmid = xReal/nReal;\n\t\t\t\t/*\n\t\t\t\tThis logic handles the situation where the hidden parent coordinate lies\n\t\t\t\ti) outside the two parents\n\t\t\t\tii) close to the two parents (leading to non-aesthetic lines)\n\t\t\t\tTo handle the first, we just compare the coordinates of xmid with those of the real parents.\n\t\t\t\tTo handle the second, we define a custom intersectionThreshold, which is minimum width between a parent and the hidden node\n\t\t\t\tThen we move the parents themselves accordingly.\n\t\t\t\tThis leads to symmetric and clean figures.\n\t\t\t\tTo understand this more properly, make sure to run this code with breakpoints.\n\t\t\t\t*/\n\t\t\t\tlet parentFirst = father.x < mother.x ? father : mother; \n\t\t\t\tlet parentSecond = father.x > mother.x ? father : mother;\n\t\t\t\tlet intersectionThreshold = 35;\n\t\t\t\tif(xmid <=parentFirst.x || xmid - parentFirst.x <=intersectionThreshold ){\n\t\t\t\t\tlet clashInit = check_ptr_link_clashes(opts, {'mother': mother, 'father': father})\n\t\t\t\t\tlet clashInitSize =  clashInit === null ? 0 : clashInit.length;\n\t\t\t\t\tlet separation = parentSecond.x - parentFirst.x;\n\t\t\t\t\tparentFirst.x = xmid - parentSecond.x + xmid;\n\t\t\t\t\tlet clash = check_ptr_link_clashes(opts, {'mother': mother, 'father': father}) \n\t\t\t\t\tlet clashSize = clash === null ? 0 : clash.length;\n\t\t\t\t\tif(overlap(opts, root.descendants(), parentFirst.x, parentFirst.depth, [parentFirst.data.name]) || (clashSize - clashInitSize > 0)){\n\t\t\t\t\t\tparentFirst.x=parentSecond.x - separation;\n\t\t\t\t\t\txmid = (parentFirst.x+parentSecond.x)/2;\n\t\t\t\t\t}\n\t\t\t\t\t\n\n\t\t\t\t} else if (xmid >=parentSecond.x || parentSecond.x - xmid <=intersectionThreshold){\n\t\t\t\t\tlet clashInit = check_ptr_link_clashes(opts, {'mother': mother, 'father': father})\n\t\t\t\t\tlet clashInitSize =  clashInit === null ? 0 : clashInit.length;\n\t\t\t\t\tlet separation = parentSecond.x - parentFirst.x\n\t\t\t\t\tparentSecond.x = xmid - parentFirst.x + xmid;\n\t\t\t\t\tlet clash = check_ptr_link_clashes(opts, {'mother': mother, 'father': father}) \n\t\t\t\t\tlet clashSize = clash === null ? 0 : clash.length;\n\t\t\t\t\tif(overlap(opts, root.descendants(), parentSecond.x, parentSecond.depth, [parentSecond.data.name]) || (clashSize - clashInitSize > 0)){\n\t\t\t\t\t\tparentSecond.x=parentFirst.x+separation;\n\t\t\t\t\t\txmid = (parentFirst.x+parentSecond.x)/2;\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\t// let xmid = (father.x + mother.x) / 2;\n\t\t\t\tif(!overlap(opts, root.descendants(), xmid, node.depth, [node.data.name])) {\n\t\t\t\t\tnode.x = xmid;   // centralise parent nodes\n\t\t\t\t\tlet diff = node.x - xmid;\n\t\t\t\t\tif(node.children.length === 2 && (node.children[0].data.hidden || node.children[1].data.hidden)) {\n\t\t\t\t\t\tif(!(node.children[0].data.hidden && node.children[1].data.hidden)) {\n\t\t\t\t\t\t\tlet child1 = (node.children[0].data.hidden ? node.children[1] : node.children[0]);\n\t\t\t\t\t\t\tlet child2 = (node.children[0].data.hidden ? node.children[0] : node.children[1]);\n\t\t\t\t\t\t\tif( ((child1.x < child2.x && xmid < child2.x) || (child1.x > child2.x && xmid > child2.x)) &&\n\t\t\t\t\t\t\t\t!overlap(opts, root.descendants(), xmid, child1.depth, [child1.data.name])){\n\t\t\t\t\t\t\t\tchild1.x = xmid;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if(node.children.length === 1 && !node.children[0].data.hidden) {\n\t\t\t\t\t\tif(!overlap(opts, root.descendants(), xmid, node.children[0].depth, [node.children[0].data.name]))\n\t\t\t\t\t\t\tnode.children[0].x = xmid;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif(diff !== 0 && !nodesOverlap(opts, node, diff, root)){\n\t\t\t\t\t\t\tif(node.children.length === 1) {\n\t\t\t\t\t\t\t\tnode.children[0].x = xmid;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tlet descendants = node.descendants();\n\t\t\t\t\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\t\t\t\t\tconsole.log('ADJUSTING '+node.data.name+' NO. DESCENDANTS '+descendants.length+' diff='+diff);\n\t\t\t\t\t\t\t\tfor(let i=0; i<descendants.length; i++) {\n\t\t\t\t\t\t\t\t\tif(node.data.name !== descendants[i].data.name)\n\t\t\t\t\t\t\t\t\t\tdescendants[i].x -= diff;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else if((node.x < father.x && node.x < mother.x) || (node.x > father.x && node.x > mother.x)){\n\t\t\t\t\t\tnode.x = xmid;   // centralise parent nodes if it doesn't lie between mother and father\n\t\t\t\t}\n\n\t}\n\trecurse(root);\n\trecurse(root);\n\n}\n\nexport function adjustPartnerIds(opts, partners){\n\n\n\tpartners.forEach(partner =>\n\t{\n\t\tlet twin = partner.mother.mztwin ? partner.mother : (partner.father.mztwin ? partner.father : null);\n\t\tif(twin){\n\t\t\tfixIdGaps(partner, twin)\n\t\t}\n\n\t}\n\t)\n\tpartners.forEach(partner =>\n\t\t{\n\t\t\tswapPartnerIds(partner)})\n\t\n\t\n\tfunction fixIdGaps(partner, twin){\n\t\tlet noparents;\n\t\tlet otherPartner;\n\t\tif(partner.mother.noparents){\n\t\t\tnoparents = partner.mother;\n\t\t\totherPartner = partner.father;\n\t\t} else if (partner.father.noparents){\n\t\t\tnoparents = partner.father;\n\t\t\totherPartner = partner.mother;\n\t\t}\n\t\tif (noparents && otherPartner){\n\n\t\t\tlet partnerFirst = noparents.id < otherPartner.id ? noparents : otherPartner;  \n\t\t\tlet partnerSecond = noparents.id > otherPartner.id ? noparents : otherPartner;\n\t\t\tif(partnerSecond.id - partnerFirst.id > 2){\n\t\t\t\tlet parentNode = partnerSecond.parent_node.filter(parent => {\n\t\t\t\t\treturn parent.father === partnerFirst || parent.mother === partnerFirst;\n\t\t\t\t})\n\t\t\t\t// fix all other partners of partnerSecond\n\t\t\t\tlet additionalPartner = partnerSecond.parent_node.filter(parent => {\n\t\t\t\t\treturn !(parent.father === partnerFirst || parent.mother === partnerFirst);\n\t\t\t\t})\n\t\t\t\tlet parentId;\n\t\t\t\tif(parentNode.length>0){\n\t\t\t\t\tparentId = parentNode[0].id;\n\t\t\t\t\tlet otherTwin =getTwins(opts.dataset, twin)[0];\n\t\t\t\t\tconsole.log(otherTwin);\n\t\t\t\t\tlet twinIdDiff = otherTwin.id - twin.id;\n\t\t\t\t\tconsole.log(twinIdDiff);\n\t\t\t\t\t\n\t\t\t\t\tif(partnerFirst.id - parentId === 1 && twinIdDiff !== 1 && twinIdDiff !== -1){\n\t\t\t\t\t\tpartnerSecond.id = partnerFirst.id - 2;\n\t\t\t\t\t\tif(additionalPartner.length>0){\n\t\t\t\t\t\t\tlet additionalPartnerNode = partnerSecond === additionalPartner[0].mother ? additionalPartner[0].father : additionalPartner[0].mother;\n\t\t\t\t\t\t\tif(twinIdDiff > 0){\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\tadditionalPartner[0].id = partnerSecond.id -1;\n\t\t\t\t\t\t\t\tadditionalPartnerNode.id + partnerSecond.id - 2;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tadditionalPartner[0].id = partnerFirst.id +1;\n\t\t\t\t\t\t\t\tadditionalPartnerNode.id + partnerFirst.id + 2;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t}\n\t\n\t\t\t\t\t} else if(partnerFirst.id - parentId === -1 && twinIdDiff !== 1 && twinIdDiff !== -1){\n\t\t\t\t\t\tpartnerSecond.id = partnerFirst.id + 2;\n\t\t\t\t\t\tif(additionalPartner.length>0){\n\t\t\t\t\t\t\tlet additionalPartnerNode = partnerSecond === additionalPartner[0].mother ? additionalPartner[0].father : additionalPartner[0].mother;\n\t\t\t\t\t\t\tif(twinIdDiff > 0){\n\t\t\t\t\t\t\t\tadditionalPartner[0].id = partnerFirst.id -1;\n\t\t\t\t\t\t\t\tadditionalPartnerNode.id = partnerFirst.id - 2;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tadditionalPartner[0].id = partnerSecond.id +1;\n\t\t\t\t\t\t\t\tadditionalPartnerNode.id = partnerSecond.id + 2;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\n\n\n\n\t\t\t}\n\t}\n\t}\n\tfunction swapPartnerIds(partner){\n\n\t\tlet noparents;\n\t\tlet otherPartner;\n\t\tif(partner.mother.noparents){\n\t\t\tnoparents = partner.mother;\n\t\t\totherPartner = partner.father;\n\t\t} else if (partner.father.noparents){\n\t\t\tnoparents = partner.father;\n\t\t\totherPartner = partner.mother;\n\t\t}\n\t\tif (noparents && otherPartner && (!otherPartner.top_level)){\n\n\t\t\tlet father = getNodeByName(opts.dataset,otherPartner.father);\t\n\n\t\t\tlet siblings = father.parent_node[0].children;\n\t\t\tlet visibleSiblings = siblings.filter(sibling =>\n\t\t\t\t!(sibling.hidden || sibling.noparents) && sibling!==noparents && sibling!==otherPartner && sibling.mother===otherPartner.mother && sibling.father===otherPartner.father\n\t\t\t);\n\n\t\t\t// Count siblings to the left and right of the partner\n\t\t\tlet leftCount = visibleSiblings.filter(sibling => sibling.id < otherPartner.id).length;\n\t\t\tlet rightCount = visibleSiblings.length - leftCount;\n\t\t\tlet sideWithHigherCount = leftCount > rightCount ? 'left' : 'right';\n\t\t\t\n\t\t\t// Find all other partners of both noparents and otherPartner\n\t\t\tlet noparentsPartner = partners.filter(p =>\n\t\t\t\t(p.mother === noparents || p.father === noparents) &&\n\t\t\t\t!(p.mother === noparents && p.father === otherPartner) &&\n\t\t\t\t!(p.father === noparents && p.mother === otherPartner)\n\t\t\t).map(p => p.mother === noparents ? p.father : p.mother)[0];\n\n\t\t\tlet otherPartnerPartner = partners.filter(p =>\n\t\t\t\t(p.mother === otherPartner || p.father === otherPartner) &&\n\t\t\t\t!(p.mother === noparents && p.father === otherPartner) &&\n\t\t\t\t!(p.father === noparents && p.mother === otherPartner)\n\t\t\t).map(p => p.mother === otherPartner ? p.father : p.mother)[0];\n\n\t\t\tlet swap = false;\n\t\t\t\n\t\t\tif(!noparentsPartner && !otherPartnerPartner){\n\t\t\t\tswap = (sideWithHigherCount === 'left' && noparents.id < otherPartner.id) ||\n\t\t\t(sideWithHigherCount === 'right' && noparents.id > otherPartner.id);\n\t\t\t} else if(otherPartnerPartner &&\n\t\t\t\tnoparents.id < otherPartner.id && otherPartnerPartner.id < otherPartner.id\n\t\t\t){\n\t\t\t\tswap = true;\n\t\t\t} else if( otherPartnerPartner &&\n\t\t\t\tnoparents.id > otherPartner.id && otherPartnerPartner.id > otherPartner.id\n\t\t\t){\n\t\t\t\tswap = true;\n\t\t\t}  else if( noparentsPartner &&\n\t\t\t\totherPartner.id > noparents.id && noparentsPartner.id > noparents.id\n\t\t\t){\n\t\t\t\tswap = true;\n\t\t\t}  else if( noparentsPartner &&\n\t\t\t\totherPartner.id > noparents.id && noparentsPartner.id > noparents.id\n\t\t\t){\n\t\t\t\tswap = true;\n\t\t\t}\n\n\n\t\t\tif (swap) {\n\t\t\t\n\t\t\t\t// Swap the positions of node and partner by exchanging their x values\n\t\t\t\tlet tempId = noparents.id;\n\t\t\t\tnoparents.id = otherPartner.id;\n\t\t\t\totherPartner.id = tempId;\n\t\t\t\n\t\t\t}\n\n\t\t\treturn swap;\n\n\t\t}\n\t}\n\n}\n\n\n// test if moving siblings by diff overlaps with other nodes\nfunction nodesOverlap(opts, node, diff, root) {\n\tlet descendants = node.descendants();\n\tlet descendantsNames = $.map(descendants, function(descendant, _i){return descendant.data.name;});\n\tlet nodes = root.descendants();\n\tfor(let i=0; i<descendants.length; i++){\n\t\tlet descendant = descendants[i];\n\t\tif(node.data.name !== descendant.data.name){\n\t\t\tlet xnew = descendant.x - diff;\n\t\t\tif(overlap(opts, nodes, xnew, descendant.depth, descendantsNames))\n\t\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n}\n\n// test if x position overlaps a node at the same depth\nexport function overlap(opts, nodes, xnew, depth, exclude_names) {\n\tfor(let n=0; n<nodes.length; n++) {\n\t\tif(depth === nodes[n].depth && $.inArray(nodes[n].data.name, exclude_names) === -1){\n\t\t\tif(Math.abs(xnew - nodes[n].x) < (opts.symbol_size*1.15))\n\t\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n}\n\n// given a persons name return the corresponding d3 tree node\nexport function getNodeByName(nodes, name) {\n\tfor (let i = 0; i < nodes.length; i++) {\n\t\tif(nodes[i].data && name === nodes[i].data.name)\n\t\t\treturn nodes[i];\n\t\telse if (name === nodes[i].name)\n\t\t\treturn nodes[i];\n\t}\n}\n\n// given the name of a url param get the value\nexport function urlParam(name){\n\tlet results = new RegExp('[?&]' + name + '=([^&#]*)').exec(window.location.href);\n\tif (results===null)\n\t   return null;\n\telse\n\t   return results[1] || 0;\n}\n\n// get grandparents index\nfunction get_grandparents_idx(dataset, midx, fidx) {\n\tlet gmidx = midx;\n\tlet gfidx = fidx;\n\twhile(  'mother' in dataset[gmidx] && 'mother' in dataset[gfidx] &&\n\t\t  !('noparents' in dataset[gmidx]) && !('noparents' in dataset[gfidx])){\n\t\tgmidx = getIdxByName(dataset, dataset[gmidx].mother);\n\t\tgfidx = getIdxByName(dataset, dataset[gfidx].mother);\n\t}\n\treturn {'midx': gmidx, 'fidx': gfidx};\n}\n\n// check by name if the individual exists\nexport function exists(opts, name){\n\treturn getNodeByName(pedcache.current(opts), name) !== undefined;\n}\n\n// print options and dataset\nexport function print_opts(opts){\n\t$(\"#pedigree_data\").remove();\n\t$(\"body\").append(\"<div id='pedigree_data'></div>\" );\n\tlet key;\n\tfor(let i=0; i<opts.dataset.length; i++) {\n\t\tlet person = \"<div class='row'><strong class='col-md-1 text-right'>\"+opts.dataset[i].name+\"</strong><div class='col-md-11'>\";\n\t\tfor(key in opts.dataset[i]) {\n\t\t\tif(key === 'name') continue;\n\t\t\tif(key === 'parent')\n\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key].name+\"; </span>\";\n\t\t\telse if (key === 'children') {\n\t\t\t\tif (opts.dataset[i][key][0] !== undefined)\n\t\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key][0].name+\"; </span>\";\n\t\t\t} else\n\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key]+\"; </span>\";\n\t\t}\n\t\t$(\"#pedigree_data\").append(person + \"</div></div>\");\n\n\t}\n\t$(\"#pedigree_data\").append(\"<br /><br />\");\n\tfor(key in opts) {\n\t\tif(key === 'dataset') continue;\n\t\t$(\"#pedigree_data\").append(\"<span>\"+key + \":\" + opts[key]+\"; </span>\");\n\t}\n}\n\nexport function is_fullscreen(){\n\treturn (document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement);\n}\n\n\nexport function get_svg_dimensions(opts) {\n\treturn {'width' : (is_fullscreen()? window.innerWidth  : opts.width),\n\t\t\t'height': (is_fullscreen()? window.innerHeight : opts.height)};\n}\n\nexport function get_tree_dimensions(opts) {\n\t// / get score at each depth used to adjust node separation\n\tlet svg_dimensions = get_svg_dimensions(opts);\n\tlet maxscore = 0;\n\tlet generation = {};\n\tfor(let i=0; i<opts.dataset.length; i++) {\n\t\tlet depth = getDepth(opts.dataset, opts.dataset[i].name);\n\t\tlet children = getAllChildren(opts.dataset, opts.dataset[i]);\n\n\t\t// score based on no. of children and if parent defined\n\t\tlet score = 1 + (children.length > 0 ? 0.55+(children.length*0.25) : 0) + (opts.dataset[i].father ? 0.25 : 0);\n\t\tif(depth in generation)\n\t\t\tgeneration[depth] += score;\n\t\telse\n\t\t\tgeneration[depth] = score;\n\n\t\tif(generation[depth] > maxscore)\n\t\t\tmaxscore = generation[depth];\n\t}\n\n\tlet max_depth = Object.keys(generation).length*opts.symbol_size*3.5;\n\tlet tree_width =  (svg_dimensions.width - opts.symbol_size > maxscore*opts.symbol_size*1.65 ?\n\t\t\t\t\t   svg_dimensions.width - opts.symbol_size : maxscore*opts.symbol_size*1.65);\n\tlet tree_height = (svg_dimensions.height - opts.symbol_size > max_depth ?\n\t\t\t\t\t   svg_dimensions.height - opts.symbol_size : max_depth);\n\treturn {'width': tree_width, 'height': tree_height};\n}\n\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\nimport {getposition, setposition} from './pedcache.js';\n\nlet zm;\n\n// initialise zoom and drag\nexport function init_zoom(opts, svg) {\n\t// offsets\n\tlet xi = opts.symbol_size/2;\n\tlet yi = -opts.symbol_size*2.5;\n\n\tzm = d3.zoom()\n\t  .scaleExtent([opts.zoomIn, opts.zoomOut])\n\t  .filter(function(e) {\n\t\t\tif(!opts.zoomSrc || opts.zoomSrc.indexOf('wheel') === -1) {\n\t\t\t\tif(e.type && e.type === 'wheel') return false\n\t\t\t}\n\t\t\t// ignore dblclick & secondary mouse buttons\n\t\t\treturn (e.type !== 'dblclick') && !e.button})\n\t  .on('zoom', function(e) { zooming(e, opts); });\n\tsvg.call(zm);\n\n\t// set initial position & scale\n\tlet xyk = getposition(opts);\t\t// cached position\n\tlet k = (xyk.length === 3 ? xyk[2] : 1);\n\tlet x = (xyk[0] !== null ? xyk[0]/k: (xi*k));\n\tlet y = (xyk[1] !== null ? xyk[1]/k: (yi*k));\n\n\tvar transform = d3.zoomIdentity\n      .scale(k)\n      .translate(x, y);\n    svg.call(zm.transform, transform);\n}\n\n// scale size the pedigree\nexport function btn_zoom(opts, scale) {\n\tlet svg = d3.select(\"#\"+opts.targetDiv).select(\"svg\");\n\tsvg.transition().duration(50).call(zm.scaleBy, scale);\n}\n\nexport function scale_to_fit(opts) {\n\tlet d = get_dimensions(opts);\n\tlet svg = d3.select(\"#\"+opts.targetDiv).select(\"svg\");\n\tlet size = get_svg_size(svg);\n\tlet f = 1;\n\tlet k = (f / Math.max(d.wid/size.w, d.hgt/size.h));\n\n\tif(k < opts.zoomIn) zm.scaleExtent([k, opts.zoomOut]);\n\n\tlet ped = get_pedigree_center(opts);\n\tsvg.call(zm.translateTo, ped.x - opts.symbol_size, ped.y - opts.symbol_size);\n\tsvg.transition().call(zm.scaleTo, k);\n}\n\nfunction zooming(e, opts) {\n\t(opts.DEBUG && console.log(\"zoom\", e.transform));\n\tlet t = e.transform;\n\tlet k = (t.k && t.k !== 1 ? t.k : undefined);\n\tsetposition(opts, t.x, t.y, k);\n\tlet ped = d3.select(\"#\"+opts.targetDiv).select(\".diagram\");\n\tped.attr('transform', 'translate(' + t.x + ',' + t.y + ')' + (k ? ' scale(' + k + ')' : ''));\n}\n\nfunction get_pedigree_center(opts) {\n\tlet b = get_bounds(opts);\n\treturn {x: b.xmin+((b.xmax-b.xmin)/2), y: b.ymin+((b.ymax-b.ymin)/2)};\n}\n\n// find width/height of pedigree graphic\nfunction get_dimensions(opts) {\n\tlet b = get_bounds(opts);\n\treturn {wid: Math.abs(b.xmax-b.xmin), hgt: Math.abs(b.ymax-b.ymin)};\n}\n\n/**\n * Get the min/max boundary of the diagram\n */\nexport function get_bounds(opts) {\n\tlet ped = d3.select(\"#\"+opts.targetDiv).select(\".diagram\");\n\tlet xmin = Number.MAX_VALUE;\n\tlet xmax = -1000000;\n\tlet ymin = Number.MAX_VALUE;\n\tlet ymax = -1000000;\n\tlet sym = opts.symbol_size;\n\tped.selectAll('g').each(function(d, _i) {\n\t\tif(d.x && d.data.name !== 'hidden_root' && !d.data.hidden) {\n\t\t\tlet n = getNodeSize(opts, this, sym);\n\t\t\tif(d.x-sym < xmin) xmin = d.x-sym;\n\t\t\tif(d.x+n.w+sym > xmax) xmax = d.x+n.w+sym;\n\t\t\tif(d.y < ymin) ymin = d.y;\n\t\t\tif(d.y+n.h+sym > ymax) ymax = d.y+n.h+sym;\n\t\t}\n\t});\n\treturn {xmin:xmin, xmax:xmax, ymin:ymin, ymax:ymax};\n}\n\n/**\n * Get the size of an individual's graphical representation\n */\nfunction getNodeSize(opts, g_elm, sym) {\n\tlet node = d3.select(g_elm).node();\n\tlet dg = node.getBBox();\n\tlet w = dg.width;\n\tlet h = dg.height;\n\tif(w === 0 && h === 0) {\t// pedigree not shown yet (family history section not opened)\n\t\ttry {\n\t\t\tw = sym*2;\n\t\t\th = sym*2;\n\t\t\tlet text_elements = d3.select(g_elm).selectAll(\".indi_details\"); // get individuals details\n\t\t\tfor(let i=0; i<text_elements._groups[0].length; i++) {\n\t\t\t\tlet txt = text_elements._groups[0][i].firstChild.nodeValue;\n\t\t\t\tlet txtsize = getTextSize(txt, opts.font_family, opts.font_size);\n\t\n\t\t\t\tw = Math.max(txtsize.w+(sym/2), w);\n\t\t\t\th = Math.max((sym*2)+(i*txtsize.h), h);\n\t\t\t}\n\t\t} catch(err) {\n\t\t\tconsole.error(err);\n\t\t\tw = sym*2;\n\t\t\th = sym*2;\n\t\t}\n\t}\n\treturn {w:w, h:h};\n}\n\n/**\n * Calculate width and height of text\n */\nfunction getTextSize(txt, font, fontSize) {\n\t  let o = $('<div></div>')\n\t            .text(txt)\n\t            .css(\n\t\t\t\t\t{'position': 'absolute',\n\t\t\t\t\t 'float': 'left', 'white-space': 'nowrap', 'visibility': 'hidden',\n\t\t\t\t\t 'font': font || 'Helvetica',\n\t\t\t\t\t 'fontSize': fontSize || '1em'})\n\t            .appendTo($('body'));\n\t  let s = {w: o.width(), h:o.height()};\n\t  o.remove();\n\t  return s;\n}\n\nfunction get_svg_size(svg) {\n\treturn {w: svg.node().clientWidth, h:svg.node().clientHeight};\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// undo, redo, reset buttons\nimport * as pedcache from './pedcache.js';\nimport {btn_zoom, scale_to_fit} from './zoom.js';\nimport {copy_dataset, getProbandIndex, is_fullscreen, messages} from './utils.js';\n\nexport function addButtons(options) {\n\tlet opts = $.extend({\n        // defaults\n\t\tbtn_target: 'pedigree_history'\n    }, options );\n\n\tlet btns = [{\"fa\": \"fa-file-image\", \"title\": \"download PNG image\"},\n\t\t\t\t{\"fa\": \"fa-undo\", \"title\": \"undo\"},\n\t\t\t\t{\"fa\": \"fa-redo\", \"title\": \"redo\"},\n\t\t\t\t{\"fa\": \"fa-refresh\", \"title\": \"reset\"}];\n\n\tbtns.push({\"fa\": \"fa-crosshairs\", \"title\": \"scale-to-fit\"});\n\tif(opts.zoomSrc && (opts.zoomSrc.indexOf('button') > -1)) {\n\t\tif(opts.zoomOut !== 1)\n\t\t\tbtns.push({\"fa\": \"fa-minus-circle\", \"title\": \"zoom-out\"});\n\t\tif(opts.zoomIn !== 1)\n\t\t\tbtns.push({\"fa\": \"fa-plus-circle\", \"title\": \"zoom-in\"});\n\t}\n\tbtns.push({\"fa\": \"fa-arrows-alt\", \"title\": \"fullscreen\"});\n\n\tlet lis = \"\";\n\tfor(let i=0; i<btns.length; i++) {\n\t\tlis += '<span>';\n\t\tlis += '<i class=\"fa fa-lg ' + btns[i].fa + ' pe-2\" aria-hidden=\"true\" title=\"'+ btns[i].title + '\"' +\n\t\t(btns[i].fa === \"fa-arrows-alt\" ? 'id=\"fullscreen\" ' : '') +\n\t\t'></i>';\n\n\t\tlis += '</span>';\n\t}\n\t$( \"#\"+opts.btn_target ).append(lis);\n\taddPbuttonEvents(opts);\n}\n\nfunction addPbuttonEvents(opts) {\n\t// fullscreen\n    $(document).on('webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange', function(_e)  {\n\t\tlet local_dataset = pedcache.current(opts);\n\t\tif (local_dataset !== undefined && local_dataset !== null) {\n\t\t\topts.dataset = local_dataset;\n\t\t}\n\t\t$(document).trigger('rebuild', [opts]);\n\t\tsetTimeout(function(){ scale_to_fit(opts); }, 500);\n    });\n\n\t$('#fullscreen').on('click', function(_e) {\n\t\t// toggle fullscreen\n\t\tif (!is_fullscreen()) {\n\t\t\tlet target = $(\"#\"+opts.targetDiv)[0];\n\t\t\tif (target.requestFullscreen) {\n                target.requestFullscreen();\n            } else if (document.documentElement.mozRequestFullScreen) {\n\t\t\t\ttarget.mozRequestFullScreen(); // Firefox\n            } else if (document.documentElement.webkitRequestFullscreen) {\n                target.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT); // Chrome and Safari\n            } else if (document.documentElement.msRequestFullscreen) {\n                target.msRequestFullscreen(); // IE\n            }\n\t\t} else {\n            if (document.exitFullscreen) {\n                document.exitFullscreen();\n            } else if (document.msExitFullscreen) {\n                document.msExitFullscreen();\n            } else if (document.mozCancelFullScreen) {\n                document.mozCancelFullScreen();\n            } else if (document.webkitExitFullscreen) {\n                document.webkitExitFullscreen();\n            }\n\t\t}\n\t});\n\n\t// press and hold to zoom in/out\n\tlet timeoutId = 0;\n\tfunction zoomIn() {btn_zoom(opts, 1.05);}\n\tfunction zoomOut() {btn_zoom(opts, 0.95);}\n\t$('.fa-plus-circle, .fa-minus-circle').on('mousedown', function() {\n\t    timeoutId = setInterval(($( this ).hasClass( \"fa-plus-circle\" ) ? zoomIn : zoomOut), 50);\n\t}).on('mouseup mouseleave', function() {\n\t    clearInterval(timeoutId);\n\t});\n\n\t// undo/redo/reset\n\t$( \"#\"+opts.btn_target ).on( \"click\", function(e) {\n\t\te.stopPropagation();\n\t\tif($(e.target).hasClass(\"disabled\"))\n\t\t\treturn false;\n\n\t\tif($(e.target).hasClass('fa-undo')) {\n\t\t\topts.dataset = pedcache.previous(opts);\n\t\t\t$(\"#\"+opts.targetDiv).empty();\n\t\t\t$(document).trigger('build', [opts]);\n\t\t} else if ($(e.target).hasClass('fa-redo')) {\n\t\t\topts.dataset = pedcache.next(opts);\n\t\t\t$(\"#\"+opts.targetDiv).empty();\n\t\t\t$(document).trigger('build', [opts]);\n\t\t} else if ($(e.target).hasClass('fa-refresh')) {\n\t\t\tmessages(\"Pedigree Reset\",\n\t\t\t         \"This may result in loss of some data. Reset now?\",\n\t\t\t         reset, opts);\n\t\t} else if ($(e.target).hasClass('fa-crosshairs')) {\n\t\t\tscale_to_fit(opts);\n\t\t} else if ($(e.target).hasClass('fa-file-image')) {\n\t\t\treturn;\n\t\t} \n\n\t\t// trigger fhChange event\n\t\t$(document).trigger('fhChange', [opts]);\n\t});\n}\n\n// reset pedigree and clear the history\nfunction reset(opts) {\n\tlet proband;\n\tif(opts.keep_proband_on_reset) {\n\t\tlet local_dataset = pedcache.current(opts);\n\t\tlet newdataset =  copy_dataset(local_dataset);\n\t\tproband = newdataset[getProbandIndex(newdataset)];\n\t\t//let children = pedigree_util.getChildren(newdataset, proband);\n\t\tproband.name = \"ch1\";\n\t\tproband.mother = \"f21\";\n\t\tproband.father = \"m21\";\n\t\t// clear pedigree data but keep proband data and risk factors\n\t\tpedcache.clear_pedigree_data(opts)\n\t} else {\n\t\tproband = {\n\t\t\t\"name\":\"ch1\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"proband\":true,\"status\":\"0\",\"display_name\":\"me\"\n\t\t};\n\t\tpedcache.clear(opts); // clear all storage data\n\t}\n\n\tdelete opts.dataset;\n\n\tlet selected = $(\"input[name='default_fam']:checked\");\n\tif(selected.length > 0 && selected.val() === 'extended2') {    // secondary relatives\n\t\topts.dataset = [\n\t\t\t{\"name\":\"wZA\",\"sex\":\"M\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"paternal grandfather\"},\n\t\t\t{\"name\":\"MAk\",\"sex\":\"F\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"paternal grandmother\"},\n\t\t\t{\"name\":\"zwB\",\"sex\":\"M\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"maternal grandfather\"},\n\t\t\t{\"name\":\"dOH\",\"sex\":\"F\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"maternal grandmother\"},\n\t\t\t{\"name\":\"MKg\",\"sex\":\"F\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"paternal aunt\"},\n\t\t\t{\"name\":\"xsm\",\"sex\":\"M\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"paternal uncle\"},\n\t\t\t{\"name\":\"m21\",\"sex\":\"M\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"father\"},\n\t\t\t{\"name\":\"f21\",\"sex\":\"F\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\",\"display_name\":\"mother\"},\n\t\t\t{\"name\":\"aOH\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"sister\"},\n\t\t\t{\"name\":\"Vha\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"brother\"},\n\t\t\t{\"name\":\"Spj\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"noparents\":true,\"status\":\"0\",\"display_name\":\"partner\"},\n\t\t\tproband,\n\t\t\t{\"name\":\"zhk\",\"sex\":\"F\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\",\"display_name\":\"daughter\"},\n\t\t\t{\"name\":\"Knx\",\"display_name\":\"son\",\"sex\":\"M\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\"},\n\t\t\t{\"name\":\"uuc\",\"display_name\":\"maternal aunt\",\"sex\":\"F\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\"},\n\t\t\t{\"name\":\"xIw\",\"display_name\":\"maternal uncle\",\"sex\":\"M\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\"}];\n\t} else if(selected.length > 0 && selected.val() === 'extended1') {    // primary relatives\n\t\topts.dataset = [\n\t\t\t{\"name\":\"m21\",\"sex\":\"M\",\"mother\":null,\"father\":null,\"status\":\"0\",\"display_name\":\"father\",\"noparents\":true},\n\t\t\t{\"name\":\"f21\",\"sex\":\"F\",\"mother\":null,\"father\":null,\"status\":\"0\",\"display_name\":\"mother\",\"noparents\":true},\n\t\t\t{\"name\":\"aOH\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"sister\"},\n\t\t\t{\"name\":\"Vha\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"brother\"},\n\t\t\t{\"name\":\"Spj\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"noparents\":true,\"status\":\"0\",\"display_name\":\"partner\"},\n\t\t\tproband,\n\t\t\t{\"name\":\"zhk\",\"sex\":\"F\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\",\"display_name\":\"daughter\"},\n\t\t\t{\"name\":\"Knx\",\"display_name\":\"son\",\"sex\":\"M\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\"}];\n\t} else {\n\t\topts.dataset = [\n\t\t\t{\"name\": \"m21\", \"display_name\": \"father\", \"sex\": \"M\", \"top_level\": true},\n\t\t\t{\"name\": \"f21\", \"display_name\": \"mother\", \"sex\": \"F\", \"top_level\": true},\n\t\t\tproband];\n\t}\n\t$(document).trigger('rebuild', [opts]);\n}\n\nexport function updateButtons(opts) {\n\tlet current = pedcache.get_count(opts);\n\tlet nstore = pedcache.nstore(opts);\n\tlet id = \"#\"+opts.btn_target;\n\tif(nstore <= current)\n\t\t$(id+\" .fa-redo\").addClass('disabled');\n\telse\n\t\t$(id+\" .fa-redo\").removeClass('disabled');\n\n\tif(current > 1)\n\t\t$(id+\" .fa-undo\").removeClass('disabled');\n\telse\n\t\t$(id+\" .fa-undo\").addClass('disabled');\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\nimport * as pedigree_util from './utils.js';\n\n// cancers, genetic & pathology tests\nexport let cancers = {\n\t\t'breast_cancer': 'breast_cancer_diagnosis_age',\n\t\t'breast_cancer2': 'breast_cancer2_diagnosis_age',\n\t\t'ovarian_cancer': 'ovarian_cancer_diagnosis_age',\n\t\t'prostate_cancer': 'prostate_cancer_diagnosis_age',\n\t\t'pancreatic_cancer': 'pancreatic_cancer_diagnosis_age'\n\t};\nexport let genetic_test1 = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'rad51d', 'rad51c', 'brip1'];\nexport let genetic_test2 = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'bard1', 'rad51d', 'rad51c', 'brip1'];\nexport let genetic_test4 = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'bard1', 'rad51d', 'rad51c', 'brip1', 'hoxb13'];\n\nexport let pathology_tests = ['er', 'pr', 'her2', 'ck14', 'ck56'];\n\n// risk factor to storage\nlet RISK_FACTOR_STORE = {};\n\n// get surgical ops and PRS for canrisk header\nexport function get_meta() {\n\tlet meta = get_surgical_ops();\n\tlet prs;\n\ttry {\n\t\tprs = get_prs_values();\n\t\tif(prs.breast_cancer_prs && prs.breast_cancer_prs.alpha !== 0 && prs.breast_cancer_prs.zscore !== 0) {\n\t\t\tmeta += \"\\n##PRS_BC=alpha=\"+prs.breast_cancer_prs.alpha+\",zscore=\"+prs.breast_cancer_prs.zscore;\n\t\t}\n\n\t\tif(prs.ovarian_cancer_prs && prs.ovarian_cancer_prs.alpha !== 0 && prs.ovarian_cancer_prs.zscore !== 0) {\n\t\t\tmeta += \"\\n##PRS_OC=alpha=\"+prs.ovarian_cancer_prs.alpha+\",zscore=\"+prs.ovarian_cancer_prs.zscore;\n\t\t}\n\n\t\tif(prs.prostate_cancer_prs && prs.prostate_cancer_prs.alpha !== 0 && prs.prostate_cancer_prs.zscore !== 0) {\n\t\t\tmeta += \"\\n##PRS_PC=alpha=\"+prs.prostate_cancer_prs.alpha+\",zscore=\"+prs.prostate_cancer_prs.zscore;\n\t\t}\n\t} catch(err) { console.warn(\"PRS\", prs); }\n\treturn meta;\n}\n\n// return a non-anonimised pedigree format\nexport function get_non_anon_pedigree(dataset, meta, version=2, ethnicity=undefined) {\n\treturn get_pedigree(dataset, undefined, meta, false, version, ethnicity);\n}\n\n//check if input has a value\nexport function hasInput(id) {\n\treturn $.trim($('#'+id).val()).length !== 0;\n}\n\n//return true if the object is empty\nlet isEmpty = function(myObj) {\n\tfor(let key in myObj) {\n\t\tif (Object.prototype.hasOwnProperty.call(myObj, key)) {\n\t\t\treturn false;\n\t\t}\n\t}\n\treturn true;\n}\n\n//get breast and ovarian PRS values\nexport function get_prs_values() {\n\tlet prs = {};\n\tif(hasInput(\"breast_prs_a\") && hasInput(\"breast_prs_z\")) {\n\t\tprs['breast_cancer_prs'] = {\n\t\t\t'alpha': parseFloat($('#breast_prs_a').val()),\n\t\t\t'zscore': parseFloat($('#breast_prs_z').val()),\n\t\t\t'percent': parseFloat($('#breast_prs_percent').val())\n\t\t};\n\t}\n\tif(hasInput(\"ovarian_prs_a\") && hasInput(\"ovarian_prs_z\")) {\n\t\tprs['ovarian_cancer_prs'] = {\n\t\t\t'alpha': parseFloat($('#ovarian_prs_a').val()),\n\t\t\t'zscore': parseFloat($('#ovarian_prs_z').val()),\n\t\t\t'percent': parseFloat($('#ovarian_prs_percent').val())\n\t\t};\n\t}\n\tif(hasInput(\"prostate_prs_a\") && hasInput(\"prostate_prs_z\")) {\n\t\tprs['prostate_cancer_prs'] = {\n\t\t\t'alpha': parseFloat($('#prostate_prs_a').val()),\n\t\t\t'zscore': parseFloat($('#prostate_prs_z').val()),\n\t\t\t'percent': parseFloat($('#prostate_prs_percent').val())\n\t\t};\n\t}\n\tconsole.log(prs);\n\treturn (isEmpty(prs) ? 0 : prs);\n}\n\nfunction get_surgical_ops() {\n\tlet meta = \"\";\n\tif(!$('#A6_4_3_check').parent().hasClass(\"off\")) {\n\t\tmeta += \";OVARY2=y\";\n\t}\n\tif(!$('#A6_4_7_check').parent().hasClass(\"off\")) {\n\t\tmeta += \";MAST2=y\";\n\t}\n\treturn meta;\n}\n\n/**\n * Get genetic test genes based on CanRisk version\n */\nfunction getGeneticTest(version) {\n\tversion = parseInt(version);\n\tif(version === 1)\n\t\treturn genetic_test1;\n\telse if(version === 2)\n\t\treturn genetic_test2;\n\telse if(version === 3)\n\t\treturn genetic_test2;\n\treturn genetic_test4;\n}\n\nexport function readCanRisk(boadicea_lines) {\n\tlet lines = boadicea_lines.trim().split('\\n');\n\tlet ped = [];\n\tlet hdr = [];  // collect risk factor header lines\n\tconst regexp = /([0-9])/;\n\tlet version = 3;\n\tlet gt = getGeneticTest(version);\n\tlet ncol = [26, 27, 27, 28];\t// number of columns - v1, v2, v3, v4\n\t// assumes two line header\n\tfor(let i = 0;i < lines.length;i++){\n\t\tlet ln = lines[i].trim();\n\t\tif(ln.indexOf(\"##\") === 0) {\n\t\t\tif(ln.indexOf(\"##CanRisk\") === 0) {\n\t\t\t\tconst match = ln.match(regexp);\n\t\t\t\tversion = parseInt(match[1]);\n\t\t\t\tgt = getGeneticTest(version);\n\t\t\t\tconsole.log(\"CanRisk File Format version \"+version);\n\n\t\t\t\tif(ln.indexOf(\";\") > -1) {   // contains surgical op data\n\t\t\t\t\tlet ops = ln.split(\";\");\n\t\t\t\t\tfor(let j=1; j<ops.length; j++) {\n\t\t\t\t\t\tlet opdata = ops[j].split(\"=\");\n\t\t\t\t\t\tif(opdata.length === 2) {\n\t\t\t\t\t\t\thdr.push(ops[j]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(ln.indexOf(\"CanRisk\") === -1 && ln.indexOf(\"##FamID\") !== 0) {\n\t\t\t\thdr.push(ln.replace(\"##\", \"\"));\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\n\t\tlet delim = /\\t/;\n\t\tif(ln.indexOf('\\t') < 0) {\n\t\t\tdelim = /\\s+/;\n\t\t\tconsole.log(\"NOT TAB DELIM\");\n\t\t}\n\t\tlet attr = $.map(ln.split(delim), function(val, _i){return val.trim();});\n\n\t\tif(attr.length > 1) {\n\t\t\tif(attr.length !== ncol[version-1]) {\n\t\t\t\tconsole.error(ln, attr);\n\t\t\t\tthrow new Error('Found number of columns '+attr.length+'; expected '+ncol[version-1]+' for CanRisk version '+version);\n\t\t\t}\n\t\t\tlet indi = {\n\t\t\t\t'famid': attr[0],\n\t\t\t\t'display_name': attr[1],\n\t\t\t\t'name':\tattr[3],\n\t\t\t\t'sex': attr[6],\n\t\t\t\t'status': attr[8]\n\t\t\t};\n\t\t\tif(attr[2] === \"1\") indi.proband = true;\n\t\t\tif(attr[4] !== \"0\") indi.father = attr[4];\n\t\t\tif(attr[5] !== \"0\") indi.mother = attr[5];\n\t\t\tif(attr[7] !== \"0\") indi.mztwin = attr[7];\n\t\t\tif(attr[9] !== \"0\") indi.age = attr[9];\n\t\t\tif(attr[10] !== \"0\") indi.yob = attr[10];\n\n\t\t\tlet idx = 11;\n\t\t\t$.each(cancers, function(cancer, diagnosis_age) {\n\t\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\n\t\t\t\tif(attr[idx] !== \"0\") {\n\t\t\t\t\tindi[diagnosis_age] = attr[idx];\n\t\t\t\t}\n\t\t\t\tidx++;\n\t\t\t});\n\n\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\n\t\t\t// BRCA1, BRCA2, PALB2, ATM, CHEK2, .... genetic tests\n\t\t\t// genetic test type, 0 = untested, S = mutation search, T = direct gene test\n\t\t\t// genetic test result, 0 = untested, P = positive, N = negative\n\t\t\tfor(let j=0; j<gt.length; j++) {\n\t\t\t\tlet gene_test = attr[idx].split(\":\");\n\t\t\t\tif(gene_test[0] !== '0') {\n\t\t\t\t\tif((gene_test[0] === 'S' || gene_test[0] === 'T') && (gene_test[1] === 'P' || gene_test[1] === 'N'))\n\t\t\t\t\t\tindi[gt[j] + '_gene_test'] = {'type': gene_test[0], 'result': gene_test[1]};\n\t\t\t\t\telse\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + gene_test[0] + \" \" + gene_test[1]);\n\t\t\t\t} else {\n\t\t\t\t\tif(gene_test[1] === 'P' || gene_test[1] === 'N')\n\t\t\t\t\t\tindi[gt[j] + '_gene_test'] = {'type': gene_test[0], 'result': gene_test[1]};\n\t\t\t\t}\n\t\t\t\tidx++;\n\t\t\t}\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\n\t\t\tlet path_test = attr[idx].split(\":\");\n\t\t\tfor(let j=0; j<path_test.length; j++) {\n\t\t\t\tif(path_test[j] !== '0') {\n\t\t\t\t\tif(path_test[j] === 'N' || path_test[j] === 'P')\n\t\t\t\t\t\tindi[pathology_tests[j] + '_bc_pathology'] = path_test[j];\n\t\t\t\t\telse\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED PATHOLOGY ON LINE '+ (i+1) + \": \" +pathology_tests[j] + \" \" +path_test[j]);\n\t\t\t\t}\n\t\t\t}\n\t\t\tped.unshift(indi);\n\t\t}\n\t}\n\n\t// group mztwins\n\tped.sort(function(a, b) {\n\t\treturn a.mztwin !== undefined ? a.mztwin.localeCompare(b.mztwin) : 0;\n\t});\n\n\treturn [hdr, ped];\n}\n\n/**\n * Get the mammographic density formatted CanRisk data file line\n */\nexport function get_mdensity(mdensity) {\n\tconst regexp = /^(birads|Volpara|Stratus)=/i;\n\tif(regexp.test(mdensity))\n\t\treturn \"\\n##\"+mdensity;\n\t\t\n\tconst birads = /^(1|2|3|4|a|b|c|d)$/i\n\tif(birads.test(mdensity))\n\t\treturn \"\\n##birads=\"+mdensity;\n\n\tconsole.error(\"Unrecognised mammographic density format :: \" + mdensity);\n\treturn \"\"\n}\n\n/**\n * Get CanRisk formated pedigree.\n */\nexport function get_pedigree(dataset, famid, meta, isanon, version=3, ethnicity=undefined) {\n\tlet v = (Number.isInteger(version) ? version+\".0\" : version.toString());\n\tlet msg = \"##CanRisk \" + v;\n\tif(!famid) {\n\t\tfamid = \"XXXX\";\n\t}\n\tif(meta) {\n\t\tmsg += meta;\n\t}\n\tif(typeof isanon === 'undefined') {\n\t\tisanon = true;\n\t}\n\t// array of individuals excluded from the calculation\n\tlet excl = $.map(dataset, function(p, _i){return 'exclude' in p && p.exclude ? p.name : null;});\n\n\t// female risk factors\n\tlet probandIdx  = pedigree_util.getProbandIndex(dataset);\n\tlet sex = 'F';\n\tif(probandIdx) {\n\t\tsex = dataset[probandIdx].sex;\n\t}\n\n\tif(sex !== 'M') {\n\t\tlet menarche    = get_risk_factor('menarche_age');\n\t\tlet parity      = get_risk_factor('parity');\n\t\tlet first_birth = get_risk_factor('age_of_first_live_birth');\n\t\tlet oc_use      = get_risk_factor('oral_contraception');\n\t\tlet mht_use     = get_risk_factor('mht');\n\t\tlet bmi         = get_risk_factor('bmi');\n\t\tlet alcohol     = get_risk_factor('alcohol_intake');\n\t\tlet menopause   = get_risk_factor('age_of_menopause');\n\t\tlet mdensity    = get_risk_factor('mammographic_density');\n\t\tlet hgt         = get_risk_factor('height');\n\t\tlet tl          = get_risk_factor('Age_Tubal_ligation');\n\t\tlet endo        = get_risk_factor('endometriosis');\n\n\t\tif(menarche !== undefined)\n\t\t\tmsg += \"\\n##menarche=\"+menarche;\n\t\tif(parity !== undefined)\n\t\t\tmsg += \"\\n##parity=\"+parity;\n\t\tif(first_birth !== undefined)\n\t\t\tmsg += \"\\n##first_live_birth=\"+first_birth;\n\t\tif(oc_use !== undefined)\n\t\t\tmsg += \"\\n##oc_use=\"+oc_use;\n\t\tif(mht_use !== undefined)\n\t\t\tmsg += \"\\n##mht_use=\"+mht_use;\n\t\tif(bmi !== undefined)\n\t\t\tmsg += \"\\n##BMI=\"+bmi;\n\t\tif(alcohol !== undefined)\n\t\t\tmsg += \"\\n##alcohol=\"+alcohol;\n\t\tif(menopause !== undefined)\n\t\t\tmsg += \"\\n##menopause=\"+menopause;\n\t\tif(mdensity !== undefined)\n\t\t\tmsg += get_mdensity(mdensity);\n\t\tif(hgt !== undefined)\n\t\t\tmsg += \"\\n##height=\"+hgt;\n\t\tif(tl !== undefined)\n\t\t\tif(tl !== \"n\" && tl !== \"N\")\n\t\t\t\tmsg += \"\\n##TL=Y\";\n\t\t\telse\n\t\t\t\tmsg += \"\\n##TL=N\";\n\n\t\tif(endo !== undefined)\n\t\t\tmsg += \"\\n##endo=\"+endo;\n\t}\n\t\n\tif(version > 2 && ethnicity !== undefined) {\n\t\tmsg += \"\\n##ethnicity=\"+ethnicity;\n\t}\n\tmsg += \"\\n##FamID\\tName\\tTarget\\tIndivID\\tFathID\\tMothID\\tSex\\tMZtwin\\tDead\\tAge\\tYob\\tBC1\\tBC2\\tOC\\tPRO\\tPAN\\tAshkn\"\n\n\tlet gt = getGeneticTest(version);\n\tfor(let i=0; i<gt.length; i++) {\n\t\tmsg += \"\\t\"+gt[i].toUpperCase();\n\t}\n\tmsg += \"\\tER:PR:HER2:CK14:CK56\";\n\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tlet p = dataset[i];\n\t\tif($.inArray(p.name, excl) !== -1) {\n\t\t\tconsole.log('EXCLUDE: '+p.name);\n\t\t\tcontinue;\n\t\t}\n\n\t\tmsg += '\\n'+famid+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t// max 13 chars\n\t\tif(isanon)\n\t\t\tmsg += i+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t\t// display_name (ANONIMISE) max 8 chars\n\t\telse\n\t\t\tmsg += (p.display_name ? p.display_name : \"NA\")+'\\t';\n\t\tmsg += ('proband' in p ? '1' : 0)+'\\t';\n\t\tmsg += p.name+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t\t// max 7 chars\n\t\tmsg += ('father' in p && !('noparents' in p) && ($.inArray(p.mother, excl) === -1)? p.father : 0)+'\\t';\t// max 7 chars\n\t\tmsg += ('mother' in p && !('noparents' in p) && ($.inArray(p.mother, excl) === -1)? p.mother : 0)+'\\t';\t// max 7 chars\n\t\tmsg += p.sex+'\\t';\n\t\tmsg += ('mztwin' in p ? p.mztwin : 0)+'\\t'; \t\t\t\t\t\t// MZtwin\n\t\tmsg += ('status' in p ? p.status : 0)+'\\t';\t\t\t\t\t\t\t// current status: 0 = alive, 1 = dead\n\t\tmsg += ('age' in p ? p.age : 0)+'\\t';\t\t\t\t\t\t\t\t// Age at last follow up or 0 = unspecified\n\t\tmsg += ('yob' in p ? p.yob : 0)+'\\t';\t\t\t\t\t\t\t\t// YOB or 0 = unspecified\n\n\t\tlet cmsg = \"\";\n\t\t$.each(cancers, function(cancer, diagnosis_age) {\n\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\n\t\t\tif(diagnosis_age in p)\n\t\t\t\tcmsg += (diagnosis_age in p ? p[diagnosis_age] : 'AU')+'\\t';\n\t\t\telse\n\t\t\t\tcmsg += '0\\t';\n\t\t});\n\t\tmsg+=cmsg;\n\n\t\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\n\t\tmsg += ('ashkenazi' in p ? p.ashkenazi : 0)+'\\t';\n\n\t\tfor(let j=0; j<gt.length; j++) {\n\t\t\tif(gt[j]+'_gene_test' in p &&\n\t\t\t   p[gt[j]+'_gene_test']['type'] !== '-' &&\n\t\t\t   p[gt[j]+'_gene_test']['result'] !== '-') {\n\t\t\t\tmsg += p[gt[j]+'_gene_test']['type'] + ':';\n\t\t\t\tmsg += p[gt[j]+'_gene_test']['result'] + '\\t';\n\t\t\t} else {\n\t\t\t\tmsg += '0:0\\t';\t\t// type, 0=untested, S=mutation search, T=direct gene test\n\t\t\t\t\t\t\t\t\t// result, 0=untested, P=positive, N=negative\n\t\t\t}\n\t\t}\n\n\t\tfor(let j=0; j<pathology_tests.length; j++) {\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\n\t\t\tif(pathology_tests[j]+'_bc_pathology' in p) {\n\t\t\t\tmsg += p[pathology_tests[j]+'_bc_pathology'];\n\t\t\t\tconsole.log('pathology '+p[pathology_tests[j]+'_bc_pathology']+' for '+p.display_name);\n\t\t\t} else {\n\t\t\t\tmsg += '0';\n\t\t\t}\n\t\t\tif(j<(pathology_tests.length-1))\n\t\t\t\tmsg += \":\";\n\t\t}\n\t}\n\tconsole.log(msg, RISK_FACTOR_STORE);\n\treturn msg;\n}\n\nexport function show_risk_factor_store() {\n\tconsole.log(\"RISK_FACTOR_STORE::\");\n\t$.each(RISK_FACTOR_STORE, function(name, val){\n\t\tconsole.log(name + \" : \" + val);\n\t});\n}\n\nexport function save_risk_factor(risk_factor_name, val) {\n\tRISK_FACTOR_STORE[store_name(risk_factor_name)] = val;\n}\n\nexport function get_risk_factor(risk_factor_name) {\n\tlet key = store_name(risk_factor_name);\n\tif(key in RISK_FACTOR_STORE) {\n\t\treturn RISK_FACTOR_STORE[key];\n\t}\n\treturn undefined;\n}\n\n// remove risk factor from storage\nexport function remove_risk_factor(risk_factor_name) {\n\tdelete RISK_FACTOR_STORE[store_name(risk_factor_name)];\n}\n\n// prefix risk factor name with the app/page name\nexport function store_name(risk_factor_name) {\n\treturn window.location.pathname.split('/').filter(function(el){ return !!el; }).pop() +\n\t       '::' + risk_factor_name;\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// pedigree I/O\nimport * as utils from './utils.js';\nimport * as pedcache from './pedcache.js';\nimport {readCanRisk, cancers, genetic_test1, pathology_tests} from './canrisk_file.js';\nimport {get_bounds} from './zoom.js';\n\n\nexport function addIO(opts) {\n\t$('#load').change(function(e) {\n\t\tload(e, opts);\n\t});\n\n\t$('#save').click(function(_e) {\n\t\tsave(opts);\n\t});\n\n\t$('#print').click(function(_e) {\n\t\tprint(get_printable_svg(opts));\n\t});\n\n\t$('#svg_download').click(function(_e) {\n\t\tsvg_download(get_printable_svg(opts));\n\t});\n\n\t$('#png_download, .fa-file-image').click(function(_e) {\n\t\tlet resolution = 4;\n\t\timg_download(opts, resolution, \"image/png\");\n\t});\n}\n\n/**\n * Get object from array by the name attribute.\n */\nfunction getByName(arr, name) {\n\treturn $.grep(arr, function(o){ return o && o.name === name; })[0];\n}\n\n/**\n * Provide font style to svg\n */\nfunction copyStylesInline(destinationNode, sourceNode) {\n\tlet containerElements = [\"svg\",\"g\"];\n\tfor (let cd = 0; cd < destinationNode.childNodes.length; cd++) {\n\t\tlet child = destinationNode.childNodes[cd];\n\t\tif (containerElements.indexOf(child.tagName) !== -1) {\n\t\t\tcopyStylesInline(child, sourceNode.childNodes[cd]);\n\t\t\tcontinue;\n\t\t}\n\t\ttry {\n\t\t\tlet style = sourceNode.childNodes[cd].currentStyle || window.getComputedStyle(sourceNode.childNodes[cd]);\n\t\t\tif (style === \"undefined\" || style === null) continue;\n\n\t\t\tfor (let st = 0; st < style.length; st++){\n\t\t\t\tif(style[st].indexOf(\"text\") > -1 || style[st].indexOf(\"font\") > -1) child.style.setProperty(style[st], style.getPropertyValue(style[st]));\n\t\t\t}\n\t\t} catch(err) { continue; }\n   }\n}\n\n/**\n * Export pedigree as image, e.g. PNG\n */\nexport function img_download(opts, resolution, img_type) {\n\tlet deferred = svg2img($('#'+opts.targetDiv).find('svg'), \"pedigree\", {resolution: resolution, img_type: img_type});\n\t$.when.apply($,[deferred]).done(function() {\n\t\tlet obj = getByName(arguments, \"pedigree\");\n\t\tif(utils.isEdge() || utils.isIE()) {\n\t\t\tlet html=\"<img src='\"+obj.img+\"' alt='canvas image'/>\";\n\t\t\tlet newTab = window.open();\t\t// pop-ups need to be enabled\n\t\t\tnewTab.document.write(html);\n\t\t} else {\n\t\t\tlet a\t  = document.createElement('a');\n\t\t\ta.href\t = obj.img;\n\t\t\ta.download = 'plot.png';\n\t\t\ta.target   = '_blank';\n\t\t\tdocument.body.appendChild(a); a.click(); document.body.removeChild(a);\n\t\t}\n\t});\n}\n\n/**\n * Given a SVG document element convert to image (e.g. jpeg, png - default png).\n */\nexport function svg2img(svg, deferred_name, options) {\n\tlet defaults = {iscanvg: false, resolution: 1, img_type: \"image/png\"};\n\tif(!options) options = defaults;\n\t$.each(defaults, function(key, value) {\n\t\tif(!(key in options)) {options[key] = value;}\n\t});\n\n\tlet copy = svg.get(0).cloneNode(true);\n\tcopyStylesInline(copy, svg.get(0));\n\tlet deferred = $.Deferred();\n\tlet svgStr = (new XMLSerializer()).serializeToString(copy);\n\n\tlet imgsrc = 'data:image/svg+xml;base64,'+ window.btoa(unescape(encodeURIComponent(svgStr))); // convert SVG string to data URL\n\tlet canvas = document.createElement(\"canvas\");\n\tcanvas.width = svg.width()*options.resolution;\n\tcanvas.height = svg.height()*options.resolution;\n\tlet context = canvas.getContext(\"2d\");\n\t// provide a white background\n\tcontext.fillStyle = \"white\";\n\tcontext.fillRect(0, 0, canvas.width, canvas.height);\n\t\n\tlet img = document.createElement(\"img\");\n\timg.onload = function() {\n\t\tcontext.drawImage(img, 0, 0, canvas.width, canvas.height);\n\t\tconsole.log(deferred_name, options.img_type);\n\t\tdeferred.resolve(\n\t\t\t{'name': deferred_name,\n\t\t\t'resolution': options.resolution,\n\t\t\t'img':canvas.toDataURL(options.img_type, 1),\n\t\t\t'w':canvas.width,\n\t\t\t'h':canvas.height});\n\t\tcontext.clearRect(0, 0, canvas.width, canvas.height);\n\t};\n\timg.src = imgsrc;\n\treturn deferred.promise();\n}\n\n/** TODO ::: test the following\nexport function svg2imgA(svgJQ, deferred_name, options) {\n\tlet defaults = {iscanvg: false, resolution: 1, img_type: \"image/png\"};\n\tif(!options) options = defaults;\n\t$.each(defaults, function(key, value) {\n\t\tif(!(key in options)) {options[key] = value;}\n\t});\n\n\tlet svg = svgJQ.get(0);\n\tlet deferred = $.Deferred();\n  \tvar copy = svg.cloneNode(true);\n\tcopyStylesInline(copy, svg);\n\tvar canvas = document.createElement(\"canvas\");\n\tcanvas.width = svgJQ.width()*options.resolution;\n\tcanvas.height = svgJQ.height()*options.resolution;\n\tvar context = canvas.getContext(\"2d\");\n\tvar data = (new XMLSerializer()).serializeToString(copy);\n\tvar DOMURL = window.URL || window.webkitURL || window;\n\tvar img = new Image();\n\tvar svgBlob = new Blob([data], {type: \"image/svg+xml;charset=utf-8\"});\n\tvar url = DOMURL.createObjectURL(svgBlob);\n\timg.onload = function () {\n\t\tcontext.drawImage(img, 0, 0, canvas.width, canvas.height);\n\t\tconsole.log(deferred_name, options.img_type);\n\t\tdeferred.resolve(\n\t\t\t{'name': deferred_name,\n\t\t\t'resolution': options.resolution,\n\t\t\t'img':canvas.toDataURL(options.img_type, 1),\n\t\t\t'w':canvas.width,\n\t\t\t'h':canvas.height})\n\t};\n\timg.src = url;\n\treturn deferred.promise();\n}\n */\n\nfunction getMatches(str, myRegexp) {\n\tlet matches = [];\n\tlet c = 0;\n\tmyRegexp.lastIndex = 0;\n\tlet match = myRegexp.exec(str);\n\twhile (match) {\n\t\tc++;\n\t\tif(c > 400) {\n\t\t\tconsole.error(\"getMatches: counter exceeded 800\");\n\t\t\treturn -1;\n\t\t}\n\t\tmatches.push(match);\n\t\tif (myRegexp.lastIndex === match.index) {\n\t\t\tmyRegexp.lastIndex++;\n\t\t}\n\t\tmatch = myRegexp.exec(str);\n\t}\n\treturn matches;\n}\n\n// find all url's to make unique\nfunction unique_urls(svg_html) {\n\tlet matches = getMatches(svg_html, /url\\((&quot;|\"|'){0,1}#(.*?)(&quot;|\"|'){0,1}\\)/g);\n\tif(matches === -1)\n\t\treturn \"ERROR DISPLAYING PEDIGREE\"\n\n\t$.each(matches, function(_index, match) {\n\t\tlet quote = (match[1] ? match[1] : \"\");\n\t\tlet val = match[2];\n\t\tlet m1 = \"id=\\\"\" + val + \"\\\"\";\n\t\tlet m2 = \"url\\\\(\" + quote + \"#\" + val + quote + \"\\\\)\";\n\n\t\tlet newval = val+utils.makeid(2);\n\t\tsvg_html = svg_html.replace(new RegExp(m1, 'g'), \"id=\\\"\"+newval+\"\\\"\" );\n\t\tsvg_html = svg_html.replace(new RegExp(m2, 'g'), \"url(#\"+newval+\")\" );\n   });\n\treturn svg_html;\n}\n\n// return a copy pedigree svg\nexport function copy_svg(opts) {\n\tlet svg_node = get_printable_svg(opts);\n\tlet d3obj = d3.select(svg_node.get(0));\n\n\t// remove unused elements\n\td3obj.selectAll(\".popup_selection, .indi_rect, .addsibling, .addpartner, .addchild, .addparents, .delete, .line_drag_selection\").remove();\n\td3obj.selectAll(\"text\")\n\t  .filter(function(){\n\t\t return d3.select(this).text().length === 0\n\t  }).remove();\n\treturn $(unique_urls(svg_node.html()));\n}\n\n// get printable svg div, adjust size to tree dimensions and scale to fit\nfunction get_printable_svg(opts) {\n\tlet local_dataset = pedcache.current(opts); // get current dataset\n\tif (local_dataset !== undefined && local_dataset !== null) {\n\t\topts.dataset = local_dataset;\n\t}\n\n\tlet svg_div = $('<div></div>');  \t\t\t\t// create a new div\n\tlet svg = $('#'+opts.targetDiv).find('svg').clone().appendTo(svg_div);\n\n\tlet a4 = {w: (595-40), h: (842-50)};\n\t\n\tlet b = get_bounds(opts);\n\tlet d = {w: Math.abs(b.xmax-b.xmin), h: Math.abs(b.ymax-b.ymin)};\n\tlet f = 1;\n\tlet k = (f / Math.max(d.w/a4.w, d.h/a4.h));\n\n\tlet xi = -(b.xmin-(opts.symbol_size))*k;\n\tlet yi = -(b.ymin-(opts.symbol_size))*k;\n\n\tsvg.attr('width', a4.w);\n\tsvg.attr('height', d.h*k);\t\n\n\tsvg.find(\".diagram\").attr(\"transform\", \"translate(\"+xi+\", \"+yi+\") scale(\"+k+\")\");\n\treturn svg_div;\n}\n\n// download the SVG to a file\nexport function svg_download(svg){\n\tlet a\t  = document.createElement('a');\n\ta.href\t = 'data:image/svg+xml;base64,'+ btoa( unescape( encodeURIComponent( svg.html() ) ) );\n\ta.download = 'plot.svg';\n\ta.target   = '_blank';\n\tdocument.body.appendChild(a); a.click(); document.body.removeChild(a);\n}\n\n// open print window for a given element\nexport function print(el, id){\n\tif(el.constructor !== Array)\n\t\tel = [el];\n\n\tlet width = $(window).width()*0.9;\n\tlet height = $(window).height()-10;\n\tlet cssFiles = [\n\t\t'/static/css/canrisk.css',\n\t\t'https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css'\n\t];\n\tlet printWindow = window.open('', 'PrintMap', 'width=' + width + ',height=' + height);\n\tlet headContent = '';\n\tfor(let i=0; i<cssFiles.length; i++)\n\t\theadContent += '<link href=\"'+cssFiles[i]+'\" rel=\"stylesheet\" type=\"text/css\" media=\"all\">';\n\theadContent += \"<style>body {font-size: \" + $(\"body\").css('font-size') + \";}</style>\";\n\n\tlet html = \"\";\n\tfor(let i=0; i<el.length; i++) {\n\t\tif(i === 0 && id)\n\t\t\thtml += id;\n\t\thtml += $(el[i]).html();\n\t\tif(i < el.length-1)\n\t\t\thtml += '<div class=\"page-break\"> </div>';\n\t}\n\n\tprintWindow.document.write(headContent);\n\tprintWindow.document.write(html);\n\tprintWindow.document.close();\n\n\tprintWindow.focus();\n\tsetTimeout(function() {\n\t\tprintWindow.print();\n\t\tprintWindow.close();\n\t}, 300);\n}\n\n// save content to a file\nexport function save_file(opts, content, filename, type){\n\tif(opts.DEBUG)\n\t\tconsole.log(content);\n\tif(!filename) filename = \"ped.txt\";\n\tif(!type) type = \"text/plain\";\n\n   let file = new Blob([content], {type: type});\n   if (window.navigator.msSaveOrOpenBlob) \t// IE10+\n\t   window.navigator.msSaveOrOpenBlob(file, filename);\n   else { \t\t\t\t\t\t\t\t\t// other browsers\n\t   let a = document.createElement(\"a\");\n\t   let url = URL.createObjectURL(file);\n\t   a.href = url;\n\t   a.download = filename;\n\t   document.body.appendChild(a);\n\t   a.click();\n\t   setTimeout(function() {\n\t\t   document.body.removeChild(a);\n\t\t   window.URL.revokeObjectURL(url);\n\t\t}, 0);\n\t}\n}\n\nfunction save(opts){\n\tlet content = JSON.stringify(pedcache.current(opts));\n\tsave_file(opts, content);\n}\n\nfunction canrisk_validation(opts) {\n\t$.each(opts.dataset, function(_idx, p) {\n\t\tif(!p.hidden && p.sex === 'M' && !utils.isProband(p)) {\n\t\t\tif(p[cancers['breast_cancer2']]) {\n\t\t\t\tlet msg = 'Male family member ('+p.display_name+') with contralateral breast cancer found. '+\n\t\t\t\t\t\t  'Please note that as the risk models do not take this into account the second '+\n\t\t\t\t\t\t  'breast cancer is ignored.'\n\t\t\t\tconsole.error(msg);\n\t\t\t\tdelete p[cancers['breast_cancer2']];\n\t\t\t\tutils.messages(\"Warning\", msg);\n\t\t\t}\n\t\t}\n\t});\n}\n\n/** Read and load pedigree data string */\nexport function load_data(d, opts) {\n\tif(opts.DEBUG) console.log(d);\n\tlet risk_factors;\n\ttry {\n\t\tif(d.indexOf(\"BOADICEA import pedigree file format 4.0\") === 0) {\n\t\t\topts.dataset = readBoadiceaV4(d, 4);\n\t\t\tcanrisk_validation(opts);\n\t\t} else if(d.indexOf(\"BOADICEA import pedigree file format 2.0\") === 0) {\n\t\t\topts.dataset = readBoadiceaV4(d, 2);\n\t\t\tcanrisk_validation(opts);\n\t\t} else if(d.indexOf(\"##\") === 0 && d.indexOf(\"CanRisk\") !== -1) {\n\t\t\tlet canrisk_data = readCanRiskFile(d);\n\t\t\trisk_factors = canrisk_data[0];\n\t\t\topts.dataset = canrisk_data[1];\n\t\t\tcanrisk_validation(opts);\n\t\t} else {\n\t\t\ttry {\n\t\t\t\tlet ped = JSON.parse(d);\n\t\t\t\tlet to_process = true;\n\t\t\t\tfor(let i=0;i<ped.length;i++) {\n\t\t\t\t\tif(ped[i].top_level) {\n\t\t\t\t\t\tto_process = false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\topts.dataset = (to_process ? process_ped(ped) : ped);\n\t\t\t} catch(err) {\n\t\t\t\topts.dataset = readLinkage(d);\n\t\t\t}\n\t\t}\n\t\tutils.validate_pedigree(opts);\n\t} catch(err1) {\n\t\tconsole.error(err1, d);\n\t\tutils.messages(\"File Error\", ( err1.message ? err1.message : err1));\n\t\treturn;\n\t}\n\tif(opts.DEBUG) console.log(opts.dataset);\n\ttry{\n\t\tpedcache.setposition(opts);\t\t// clear position\n\t\t$(document).trigger('rebuild', [opts]);\n\t\tconsole.log(risk_factors);\n\t\t// load risk factors - fire riskfactorChange event\n\t\t$(document).trigger('riskfactorChange', [opts, risk_factors]);\n\t\t$(document).trigger('fhChange', [opts]); \t// trigger fhChange event\n\t\n\t\ttry {\n\t\t\t// update FH section\n\t\t\tacc_FamHist_ticked();\t\t\t\t// eslint-disable-line no-undef\n\t\t\tacc_FamHist_Leave();\t\t\t\t// eslint-disable-line no-undef\n\t\t\tRESULT.FLAG_FAMILY_MODAL = true;\t// eslint-disable-line no-undef\n\t\t} catch(err3) {\n\t\t\t// ignore error\n\t\t}\n\t} catch(err2) {\n\t\tutils.messages(\"File Error\", ( err2.message ? err2.message : err2));\n\t}\n}\n\nfunction load(e, opts) {\n\tlet f = e.target.files[0];\n\tif(f) {\n\t\tlet reader = new FileReader();\n\t\treader.onload = function(e) {\n\t\t\tload_data(e.target.result, opts)\n\t\t};\n\t\treader.onerror = function(event) {\n\t\t\tutils.messages(\"File Error\", \"File could not be read! Code \" + event.target.error.code);\n\t\t};\n\t\treader.readAsText(f);\n\t} else {\n\t\tconsole.error(\"File could not be read!\");\n\t}\n\t$(\"#load\")[0].value = ''; // reset value\n}\n\n//\n// https://www.cog-genomics.org/plink/1.9/formats#ped\n// https://www.cog-genomics.org/plink/1.9/formats#fam\n//\t1. Family ID ('FID')\n//\t2. Within-family ID ('IID'; cannot be '0')\n//\t3. Within-family ID of father ('0' if father isn't in dataset)\n//\t4. Within-family ID of mother ('0' if mother isn't in dataset)\n//\t5. Sex code ('1' = male, '2' = female, '0' = unknown)\n//\t6. Phenotype value ('1' = control, '2' = case, '-9'/'0'/non-numeric = missing data if case/control)\n//  7. Genotypes (column 7 onwards);\n//\t columns 7 & 8 are allele calls for first variant ('0' = no call); colummns 9 & 10 are calls for second variant etc.\nexport function readLinkage(boadicea_lines) {\n\tlet lines = boadicea_lines.trim().split('\\n');\n\tlet ped = [];\n\tlet famid;\n\tfor(let i = 0;i < lines.length;i++){\n\t   let attr = $.map(lines[i].trim().split(/\\s+/), function(val, _i){return val.trim();});\n\t   if(attr.length < 5)\n\t\t   throw new Error('unknown format');\n\t   let sex = (attr[4] === '1' ? 'M' : (attr[4] === '2' ? 'F' : 'U'));\n\t   let indi = {\n\t\t\t'famid': attr[0],\n\t\t\t'display_name': attr[1],\n\t\t\t'name':\tattr[1],\n\t\t\t'sex': sex\n\t\t};\n\t\tif(attr[2] !== \"0\") indi.father = attr[2];\n\t\tif(attr[3] !== \"0\") indi.mother = attr[3];\n\n\t\tif (typeof famid != 'undefined' && famid !== indi.famid) {\n\t\t\tconsole.error('multiple family IDs found only using famid = '+famid);\n\t\t\tbreak;\n\t\t}\n\t\tif(attr[5] === \"2\") indi.affected = 2;\n\t\t// add genotype columns\n\t\tif(attr.length > 6) {\n\t\t\tindi.alleles = \"\";\n\t\t\tfor(let j=6; j<attr.length; j+=2) {\n\t\t\t\tindi.alleles += attr[j] + \"/\" + attr[j+1] + \";\";\n\t\t\t}\n\t\t}\n\n\t\tped.unshift(indi);\n\t\tfamid = attr[0];\n\t}\n\treturn process_ped(ped);\n}\n\nexport function readCanRiskFile(boadicea_lines) {\n\tlet [hdr, ped] = readCanRisk(boadicea_lines);\n\ttry {\n\t\treturn [hdr, process_ped(ped)];\n\t} catch(e) {\n\t\tconsole.error(e);\n\t\treturn [hdr, ped];\n\t}\n}\n\n// read boadicea format v4 & v2\nexport function readBoadiceaV4(boadicea_lines, version) {\n\tlet lines = boadicea_lines.trim().split('\\n');\n\tlet ped = [];\n\t// assumes two line header\n\tfor(let i = 2;i < lines.length;i++){\n\t   let attr = $.map(lines[i].trim().split(/\\s+/), function(val, _i){return val.trim();});\n\t\tif(attr.length > 1) {\n\t\t\tlet indi = {\n\t\t\t\t'famid': attr[0],\n\t\t\t\t'display_name': attr[1],\n\t\t\t\t'name':\tattr[3],\n\t\t\t\t'sex': attr[6],\n\t\t\t\t'status': attr[8]\n\t\t\t};\n\t\t\tif(attr[2] === \"1\") indi.proband = true;\n\t\t\tif(attr[4] !== \"0\") indi.father = attr[4];\n\t\t\tif(attr[5] !== \"0\") indi.mother = attr[5];\n\t\t\tif(attr[7] !== \"0\") indi.mztwin = attr[7];\n\t\t\tif(attr[9] !== \"0\") indi.age = attr[9];\n\t\t\tif(attr[10] !== \"0\") indi.yob = attr[10];\n\n\t\t\tlet idx = 11;\n\t\t\t$.each(cancers, function(_cancer, diagnosis_age) {\n\t\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\n\t\t\t\tif(attr[idx] !== \"0\") {\n\t\t\t\t\tindi[diagnosis_age] = attr[idx];\n\t\t\t\t}\n\t\t\t\tidx++;\n\t\t\t});\n\n\t\t\tif(version === 4) {\n\t\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\n\t\t\t\t// BRCA1, BRCA2, PALB2, ATM, CHEK2 genetic tests\n\t\t\t\t// type, 0 = untested, S = mutation search, T = direct gene test\n\t\t\t\t// result, 0 = untested, P = positive, N = negative\n\t\t\t\tfor(let j=0; j<5; j++) {\n\t\t\t\t\tidx+=2;\n\t\t\t\t\tif(attr[idx-2] !== '0') {\n\t\t\t\t\t\tif((attr[idx-2] === 'S' || attr[idx-2] === 'T') && (attr[idx-1] === 'P' || attr[idx-1] === 'N'))\n\t\t\t\t\t\t\tindi[genetic_test1[j] + '_gene_test'] = {'type': attr[idx-2], 'result': attr[idx-1]};\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + attr[idx-2] + \" \" + attr[idx-1]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else if (version === 2) {\n\t\t\t\t// genetic test BRCA1, BRCA2\n\t\t\t\t// type, 0 = untested, S = mutation search, T = direct gene test\n\t\t\t\t// result, 0 = untested, N = no mutation, 1 = BRCA1 positive, 2 = BRCA2 positive, 3 = BRCA1/2 positive\n\t\t\t\tidx+=2; \t// gtest\n\t\t\t\tif(attr[idx-2] !== '0') {\n\t\t\t\t\tif((attr[idx-2] === 'S' || attr[idx-2] === 'T')) {\n\t\t\t\t\t\tif(attr[idx-1] === 'N') {\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\n\t\t\t\t\t\t} else if(attr[idx-1] === '1') {\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\n\t\t\t\t\t\t} else if(attr[idx-1] === '2') {\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\n\t\t\t\t\t\t} else if(attr[idx-1] === '3') {\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + attr[idx-2] + \" \" + attr[idx-1]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\n\t\t\t}\n\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\n\t\t\tfor(let j=0; j<pathology_tests.length; j++) {\n\t\t\t\tif(attr[idx] !== '0') {\n\t\t\t\t\tif(attr[idx] === 'N' || attr[idx] === 'P')\n\t\t\t\t\t\tindi[pathology_tests[j] + '_bc_pathology'] = attr[idx];\n\t\t\t\t\telse\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED PATHOLOGY ON LINE '+ (i+1) + \": \" +pathology_tests[j] + \" \" +attr[idx]);\n\t\t\t\t}\n\t\t\t\tidx++;\n\t\t\t}\n\t\t\tped.unshift(indi);\n\t\t}\n\t}\n\n\ttry {\n\t\treturn process_ped(ped);\n\t} catch(e) {\n\t\tconsole.error(e);\n\t\treturn ped;\n\t}\n}\n\nfunction process_ped(ped) {\n\t// find the level of individuals in the pedigree\n\tfor(let j=0;j<2;j++) {\n\t\tfor(let i=0;i<ped.length;i++) {\n\t\t\tgetLevel(ped, ped[i].name);\n\t\t}\n\t}\n\n\tfix_n_balance_levels(ped);\n\n\t// find the max level (i.e. top_level)\n\tlet max_level = 0;\n\tfor(let i=0;i<ped.length;i++) {\n\t\tif(ped[i].level && ped[i].level > max_level)\n\t\t\tmax_level = ped[i].level;\n\t}\n\n\t// identify top_level and other nodes without parents\n\tfor(let i=0;i<ped.length;i++) {\n\t\tif(utils.getDepth(ped, ped[i].name) === 1) {\n\t\t\tif(ped[i].level && ped[i].level === max_level) {\n\t\t\t\tped[i].top_level = true;\n\t\t\t} else {\n\t\t\t\tped[i].noparents = true;\n\n\t\t\t\t// 1. look for partners parents\n\t\t\t\tlet pidx = getPartnerIdx(ped, ped[i]);\n\t\t\t\tif(pidx > -1) {\n\t\t\t\t\tif(ped[pidx].mother) {\n\t\t\t\t\t\tped[i].mother = ped[pidx].mother;\n\t\t\t\t\t\tped[i].father = ped[pidx].father;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// 2. or adopt parents from level above\n\t\t\t\tif(!ped[i].mother){\n\t\t\t\t\tfor(let j=0; j<ped.length; j++) {\n\t\t\t\t\t\tif(ped[i].level === (ped[j].level-1)) {\n\t\t\t\t\t\t\tpidx = getPartnerIdx(ped, ped[j]);\n\t\t\t\t\t\t\tif(pidx > -1 && i !== pidx) {\n\t\t\t\t\t\t\t\tped[i].mother = (ped[j].sex === 'F' ? ped[j].name : ped[pidx].name);\n\t\t\t\t\t\t\t\tped[i].father = (ped[j].sex === 'M' ? ped[j].name : ped[pidx].name);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tdelete ped[i].top_level;\n\t\t}\n\t}\n\treturn ped;\n}\n\n// get the partners for a given node\nfunction getPartnerIdx(dataset, anode) {\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tlet bnode = dataset[i];\n\t\tif(anode.name === bnode.mother)\n\t\t\treturn utils.getIdxByName(dataset, bnode.father);\n\t\telse if(anode.name === bnode.father)\n\t\t\treturn utils.getIdxByName(dataset, bnode.mother);\n\t}\n\treturn -1;\n}\n\n// for a given individual assign levels to a parents ancestors\nfunction getLevel(dataset, name) {\n\tlet idx = utils.getIdxByName(dataset, name);\n\tlet level = (dataset[idx].level ? dataset[idx].level : 0);\n\tupdate_parents_level(idx, level, dataset);\n}\n\n// recursively update parents levels\nfunction update_parents_level(idx, level, dataset) {\n\tlet parents = ['mother', 'father'];\n\tlevel++;\n\tfor(let i=0; i<parents.length; i++) {\n\t\tlet pidx = utils.getIdxByName(dataset, dataset[idx][parents[i]]);\n\t\tif(pidx >= 0) {\n\t\t\tlet ma = dataset[utils.getIdxByName(dataset, dataset[idx].mother)];\n\t\t\tlet pa = dataset[utils.getIdxByName(dataset, dataset[idx].father)];\n\t\t\tif(!dataset[pidx].level || dataset[pidx].level < level) {\n\t\t\t\tma.level = level;\n\t\t\t\tpa.level = level;\n\t\t\t}\n\n\t\t\tif(ma.level < pa.level) {\n\t\t\t\tma.level = pa.level;\n\t\t\t} else if(pa.level < ma.level) {\n\t\t\t\tpa.level = ma.level;\n\t\t\t}\n\t\t\tupdate_parents_level(pidx, level, dataset);\n\t\t}\n\t}\n}\n\n// for a pedigree fix the levels of children nodes to be consistent with parent\nfunction fix_n_balance_levels(ped) {\n\tlet updated = false;\n\tlet l = ped.length;\n\n\tfor(let i=0;i<l;i++) {\n\t\tlet children = utils.getChildren(ped, ped[i]);\n\t\tlet prt_lvl = ped[i].level;\n\t\tfor(let j=0;j<children.length;j++){\n\t\t\tif(prt_lvl - children[j].level > 1) {\n\t\t\t\tchildren[j].level = prt_lvl-1;\n\t\t\t\tlet ptrs = utils.get_partners(ped, children[j]);\n\n\t\t\t\tfor(let k=0;k<ptrs.length;k++){\n\t\t\t\t\tlet p = utils.getNodeByName(ped, ptrs[k])\n\t\t\t\t\tp.level = prt_lvl-1;\n\n\t\t\t\t\tlet m = utils.getNodeByName(ped, p.mother);\n\t\t\t\t\tlet f = utils.getNodeByName(ped, p.father);\n\t\t\t\t\tif(m) m.level = prt_lvl;\n\t\t\t\t\tif(f) f.level = prt_lvl;\n\t\t\t\t}\n\t\t\t\tupdated = true;\n\t\t\t}\n\t\t}\n\t}\n\treturn updated;\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n\n// set two siblings as twins\nexport function setMzTwin(dataset, d1, d2, twin_type) {\n\tif(!d1[twin_type]) {\n\t\td1[twin_type] = getUniqueTwinID(dataset, twin_type);\n\t\tif(!d1[twin_type])\n\t\t\treturn false;\n\t}\n\td2[twin_type] = d1[twin_type];\n\tif(d1.yob)\n\t\td2.yob = d1.yob;\n\tif(d1.age && (d1.status === \"0\" || !d1.status))\n\t\td2.age = d1.age;\n\treturn true;\n}\n\n// get a new unique twins ID, max of 10 twins in a pedigree\nexport function getUniqueTwinID(dataset, twin_type) {\n\tlet mz = [1, 2, 3, 4, 5, 6, 7, 8, 9, \"A\"];\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tif(dataset[i][twin_type]) {\n\t\t\tlet idx = mz.indexOf(dataset[i][twin_type]);\n\t\t\tif (idx > -1)\n\t\t\t\tmz.splice(idx, 1);\n\t\t}\n\t}\n\tif(mz.length > 0)\n\t\treturn mz[0];\n\treturn undefined;\n}\n\n// sync attributes of twins\nexport function syncTwins(dataset, d1) {\n\tif(!d1.mztwin && !d1.dztwin)\n\t\treturn;\n\tlet twin_type = (d1.mztwin ? \"mztwin\" : \"dztwin\");\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tlet d2 = dataset[i];\n\t\tif(d2[twin_type] && d1[twin_type] === d2[twin_type] && d2.name !== d1.name) {\n\t\t\tif(twin_type === \"mztwin\")\n\t\t\t  d2.sex = d1.sex;\n\t\t\tif(d1.yob)\n\t\t\t\td2.yob = d1.yob;\n\t\t\tif(d1.age && (d1.status === 0 || !d1.status))\n\t\t\t\td2.age = d1.age;\n\t\t}\n\t}\n}\n\n// check integrity twin settings\nexport function checkTwins(dataset) {\n\tlet twin_types = [\"mztwin\", \"dztwin\"];\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tfor(let j=0; j<twin_types.length; j++) {\n\t\t\tlet twin_type = twin_types[j];\n\t\t\tif(dataset[i][twin_type]) {\n\t\t\t\tlet count = 0;\n\t\t\t\tfor(let j=0; j<dataset.length; j++) {\n\t\t\t\t\tif(dataset[j][twin_type] === dataset[i][twin_type])\n\t\t\t\t\t\tcount++;\n\t\t\t\t}\n\t\t\t\tif(count < 2)\n\t\t\t\t\tdelete dataset[i][[twin_type]];\n\t\t\t}\n\t\t}\n\t}\n}","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// pedigree form\nimport {syncTwins} from './twins.js';\nimport {copy_dataset, getNodeByName} from './utils.js';\nimport {current as pedcache_current} from './pedcache.js';\n\n\n// handle family history change events (undo/redo/delete)\n$(document).on('fhChange', function(e, opts){\n\ttry {\n\t\tlet id = $('#id_name').val();  // get name from hidden field\n\t\tlet node = getNodeByName(pedcache_current(opts), id)\n\t\tif(node === undefined)\n\t\t\t$('form > fieldset').prop(\"disabled\", true);\n\t\telse\n\t\t\t$('form > fieldset').prop('disabled', false);\n\t} catch(err) {\n\t\tconsole.warn(err);\n\t}\n})\n\n// update status field and age label - 0 = alive, 1 = dead\nexport function updateStatus(status) {\n\t$('#age_yob_lock').removeClass('fa-lock fa-unlock-alt');\n\t(status === \"1\" ? $('#age_yob_lock').addClass('fa-unlock-alt') : $('#age_yob_lock').addClass('fa-lock'));\n\t$('#id_age_'+status).removeClass(\"hidden\");\n\t$('#id_age_'+(status === \"1\" ? '0' : '1')).addClass(\"hidden\");\n}\n\nexport function nodeclick(node) {\n\t$('form > fieldset').prop('disabled', false);\n\t// clear values\n\t$('#person_details').find(\"input[type=text], input[type=number]\").val(\"\");\n\t$('#person_details select').val('').prop('selected', true);\n\n\t// assign values to input fields in form\n\tif(node.sex === 'M' || node.sex === 'F')\n\t\t$('input[name=sex][value=\"'+node.sex+'\"]').prop('checked', true);\n\telse\n\t\t$('input[name=sex]').prop('checked', false);\n\tupdate_cancer_by_sex(node);\n\n\tif(!('status' in node))\n\t\tnode.status = 0;\n\t$('input[name=status][value=\"'+node.status+'\"]').prop('checked', true);\n\t// show lock symbol for age and yob synchronisation\n\tupdateStatus(node.status);\n\n\tif('proband' in node) {\n\t\t$('#id_proband').prop('checked', node.proband);\n\t\t$('#id_proband').prop(\"disabled\", true);\n\t} else {\n\t\t$('#id_proband').prop('checked', false);\n\t\t$('#id_proband').prop(\"disabled\", !('yob' in node))\n\t}\n\n\tif('exclude' in node) {\n\t\t$('#id_exclude').prop('checked', node.exclude);\n\t} else {\n\t\t$('#id_exclude').prop('checked', false);\n\t}\n\n/*\t\tif('ashkenazi' in node) {\n\t\t\t$('#id_ashkenazi').prop('checked', (node.proband == 1 ? true: false));\n\t\t} else {\n\t\t\t$('#id_ashkenazi').prop('checked', false);\n\t\t}*/\n\n\t// year of birth\n\tif('yob' in node) {\n\t\t$('#id_yob_0').val(node.yob);\n\t} else {\n\t\t$('#id_yob_0').val('-');\n\t}\n\n\t// clear pathology\n\t$('select[name$=\"_bc_pathology\"]').val('-');\n\t// clear gene tests\n\t$('select[name*=\"_gene_test\"]').val('-');\n\n\t// disable sex radio buttons if the person has a partner\n\t$(\"input[id^='id_sex_']\").prop(\"disabled\", (node.parent_node && node.sex !== 'U' ? true : false));\n\n\t// disable pathology for male relatives (as not used by model)\n\t// and if no breast cancer age of diagnosis\n\t$(\"select[id$='_bc_pathology']\").prop(\"disabled\",\n\t\t\t(node.sex === 'M' || (node.sex === 'F' && !('breast_cancer_diagnosis_age' in node)) ? true : false));\n\n\t// approximate diagnosis age\n\t$('#id_approx').prop('checked', (node.approx_diagnosis_age ? true: false));\n\tupdate_diagnosis_age_widget();\n\n\tfor(let key in node) {\n\t\tif(key !== 'proband' && key !== 'sex') {\n\t\t\tif($('#id_'+key).length) {\t// input value\n\t\t\t\tif(key.indexOf('_gene_test')  !== -1 && node[key] !== null && typeof node[key] === 'object') {\n\t\t\t\t\t$('#id_'+key).val(node[key].type);\n\t\t\t\t\t$('#id_'+key+'_result').val(node[key].result);\n\t\t\t\t} else {\n\t\t\t\t\t$('#id_'+key).val(node[key]);\n\t\t\t\t}\n\t\t\t} else if(key.indexOf('_diagnosis_age') !== -1) {\n\t\t\t\tif($(\"#id_approx\").is(':checked')) {\n\t\t\t\t\t$('#id_'+key+'_1').val(round5(node[key])).prop('selected', true);\n\t\t\t\t} else {\n\t\t\t\t\t$('#id_'+key+'_0').val(node[key]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\ttry {\n\t\t$('#person_details').find('form').valid();\n\t} catch(err) {\n\t\tconsole.warn('valid() not found');\n\t}\n}\n\nfunction update_ashkn(newdataset) {\n\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\n\tif($('#orig_ashk').is(':checked')) {\n\t\t$.each(newdataset, function(_i, p) {\n\t\t\tif(p.proband)\n\t\t\t\tp.ashkenazi = 1;\n\t\t});\n\t} else {\n\t\t$.each(newdataset, function(_i, p) {\n\t\t\tdelete p.ashkenazi;\n\t\t});\n\t}\n}\n\n// Save Ashkenazi status\nexport function save_ashkn(opts) {\n\tlet dataset = pedcache_current(opts);\n\tlet newdataset = copy_dataset(dataset);\n\tupdate_ashkn(newdataset);\n\topts.dataset = newdataset;\n\t$(document).trigger('rebuild', [opts]);\n}\n\nexport function save(opts) {\n\tlet dataset = pedcache_current(opts);\n\tlet name = $('#id_name').val();\n\tlet newdataset = copy_dataset(dataset);\n\tlet person = getNodeByName(newdataset, name);\n\tif(!person) {\n\t\tconsole.warn('person not found when saving details');\n\t\treturn;\n\t}\n\t$(\"#\"+opts.targetDiv).empty();\n\n\t// individual's personal and clinical details\n\tlet yob = $('#id_yob_0').val();\n\tif(yob && yob !== '') {\n\t\tperson.yob = yob;\n\t} else {\n\t\tdelete person.yob;\n\t}\n\n\t// current status: 0 = alive, 1 = dead\n\tlet status = $('#id_status').find(\"input[type='radio']:checked\");\n\tif(status.length > 0){\n\t\tperson.status = status.val();\n\t}\n\n\t// booleans switches\n\tlet switches = [\"miscarriage\", \"adopted_in\", \"adopted_out\", \"termination\", \"stillbirth\"];\n\tfor(let iswitch=0; iswitch<switches.length; iswitch++){\n\t\tlet attr = switches[iswitch];\n\t\tlet s = $('#id_'+attr);\n\t\tif(s.length > 0){\n\t\t\tconsole.log(s.is(\":checked\"));\n\t\t\tif(s.is(\":checked\"))\n\t\t\t\tperson[attr] = true;\n\t\t\telse\n\t\t\t\tdelete person[attr];\n\t\t}\n\t}\n\n\t// current sex\n\tlet sex = $('#id_sex').find(\"input[type='radio']:checked\");\n\tif(sex.length > 0){\n\t\tperson.sex = sex.val();\n\t\tupdate_cancer_by_sex(person);\n\t}\n\n\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\n\tupdate_ashkn(newdataset);\n\n\tif($('#id_approx').is(':checked')) // approximate diagnosis age\n\t\tperson.approx_diagnosis_age = true;\n\telse\n\t\tdelete person.approx_diagnosis_age;\n\n\t$(\"#person_details select[name*='_diagnosis_age']:visible, #person_details input[type=text]:visible, #person_details input[type=number]:visible\").each(function() {\n\t\tlet name = (this.name.indexOf(\"_diagnosis_age\")>-1 ? this.name.substring(0, this.name.length-2): this.name);\n\n\t\tif($(this).val()) {\n\t\t\tlet val = $(this).val();\n\t\t\tif(name.indexOf(\"_diagnosis_age\") > -1 && $(\"#id_approx\").is(':checked'))\n\t\t\t\tval = round5(val);\n\t\t\tperson[name] = val;\n\t\t} else {\n\t\t\tdelete person[name];\n\t\t}\n\t});\n\n\t// cancer checkboxes\n\t$('#person_details input[type=\"checkbox\"][name$=\"cancer\"],input[type=\"checkbox\"][name$=\"cancer2\"]').each(function() {\n\t\tif(this.checked)\n\t\t\tperson[$(this).attr('name')] = true;\n\t\telse\n\t\t\tdelete person[$(this).attr('name')];\n\t});\n\n\t// pathology tests\n\t$('#person_details select[name$=\"_bc_pathology\"]').each(function() {\n\t\tif($(this).val() !== '-') {\n\t\t\tperson[$(this).attr('name')] = $(this).val();\n\t\t} else {\n\t\t\tdelete person[$(this).attr('name')];\n\t\t}\n\t});\n\n\t// genetic tests\n\t$('#person_details select[name$=\"_gene_test\"]').each(function() {\n\t\tif($(this).val() !== '-') {\n\t\t\tlet tres = $('select[name=\"'+$(this).attr('name')+'_result\"]');\n\t\t\tperson[$(this).attr('name')] = {'type': $(this).val(), 'result': $(tres).val()};\n\t\t} else {\n\t\t\tdelete person[$(this).attr('name')];\n\t\t}\n\t});\n\n\t// record HOXB13 genetic test\n\tlet hoxb13_result = $('#person_details select[name=\"hoxb13_gene_test_result\"]').val();\n\tif(hoxb13_result !== undefined && hoxb13_result !== '-') {\n\t\tperson[\"hoxb13_gene_test\"] = {'type': 'T', 'result': hoxb13_result};\t// assume direct test\n\t} else {\n\t\tdelete person[\"hoxb13_gene_test\"];\n\t}\n\n\ttry {\n\t\t$('#person_details').find('form').valid();\n\t} catch(err) {\n\t\tconsole.warn('valid() not found');\n\t}\n\n\tsyncTwins(newdataset, person);\n\topts.dataset = newdataset;\n\t$(document).trigger('rebuild', [opts]);\n}\n\nexport function update_diagnosis_age_widget() {\n\tif($(\"#id_approx\").is(':checked')) {\n\t\t$(\"[id$='_diagnosis_age_0']\").each(function( _i ) {\n\t\t\tif($(this).val() !== '') {\n\t\t\t\tlet name = this.name.substring(0, this.name.length-2);\n\t\t\t\t$(\"#id_\"+name+\"_1\").val(round5($(this).val())).prop('selected', true);\n\t\t\t}\n\t\t});\n\n\t\t$(\"[id$='_diagnosis_age_0']\").hide();\n\t\t$(\"[id$='_diagnosis_age_1']\").show();\n\t} else {\n\t\t$(\"[id$='_diagnosis_age_1']\").each(function( _i ) {\n\t\t\tif($(this).val() !== '') {\n\t\t\t\tlet name = this.name.substring(0, this.name.length-2);\n\t\t\t\t$(\"#id_\"+name+\"_0\").val($(this).val());\n\t\t\t}\n\t\t});\n\n\t\t$(\"[id$='_diagnosis_age_0']\").show();\n\t\t$(\"[id$='_diagnosis_age_1']\").hide();\n\t}\n}\n\n// males should not have ovarian cancer and females should not have prostate cancer\nfunction update_cancer_by_sex(node) {\n\t$('#cancer .row').show();\n\tif(node.sex === 'M') {\n\t\tdelete node.ovarian_cancer_diagnosis_age;\n\t\t$(\"[id^='id_ovarian_cancer_diagnosis_age']\").closest('.row').hide();\n\t\t$(\"[id^='id_breast_cancer2_diagnosis_age']\").prop('disabled', true);\n\t} else if(node.sex === 'F') {\n\t\tdelete node.prostate_cancer_diagnosis_age;\n\t\t$(\"[id^='id_prostate_cancer_diagnosis_age']\").closest('.row').hide();\n\t\t$(\"[id^='id_breast_cancer2_diagnosis_age']\").prop('disabled', false);\n\t}\n}\n\n// round to 5, 15, 25, 35 ....\nfunction round5(x1) {\n\tlet x2 = (Math.round((x1-1) / 10) * 10);\n\treturn (x1 < x2 ? x2 - 5 : x2 + 5);\n}\n\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// pedigree widgets\nimport * as utils from './utils.js';\nimport {save} from './popup_form.js';\nimport {current as pedcache_current} from './pedcache.js';\nimport {getUniqueTwinID, setMzTwin, checkTwins} from './twins.js';\n\n\nlet dragging;\nlet last_mouseover;\n//\n// Add widgets to nodes and bind events\nexport function addWidgets(opts, node) {\n\n\t// popup gender selection box\n\tlet font_size = parseInt($(\"body\").css('font-size'));\n\tlet popup_selection = d3.select('.diagram');\n\tpopup_selection.append(\"rect\").attr(\"class\", \"popup_selection\")\n\t\t\t\t\t\t\t.attr(\"rx\", 6)\n\t\t\t\t\t\t\t.attr(\"ry\", 6)\n\t\t\t\t\t\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t\t\t\t\t\t.style(\"opacity\", 0)\n\t\t\t\t\t\t\t.attr(\"width\",  font_size*7.9)\n\t\t\t\t\t\t\t.attr(\"height\", font_size*2)\n\t\t\t\t\t\t\t.style(\"stroke\", \"darkgrey\")\n\t\t\t\t\t\t\t.attr(\"fill\", \"white\");\n\n\tlet square = popup_selection.append(\"text\")  // male\n\t\t.attr('font-family', 'FontAwesome')\n\t\t.style(\"opacity\", 0)\n\t\t.style(\"font-size\", \"1.1em\")\n\t\t.attr(\"class\", \"popup_selection fa-square persontype\")\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t.attr(\"x\", font_size/3)\n\t\t.attr(\"y\", font_size*1.5)\n\t\t.text(\"\\uf096 \");\n\tlet square_title = square.append(\"svg:title\").text(\"add male\");\n\n\tlet circle = popup_selection.append(\"text\")  // female\n\t\t.attr('font-family', 'FontAwesome')\n\t\t.style(\"opacity\", 0)\n\t\t.style(\"font-size\", \"1.1em\")\n\t\t.attr(\"class\", \"popup_selection fa-circle persontype\")\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t.attr(\"x\", font_size*1.71)\n\t\t.attr(\"y\", font_size*1.5)\n\t\t.text(\"\\uf10c \");\n\tlet circle_title = circle.append(\"svg:title\").text(\"add female\");\n\n\tlet unspecified = popup_selection.append(\"text\")  // unspecified\n\t\t.attr('font-family', 'FontAwesome')\n\t\t.style(\"opacity\", 0)\n\t\t.style(\"font-size\", \"1.1em\")\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t.attr(\"x\", font_size*0.065)\n\t\t.attr(\"y\", -font_size*0.065)\n\t\t.attr(\"class\", \"popup_selection fa-unspecified popup_selection_rotate45 persontype\")\n\t\t.text(\"\\uf096 \");\n\tunspecified.append(\"svg:title\").text(\"add unspecified\");\n\n\tlet dztwin = popup_selection.append(\"text\")  // dizygotic twins\n\t\t.attr('font-family', 'FontAwesome')\n\t\t.style(\"opacity\", 0)\n\t\t.style(\"font-size\", \"1.6em\")\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t\t.attr(\"class\", \"popup_selection fa-angle-up persontype dztwin\")\n\t\t.attr(\"x\", font_size*4.62)\n\t\t.attr(\"y\", font_size*1.5)\n\t\t.text(\"\\uf106 \");\n\tdztwin.append(\"svg:title\").text(\"add dizygotic/fraternal twins\");\n\n\tlet mztwin = popup_selection.append(\"text\")  // monozygotic twins\n\t.attr('font-family', 'FontAwesome')\n\t.style(\"opacity\", 0)\n\t.style(\"font-size\", \"1.6em\")\n\t.attr(\"transform\", \"translate(-1000,-100)\")\n\t.attr(\"class\", \"popup_selection fa-caret-up persontype mztwin\")\n\t.attr(\"x\", font_size*6.4)\n\t.attr(\"y\", font_size*1.5)\n\t.text(\"\\uf0d8 \");\n\tmztwin.append(\"svg:title\").text(\"add monozygotic/identical twins\");\n\n\tlet add_person = {};\n\t// click the person type selection\n\td3.selectAll(\".persontype\")\n\t  .on(\"click\", function () {\n\t\tlet newdataset = utils.copy_dataset(pedcache_current(opts));\n\t\tlet mztwin = d3.select(this).classed(\"mztwin\");\n\t\tlet dztwin = d3.select(this).classed(\"dztwin\");\n\t\tlet twin_type;\n\t\tlet sex;\n\t\tif(mztwin || dztwin) {\n\t\t\tsex = add_person.node.datum().data.sex;\n\t\t\ttwin_type = (mztwin ? \"mztwin\" : \"dztwin\");\n\t\t} else {\n\t\t\tsex = d3.select(this).classed(\"fa-square\") ? 'M' : (d3.select(this).classed(\"fa-circle\") ? 'F' : 'U');\n\t\t}\n\n\t\tif(add_person.type === 'addsibling')\n\t\t\taddsibling(newdataset, add_person.node.datum().data, sex, false, twin_type);\n\t\telse if(add_person.type === 'addchild')\n\t\t\taddchild(newdataset, add_person.node.datum().data, (twin_type ? 'U' : sex), (twin_type ? 2 : 1), twin_type);\n\t\telse\n\t\t\treturn;\n\t\topts.dataset = newdataset;\n\t\t$(document).trigger('rebuild', [opts]);\n\t\td3.selectAll('.popup_selection').style(\"opacity\", 0);\n\t\tadd_person = {};\n\t  })\n\t  .on(\"mouseover\", function() {\n\t\t  if(add_person.node)\n\t\t\t  add_person.node.select('rect').style(\"opacity\", 0.2);\n\t\t  d3.selectAll('.popup_selection').style(\"opacity\", 1);\n\t\t  // add tooltips to font awesome widgets\n\t\t  if(add_person.type === 'addsibling'){\n\t\t\t if(d3.select(this).classed(\"fa-square\"))\n\t\t\t\t  square_title.text(\"add brother\");\n\t\t\t  else\n\t\t\t\t  circle_title.text(\"add sister\");\n\t\t  } else if(add_person.type === 'addchild'){\n\t\t\t  if(d3.select(this).classed(\"fa-square\"))\n\t\t\t\t  square_title.text(\"add son\");\n\t\t\t  else\n\t\t\t\t  circle_title.text(\"add daughter\");\n\t\t  }\n\t  });\n\n\t// handle mouse out of popup selection\n\td3.selectAll(\".popup_selection\").on(\"mouseout\", function () {\n\t\t// hide rect and popup selection\n\t\tif(add_person.node !== undefined && highlight.indexOf(add_person.node.datum()) === -1)\n\t\t\tadd_person.node.select('rect').style(\"opacity\", 0);\n\t\td3.selectAll('.popup_selection').style(\"opacity\", 0);\n\t});\n\n\n\t// drag line between nodes to create partners\n\tdrag_handle(opts);\n\n\t// rectangle used to highlight on mouse over\n\tnode.filter(function (d) {\n\t\t    return d.data.hidden && !opts.DEBUG ? false : true;\n\t\t})\n\t\t.append(\"rect\")\n\t\t.attr(\"class\", 'indi_rect')\n\t\t.attr(\"rx\", 6)\n\t\t.attr(\"ry\", 6)\n\t\t.attr(\"x\", function(_d) { return - 0.75*opts.symbol_size; })\n\t\t.attr(\"y\", function(_d) { return - opts.symbol_size; })\n\t\t.attr(\"width\",  (1.5 * opts.symbol_size)+'px')\n\t\t.attr(\"height\", (2 * opts.symbol_size)+'px')\n\t\t.style(\"stroke\", \"black\")\n\t\t.style(\"stroke-width\", 0.7)\n\t\t.style(\"opacity\", 0)\n\t\t.attr(\"fill\", \"grey\");\n\n\t// widgets\n\tlet fx = function(_d) {return off - (0.75*opts.symbol_size);};\n\tlet fy = opts.symbol_size -2;\n\tlet off = 0;\n\tlet widgets = {\n\t\t'addchild':   {'text': '\\uf063', 'title': 'add child',   'fx': fx, 'fy': fy},\n\t\t'addsibling': {'text': '\\uf234', 'title': 'add sibling', 'fx': fx, 'fy': fy},\n\t\t'addpartner': {'text': '\\uf0c1', 'title': 'add partner', 'fx': fx, 'fy': fy},\n\t\t'addparents': {\n\t\t\t'text': '\\uf062', 'title': 'add parents',\n\t\t\t'fx': - 0.75*opts.symbol_size,\n\t\t\t'fy': - opts.symbol_size + 11\n\t\t},\n\t\t'delete': {\n\t\t\t'text': 'X', 'title': 'delete',\n\t\t\t'fx': (opts.symbol_size/2) - 1,\n\t\t\t'fy': - opts.symbol_size + 12,\n\t\t\t'styles': {\"font-weight\": \"bold\", \"fill\": \"darkred\", \"font-family\": \"monospace\"}\n\t\t}\n\t};\n\n\tif(opts.edit) {\n\t\twidgets.settings = {'text': '\\uf013', 'title': 'settings', 'fx': (-font_size/2)+2, 'fy': -opts.symbol_size + 11};\n\t}\n\n\tfor(let key in widgets) {\n\t\tlet widget = node.filter(function (d) {\n\t\t\t\treturn  (d.data.hidden && !opts.DEBUG ? false : true) &&\n\t\t\t\t\t\t!((d.data.mother === undefined || d.data.noparents) && key === 'addsibling') &&\n\t\t\t\t\t\t!(d.data.parent_node !== undefined && d.data.parent_node.length > 1 && key === 'addpartner') &&\n\t\t\t\t\t\t!(d.data.parent_node === undefined && key === 'addchild') &&\n\t\t\t\t\t\t!((d.data.noparents === undefined && d.data.top_level === undefined) && key === 'addparents');\n\t\t\t})\n\t\t\t.append(\"text\")\n\t\t\t.attr(\"class\", key)\n\t\t\t.style(\"opacity\", 0)\n\t\t\t.attr('font-family', 'FontAwesome')\n\t\t\t.attr(\"xx\", function(d){return d.x;})\n\t\t\t.attr(\"yy\", function(d){return d.y;})\n\t\t\t.attr(\"x\", widgets[key].fx)\n\t\t\t.attr(\"y\", widgets[key].fy)\n\t\t\t.attr('font-size', '0.85em' )\n\t\t\t.text(widgets[key].text);\n\n\t\tif('styles' in widgets[key])\n\t\t\tfor(let style in widgets[key].styles){\n\t\t\t\twidget.attr(style, widgets[key].styles[style]);\n\t\t\t}\n\n\t\twidget.append(\"svg:title\").text(widgets[key].title);\n\t\toff += 17;\n\t}\n\n\t// add sibling or child\n\td3.selectAll(\".addsibling, .addchild\")\n\t  .on(\"mouseover\", function () {\n\t\t  let type = d3.select(this).attr('class');\n\t\t  d3.selectAll('.popup_selection').style(\"opacity\", 1);\n\t\t  add_person = {'node': d3.select(this.parentNode), 'type': type};\n\n\t\t  //let translate = getTranslation(d3.select('.diagram').attr(\"transform\"));\n\t\t  let x = parseInt(d3.select(this).attr(\"xx\")) + parseInt(d3.select(this).attr(\"x\"));\n\t\t  let y = parseInt(d3.select(this).attr(\"yy\")) + parseInt(d3.select(this).attr(\"y\"));\n\t\t  d3.selectAll('.popup_selection').attr(\"transform\", \"translate(\"+x+\",\"+(y+2)+\")\");\n\t\t  d3.selectAll('.popup_selection_rotate45')\n\t\t\t.attr(\"transform\", \"translate(\"+(x+(3*font_size))+\",\"+(y+(font_size*1.2))+\") rotate(45)\");\n\t  });\n\n\t// handle widget clicks\n\td3.selectAll(\".addchild, .addpartner, .addparents, .delete, .settings\")\n\t  .on(\"click\", function (e) {\n\t\t  e.stopPropagation();\n\t\tlet opt = d3.select(this).attr('class');\n\t\tlet d = d3.select(this.parentNode).datum();\n\t\tif(opts.DEBUG) {\n\t\t\tconsole.log(opt);\n\t\t}\n\n\t\tlet newdataset;\n\t\tif(opt === 'settings') {\n\t\t\tif(typeof opts.edit === 'function') {\n\t\t\t\topts.edit(opts, d);\n\t\t\t} else {\n\t\t\t\topenEditDialog(opts, d);\n\t\t\t}\n\t\t} else if(opt === 'delete') {\n\t\t\tnewdataset = utils.copy_dataset(pedcache_current(opts));\n\t\t\tdelete_node_dataset(newdataset, d.data, opts, onDone);\n\t\t} else if(opt === 'addparents') {\n\t\t\tnewdataset = utils.copy_dataset(pedcache_current(opts));\n\t\t\topts.dataset = newdataset;\n\t\t\taddparents(opts, newdataset, d.data.name);\n\t\t\t$(document).trigger('rebuild', [opts]);\n\t\t} else if(opt === 'addpartner') {\n\t\t\tnewdataset = utils.copy_dataset(pedcache_current(opts));\n\t\t\taddpartner(opts, newdataset, d.data.name);\n\t\t\topts.dataset = newdataset;\n\t\t\t$(document).trigger('rebuild', [opts]);\n\t\t}\n\t\t// trigger fhChange event\n\t\t$(document).trigger('fhChange', [opts]);\n\t});\n\n\t// other mouse events\n\tlet highlight = [];\n\n\tnode.filter(function (d) { return !d.data.hidden; })\n\t.on(\"click\", function (e, d) {\n\t\tif (e.ctrlKey) {\n\t\t\tif(highlight.indexOf(d) === -1)\n\t\t\t\thighlight.push(d);\n\t\t\telse\n\t\t\t\thighlight.splice(highlight.indexOf(d), 1);\n\t\t} else\n\t\t\thighlight = [d];\n\n\t\tif('nodeclick' in opts) {\n\t\t\topts.nodeclick(d.data);\n\t\t\td3.selectAll(\".indi_rect\").style(\"opacity\", 0);\n\t\t\td3.selectAll('.indi_rect').filter(function(d) {return highlight.indexOf(d) !== -1;}).style(\"opacity\", 0.5);\n\t\t}\n\t})\n\t.on(\"mouseover\", function(e, d){\n\t\te.stopPropagation();\n\t\tlast_mouseover = d;\n\t\tif(dragging) {\n\t\t\tif(dragging.data.name !== last_mouseover.data.name &&\n\t\t\t   dragging.data.sex !== last_mouseover.data.sex) {\n\t\t\t\td3.select(this).select('rect').style(\"opacity\", 0.2);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t\td3.select(this).select('rect').style(\"opacity\", 0.2);\n\t\td3.select(this).selectAll('.addchild, .addsibling, .addpartner, .addparents, .delete, .settings').style(\"opacity\", 1);\n\t\td3.select(this).selectAll('.indi_details').style(\"opacity\", 0);\n\t\td3.select(this).selectAll('.ped_label').style(\"opacity\", 0);\n\n\t\tsetLineDragPosition(opts.symbol_size-10, 0, opts.symbol_size-2, 0, d.x+\",\"+(d.y+2));\n\t})\n\t.on(\"mouseout\", function(d){\n\t\tif(dragging)\n\t\t\treturn;\n\n\t\td3.select(this).selectAll('.addchild, .addsibling, .addpartner, .addparents, .delete, .settings').style(\"opacity\", 0);\n\t\tif(highlight.indexOf(d) === -1)\n\t\t\td3.select(this).select('rect').style(\"opacity\", 0);\n\t\td3.select(this).selectAll('.indi_details').style(\"opacity\", 1);\n\t\td3.select(this).selectAll('.ped_label').style(\"opacity\", 1);\n\t\t// hide popup if it looks like the mouse is moving north\n\t\tlet xcoord = d3.pointer(d)[0];\n\t\tlet ycoord = d3.pointer(d)[1];\n\t\tif(ycoord < 0.8*opts.symbol_size)\n\t\t\td3.selectAll('.popup_selection').style(\"opacity\", 0);\n\t\tif(!dragging) {\n\t\t\t// hide popup if it looks like the mouse is moving north, south or west\n\t\t\tif( Math.abs(ycoord) > 0.25*opts.symbol_size ||\n\t\t\t\tMath.abs(ycoord) < -0.25*opts.symbol_size ||\n\t\t\t\txcoord < 0.2*opts.symbol_size){\n\t\t\t\t\tsetLineDragPosition(0, 0, 0, 0);\n\t\t\t}\n        }\n\t});\n}\n\nfunction onDone(opts, dataset) {\n\t// assign new dataset and rebuild pedigree\n\topts.dataset = dataset;\n\t$(document).trigger('rebuild', [opts]);\n}\n\n// drag line between nodes to create partners\nfunction drag_handle(opts) {\n\tlet line_drag_selection = d3.select('.diagram');\n\tlet dline = line_drag_selection.append(\"line\").attr(\"class\", 'line_drag_selection')\n        .attr(\"stroke-width\", 6)\n        .style(\"stroke-dasharray\", (\"2, 1\"))\n        .attr(\"stroke\",\"black\")\n        .call(d3.drag()\n                .on(\"start\", dragstart)\n                .on(\"drag\", drag)\n                .on(\"end\", dragstop));\n\tdline.append(\"svg:title\").text(\"drag to create consanguineous partners\");\n\n\tsetLineDragPosition(0, 0, 0, 0);\n\n\tfunction dragstart() {\n\t\tdragging = last_mouseover;\n\t\td3.selectAll('.line_drag_selection')\n\t\t\t.attr(\"stroke\",\"darkred\");\n\t}\n\n\tfunction dragstop(_d) {\n\t\tif(last_mouseover &&\n\t\t   dragging.data.name !== last_mouseover.data.name &&\n\t\t   dragging.data.sex  !== last_mouseover.data.sex) {\n\t\t\tlet child = {\"name\": utils.makeid(4), \"sex\": 'U',\"hidden\":true,\n\t\t\t\t     \"mother\": (dragging.data.sex === 'F' ? dragging.data.name : last_mouseover.data.name),\n\t\t\t         \"father\": (dragging.data.sex === 'F' ? last_mouseover.data.name : dragging.data.name)};\n\t\t\tlet newdataset = utils.copy_dataset(opts.dataset);\n\t\t\topts.dataset = newdataset;\n\n\t\t\tlet idx = utils.getIdxByName(opts.dataset, dragging.data.name)+1;\n\t\t\topts.dataset.splice(idx, 0, child);\n\t\t\t$(document).trigger('rebuild', [opts]);\n\t\t}\n\t\tsetLineDragPosition(0, 0, 0, 0);\n\t\td3.selectAll('.line_drag_selection')\n\t\t\t.attr(\"stroke\",\"black\");\n\t\tdragging = undefined;\n\t\treturn;\n\t}\n\n\tfunction drag(e) {\n\t\te.sourceEvent.stopPropagation();\n\t\tlet dx = e.dx;\n\t\tlet dy = e.dy;\n\t\tlet xnew = parseFloat(d3.select(this).attr('x2'))+ dx;\n        let ynew = parseFloat(d3.select(this).attr('y2'))+ dy;\n        setLineDragPosition(opts.symbol_size-10, 0, xnew, ynew);\n\t}\n}\n\n/**\n * Set the position and start and end of consanguineous widget.\n */\nfunction setLineDragPosition(x1, y1, x2, y2, translate) {\n\tif(translate) {\n\t\td3.selectAll('.line_drag_selection').attr(\"transform\", \"translate(\"+translate+\")\");\n\t}\n\td3.selectAll('.line_drag_selection')\n\t\t.attr(\"x1\", x1)\n\t\t.attr(\"y1\", y1)\n\t\t.attr(\"x2\", x2)\n\t\t.attr(\"y2\", y2);\n}\n\nfunction capitaliseFirstLetter(string) {\n  return string.charAt(0).toUpperCase() + string.slice(1);\n}\n\n\n\n\n// if opt.edit is set true (rather than given a function) this is called to edit node attributes\nfunction openEditDialog(opts, d) {\n  let changeFlag = false;\n  $(\"#node_properties\").dialog({\n    autoOpen: false,\n    title: d.data.display_name,\n    modal: true,\n    width: $(window).width() > 676 ? 676 : $(window).width() - 30,\n    buttons: [\n    {\n        text: \"Cancel\",\n        class: \"ui-cancel-button\",\n        click: function () {\n\t\t\thandleCancelClose();\n\t\t}\n\t},\n\t{\n        text: \"Save\",\n        class: \"ui-save-button\",\n        click: function () {\n          save(opts);\n          $(this).dialog(\"close\");\n        },\n      },\n    ],\n  });\n\n  function handleCancelClose() {\n\tif (changeFlag) {\n\t  $(\n\t\t`<div>\n\t\t<h2 style=\"margin: 0; font-weight: bold;\">Any changes made will be lost.</h2>\n\t\t<p style=\"margin-top: 10px;\">Do you want to continue?</p>\n\t  </div>`\n\t  ).dialog({\n\t\tmodal: true,\n\t\ttitle: \"\",\n\t\tminWidth: 350,\n\t\twidth: $(\"#node_properties\").dialog(\"option\", \"width\") * 0.67,\n\t\topen: function () {\n\t\t\t// Remove the default titlebar styling\n\t\t\t$(this).parent().find(\".ui-dialog-titlebar\").remove();\n\t\t  },\n\t\tbuttons: [\n\t\t  {\n\t\t\ttext: \"Yes\",\n\t\t\tclass: \"ui-yes-button\",\n\t\t\tclick: function () {\n\t\t\t  $(this).dialog(\"close\"); // Close confirmation dialog\n\t\t\t  $(\"#node_properties\").dialog(\"close\"); // Close main dialog\n\t\t\t},\n\t\t  },\n\t\t  {\n\t\t\ttext: \"No\",\n\t\t\tclass: \"ui-no-button\",\n\t\t\tclick: function () {\n\t\t\t  $(this).dialog(\"close\"); // Close confirmation dialog\n\t\t\t},\n\t\t  },\n\t\t],\n\t  });\n\t} else {\n\t  $(\"#node_properties\").dialog(\"close\");\n\t}\n  }\n  \n\n  let table =\n    \"<table id='person_details' style='border-collapse: collapse; margin-top: 0.5rem; max-width: 600px !important' width='600px' class='edit_table' height='500px' border='0'>\";\n  table +=\n    \"<tr><td>Unique ID</td><td><input class='form-control' type='text' id='id_name' name='name' value=\" +\n    (d.data.name ? d.data.name : \"\") +\n    \"></td></tr>\";\n  table +=\n    \"<tr><td>First Name</td><td><input class='form-control' type='text' id='id_display_name' name='display_name' value=\" +\n    (d.data.display_name ? d.data.display_name : \"\") +\n    \"></td><td style='padding-left: 1.5rem;'>Last Name</td><td><input class='form-control' type='text' id='id_last_name' name='last_name' value=\" +\n    (d.data.last_name ? d.data.last_name : \"\") +\n    \"></td></tr>\";\n  table +=\n    \"<tr><td>Year Of Birth</td><td><input class='form-control' type='number' id='id_yob' min='1900' max='2050' name='yob' style='width:7em !important;' value=\" +\n    (d.data.yob ? d.data.yob : \"\") +\n    \"></td><td style='padding-left: 1.5rem;'>Age</td><td><input class='form-control' type='number' id='id_age' min='0' max='120' name='age' style='width:7em !important;' value=\" +\n    (d.data.age ? d.data.age : \"\") +\n    \"></td></tr>\";\n  table +=\n    \"<tr><td>Year Of Death</td><td><input class='form-control' type='number' id='id_yod' min='1900' max='2050' name='yod' style='width:7em !important;' value=\" +\n    (d.data.yod ? d.data.yod : \"\") +\n    \"></td><td style='padding-left: 1.5rem;'>Age of death</td><td><input class='form-control' type='number' id='id_age_age_of_death' min='0' max='120' name='age_of_death' style='width:7em !important;' value=\" +\n    (d.data.age_of_death ? d.data.age_of_death : \"\") +\n    \"></td></tr>\";\n  table +=\n    '<tr><td>Sex</td><td colspan=\"3\" id=\"id_sex\">' +\n    '<label class=\"radio-inline\" ><input type=\"radio\" name=\"sex\" value=\"M\" ' +\n    (d.data.sex === \"M\" ? \"checked\" : \"\") +\n    ' style=\"padding-right: 1rem;\">&thinsp;Male</label>' +\n    '<label class=\"radio-inline\" style=\"margin-left: 0.5rem;\" ><input type=\"radio\" name=\"sex\" value=\"F\" ' +\n    (d.data.sex === \"F\" ? \"checked\" : \"\") +\n    ' style=\"padding-right: 1rem\">&thinsp;Female</label>' +\n    '<label class=\"radio-inline\" style=\"margin-left: 0.5rem;\"><input type=\"radio\" name=\"sex\" value=\"U\" style=\"padding-left: 0.5rem; padding-right: 0.5rem;\">&thinsp;Unknown</label>' +\n    \"</td></tr>\";\n  // alive status = 0; dead status = 1\n  table +=\n    '<tr><td>Individual is</td><td colspan=\"2\" id=\"id_status\">' +\n    '<label class=\"checkbox-inline\" ><input type=\"radio\" name=\"status\" value=\"0\" ' +\n    (parseInt(d.data.status) === 0 ? \"checked\" : \"\") +\n    ' style=\"padding-right: 1rem;\">&thinsp;Alive</label>' +\n    '<label class=\"checkbox-inline\" style=\"margin-left: 0.5rem;\" ><input type=\"radio\" name=\"status\" value=\"1\" ' +\n    (parseInt(d.data.status) === 1 ? \"checked\" : \"\") +\n    ' style=\"padding-right: 1rem; margin-left: 0.5rem;\">&thinsp;Deceased</label>' +\n    \"</td></tr>\";\n  $(\"#id_status input[value='\" + d.data.status + \"']\").prop(\"checked\", true);\n\n  // switches\n  table +=\n    \"<tr><td><strong>Father</strong></td><td><input class='form-control' type='text' id='id_father' name='father' value='\" +\n    (d.data.father ? d.data.father : \"\") +\n    \"'></td>\" + \n    \"<td style='padding-left: 1.5rem;'><strong>Mother</strong></td><td><input class='form-control' type='text' id='id_mother' name='mother' value='\" +\n    (d.data.mother ? d.data.mother : \"\") +\n    \"'></td></tr>\";\n  table +=\n    \"<tr><td><strong>No_parents</strong></td><td><input class='form-control' type='text' id='id_noparents' name='noparents' value='\" +\n    (d.data.noparents ? d.data.noparents : \"\") +\n    \"'></td></tr>\";\n  let switches = [\n    \"adopted_in\",\n    \"adopted_out\",\n    \"miscarriage\",\n    \"stillbirth \",\n    \"termination\",\n    \"Abortion\",\n  ];\n  table +=\n    '<tr><td colspan=\"2\"><strong>Reproduction:</strong></td></tr><tr><td colspan=\"3\" >' +\n    switches\n      .map(\n        (attr, i) =>\n          (i === 3 ? '</td></tr><tr><td colspan=\"4\">' : \"\") +\n          '<label class=\"checkbox-inline\" style=\"display: inline-flex; align-items: center; white-space: nowrap; margin-right: 16px;\"\"><input type=\"checkbox\" id=\"id_' +\n          attr +\n          '\" name=\"' +\n          attr +\n          '\" value=\"0\" ' +\n          (d.data[attr] ? \"checked\" : \"\") +\n          \">&thinsp;\" +\n          capitaliseFirstLetter(attr.replace(\"_\", \" \")) +\n          \"</label>\"\n      )\n      .join(\"\") +\n    \"</td></tr>\";\n  table += \"</td></tr>\";\n\n  //\n  let exclude = [\n    \"children\",\n    \"name\",\n    \"parent_node\",\n    \"top_level\",\n    \"id\",\n    \"noparents\",\n    \"level\",\n    \"age\",\n    \"sex\",\n    \"status\",\n    \"display_name\",\n    \"mother\",\n    \"father\",\n    \"yob\",\n    \"mztwin\",\n    \"dztwin\",\n  ];\n  $.merge(exclude, switches);\n  table += '<tr><td colspan=\"2\"><strong>Age of Diagnosis:</strong></td></tr>';\n  $.each(opts.diseases, function (k, v) {\n    exclude.push(v.type + \"_diagnosis_age\");\n    let disease_colour =\n      '&thinsp;<span style=\"padding-left:5px;background:' +\n      opts.diseases[k].colour +\n      '\"></span>';\n    let diagnosis_age = d.data[v.type + \"_diagnosis_age\"];\n    table +=\n      \"<tr><td style='text-align:right; padding-right: 0.5rem;'>\" +\n      capitaliseFirstLetter(v.type.replace(\"_\", \" \")) +\n      disease_colour +\n      \"&nbsp;</td><td>\" +\n      \"<input class='form-control' id='id_\" +\n      v.type +\n      \"_diagnosis_age_0' max='110' min='0' name='\" +\n      v.type +\n      \"_diagnosis_age_0' style='width:5em' type='number' value='\" +\n      (diagnosis_age !== undefined ? diagnosis_age : \"\") +\n      \"'></td></tr>\";\n  });\n  table += '<tr><td colspan=\"2\" style=\"line-height:1px;\"></td></tr>';\n  table +=\n    \"<tr><td ><strong>Additional Information:</strong></td><td class='text-area-cell'><textarea type='text' class='text-area' maxlength='15000' cols='25' rows='25' wrap='soft' id='id_additional_information' name='additional_information' style='max-height: 100px;' value='\" +\n    (d.data.additional_information ? d.data.additional_information : \"\") +\n    \" '></textarea></td></tr>\";\n  table += \"</table>\";\n  $(\"#node_properties\").html(table);\n  $(\"#node_properties\").dialog(\"open\");\n  $(\n    \"#node_properties input[type=radio], #node_properties input[type=checkbox], #node_properties input[type=text], #node_properties input[type=number]\"\n  ).change(function () {\n    changeFlag = true;\n  });\n  return;\n}\n\n\n\n// add children to a given node\nexport function addchild(dataset, node, sex, nchild, twin_type) {\n\tif(twin_type && $.inArray(twin_type, [ \"mztwin\", \"dztwin\" ] ) === -1)\n\t\treturn new Error(\"INVALID TWIN TYPE SET: \"+twin_type);\n\n\tif (typeof nchild === typeof undefined)\n\t\tnchild = 1;\n\tlet children = utils.getAllChildren(dataset, node);\n\tlet ptr_name, idx;\n\tif (children.length === 0) {\n\t\tlet partner = addsibling(dataset, node, node.sex === 'F' ? 'M': 'F', node.sex === 'F');\n\t\tpartner.noparents = true;\n\t\tptr_name = partner.name;\n\t\tidx = utils.getIdxByName(dataset, node.name)+1;\n\t} else {\n\t\tlet c = children[0];\n\t\tptr_name = (c.father === node.name ? c.mother : c.father);\n\t\tidx = utils.getIdxByName(dataset, c.name);\n\t}\n\n\tlet twin_id;\n\tif(twin_type)\n\t\ttwin_id = getUniqueTwinID(dataset, twin_type);\n\tlet newchildren = [];\n\tfor (let i = 0; i < nchild; i++) {\n\t\tlet child = {\"name\": utils.makeid(4), \"sex\": sex,\n\t\t\t\t\t \"mother\": (node.sex === 'F' ? node.name : ptr_name),\n\t\t\t\t\t \"father\": (node.sex === 'F' ? ptr_name : node.name)};\n\t\tdataset.splice(idx, 0, child);\n\n\t\tif(twin_type)\n\t\t\tchild[twin_type] = twin_id;\n\t\tnewchildren.push(child);\n\t}\n\treturn newchildren;\n}\n\n//\nexport function addsibling(dataset, node, sex, add_lhs, twin_type) {\n\tif(twin_type && $.inArray(twin_type, [ \"mztwin\", \"dztwin\" ] ) === -1)\n\t\treturn new Error(\"INVALID TWIN TYPE SET: \"+twin_type);\n\n\tlet newbie = {\"name\": utils.makeid(4), display_name: \"new!\", \"sex\": sex};\n\tif(node.top_level) {\n\t\tnewbie.top_level = true;\n\t} else {\n\t\tnewbie.mother = node.mother;\n\t\tnewbie.father = node.father;\n\t}\n\tlet idx = utils.getIdxByName(dataset, node.name);\n\n\tif(twin_type) {\n\t\tsetMzTwin(dataset, dataset[idx], newbie, twin_type);\n\t}\n\n\tif(!add_lhs) { // add to LHS\n\t\tidx++;\n\t}\n\tdataset.splice(idx, 0, newbie);\n\treturn newbie;\n}\n\n// add parents to the 'node'\nexport function addparents(opts, dataset, name) {\n\tlet mother, father;\n\tlet root = utils.roots[opts.targetDiv];\n\tlet flat_tree = utils.flatten(root);\n\tlet tree_node = utils.getNodeByName(flat_tree, name);\n\tlet node  = tree_node.data;\n\tlet depth = tree_node.depth;   // depth of the node in relation to the root (depth = 1 is a top_level node)\n\n\tlet pid = -101;\n\tlet ptr_name;\n\tlet children = utils.getAllChildren(dataset, node);\n\tif(children.length > 0){\n\t\tptr_name = children[0].mother === node.name ? children[0].father : children[0].mother;\n\t\tpid = utils.getNodeByName(flat_tree, ptr_name).data.id;\n\t}\n\n\tlet i;\n\tif(depth === 1) {\n\t\tmother = {\"name\": utils.makeid(4), \"sex\": \"F\", \"top_level\": true};\n\t\tfather = {\"name\": utils.makeid(4), \"sex\": \"M\", \"top_level\": true};\n\t\tdataset.splice(0, 0, mother);\n\t\tdataset.splice(0, 0, father);\n\n\t\tfor(i=0; i<dataset.length; i++){\n\t\t\tif( (dataset[i].top_level || utils.getDepth(dataset, dataset[i].name) === 2) && \n\t\t\t     dataset[i].name !== mother.name && dataset[i].name !== father.name){\n\t\t\t\tdelete dataset[i].top_level;\n\t\t\t\tdataset[i].noparents = true;\n\t\t\t\tdataset[i].mother = mother.name;\n\t\t\t\tdataset[i].father = father.name;\n\t\t\t}\n\t\t}\n\t} else {\n\t\tlet node_mother = utils.getNodeByName(flat_tree, tree_node.data.mother);\n\t\tlet node_father = utils.getNodeByName(flat_tree, tree_node.data.father);\n\t\tlet node_sibs = utils.getAllSiblings(dataset, node);\n\n\t\t// lhs & rhs id's for siblings of this node\n\t\tlet rid = 10000;\n\t\tlet lid = tree_node.data.id;\n\t\tfor(i=0; i<node_sibs.length; i++){\n\t\t\tlet sid = utils.getNodeByName(flat_tree, node_sibs[i].name).data.id;\n\t\t\tif(sid < rid && sid > tree_node.data.id)\n\t\t\t\trid = sid;\n\t\t\tif(sid < lid)\n\t\t\t\tlid = sid;\n\t\t}\n\t\tlet add_lhs = (lid >= tree_node.data.id || (pid === lid && rid < 10000));\n\t\tif(opts.DEBUG)\n\t\t\tconsole.log('lid='+lid+' rid='+rid+' nid='+tree_node.data.id+' ADD_LHS='+add_lhs);\n\t\tlet midx;\n\t\tif( (!add_lhs && node_father.data.id > node_mother.data.id) ||\n\t\t\t(add_lhs && node_father.data.id < node_mother.data.id) )\n\t\t\tmidx = utils.getIdxByName(dataset, node.father);\n\t\telse\n\t\t\tmidx = utils.getIdxByName(dataset, node.mother);\n\n\t\tlet parent = dataset[midx];\n\t\tfather = addsibling(dataset, parent, 'M', add_lhs);\n\t\tmother = addsibling(dataset, parent, 'F', add_lhs);\n\n\t\tlet faidx = utils.getIdxByName(dataset, father.name);\n\t\tlet moidx = utils.getIdxByName(dataset, mother.name);\n\t\tif(faidx > moidx) {\t\t\t\t   // switch to ensure father on lhs of mother\n\t\t\tlet tmpfa = dataset[faidx];\n\t\t\tdataset[faidx] = dataset[moidx];\n\t\t\tdataset[moidx] = tmpfa;\n\t\t}\n\n\t\tlet orphans = utils.getAdoptedSiblings(dataset, node);\n\t\tlet nid = tree_node.data.id;\n\t\tfor(i=0; i<orphans.length; i++){\n\t\t\tlet oid = utils.getNodeByName(flat_tree, orphans[i].name).data.id;\n\t\t\tif(opts.DEBUG)\n\t\t\t\tconsole.log('ORPHAN='+i+' '+orphans[i].name+' '+(nid < oid && oid < rid)+' nid='+nid+' oid='+oid+' rid='+rid);\n\t\t\tif((add_lhs || nid < oid) && oid < rid){\n\t\t\t\tlet oidx = utils.getIdxByName(dataset, orphans[i].name);\n\t\t\t\tdataset[oidx].mother = mother.name;\n\t\t\t\tdataset[oidx].father = father.name;\n\t\t\t}\n\t\t}\n\t}\n\n\tif(depth === 2) {\n\t\tmother.top_level = true;\n\t\tfather.top_level = true;\n\t} else if(depth > 2) {\n\t\tmother.noparents = true;\n\t\tfather.noparents = true;\n\t}\n\tlet idx = utils.getIdxByName(dataset, node.name);\n\tdataset[idx].mother = mother.name;\n\tdataset[idx].father = father.name;\n\tdelete dataset[idx].noparents;\n\n\tif('parent_node' in node) {\n\t\tlet ptr_node = dataset[utils.getIdxByName(dataset, ptr_name)];\n\t\tif('noparents' in ptr_node) {\n\t\t\tptr_node.mother = mother.name;\n\t\t\tptr_node.father = father.name;\n\t\t}\n\t}\n}\n\n// add partner\nexport function addpartner(opts, dataset, name) {\n\tlet root = utils.roots[opts.targetDiv];\n\tlet flat_tree = utils.flatten(root);\n\tlet tree_node = utils.getNodeByName(flat_tree, name);\n\t/*\n\tOlder logic - partner lhs or rhs (controlled via lhs argument of addsibling function) depends on gender, M or F, alone\n\tNew Logic - if partners exist, check their position, and place a new partner in the opposite direction. \n\tUse this condition to control lhs argument of addsibling\n\t*/\n\tlet tree_partner = utils.get_partners(dataset, tree_node.data);\n\n\tlet siblings = tree_node.parent.children;\n\tlet lhs = siblings.length > 1;\n\n\tif(tree_partner.length >0){\n\t\tlet treeIdx = utils.getIdxByName(flat_tree,name);\n\t\tlet partnerIdx = utils.getIdxByName(flat_tree,tree_partner);\n\t\tlhs =  treeIdx < partnerIdx;\n\t}\n\t\n\tlet partner = addsibling(dataset, tree_node.data, tree_node.data.sex === 'F' ? 'M' : 'F', lhs);\n\t// let partner = addsibling(dataset, tree_node.data, tree_node.data.sex === 'F' ? 'M' : 'F', tree_node.data.sex === 'F');\n\tpartner.noparents = true;\n\n\tlet child = {\"name\": utils.makeid(4), \"sex\": \"M\", hidden: true};\n\tchild.mother = (tree_node.data.sex === 'F' ? tree_node.data.name : partner.name);\n\tchild.father = (tree_node.data.sex === 'F' ? partner.name : tree_node.data.name);\n\n\tlet idx = utils.getIdxByName(dataset, tree_node.data.name)+2;\n\tdataset.splice(idx, 0, child);\n}\n\n// get adjacent nodes at the same depth\nfunction adjacent_nodes(root, node, excludes) {\n\tlet dnodes = utils.getNodesAtDepth(utils.flatten(root), node.depth, excludes);\n\tlet lhs_node, rhs_node;\n\tfor(let i=0; i<dnodes.length; i++) {\n\t\tif(dnodes[i].x < node.x)\n\t\t\tlhs_node = dnodes[i];\n\t\tif(!rhs_node && dnodes[i].x > node.x)\n\t\t\trhs_node = dnodes[i];\n\t}\n\treturn [lhs_node, rhs_node];\n}\n\n// delete a node and descendants\nexport function delete_node_dataset(dataset, node, opts, onDone) {\n\tlet root = utils.roots[opts.targetDiv];\n\tlet fnodes = utils.flatten(root);\n\tlet deletes = [];\n\tlet i, j;\n\n\t// get d3 data node\n\tif(node.id === undefined) {\n\t\tlet d3node = utils.getNodeByName(fnodes, node.name);\n\t\tif(d3node !== undefined)\n\t\t\tnode = d3node.data;\n\t}\n\n\tif(node.parent_node) {\n\t\tfor(i=0; i<node.parent_node.length; i++){\n\t\t\tlet parent = node.parent_node[i];\n\t\t\tlet ps = [utils.getNodeByName(dataset, parent.mother.name),\n\t\t\t\t\t  utils.getNodeByName(dataset, parent.father.name)];\n\t\t\t// delete parents\n\t\t\tfor(j=0; j<ps.length; j++) {\n\t\t\t\tif(ps[j].name === node.name || ps[j].noparents !== undefined || ps[j].top_level) {\n\t\t\t\t\tdataset.splice(utils.getIdxByName(dataset, ps[j].name), 1);\n\t\t\t\t\tdeletes.push(ps[j]);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tlet children = parent.children;\n\t\t\tlet children_names = $.map(children, function(p, _i){return p.name;});\n\t\t\tfor(j=0; j<children.length; j++) {\n\t\t\t\tlet child = utils.getNodeByName(dataset, children[j].name);\n\t\t\t\tif(child){\n\t\t\t\t\tchild.noparents = true;\n\t\t\t\t\tlet ptrs = utils.get_partners(dataset, child);\n\t\t\t\t\tlet ptr;\n\t\t\t\t\tif(ptrs.length > 0)\n\t\t\t\t\t\tptr = utils.getNodeByName(dataset, ptrs[0]);\n\t\t\t\t\tif(ptr && ptr.mother !== child.mother) {\n\t\t\t\t\t\tchild.mother = ptr.mother;\n\t\t\t\t\t\tchild.father = ptr.father;\n\t\t\t\t\t} else if(ptr) {\n\t\t\t\t\t\tlet child_node  = utils.getNodeByName(fnodes, child.name);\n\t\t\t\t\t\tlet adj = adjacent_nodes(root, child_node, children_names);\n\t\t\t\t\t\tchild.mother = adj[0] ? adj[0].data.mother : (adj[1] ? adj[1].data.mother : null);\n\t\t\t\t\t\tchild.father = adj[0] ? adj[0].data.father : (adj[1] ? adj[1].data.father : null);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tdataset.splice(utils.getIdxByName(dataset, child.name), 1);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} else {\n\t\tdataset.splice(utils.getIdxByName(dataset, node.name), 1);\n\t}\n\n\t// delete ancestors\n\tconsole.log(deletes);\n\tfor(i=0; i<deletes.length; i++) {\n\t\tlet del = deletes[i];\n\t\tlet sibs = utils.getAllSiblings(dataset, del);\n\t\tconsole.log('DEL', del.name, sibs);\n\t\tif(sibs.length < 1) {\n\t\t\tconsole.log('del sibs', del.name, sibs);\n\t\t\tlet data_node  = utils.getNodeByName(fnodes, del.name);\n\t\t\tlet ancestors = data_node.ancestors();\n\t\t\tfor(j=0; j<ancestors.length; j++) {\n\t\t\t\tconsole.log(ancestors[i]);\n\t\t\t\tif(ancestors[j].data.mother){\n\t\t\t\t\tconsole.log('DELETE ', ancestors[j].data.mother, ancestors[j].data.father);\n\t\t\t\t\tdataset.splice(utils.getIdxByName(dataset, ancestors[j].data.mother.name), 1);\n\t\t\t\t\tdataset.splice(utils.getIdxByName(dataset, ancestors[j].data.father.name), 1);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t// check integrity of mztwins settings\n\tcheckTwins(dataset);\n\n\tlet uc;\n\ttry\t{\n\t\t// validate new pedigree dataset\n\t\tlet newopts = $.extend({}, opts);\n\t\tnewopts.dataset = utils.copy_dataset(dataset);\n\t\tutils.validate_pedigree(newopts);\n\t\t// check if pedigree is split\n\t\tuc = utils.unconnected(dataset);\n\t} catch(err) {\n\t\tutils.messages('Warning', 'Deletion of this pedigree member is disallowed.')\n\t\tthrow err;\n\t}\n\tif(uc.length > 0) {\n\t\t// check & warn only if this is a new split\n\t\tif(utils.unconnected(opts.dataset).length === 0) {\n\t\t\tconsole.error(\"individuals unconnected to pedigree \", uc);\n\t\t\tutils.messages(\"Warning\", \"Deleting this will split the pedigree. Do you want to continue?\", onDone, opts, dataset);\n\t\t\treturn;\n\t\t}\n\t}\n\n\tif(onDone) {\n\t\tonDone(opts, dataset);\n\t}\n\treturn dataset;\n}\n\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\nimport {prefixInObj} from './utils.js';\n\nexport function addLabels(opts, node) {\n\t// names of individuals\n\taddLabel(opts, node, -(0.75 * opts.symbol_size), (0.2 * opts.symbol_size),\n\t\t\tfunction(d) {\n\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\treturn ('display_name' in d.data ? d.data.display_name : d.data.name) + '  ' + d.data.id;\n\t\t\t\treturn 'display_name' in d.data ? d.data.display_name : '';}, undefined, ['display_name']);\n\n\taddLabel(opts, node, -(0.4 * opts.symbol_size), -((0.1 * opts.symbol_size)-13),\n\t\tfunction(d) {\n\t\tif(opts.DEBUG)\n\t\t\treturn ('last_name' in d.data ? d.data.last_name : d.data.name) + '  ' + d.data.id;\n\t\t\treturn 'last_name' in d.data ? d.data.last_name : '';}, undefined, ['last_name']);\n\tlet font_size = parseInt(getPx(opts)) + 4;\n\t// display age/yob label first\n\tfor(let ilab=0; ilab<opts.labels.length; ilab++) {\n\t\tlet label = opts.labels[ilab];\n\t\tlet arr = (Array.isArray(label) ? label : [label]);\n\t\tif(arr.indexOf('age') > -1 || arr.indexOf('yob') > -1) {\n\t\t\taddLabel(opts, node, -opts.symbol_size,\n\t\t\t\tfunction(d) { return ypos(d, arr, font_size); },\n\t\t\t\tfunction(d) { return get_text(d, arr); }, 'indi_details', arr);\n\t\t}\n\t}\n\n\t// individuals disease details\n\tfor(let i=0;i<opts.diseases.length; i++) {\n\t\tlet disease = opts.diseases[i].type;\n\t\taddLabel(opts, node, -opts.symbol_size,\n\t\t\t\tfunction(d) { return ypos(d, [disease], font_size); },\n\t\t\t\tfunction(d) {\n\t\t\t\t\tlet dis = disease.replace('_', ' ').replace('cancer', 'ca.');\n\t\t\t\t\treturn disease+'_diagnosis_age' in d.data ? dis +\": \"+ d.data[disease+'_diagnosis_age'] : '';\n\t\t\t\t}, 'indi_details', [disease]);\n\t}\n\n\t// display other labels defined in opts.labels e.g. alleles/genotype data\n\tfor(let ilab=0; ilab<opts.labels.length; ilab++) {\n\t\tlet label = opts.labels[ilab];\n\t\tlet arr = (Array.isArray(label) ? label : [label]);\n\t\tif(arr.indexOf('age') === -1 && arr.indexOf('yob') === -1) {\n\t\t\taddLabel(opts, node, -opts.symbol_size,\n\t\t\t\tfunction(d) { return ypos(d, arr, font_size); },\n\t\t\t\tfunction(d) { return get_text(d, arr); }, 'indi_details', arr);\n\t\t}\n\t}\n}\n\nfunction get_text(d, arr) {\n\tlet txt = \"\";\n\tfor(let l=0; l<arr.length; l++) {\n\t\tlet this_label = arr[l];\n\t\tif(d.data[this_label]) {\n\t\t\tif(this_label === 'alleles') {\n\t\t\t\tlet vars = d.data.alleles.split(';');\n\t\t\t\tfor(let ivar = 0;ivar < vars.length;ivar++) {\n\t\t\t\t\tif(vars[ivar] !== \"\") txt += vars[ivar] + ';';\n\t\t\t\t}\n\t\t\t} else if(this_label === 'age') {\n\t\t\t\ttxt += d.data[this_label] +'y ';\n\t\t\t} else if(this_label === 'stillbirth') {\n\t\t\t\ttxt += \"SB\";\n\t\t\t} else if(this_label.match(\"_gene_test$\") && 'result' in d.data[this_label]) {\n\t\t\t\tlet r = d.data[this_label]['result'].toUpperCase();\n\t\t\t\t//let t = d.data[this_label]['type'];\n\t\t\t\tif(r !== \"-\") {\n\t\t\t\t\ttxt += this_label.replace('_gene_test', '').toUpperCase()\n\t\t\t\t\ttxt += (r === 'P' ? '+ ' : (r === 'N' ? '- ' : ' '));\n\t\t\t\t}\n\t\t\t} else if(this_label.match(\"_bc_pathology$\")) {\n\t\t\t\tlet r = d.data[this_label].toUpperCase();\n\t\t\t\ttxt += this_label.replace('_bc_pathology', '').toUpperCase()\n\t\t\t\ttxt += (r === 'P' ? '+ ' : (r === 'N' ? '- ' : ' '));\n\t\t\t} else {\n\t\t\t  txt += d.data[this_label];\n\t\t\t}\n\t\t}\n\t}\n\tif(txt !== \"\") return txt;\n}\n\nfunction ypos(d, arr, font_size) {\n\tif(!node_has_label(d, arr)) return;\n\td.y_offset = (!d.y_offset ? font_size*2.35 : d.y_offset+font_size);\n\treturn d.y_offset;\n}\n\nfunction node_has_label(d, labels) {\n\tfor(let l=0; l<labels.length; l++) {\n\t\tif(prefixInObj(labels[l], d.data)) return true;\n\t}\n\treturn false;\n}\n\n// add label to node\nfunction addLabel(opts, node, fx, fy, ftext, class_label, labels) {\n\tnode.filter(function (d) {\n\t\treturn !d.data.hidden && (!labels || node_has_label(d, labels));\n\t}).append(\"text\")\n\t.attr(\"class\", (class_label ? class_label + ' ped_label' : 'ped_label'))\n\t// .attr(\"x\", fx)\n\t// .attr(\"y\", fy)\n\t.attr(\"x\", function() {\n        return class_label === 'indi_details' ? fx+30 : fx-5;\n    })\n    .attr(\"y\", function() {\n        return class_label === 'indi_details' ?  45 : fy+35;\n    })\n\t.attr(\"font-family\", opts.font_family)\n\t// .attr(\"font-size\", opts.font_size)\n\t.attr(\"font-size\", \"0.80em\")\n\t.attr(\"font-weight\", opts.font_weight)\n\t.text(ftext);\n}\n\n// get height in pixels\nfunction getPx(opts){\n\tlet emVal = opts.font_size;\n\tif (emVal === parseInt(emVal, 10)) // test if integer\n\t\treturn emVal;\n\n\tif(emVal.indexOf(\"px\") > -1)\n\t\treturn emVal.replace('px', '');\n\telse if(emVal.indexOf(\"em\") === -1)\n\t\treturn emVal;\n\temVal = parseFloat(emVal.replace('em', ''));\n\treturn (parseFloat(getComputedStyle($('#'+opts.targetDiv).get(0)).fontSize)*emVal)-1.0;\n}\n","import  * as utils from './utils.js';\nimport {current as pedcache_current} from './pedcache.js';\n\n\n// initialise node dragging - SHIFT + DRAG\nexport function init_dragging(opts, node) {\n\t// add drag\n\tnode.filter(function (d) {return !d.data.hidden;})\n\t    .call(d3.drag()\n\t\t\t\t.filter(function filter(event) {\n\t\t\t\t\treturn !event.ctrlKey && !event.button && event.shiftKey; \t// shift and drag\n\t\t\t\t})\n                .on(\"start\", dragstart)\n                .on(\"drag\", drag)\n                .on(\"end\", dragstop));\n\n\tlet xstart;\n\tlet xnew;\n\n    function dragstart() {\n\t\txstart = d3.select(this).select('.indi_rect').attr('x');\n\t}\n\t\n\tfunction drag(e) {\n\t\te.sourceEvent.stopPropagation();\n\t\tlet dx = e.dx;\n\t\tlet indir = d3.select(this).select('.indi_rect');\n\t\txnew = parseFloat(indir.attr('x'))+ dx;\n        indir.attr(\"x\", xnew);\n\t}\n\t\n\tfunction dragstop(_d) {\n\t\tlet me = d3.select(this).datum().data;\n\t\tlet pnrs = utils.get_partners(opts.dataset, me);\n\t\tlet pnrName = (pnrs.length === 1 ? utils.get_partners(opts.dataset, me)[0] : -1);\n\n\t\t// reset individuals rectangle\n\t\tlet indir = d3.select(this).select('.indi_rect');\n\t\tindir.attr(\"x\", xstart);\n\n\t\tconst isMovingRight = (xnew>xstart);\n\t\t\n\t\t// get depth of node being dragged\n\t\tlet root = utils.roots[opts.targetDiv];\n\t\tlet flat_tree = utils.flatten(root);\n\t\tlet meNode = utils.getNodeByName(flat_tree, me.name);\n\t\t\n\t\t// nodes at same depth\n\t\tlet dnodes = utils.getNodesAtDepth(utils.flatten(root), meNode.depth);\n\n\t\t// locate adjacent nodes\n\t\tlet lft_node, rgt_node, adj_node;\n\t\txnew += meNode.x;\n\t\tlet xlft = -Number.MAX_VALUE;\n\t\tlet xrgt =  Number.MAX_VALUE;\n\t\tfor(let i=0; i<dnodes.length; i++) {\n\t\t\tif(dnodes[i].x < xnew && dnodes[i].x > xlft) {\n\t\t\t\tlft_node = dnodes[i];\n\t\t\t\txlft = dnodes[i].x;\n\t\t\t} else if(dnodes[i].x > xnew && dnodes[i].x < xrgt) {\n\t\t\t\trgt_node = dnodes[i];\n\t\t\t\txrgt = dnodes[i].x;\n\t\t\t}\n\t\t}\n\t\tif(lft_node === undefined && rgt_node === undefined) return;\n\t\tlet adjIdx;\n\t\tif(isMovingRight) {\n\t\t\tadjIdx = utils.getIdxByName(opts.dataset, lft_node.data.name);\n\t\t\tadj_node = lft_node;\n\t\t} else {\n\t\t\tadjIdx = utils.getIdxByName(opts.dataset, rgt_node.data.name);\n\t\t\tadj_node = rgt_node;\n\t\t}\n\n\t\t// move node to new location in dataset\n        let newdataset = utils.copy_dataset(pedcache_current(opts));\n        let idx = utils.getIdxByName(opts.dataset, me.name);\n        el_move(newdataset, idx, adjIdx);\n        if(pnrName !== -1 && pnrName !== adj_node.data.name) {\n\t\t\tidx = utils.getIdxByName(newdataset, pnrName);\n\t\t\tel_move(newdataset, idx, adjIdx);\n        }\n        opts.dataset = newdataset;\n        $(document).trigger('rebuild', [opts]);\n\t}\n}\n\n// move element in array\nfunction el_move(arr, old_index, new_index) {\n    if (new_index >= arr.length) {\n        var k = new_index - arr.length + 1;\n        while (k--) {\n            arr.push(undefined);\n        }\n    }\n    arr.splice(new_index, 0, arr.splice(old_index, 1)[0]);\n    return arr;\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// Pedigree Tree Builder\nimport  * as utils from './utils.js';\nimport * as pbuttons from './pbuttons.js';\nimport * as pedcache from './pedcache.js';\nimport * as io from './io.js';\nimport {addWidgets} from './widgets.js';\nimport {init_zoom} from './zoom.js';\nimport {addLabels} from './labels.js';\nimport {init_dragging} from './dragging.js';\n\n\nexport function build(options) {\n\tlet opts = $.extend({ // defaults\n\t\ttargetDiv: 'pedigree_edit',\n\t\tdataset: [ {\"name\": \"m21\", \"display_name\": \"father\", \"sex\": \"M\", \"top_level\": true},\n\t\t\t\t   {\"name\": \"f21\", \"display_name\": \"mother\", \"sex\": \"F\", \"top_level\": true},\n\t\t\t\t   {\"name\": \"ch1\", \"display_name\": \"me\", \"sex\": \"F\", \"mother\": \"f21\", \"father\": \"m21\", \"proband\": true}],\n\t\twidth: 600,\n\t\theight: 400,\n\t\tsymbol_size: 35,\n\t\tzoomSrc: ['wheel', 'button'],\n\t\tzoomIn: 1.0,\n\t\tzoomOut: 1.0,\n\t\tdragNode: true,\n\t\tshowWidgets: true,\n\t\tdiseases: [\t{'type': 'breast_cancer', 'colour': '#F68F35'},\n\t\t\t\t\t{'type': 'breast_cancer2', 'colour': 'pink'},\n\t\t\t\t\t{'type': 'ovarian_cancer', 'colour': '#306430'},\n\t\t\t\t\t{'type': 'pancreatic_cancer', 'colour': '#4289BA'},\n\t\t\t\t\t{'type': 'prostate_cancer', 'colour': '#D5494A'}],\n\t\tlabels: ['stillbirth', ['age', 'yob'], 'alleles',\n\t\t\t\t\t\t\t   ['brca1_gene_test', 'brca2_gene_test', 'palb2_gene_test', 'chek2_gene_test', 'atm_gene_test'],\n\t\t\t\t\t\t\t   ['rad51d_gene_test', 'rad51c_gene_test', 'brip1_gene_test', 'hoxb13_gene_test'],\n\t\t\t\t\t\t\t   ['er_bc_pathology', 'pr_bc_pathology', 'her2_bc_pathology', 'ck14_bc_pathology', 'ck56_bc_pathology']],\n\t\tkeep_proband_on_reset: false,\n\t\tfont_size: '.75em',\n\t\tfont_family: 'Helvetica',\n\t\tfont_weight: 700,\n\t\tbackground: \"#FAFAFA\",\n\t\tnode_background: '#fdfdfd',\n\t\tvalidate: true,\n\t\tDEBUG: false}, options );\n\n\tif ( $( \"#fullscreen\" ).length === 0 ) {\n\t\t// add undo, redo, fullscreen buttons and event listeners once\n\t\tpbuttons.addButtons(opts, rebuild, build);\n\t\tio.addIO(opts);\n\t}\n\n\tif(pedcache.nstore(opts) === -1)\n\t\tpedcache.init_cache(opts);\n\n\tpbuttons.updateButtons(opts);\n\n\t// validate pedigree data\n\tutils.validate_pedigree(opts);\n\t// group top level nodes by partners\n\topts.dataset = group_top_level(opts.dataset);\n\n\tif(opts.DEBUG)\n\t\tutils.print_opts(opts);\n\tlet svg_dimensions = utils.get_svg_dimensions(opts);\n\tlet svg = d3.select(\"#\"+opts.targetDiv)\n\t\t\t\t .append(\"svg:svg\")\n\t\t\t\t .attr(\"width\", svg_dimensions.width)\n\t\t\t\t .attr(\"height\", svg_dimensions.height);\n\n\tsvg.append(\"rect\")\n\t\t.attr(\"width\", \"100%\")\n\t\t.attr(\"height\", \"100%\")\n\t\t.attr(\"rx\", 6)\n\t\t.attr(\"ry\", 6)\n\t\t.style(\"stroke\", \"white\")\n\t\t.style(\"fill\", \"white\") // or none\n\t\t.style(\"stroke-width\", 1);\n\n\tlet ped = svg.append(\"g\")\n\t\t\t .attr(\"class\", \"diagram\");\n\n\tlet top_level = $.map(opts.dataset, function(val, _i){return 'top_level' in val && val.top_level ? val : null;});\n\tlet hidden_root = {\n\t\tname : 'hidden_root',\n\t\tid : 0,\n\t\thidden : true,\n\t\tchildren : top_level\n\t};\n\n\tlet partners = utils.buildTree(opts, hidden_root, hidden_root)[0];\n\n\t// Varun's Note: Build Tree creates\n\t// 1. hidden nodes which are used to generate downward lines to connect children. \n\t// 2. IDs which it assigns to every node, including hidden node. The order of these IDs determines the order of nodes in a given generation.\n\t// The following function, adjustPartnerIds fixes two important issues that are prevalent for partners in particular.\n\t// a) When siblings are present, the partners are rendered on the wrong sides.\n\t// b) When both mztwins have a partner each, line crossing happen.\n\t// If you turn this off, both issues will start occuring again, but the rest of the tree will be fine. \n\t// To understand this logic and code, run this segment with breakpoints and track the values of IDs in hidden_root, partners and opts.dataset\n\n\tutils.adjustPartnerIds(opts, partners);\n\n\tlet root = d3.hierarchy(hidden_root);\n\tutils.roots[opts.targetDiv] = root;\n\n\t// / get score at each depth used to adjust node separation\n\tlet tree_dimensions = utils.get_tree_dimensions(opts);\n\tif(opts.DEBUG)\n\t\tconsole.log('opts.width='+svg_dimensions.width+' width='+tree_dimensions.width+\n\t\t\t\t\t' opts.height='+svg_dimensions.height+' height='+tree_dimensions.height);\n\n\tlet treemap = d3.tree().separation(function(a, b) {\n\t\treturn a.parent === b.parent || a.data.hidden || b.data.hidden ? 1.2 : 2.2;\n\t}).size([tree_dimensions.width, tree_dimensions.height]);\n\n\tlet nodes = treemap(root.sort(function(a, b) { return a.data.id - b.data.id; }));\n\tlet flattenNodes = nodes.descendants();\n\n\t// check the number of visible nodes equals the size of the pedigree dataset\n\t// let vis_nodes = $.map(opts.dataset, function(p, _i){return p.hidden ? null : p;});\n\t// if(vis_nodes.length !== opts.dataset.length) {\n\t// \tthrow utils.create_err('NUMBER OF VISIBLE NODES DIFFERENT TO NUMBER IN THE DATASET');\n\t// }\n\n\t\n\tutils.adjust_coords(opts, nodes, flattenNodes);\n\n\tlet ptrLinkNodes = utils.linkNodes(flattenNodes, partners);\n\tcheck_ptr_links(opts, ptrLinkNodes);   // check for crossing of partner lines\n\n\tlet node = ped.selectAll(\".node\")\n\t\t\t\t  .data(nodes.descendants())\n\t\t\t\t  .enter()\n\t\t\t\t  .append(\"g\")\n\t\t\t\t\t.attr(\"transform\", function(d, _i) {\n\t\t\t\t\t\treturn \"translate(\" + d.x + \",\" + d.y + \")\";\n\t\t\t\t\t});\n\t\n\t\t\t\t\tconst customLineSymbol = {\n\t\t\t\t\t\tdraw(context,) {\n\t\t\t\t\t\t\tconst length = 40\n\t\t\t\t\t\t\tcontext.moveTo(0, 0);\n\t\t\t\t\t\t\tcontext.lineTo(-length/2, 0);\n\t\t\t\t\t\t\tcontext.lineTo(length/2, 0);\n\t\t\t\t\t\t\t}};\n\t// provide a border to the node\n\tnode.filter(function (d) {return !d.data.hidden;})\n\t\t.append(\"path\")\n\t\t.attr(\"shape-rendering\", \"geometricPrecision\")\n\t\t.attr(\"transform\", function(d) {return !has_gender(d.data.sex) && !(d.data.miscarriage || d.data.termination) ? \"rotate(45)\" : \"\";})\n\t\t.attr(\"d\", d3.symbol().size(function(_d) { return (opts.symbol_size * opts.symbol_size) + 2;})\n\t\t\t\t.type(function(d) {\n\t\t\t\t\tif(d.data.noChild){\n                        return customLineSymbol\n                    }\n\t\t\t\t\tif(d.data.miscarriage || d.data.termination)\n\t\t\t\t\t\treturn d3.symbolTriangle;\n\t\t\t\t\treturn d.data.sex === \"F\" ? d3.symbolCircle : d3.symbolSquare;}))\n\t\t.style(\"stroke\", function (d) {\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \"#303030\" : \"black\";\n\t\t})\n\t\t.style(\"stroke-width\", function (d) {\n\t\t\tif(d.data.proband){\n\t\t\t\treturn \".55em\";\n\t\t\t}\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \".4em\" : \".3em\";\n\t\t})\n\t\t.style(\"stroke-dasharray\", function (d) {return !d.data.exclude ? null : (\"3, 3\");})\n\t\t.style(\"fill\", \"none\");\n\n\t// set a clippath\n\tnode.filter(function (d) {return !(d.data.hidden && !opts.DEBUG);})\n\t\t.append(\"clipPath\")\n\t\t.attr(\"id\", function (d) {return d.data.name;}).append(\"path\")\n\t\t.attr(\"class\", \"node\")\n\t\t.attr(\"transform\", function(d) {return !has_gender(d.data.sex) && !(d.data.miscarriage || d.data.termination) ? \"rotate(45)\" : \"\";})\n\t\t.attr(\"d\", d3.symbol().size(function(d) {\n\t\t\t\tif (d.data.hidden)\n\t\t\t\t\treturn opts.symbol_size * opts.symbol_size / 5;\n\t\t\t\treturn opts.symbol_size * opts.symbol_size;\n\t\t\t})\n\t\t\t.type(function(d) {\n\t\t\t\tif(d.data.noChild){\n\t\t\t\t\treturn customLineSymbol\n\t\t\t\t}\n\t\t\t\tif(d.data.miscarriage || d.data.termination)\n\t\t\t\t\treturn d3.symbolTriangle;\n\t\t\t\treturn d.data.sex === \"F\" ? d3.symbolCircle :d3.symbolSquare;}));\n\n\t// pie plots for disease colours\n\tlet pienode = node.filter(function (d) {return !(d.data.hidden && !opts.DEBUG);}).selectAll(\"pienode\")\n\t   .data(function(d) {\t \t\t// set the disease data for the pie plot\n\t\t   let ncancers = 0;\n\t\t   let cancers = $.map(opts.diseases, function(_val, i){\n\t\t\t   if(utils.prefixInObj(opts.diseases[i].type, d.data)) {ncancers++; return 1;} else return 0;\n\t\t   });\n\t\t   if(ncancers === 0) cancers = [1];\n\t\t   return [$.map(cancers, function(val, _i){\n\t\t\t   return {'cancer': val, 'ncancers': ncancers, 'id': d.data.name,\n\t\t\t\t\t\t'sex': d.data.sex, 'proband': d.data.proband, 'hidden': d.data.hidden,\n\t\t\t\t\t\t'affected': d.data.affected,\n\t\t\t\t\t\t'exclude': d.data.exclude};})];\n\t   })\n\t   .enter()\n\t\t.append(\"g\");\n\n\tpienode.selectAll(\"path\")\n\t\t.data(d3.pie().value(function(d) {return d.cancer;}))\n\t\t.enter().append(\"path\")\n\t\t\t.attr(\"clip-path\", function(d) {return \"url(#\"+d.data.id+\")\";}) // clip the rectangle\n\t\t\t.attr(\"class\", \"pienode\")\n\t\t\t.attr(\"d\", d3.arc().innerRadius(0).outerRadius(opts.symbol_size))\n\t\t\t.style(\"fill\", function(d, i) {\n\t\t\t\tif(d.data.exclude)\n\t\t\t\t\treturn 'lightgrey';\n\t\t\t\tif(d.data.ncancers === 0) {\n\t\t\t\t\tif(d.data.affected)\n\t\t\t\t\t\treturn 'darkgrey';\n\t\t\t\t\treturn opts.node_background;\n\t\t\t\t}\n\t\t\t\treturn opts.diseases[i].colour;\n\t\t\t});\n\n\t// adopted in/out brackets\n\tnode.filter(function (d) {return !d.data.hidden && (d.data.adopted_in || d.data.adopted_out);})\n\t\t.append(\"path\")\n\t\t.attr(\"d\", function(_d) {\n\t\t\tlet dx = -(opts.symbol_size * 0.66);\n\t\t\tlet dy = -(opts.symbol_size * 0.64);\n\t\t\tlet indent = opts.symbol_size/4;\n\t\t\treturn get_bracket(dx, dy, indent, opts)+get_bracket(-dx, dy, -indent, opts);\n\t\t\t})\n\t\t.style(\"stroke\", function (d) {\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \"#303030\" : \"grey\";\n\t\t})\n\t\t.style(\"stroke-width\", function (_d) {\n\t\t\treturn \".1em\";\n\t\t})\n\t\t.style(\"stroke-dasharray\", function (d) {return !d.data.exclude ? null : (\"3, 3\");})\n\t\t.style(\"fill\", \"none\");\n\n\n\t// alive status = 0; dead status = 1\n\tnode.filter(function (d) {return d.data.status === \"1\" || d.data.status === 1;})\n\t\t.append('line')\n\t\t\t.style(\"stroke\", \"black\")\n\t\t\t.style(\"stroke-width\", \"0.20em\")\n\t\t\t.attr(\"x1\", function(_d, _i) {return -0.6*opts.symbol_size;})\n\t\t\t.attr(\"y1\", function(_d, _i) {return 0.6*opts.symbol_size;})\n\t\t\t.attr(\"x2\", function(_d, _i) {return 0.6*opts.symbol_size;})\n\t\t\t.attr(\"y2\", function(_d, _i) {return -0.6*opts.symbol_size;});\n\n/*\n * let warn = node.filter(function (d) { return (!d.data.age || !d.data.yob) && !d.data.hidden; }).append(\"text\") .attr('font-family', 'FontAwesome')\n * .attr(\"x\", \".25em\") .attr(\"y\", -(0.4 * opts.symbol_size), -(0.2 * opts.symbol_size)) .html(\"\\uf071\"); warn.append(\"svg:title\").text(\"incomplete\");\n */\n\t// add display names and labels defined by opts.labels\n\taddLabels(opts, node);\n\n\t//\n\tif(opts.showWidgets) addWidgets(opts, node);\n\n\t// links between partners\n\tlet clash_depth = {};\n\n\t// get path looping over node(s)\n\tlet draw_path = function(clash, dx, dy1, dy2, parent_node, cshift) {\n\t\tlet extend = function(i, l) {\n\t\t\tif(i+1 < l)   // && Math.abs(clash[i] - clash[i+1]) < (opts.symbol_size*1.25)\n\t\t\t\treturn extend(++i);\n\t\t\treturn i;\n\t\t};\n\t\tlet path = \"\";\n\t\tfor(let j=0; j<clash.length; j++) {\n\t\t\tlet k = extend(j, clash.length);\n\t\t\tlet dx1 = clash[j] - dx - cshift;\n\t\t\tlet dx2 = clash[k] + dx + cshift;\n\t\t\tif(parent_node.x > dx1 && parent_node.x < dx2)\n\t\t\t\tparent_node.y = dy2;\n\n\t\t\tpath +=\n            \"L\" + (dx1 - 25) + \",\" + (dy1 - cshift) +\n            \"Q\" + (dx1 - 5) + \",\" + (dy1 - cshift) + \" \" + (dx1 - 5) + \",\" + (dy2 - cshift) +\n            \"L\" + (dx1 - 5) + \",\" + (dy2 - cshift - 10) +\n            \"Q\" + (dx1 - 5) + \",\" + (dy2 - cshift - 20) + \" \" + (dx1 + 5) + \",\" + (dy2 - cshift - 20) +\n            \"L\" + (dx2 - 2) + \",\" + (dy2 - cshift - 20) +\n            \"Q\" + (dx2 + 8) + \",\" + (dy2 - cshift - 20) + \" \" + (dx2 + 8) + \",\" + (dy2 - cshift - 10) +\n            \"L\" + (dx2 + 8) + \",\" + (dy2 - cshift) +\n            \"Q\" + (dx2 + 8) + \",\" + (dy1 - cshift) + \" \" + (dx2 + 28) + \",\" + (dy1 - cshift) +\n            \"L\" + (dx2 + 40) + \",\" + (dy1 - cshift);\n        \n\t\t\tj = k;\n\t\t}\n\t\treturn path;\n\t}\n\n\n\tpartners = ped.selectAll(\".partner\")\n\t\t.data(ptrLinkNodes)\n\t\t.enter()\n\t\t\t.insert(\"path\", \"g\")\n\t\t\t.attr(\"fill\", \"none\")\n\t\t\t.attr(\"stroke\", \"#000\")\n\t\t\t.attr(\"stroke-width\", \"0.2em\")\n\t\t\t.attr(\"shape-rendering\", \"auto\")\n\t\t\t.attr('d', function(d, _i) {\n\t\t\t\tlet node1 = utils.getNodeByName(flattenNodes, d.mother.data.name);\n\t\t\t\tlet node2 = utils.getNodeByName(flattenNodes, d.father.data.name);\n\t\t\t\tlet consanguity = utils.consanguity(node1, node2, opts);\n\t\t\t\tlet divorced = (d.mother.data.divorced &&  d.mother.data.divorced === d.father.data.name);\n\n\t\t\t\tlet x1 = (d.mother.x < d.father.x ? d.mother.x : d.father.x);\n\t\t\t\tlet x2 = (d.mother.x < d.father.x ? d.father.x : d.mother.x);\n\t\t\t\tlet dy1 = d.mother.y;\n\t\t\t\tlet dy2, dx, parent_node;\n\n\t\t\t\t// identify clashes with other nodes at the same depth\n\t\t\t\tlet clash = check_ptr_link_clashes(opts, d);\n\t\t\t\tlet path = \"\";\n\t\t\t\tif(clash) {\n\t\t\t\t\tif(d.mother.depth in clash_depth)\n\t\t\t\t\t\tclash_depth[d.mother.depth] += 4;\n\t\t\t\t\telse\n\t\t\t\t\t\tclash_depth[d.mother.depth] = 4;\n\n\t\t\t\t\tdy1 -= clash_depth[d.mother.depth];\n\t\t\t\t\tdx = clash_depth[d.mother.depth] + (opts.symbol_size/2) + 2;\n\n\t\t\t\t\tlet parent_nodes = d.mother.data.parent_node;\n\t\t\t\t\tlet parent_node_name = parent_nodes[0];\n\t\t\t\t\tfor(let ii=0; ii<parent_nodes.length; ii++) {\n\t\t\t\t\t\tif(parent_nodes[ii].father.name === d.father.data.name &&\n\t\t\t\t\t\t   parent_nodes[ii].mother.name === d.mother.data.name)\n\t\t\t\t\t\t\tparent_node_name = parent_nodes[ii].name;\n\t\t\t\t\t}\n\t\t\t\t\tparent_node = utils.getNodeByName(flattenNodes, parent_node_name);\n\t\t\t\t\tparent_node.y = dy1; // adjust hgt of parent node\n\t\t\t\t\tclash.sort(function (a,b) {return a - b;});\n\n\t\t\t\t\tdy2 = (dy1-(opts.symbol_size/2)-3);\n\t\t\t\t\tpath = draw_path(clash, dx, dy1, dy2, parent_node, 0);\n\t\t\t\t}\n\n\t\t\t\tlet divorce_path = \"\";\n\t\t\t\tif(divorced && !clash)\n\t\t\t\t\tdivorce_path = \"M\" + (x1+((x2-x1)*.66)+6) + \",\" + (dy1-14) +\n\t\t\t\t\t\t\t\t   \"L\"+  (x1+((x2-x1)*.66)-6) + \",\" + (dy1+14) +\n\t\t\t\t\t\t\t\t   \"M\" + (x1+((x2-x1)*.66)+13) + \",\" + (dy1-14) +\n\t\t\t\t\t\t\t\t   \"L\"+  (x1+((x2-x1)*.66)+1)  + \",\" + (dy1+14);\n\t\t\t\tif(consanguity) {  // consanguinous, draw double line between partners\n\t\t\t\t\tdy1 = (d.mother.x < d.father.x ? d.mother.y : d.father.y);\n\t\t\t\t\tdy2 = (d.mother.x < d.father.x ? d.father.y : d.mother.y);\n\n\t\t\t\t\tlet cshift = 9;\n\t\t\t\t\tif(Math.abs(dy1-dy2) > 0.1) {\t  // DIFFERENT LEVEL\n\t\t\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + \"L\" + x2 + \",\" + dy2 +\n\t\t\t\t\t\t\t\t\"M\" + x1 + \",\" + (dy1 - cshift) + \"L\" + x2 + \",\" + (dy2 - cshift);\n\t\t\t\t\t} else {\t\t\t\t\t\t   // SAME LEVEL\n\t\t\t\t\t\tlet path2 = (clash ? draw_path(clash, dx, dy1, dy2, parent_node, cshift) : \"\");\n\t\t\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + path + \"L\" + x2 + \",\" + dy1 +\n\t\t\t\t\t\t\t\t\"M\" + x1 + \",\" + (dy1 - cshift) + path2 + \"L\" + x2 + \",\" + (dy1 - cshift) + divorce_path;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + path + \"L\" + x2 + \",\" + dy1 + divorce_path;\n\t\t\t});\n\n\t// links to children\n\tped.selectAll(\".link\")\n\t\t.data(root.links(nodes.descendants()))\n\t\t.enter()\n\t\t\t.filter(function (d) {\n\t\t\t\t// filter unless debug is set\n\t\t\t\treturn (opts.DEBUG ||\n\t\t\t\t\t\t(d.target.data.noparents === undefined && d.source.parent !== null && !d.target.data.hidden));\n\t\t\t})\n\t\t\t.insert(\"path\", \"g\")\n\t\t\t.attr(\"fill\", \"none\")\n\t\t\t.attr(\"stroke-width\", function(d, _i) {\n\t\t\t\tif(d.target.data.noparents !== undefined || d.source.parent === null || d.target.data.hidden)\n\t\t\t\t\treturn 1;\n\t\t\t\treturn (opts.DEBUG ? 2 : 1);\n\t\t\t})\n\t\t\t.attr(\"stroke\", function(d, _i) {\n\t\t\t\tif(d.target.data.noparents !== undefined || d.source.parent === null || d.target.data.hidden)\n\t\t\t\t\treturn 'pink';\n\t\t\t\treturn \"#000\";\n\t\t\t})\n\t\t\t.attr(\"stroke-dasharray\", function(d, _i) {\n\t\t\t\tif(!d.target.data.adopted_in) return null;\n\t\t\t\tlet dash_len = Math.abs(d.source.y-((d.source.y + d.target.y) / 2));\n\t\t\t\tlet dash_array = [dash_len, 0, Math.abs(d.source.x-d.target.x), 0];\n\t\t\t\tlet twins = utils.getTwins(opts.dataset, d.target.data);\n\t\t\t\tif(twins.length >= 1) dash_len = dash_len * 3;\n\t\t\t\tfor(let usedlen = 0; usedlen < dash_len; usedlen += 10)\n\t\t\t\t\t$.merge(dash_array, [5, 5]);\n\t\t\t\treturn dash_array;\n\t\t\t})\n\t\t\t.attr(\"shape-rendering\", function(d, _i) {\n\t\t\t\tif(d.target.data.mztwin || d.target.data.dztwin)\n\t\t\t\t\treturn \"geometricPrecision\";\n\t\t\t\treturn \"auto\";\n\t\t\t})\n\t\t\t.attr(\"d\", function(d, _i) {\n\t\t\t\tif(d.target.data.mztwin || d.target.data.dztwin) {\n\t\t\t\t\t// get twin position\n\t\t\t\t\tlet twins = utils.getTwins(opts.dataset, d.target.data);\n\t\t\t\t\tif(twins.length >= 1) {\n\t\t\t\t\t\tlet twinx = 0;\n\t\t\t\t\t\tlet xmin = d.target.x;\n\t\t\t\t\t\t//let xmax = d.target.x;\n\t\t\t\t\t\tfor(let t=0; t<twins.length; t++) {\n\t\t\t\t\t\t\tlet thisx = utils.getNodeByName(flattenNodes, twins[t].name).x;\n\t\t\t\t\t\t\tif(xmin > thisx) xmin = thisx;\n\t\t\t\t\t\t\t//if(xmax < thisx) xmax = thisx;\n\t\t\t\t\t\t\ttwinx += thisx;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet xmid = ((d.target.x + twinx) / (twins.length+1));\n\t\t\t\t\t\tlet ymid = ((d.source.y + d.target.y) / 2);\n\n\t\t\t\t\t\tlet xhbar = \"\";\n\t\t\t\t\t\tif(xmin === d.target.x && d.target.data.mztwin) {\n\t\t\t\t\t\t\t// horizontal bar for mztwins\n\t\t\t\t\t\t\tlet xx = (xmid + d.target.x)/2;\n\t\t\t\t\t\t\tlet yy = (ymid + (d.target.y-(opts.symbol_size/2)))/2;\n\t\t\t\t\t\t\txhbar = \"M\" + xx + \",\" + yy +\n\t\t\t\t\t\t\t\t\t\"L\" + (xmid + (xmid-xx)) + \" \" + yy;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn \"M\" + (d.source.x) + \",\" + (d.source.y ) +\n\t\t\t\t\t\t\t   \"V\" + ymid +\n\t\t\t\t\t\t\t   \"H\" + xmid +\n\t\t\t\t\t\t\t   \"L\" + (d.target.x) + \" \" + (d.target.y-(opts.symbol_size/2)) +\n\t\t\t\t\t\t\t   xhbar;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif(d.source.data.mother) {   // check parents depth to see if they are at the same level in the tree\n\t\t\t\t\tlet ma = utils.getNodeByName(flattenNodes, d.source.data.mother.name);\n\t\t\t\t\tlet pa = utils.getNodeByName(flattenNodes, d.source.data.father.name);\n\n\t\t\t\t\tif(ma.depth !== pa.depth) {\n\t\t\t\t\t\treturn \"M\" + (d.source.x) + \",\" + ((ma.y + pa.y) / 2) +\n\t\t\t\t\t\t\t   \"H\" + (d.target.x) +\n\t\t\t\t\t\t\t   \"V\" + (d.target.y);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn \"M\" + (d.source.x) + \",\" + (d.source.y) +\n\t\t\t\t\t   \"V\" + ((d.source.y + d.target.y) / 2) +\n\t\t\t\t\t   \"H\" + (d.target.x) +\n\t\t\t\t\t   \"V\" + (d.target.y);\n\t\t\t});\n\n\t// draw proband arrow\n\tlet probandIdx  = utils.getProbandIndex(opts.dataset);\n\tif(typeof probandIdx !== 'undefined') {\n\t\tlet probandNode = utils.getNodeByName(flattenNodes, opts.dataset[probandIdx].name);\n\t\tlet triid = \"triangle\"+utils.makeid(3);\n\t\tped.append(\"svg:defs\").append(\"svg:marker\")\t// arrow head\n\t\t\t.attr(\"id\", triid)\n\t\t\t.attr(\"refX\", 6)\n\t\t\t.attr(\"refY\", 6)\n\t\t\t.attr(\"markerWidth\", 20)\n\t\t\t.attr(\"markerHeight\", 20)\n\t\t\t.attr(\"orient\", \"auto\")\n\t\t\t.append(\"path\")\n\t\t\t.attr(\"d\", \"M 0 0 12 6 0 12 3 6\")\n\t\t\t.style(\"fill\", \"black\");\n\n\t\tped.append(\"line\")\n\t\t\t.attr(\"x1\", probandNode.x-(opts.symbol_size/0.7))\n\t\t\t.attr(\"y1\", probandNode.y+(opts.symbol_size/1.4))\n\t\t\t.attr(\"x2\", probandNode.x-(opts.symbol_size/1.4))\n\t\t\t.attr(\"y2\", probandNode.y+(opts.symbol_size/4))\n\t\t\t.attr(\"stroke-width\", 1)\n\t\t\t.attr(\"stroke\", \"black\")\n\t\t\t.attr(\"marker-end\", \"url(#\"+triid+\")\");\n\t}\n\n\t// drag and zoom\n\tinit_zoom(opts, svg);\n\t// drag nodes\n\tif(opts.dragNode) init_dragging(opts, node);\n\treturn opts;\n}\n\nfunction has_gender(sex) {\n\treturn sex === \"M\" || sex === \"F\";\n}\n\n//adopted in/out brackets\nfunction get_bracket(dx, dy, indent, opts) {\n\treturn \t\"M\" + (dx+indent) + \",\" + dy +\n\t\t\t\"L\" + dx + \" \" + dy +\n\t\t\t\"L\" + dx + \" \" + (dy+(opts.symbol_size *  1.28)) +\n\t\t\t\"L\" + dx + \" \" + (dy+(opts.symbol_size *  1.28)) +\n\t\t\t\"L\" + (dx+indent) + \",\" + (dy+(opts.symbol_size *  1.28))\n}\n\n// check for crossing of partner lines\nfunction check_ptr_links(opts, ptrLinkNodes){\n\tfor(let a=0; a<ptrLinkNodes.length; a++) {\n\t\tlet clash = check_ptr_link_clashes(opts, ptrLinkNodes[a]);\n\t\tif(clash)\n\t\t\tconsole.log(\"CLASH :: \"+ptrLinkNodes[a].mother.data.name+\" \"+ptrLinkNodes[a].father.data.name, clash);\n\t}\n}\n\n\nexport function check_ptr_link_clashes(opts, anode) {\n\tlet root = utils.roots[opts.targetDiv];\n\tlet flattenNodes = utils.flatten(root);\n\tlet mother, father;\n\tif('name' in anode) {\n\t\tanode = utils.getNodeByName(flattenNodes, anode.name);\n\t\tif(!('mother' in anode.data))\n\t\t\treturn null;\n\t\tmother = utils.getNodeByName(flattenNodes, anode.data.mother);\n\t\tfather = utils.getNodeByName(flattenNodes, anode.data.father);\n\t} else {\n\t\tmother = anode.mother;\n\t\tfather = anode.father;\n\t}\n\n\tlet x1 = (mother.x < father.x ? mother.x : father.x);\n\tlet x2 = (mother.x < father.x ? father.x : mother.x);\n\tlet dy = mother.y;\n\n\t// identify clashes with other nodes at the same depth\n\tlet clash = $.map(flattenNodes, function(bnode, _i){\n\t\treturn !bnode.data.hidden &&\n\t\t\t\tbnode.data.name !== mother.data.name &&  bnode.data.name !== father.data.name &&\n\t\t\t\tbnode.y === dy && bnode.x > x1 && bnode.x < x2 ? bnode.x : null;\n\t});\n\treturn clash.length > 0 ? clash : null;\n}\n\n// group top_level nodes by their partners\nfunction group_top_level(dataset) {\n\t// let top_level = $.map(dataset, function(val, i){return 'top_level' in val && val.top_level ? val : null;});\n\t// calculate top_level nodes\n\tfor(let i=0;i<dataset.length;i++) {\n\t\tif(utils.getDepth(dataset, dataset[i].name) === 2)\n\t\t\tdataset[i].top_level = true;\n\t}\n\n\tlet top_level = [];\n\tlet top_level_seen = [];\n\tfor(let i=0;i<dataset.length;i++) {\n\t\tlet node = dataset[i];\n\t\tif('top_level' in node && $.inArray(node.name, top_level_seen) === -1){\n\t\t\ttop_level_seen.push(node.name);\n\t\t\ttop_level.push(node);\n\t\t\tlet ptrs = utils.get_partners(dataset, node);\n\t\t\tfor(let j=0; j<ptrs.length; j++){\n\t\t\t\tif($.inArray(ptrs[j], top_level_seen) === -1) {\n\t\t\t\t\ttop_level_seen.push(ptrs[j]);\n\t\t\t\t\ttop_level.push(utils.getNodeByName(dataset, ptrs[j]));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tlet newdataset = $.map(dataset, function(val, _i){return 'top_level' in val && val.top_level ? null : val;});\n\tfor (let i = top_level.length; i > 0; --i)\n\t\tnewdataset.unshift(top_level[i-1]);\n\treturn newdataset;\n}\n\nexport function rebuild(opts) {\n\t$(\"#\"+opts.targetDiv).empty();\n\tpedcache.init_cache(opts);\n\topts.editClicked = true;\n\ttry {\n\t\tbuild(opts);\n\t} catch(e) {\n\t\tconsole.error(e);\n\t\tthrow e;\n\t}\n\n\ttry {\n\t\ttemplates.update(opts);\t\t// eslint-disable-line no-undef\n\t} catch(e) {\n\t\t// templates not declared\n\t}\n}\n\n$(document).on('rebuild', function(_e, opts){\n\trebuild(opts);\n})\n\n$(document).on('build', function(_e, opts){\n\tbuild(opts);\n})\n","/**\n/* Functions used by 3rd party apps\n/*\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\nimport {copy_dataset, getNodeByName, getProbandIndex} from './utils.js';\nimport {rebuild} from './pedigree.js';\nimport {delete_node_dataset} from './widgets.js';\nimport {addchild} from './widgets.js';\nimport {syncTwins} from './twins.js';\nimport * as pedcache from './pedcache.js';\n\n\n// Set or remove node attributes.\n// If a value is not provided the attribute is removed.\n// 'key' can be a list of keys or a single key.\nexport function node_attr(opts, name, keys, value){\n\tlet newdataset = copy_dataset(pedcache.current(opts));\n\tlet node = getNodeByName(newdataset, name);\n\tif(!node){\n\t\tconsole.warn(\"No person defined\");\n\t\treturn;\n\t}\n\n\tif(!$.isArray(keys)) {\n\t\tkeys = [keys];\n\t}\n\n\tif(value) {\n\t\tfor(let i=0; i<keys.length; i++) {\n\t\t\tlet k = keys[i];\n\t\t\t//console.log('VALUE PROVIDED', k, value, (k in node));\n\t\t\tif(k in node && keys.length === 1) {\n\t\t\t\tif(node[k] === value)\n\t\t\t\t\treturn;\n\t\t\t\ttry {\n\t\t\t\t   if(JSON.stringify(node[k]) === JSON.stringify(value))\n\t\t\t\t\t   return;\n\t\t\t\t} catch(e){\n\t\t\t\t\t// continue regardless of error\n\t\t\t\t}\n\t\t\t}\n\t\t\tnode[k] = value;\n\t\t}\n\t} else {\n\t\tlet found = false;\n\t\tfor(let i=0; i<keys.length; i++) {\n\t\t\tlet k = keys[i];\n\t\t\t//console.log('NO VALUE PROVIDED', k, (k in node));\n\t\t\tif(k in node) {\n\t\t\t\tdelete node[k];\n\t\t\t\tfound = true;\n\t\t\t}\n\t\t}\n\t\tif(!found)\n\t\t\treturn;\n\t}\n\tsyncTwins(newdataset, node);\n\topts.dataset = newdataset;\n\trebuild(opts);\n}\n\n// Set or remove proband attributes.\n// If a value is not provided the attribute is removed from the proband.\n// 'key' can be a list of keys or a single key.\nexport function proband_attr(opts, keys, value){\n\tlet proband = opts.dataset[ getProbandIndex(opts.dataset) ];\n\tnode_attr(opts, proband.name, keys, value);\n}\n\n// add a child to the proband; giveb sex, age, yob and breastfeeding months (optional)\nexport function proband_add_child(opts, sex, age, yob, breastfeeding){\n\tlet newdataset = copy_dataset(pedcache.current(opts));\n\tlet proband = newdataset[ getProbandIndex(newdataset) ];\n\tif(!proband){\n\t\tconsole.warn(\"No proband defined\");\n\t\treturn;\n\t}\n\tlet newchild = addchild(newdataset, proband, sex, 1)[0];\n\tnewchild.age = age;\n\tnewchild.yob = yob;\n\tif(breastfeeding !== undefined)\n\t\tnewchild.breastfeeding = breastfeeding;\n\topts.dataset = newdataset;\n\trebuild(opts);\n\treturn newchild.name;\n}\n\n// delete node using the name\nexport function delete_node_by_name(opts, name){\n\tfunction onDone(opts, dataset) {\n\t\t// assign new dataset and rebuild pedigree\n\t\topts.dataset = dataset;\n\t\trebuild(opts);\n\t}\n\tlet newdataset = copy_dataset(pedcache.current(opts));\n\tlet node = getNodeByName(pedcache.current(opts), name);\n\tif(!node){\n\t\tconsole.warn(\"No node defined\");\n\t\treturn;\n\t}\n\tdelete_node_dataset(newdataset, node, opts, onDone);\n}\n"],"names":["max_limit","dict_cache","has_browser_storage","opts","store_type","undefined","mod","localStorage","setItem","removeItem","e","get_prefix","btn_target","get_arr","get_browser_store","item","getItem","sessionStorage","set_browser_store","name","clear_pedigree_data","prefix","store","items","i","length","key","indexOf","push","get_count","count","set_count","init_cache","dataset","JSON","stringify","console","warn","nstore","current","parse","previous","nst","next","parseInt","clear","clear_browser_store","setposition","x","y","zoom","zoomName","getposition","pos","parseFloat","it","arr","roots","isIE","ua","navigator","userAgent","isEdge","match","create_err","err","error","Error","validate_pedigree","validate","DEBUG","log","call","this","display_name","uniquenames","famids","p","hidden","mother","father","midx","getIdxByName","fidx","sex","$","inArray","famid","join","uc","unconnected","copy_dataset","id","sort","a","b","disallowed","newdataset","obj","prefixInObj","found","each","k","_n","messages","title","msg","onConfirm","dialog","modal","width","buttons","Yes","No","open","parent","find","css","background","color","border","text","click","errModalEl","document","getElementById","modalTitle","querySelector","modalBodyInput","removeClass","on","off","cancelBtn","hasClass","addClass","textContent","showDialog","makeid","len","possible","charAt","Math","floor","random","buildTree","person","root","partnerLinks","children","getChildren","nodes","flatten","partners","_i","child","_j","m","getNodeByName","f","contains_parent","merge","ptr","setChildrenId","gp","gmidx","gfidx","get_grandparents_idx","updateParent","parent_node","mztwin","dztwins","twins","getTwins","twin","dztwin","isProband","attr","combineArrays","arr1","arr2","include_children","connected","get_partners","getAllChildren","_child_idx","anode","ptrs","bnode","target","getProbandIndex","change","ii","nconnect","_idx","has_parent","noparents","names","map","val","proband","sibs","getSiblings","twin_type","getAllSiblings","getAdoptedSiblings","getDepth","idx","depth","top_level","getNodesAtDepth","fnodes","exclude_names","data","linkNodes","flattenNodes","links","ancestors","node","recurse","consanguity","node1","node2","ancestors1","ancestors2","names1","ancestor","names2","_index","flat","forEach","adjust_coords","xReal","nReal","xmid","parentFirst","parentSecond","intersectionThreshold","clashInit","check_ptr_link_clashes","clashInitSize","separation","clash","clashSize","overlap","descendants","diff","child1","child2","descendantsNames","descendant","nodesOverlap","adjustConnection","adjustPartnerIds","partner","otherPartner","partnerFirst","partnerSecond","parentId","parentNode","filter","additionalPartner","otherTwin","twinIdDiff","additionalPartnerNode","fixIdGaps","visibleSiblings","sibling","leftCount","sideWithHigherCount","noparentsPartner","otherPartnerPartner","swap","tempId","swapPartnerIds","xnew","n","abs","symbol_size","print_opts","remove","append","is_fullscreen","fullscreenElement","mozFullScreenElement","webkitFullscreenElement","msFullscreenElement","get_svg_dimensions","window","innerWidth","height","innerHeight","get_tree_dimensions","svg_dimensions","maxscore","generation","score","max_depth","Object","keys","string","toUpperCase","slice","pedcache","time","d","Date","getHours","getMinutes","getSeconds","getFullYear","getMonth","getDate","is_proband","results","RegExp","exec","location","href","age","yob","status","year","sum","zm","init_zoom","svg","xi","yi","d3","scaleExtent","zoomIn","zoomOut","zoomSrc","type","button","transform","t","ped","select","targetDiv","zooming","xyk","zoomIdentity","scale","translate","btn_zoom","transition","duration","scaleBy","scale_to_fit","get_bounds","wid","xmax","xmin","hgt","ymax","ymin","get_dimensions","size","w","clientWidth","h","clientHeight","get_svg_size","max","get_pedigree_center","translateTo","scaleTo","Number","MAX_VALUE","sym","selectAll","g_elm","dg","getBBox","text_elements","_groups","txtsize","getTextSize","firstChild","nodeValue","font_family","font_size","getNodeSize","txt","font","fontSize","o","position","float","visibility","appendTo","s","addButtons","options","extend","btns","fa","lis","_e","local_dataset","trigger","setTimeout","exitFullscreen","msExitFullscreen","mozCancelFullScreen","webkitExitFullscreen","requestFullscreen","documentElement","mozRequestFullScreen","webkitRequestFullscreen","Element","ALLOW_KEYBOARD_INPUT","msRequestFullscreen","timeoutId","setInterval","clearInterval","stopPropagation","empty","reset","addPbuttonEvents","keep_proband_on_reset","selected","cancers","breast_cancer","breast_cancer2","ovarian_cancer","prostate_cancer","pancreatic_cancer","genetic_test1","genetic_test2","genetic_test4","pathology_tests","RISK_FACTOR_STORE","hasInput","trim","isEmpty","myObj","prototype","hasOwnProperty","get_prs_values","prs","alpha","zscore","percent","getGeneticTest","version","readCanRisk","boadicea_lines","lines","split","hdr","regexp","gt","ncol","ln","ops","j","replace","delim","indi","cancer","diagnosis_age","ashkenazi","gene_test","result","path_test","unshift","localeCompare","get_mdensity","mdensity","test","get_pedigree","meta","isanon","arguments","ethnicity","isInteger","toString","excl","exclude","probandIdx","pedigree_util","menarche","get_risk_factor","parity","first_birth","oc_use","mht_use","bmi","alcohol","menopause","tl","endo","cmsg","risk_factor_name","store_name","pathname","el","pop","get_surgical_ops","breast_cancer_prs","ovarian_cancer_prs","prostate_cancer_prs","addIO","files","reader","FileReader","onload","load_data","onerror","event","utils","code","readAsText","value","load","content","save_file","save","print","get_printable_svg","svg_download","img_download","copyStylesInline","destinationNode","sourceNode","containerElements","cd","childNodes","tagName","style","currentStyle","getComputedStyle","st","setProperty","getPropertyValue","resolution","img_type","deferred","svg2img","when","apply","done","grep","html","img","write","createElement","download","body","appendChild","removeChild","deferred_name","defaults","iscanvg","copy","get","cloneNode","Deferred","svgStr","XMLSerializer","serializeToString","imgsrc","btoa","unescape","encodeURIComponent","canvas","context","getContext","fillStyle","fillRect","drawImage","resolve","toDataURL","clearRect","src","promise","unique_urls","svg_html","matches","str","myRegexp","c","lastIndex","index","getMatches","quote","m1","m2","newval","svg_div","clone","a4","constructor","Array","cssFiles","printWindow","headContent","close","focus","filename","file","Blob","msSaveOrOpenBlob","url","URL","createObjectURL","revokeObjectURL","canrisk_validation","risk_factors","readBoadiceaV4","canrisk_data","readCanRiskFile","to_process","process_ped","readLinkage","err1","message","acc_FamHist_ticked","acc_FamHist_Leave","RESULT","FLAG_FAMILY_MODAL","err3","err2","affected","alleles","_cancer","getLevel","updated","l","prt_lvl","level","fix_n_balance_levels","max_level","pidx","getPartnerIdx","update_parents_level","parents","ma","pa","svg_node","d3obj","getUniqueTwinID","mz","splice","syncTwins","d1","d2","updateStatus","update_ashkn","is","pedcache_current","switches","iswitch","update_cancer_by_sex","approx_diagnosis_age","substring","round5","checked","tres","hoxb13_result","valid","update_diagnosis_age_widget","prop","hide","show","ovarian_cancer_diagnosis_age","closest","prostate_cancer_diagnosis_age","x1","x2","round","dragging","last_mouseover","addWidgets","popup_selection","square_title","circle_title","add_person","classed","datum","addsibling","addchild","highlight","dragstart","dragstop","_d","setLineDragPosition","drag","sourceEvent","dx","dy","ynew","drag_handle","fx","fy","widgets","addpartner","addparents","delete","styles","fill","edit","settings","widget","opt","changeFlag","handleCancelClose","minWidth","class","autoOpen","table","last_name","yod","age_of_death","capitaliseFirstLetter","diseases","v","disease_colour","colour","additional_information","openEditDialog","delete_node_dataset","onDone","ctrlKey","nodeclick","xcoord","pointer","ycoord","y1","y2","nchild","ptr_name","twin_id","newchildren","add_lhs","newbie","setMzTwin","flat_tree","tree_node","pid","node_mother","node_father","node_sibs","rid","lid","sid","faidx","moidx","tmpfa","orphans","nid","oid","oidx","ptr_node","tree_partner","lhs","adjacent_nodes","excludes","lhs_node","rhs_node","dnodes","deletes","d3node","ps","children_names","adj","del","twin_types","checkTwins","newopts","addLabels","addLabel","emVal","getPx","ilab","labels","label","isArray","ypos","get_text","disease","dis","this_label","vars","ivar","r","node_has_label","y_offset","ftext","class_label","font_weight","el_move","old_index","new_index","build","dragNode","showWidgets","node_background","pbuttons","io","top_level_seen","group_top_level","hidden_root","hierarchy","tree_dimensions","tree","treemap","ptrLinkNodes","check_ptr_links","enter","customLineSymbol","draw","moveTo","lineTo","has_gender","miscarriage","termination","symbol","noChild","symbolTriangle","symbolCircle","symbolSquare","pienode","ncancers","_val","pie","arc","innerRadius","outerRadius","adopted_in","adopted_out","indent","get_bracket","clash_depth","draw_path","dy1","dy2","cshift","path","dx1","dx2","insert","divorced","parent_nodes","parent_node_name","divorce_path","source","dash_len","dash_array","usedlen","twinx","thisx","ymid","xhbar","xx","yy","probandNode","triid","xstart","shiftKey","indir","me","pnrName","isMovingRight","lft_node","rgt_node","adj_node","meNode","adjIdx","xlft","xrgt","init_dragging","rebuild","editClicked","templates","update","node_attr","breastfeeding","newchild"],"mappings":"wCAQA,IAAIA,EAAY,GACZC,EAAa,CAAA,EAGjB,SAASC,EAAoBC,GAC5B,IACC,GAAuB,UAApBA,EAAKC,WACP,OAAO,EAER,GAAuB,UAApBD,EAAKC,YAA8C,YAApBD,EAAKC,iBAAgDC,IAApBF,EAAKC,WACvE,OAAO,EAER,IAAIE,EAAM,OAGV,OAFAC,aAAaC,QAAQF,EAAKA,GAC1BC,aAAaE,WAAWH,IACjB,CACP,CAAC,MAAMI,GACP,OAAO,CACR,CACD,CAEA,SAASC,EAAWR,GACnB,MAAO,YAAYA,EAAKS,WAAW,GACpC,CAGA,SAASC,EAAQV,GAChB,OAAOF,EAAWU,EAAWR,GAC9B,CAEA,SAASW,EAAkBX,EAAMY,GAChC,MAAuB,UAApBZ,EAAKC,WACAG,aAAaS,QAAQD,GAErBE,eAAeD,QAAQD,EAChC,CAEA,SAASG,EAAkBf,EAAMgB,EAAMJ,GACtC,MAAuB,UAApBZ,EAAKC,WACAG,aAAaC,QAAQW,EAAMJ,GAE3BE,eAAeT,QAAQW,EAAMJ,EACtC,CAWO,SAASK,EAAoBjB,GACnC,IAAIkB,EAASV,EAAWR,GACpBmB,EAA6B,UAApBnB,EAAKC,WAAyBG,aAAeU,eACtDM,EAAQ,GACZ,IAAI,IAAIC,EAAI,EAAGA,EAAIF,EAAMG,OAAQD,IACI,IAAjCF,EAAMI,IAAIF,GAAGG,QAAQN,IACvBE,EAAMK,KAAKN,EAAMI,IAAIF,IAEvB,IAAI,IAAIA,EAAI,EAAGA,EAAID,EAAME,OAAQD,IAChCF,EAAMb,WAAWc,EAAMC,GACzB,CAEO,SAASK,EAAU1B,GACzB,IAAI2B,EAKJ,OAHCA,EADG5B,EAAoBC,GACfW,EAAkBX,EAAMQ,EAAWR,GAAM,SAEzCF,EAAWU,EAAWR,GAAM,SAClC2B,QACKA,EACD,CACR,CAEA,SAASC,EAAU5B,EAAM2B,GACpB5B,EAAoBC,GACvBe,EAAkBf,EAAMQ,EAAWR,GAAM,QAAS2B,GAElD7B,EAAWU,EAAWR,GAAM,SAAW2B,CACzC,CAEO,SAASE,EAAW7B,GAC1B,IAAIA,EAAK8B,QACR,OACD,IAAIH,EAAQD,EAAU1B,GAClBD,EAAoBC,GACvBe,EAAkBf,EAAMQ,EAAWR,GAAM2B,EAAOI,KAAKC,UAAUhC,EAAK8B,WAEpEG,QAAQC,KAAK,sDAAuDlC,EAAKC,YACzEJ,EAAY,SACSK,IAAlBQ,EAAQV,KACVF,EAAWU,EAAWR,IAAS,IAChCU,EAAQV,GAAMyB,KAAKM,KAAKC,UAAUhC,EAAK8B,WAErCH,EAAQ9B,EACV8B,IAEAA,EAAQ,EACTC,EAAU5B,EAAM2B,EACjB,CAEO,SAASQ,EAAOnC,GACtB,IAAGD,EAAoBC,GAMtB,OAAQU,EAAQV,IAASU,EAAQV,GAAMsB,OAAS,EAAIZ,EAAQV,GAAMsB,QAAU,EAL5E,IAAI,IAAID,EAAExB,EAAWwB,EAAE,EAAGA,IACzB,GAAuD,OAApDV,EAAkBX,EAAMQ,EAAWR,IAAOqB,EAAE,IAC9C,OAAOA,EAKV,OAAQ,CACT,CAEO,SAASe,EAAQpC,GACvB,IAAIoC,EAAUV,EAAU1B,GAAM,EAG9B,OAFgB,IAAboC,IACFA,EAAUvC,GACRE,EAAoBC,GACf+B,KAAKM,MAAM1B,EAAkBX,EAAMQ,EAAWR,GAAMoC,IACpD1B,EAAQV,GACR+B,KAAKM,MAAM3B,EAAQV,GAAMoC,SAD5B,CAEN,CAmBO,SAASE,EAAStC,EAAMsC,GAI9B,QAHgBpC,IAAboC,IACFA,EAAWZ,EAAU1B,GAAQ,GAE3BsC,EAAW,EAAG,CAChB,IAAIC,EAAMJ,EAAOnC,GAEhBsC,EADEC,EAAM1C,EACG0C,EAAM,EAEN1C,EAAY,CACzB,CAEA,OADA+B,EAAU5B,EAAMsC,EAAW,GACxBvC,EAAoBC,GACf+B,KAAKM,MAAM1B,EAAkBX,EAAMQ,EAAWR,GAAMsC,IAEpDP,KAAKM,MAAM3B,EAAQV,GAAMsC,GAClC,CAEO,SAASE,EAAKxC,EAAMwC,GAO1B,YANYtC,IAATsC,IACFA,EAAOd,EAAU1B,IACfwC,GAAQ3C,IACV2C,EAAO,GAERZ,EAAU5B,EAAMyC,SAASD,GAAQ,GAC9BzC,EAAoBC,GACf+B,KAAKM,MAAM1B,EAAkBX,EAAMQ,EAAWR,GAAMwC,IAEpDT,KAAKM,MAAM3B,EAAQV,GAAMwC,GAClC,CAEO,SAASE,EAAM1C,GAClBD,EAAoBC,IAjIxB,SAA6BA,GACL,UAApBA,EAAKC,WACAG,aAAasC,QAEb5B,eAAe4B,OACxB,CA6HEC,CAAoB3C,GACrBF,EAAa,CAAA,CACd,CAGO,SAAS8C,EAAY5C,EAAM6C,EAAGC,EAAGC,GACvC,GAAGhD,EAAoBC,GAAO,CAC7B,IAAImB,EAA6B,UAApBnB,EAAKC,WAAyBG,aAAeU,eACvD+B,GACF9B,EAAkBf,EAAMQ,EAAWR,GAAM,KAAM6C,GAC/C9B,EAAkBf,EAAMQ,EAAWR,GAAM,KAAM8C,KAE/C3B,EAAMb,WAAWE,EAAWR,GAAM,MAClCmB,EAAMb,WAAWE,EAAWR,GAAM,OAGnC,IAAIgD,EAAWxC,EAAWR,GAAM,QAC7B+C,EACFhC,EAAkBf,EAAMgD,EAAUD,GAElC5B,EAAMb,WAAW0C,EAElB,CAEF,CAEO,SAASC,EAAYjD,GAC3B,IAAID,EAAoBC,IAC0B,OAAhDI,aAAaS,QAAQL,EAAWR,GAAM,OACY,OAAlDc,eAAeD,QAAQL,EAAWR,GAAM,MACzC,MAAO,CAAC,KAAM,MACf,IAAIkD,EAAM,CAAET,SAAS9B,EAAkBX,EAAMQ,EAAWR,GAAM,OAC3DyC,SAAS9B,EAAkBX,EAAMQ,EAAWR,GAAM,QAGrD,OAFyD,OAAtDW,EAAkBX,EAAMQ,EAAWR,GAAM,UAC3CkD,EAAIzB,KAAK0B,WAAWxC,EAAkBX,EAAMQ,EAAWR,GAAM,WACvDkD,CACR,yHAtFO,SAAclD,GACpB,GAAGD,EAAoBC,GACtB,IAAI,IAAIqB,EAAExB,EAAWwB,EAAE,EAAGA,IAAK,CAC9B,IAAI+B,EAAKzC,EAAkBX,EAAMQ,EAAWR,IAAOqB,EAAE,IACrD,GAAU,OAAP+B,EAEF,OADAxB,EAAU5B,EAAMqB,GACTU,KAAKM,MAAMe,EAEpB,KACM,CACN,IAAIC,EAAM3C,EAAQV,GAClB,GAAGqD,EACF,OAAOtB,KAAKM,MAAMgB,EAAIA,EAAI/B,OAAO,GACnC,CAED,6CCzIO,IAAIgC,EAAQ,CAAA,EAEZ,SAASC,IACd,IAAIC,EAAKC,UAAUC,UAEnB,OAAOF,EAAGhC,QAAQ,UAAY,GAAKgC,EAAGhC,QAAQ,aAAe,CAC/D,CAEO,SAASmC,IACd,OAAOF,UAAUC,UAAUE,MAAM,QACnC,CAEO,SAASC,EAAWC,GAE1B,OADA7B,QAAQ8B,MAAMD,GACP,IAAIE,MAAMF,EAClB,CAGO,SAASG,EAAkBjE,GACjC,GAAGA,EAAKkE,SAAU,CACjB,GAA4B,mBAAjBlE,EAAKkE,SAGf,OAFGlE,EAAKmE,OACPlC,QAAQmC,IAAI,0CACNpE,EAAKkE,SAASG,KAAKC,KAAMtE,GAIjC,IAEIuE,EAFAC,EAAc,GACdC,EAAS,GAEb,IAAI,IAAIC,EAAE,EAAGA,EAAE1E,EAAK8B,QAAQR,OAAQoD,IAAK,CACxC,IAAIA,EAAEC,SACF3E,EAAK8B,QAAQ4C,GAAGE,QAAU5E,EAAK8B,QAAQ4C,GAAGG,QAAQ,CACpDN,EAAevE,EAAK8B,QAAQ4C,GAAGH,aAC3BA,IACHA,EAAe,WAChBA,GAAgB,cAAcvE,EAAK8B,QAAQ4C,GAAG1D,KAAK,IACnD,IAAI4D,EAAS5E,EAAK8B,QAAQ4C,GAAGE,OACzBC,EAAS7E,EAAK8B,QAAQ4C,GAAGG,OAC7B,IAAID,IAAWC,EACd,MAAMhB,EAAW,sBAAsBU,GAGxC,IAAIO,EAAOC,EAAa/E,EAAK8B,QAAS8C,GAClCI,EAAOD,EAAa/E,EAAK8B,QAAS+C,GACtC,IAAa,IAAVC,EACF,MAAMjB,EAAW,wBAAwBe,EAAO,sBAC3CL,EAAa,kCACnB,IAAa,IAAVS,EACF,MAAMnB,EAAW,wBAAwBgB,EAAO,sBAC3CN,EAAa,kCACnB,GAA8B,MAA3BvE,EAAK8B,QAAQgD,GAAMG,IACrB,MAAMpB,EAAW,+BAA+BU,EAC9C,4FACH,GAA8B,MAA3BvE,EAAK8B,QAAQkD,GAAMC,IACrB,MAAMpB,EAAW,+BAA+BU,EAC9C,yFACJ,CAID,IAAIvE,EAAK8B,QAAQ4C,GAAG1D,KACnB,MAAM6C,EAAWU,EAAa,oBAC/B,GAAGW,EAAEC,QAAQnF,EAAK8B,QAAQ4C,GAAG1D,KAAMwD,IAAgB,EAClD,MAAMX,EAAW,6BAA6BU,EAAa,mBAC5DC,EAAY/C,KAAKzB,EAAK8B,QAAQ4C,GAAG1D,OAEgB,IAA9CkE,EAAEC,QAAQnF,EAAK8B,QAAQ4C,GAAGU,MAAOX,IAAkBzE,EAAK8B,QAAQ4C,GAAGU,OACrEX,EAAOhD,KAAKzB,EAAK8B,QAAQ4C,GAAGU,MAE9B,CAEA,GAAGX,EAAOnD,OAAS,EAClB,MAAMuC,EAAW,+BAA+BY,EAAOY,KAAK,MAAM,KAGnE,IAAIC,EAAKC,EAAYvF,EAAK8B,SACvBwD,EAAGhE,OAAS,GACdW,QAAQC,KAAK,uCAAwCoD,EACvD,CACD,CAEO,SAASE,EAAa1D,GACzBA,EAAQ,GAAG2D,IACb3D,EAAQ4D,MAAK,SAASC,EAAEC,GAAG,OAASD,EAAEF,IAAOG,EAAEH,GAASE,EAAEF,GAAKG,EAAEH,GAAM,EAAMG,EAAEH,GAAKE,EAAEF,IAAO,EAAI,EAA7C,CAAiD,IAGtG,IAAII,EAAa,CAAC,KAAM,eACpBC,EAAa,GACjB,IAAI,IAAIzE,EAAE,EAAGA,EAAES,EAAQR,OAAQD,IAAI,CAClC,IAAI0E,EAAM,CAAA,EACV,IAAI,IAAIxE,KAAOO,EAAQT,IACU,IAA7BwE,EAAWrE,QAAQD,KACrBwE,EAAIxE,GAAOO,EAAQT,GAAGE,IAExBuE,EAAWrE,KAAKsE,EACjB,CACA,OAAOD,CACR,CAGO,SAASE,EAAY9E,EAAQ6E,GACnC,IAAIE,GAAQ,EAQZ,OAPGF,GACFb,EAAEgB,KAAKH,GAAK,SAASI,EAAGC,GACvB,GAA6B,IAA1BD,EAAE3E,QAAQN,EAAO,MAAciF,IAAMjF,EAEvC,OADA+E,GAAQ,EACDA,CAET,IACMA,CACR,CA0CO,SAASI,EAASC,EAAOC,EAAKC,EAAWxG,EAAM8B,GACrD,IAEI0E,EACFtB,EAAE,uBAAuBqB,EAAI,UAAUE,OAAO,CAC5CC,OAAO,EACPJ,MAAOA,EAEPK,MAAO,IACPC,QAAS,CACRC,IAAO,WACN3B,EAAEZ,MAAMmC,OAAO,SACfD,EAAUxG,EAAM8B,EAChB,EACDgF,GAAM,WACL5B,EAAEZ,MAAMmC,OAAO,QAChB,GAEDM,KAAM,WAEL7B,EAAEZ,MAAM0C,SAASC,KAAK,gDAAgDC,IAAI,CACzEC,WAAc,UACdC,MAAS,YAKVlC,EAAEZ,MAAM0C,SAASC,KAAK,+CAA+CC,IAAI,CACxEC,WAAc,UACdC,MAAS,UACTC,OAAU,uBAEZ,IAIFnC,EAAE,uBAAuBqB,EAAI,UAAUE,OAAO,CAC7CH,MAAOA,EACPK,MAAO,IACPC,QAAS,CAAC,CACTU,KAAM,KACNC,MAAO,WAAarC,EAAGZ,MAAOmC,OAAQ,QAAU,KAInD,CAAC,MAAM3C,IA1ET,SAAoBwC,EAAOC,EAAKC,EAAWxG,EAAM8B,GAChD,MAAM0F,EAAaC,SAASC,eAAe,YACrCC,EAAaH,EAAWI,cAAc,gBACtCC,EAAiBL,EAAWI,cAAc,eAChD,GAAGpB,EACFtB,EAAE,2BAA2B4C,YAAY,UACzC5C,EAAE,mCAAmC6C,GAAI,SAAS,WACjDvB,EAAUxG,EAAM8B,GAChBoD,EAAE,mCAAmC8C,IAAI,QAC1C,QACM,CACN,MAAMC,EAAY/C,EAAE,uCAChB+C,EAAUC,SAAS,WAAWD,EAAUE,SAAS,UACrDjD,EAAE,mCAAmC8C,IAAI,QAC1C,CAEAL,EAAWS,YAAc9B,EACzBuB,EAAeO,YAAc7B,EAC7BrB,EAAE,aAAawB,MAAM,OACtB,CAwDE2B,CAAW/B,EAAOC,EAAKC,EAAWxG,EAAM8B,EACzC,CACD,CA8BO,SAASwG,EAAOC,GACtB,IAAIjB,EAAO,GACPkB,EAAW,uDACf,IAAK,IAAInH,EAAE,EAAGA,EAAIkH,EAAKlH,IACtBiG,GAAQkB,EAASC,OAAOC,KAAKC,MAAsBH,GAAhBE,KAAKE,WACzC,OAAOtB,CACR,CAEO,SAASuB,EAAU7I,EAAM8I,EAAQC,EAAMC,EAAcvD,QAC5B,IAApBqD,EAAOG,WACjBH,EAAOG,SAAWC,EAAYlJ,EAAK8B,QAASgH,SAEjB,IAAjBE,IACVA,EAAe,GACfvD,EAAK,GAGN,IAAI0D,EAAQC,EAAQL,GAEhBM,EAAW,GAqDf,OApDAnE,EAAEgB,KAAK4C,EAAOG,UAAU,SAASK,EAAIC,GACpCrE,EAAEgB,KAAKlG,EAAK8B,SAAS,SAAS0H,EAAI9E,GACjC,IAAM6E,EAAMvI,OAAS0D,EAAEE,QAAY2E,EAAMvI,OAAS0D,EAAEG,cAAyB3E,IAAbqJ,EAAM9D,GAAkB,CACvF,IAAIgE,EAAIC,GAAcP,EAAOzE,EAAEE,QAC3B+E,EAAID,GAAcP,EAAOzE,EAAEG,QAC/B4E,OAAWvJ,IAANuJ,EAAiBA,EAAIC,GAAc1J,EAAK8B,QAAS4C,EAAEE,QACxD+E,OAAWzJ,IAANyJ,EAAiBA,EAAID,GAAc1J,EAAK8B,QAAS4C,EAAEG,QA8M5D,SAAyBxB,EAAKoG,EAAGE,GAChC,IAAI,IAAItI,EAAE,EAAGA,EAAEgC,EAAI/B,OAAQD,IAC1B,GAAGgC,EAAIhC,GAAGuD,SAAW6E,GAAKpG,EAAIhC,GAAGwD,SAAW8E,EAC3C,OAAO,EACT,OAAO,CACR,CAlNQC,CAAgBP,EAAUI,EAAGE,IAChCN,EAAS5H,KAAK,CAACmD,OAAU6E,EAAG5E,OAAU8E,GACxC,CACD,GACD,IACAzE,EAAE2E,MAAMb,EAAcK,GAEtBnE,EAAEgB,KAAKmD,GAAU,SAASC,EAAIQ,GAC7B,IAAIlF,EAASkF,EAAIlF,OACbC,EAASiF,EAAIjF,OACjBD,EAAOqE,SAAW,GAClB,IAAIjC,EAAS,CACXhG,KAAOsH,EAAO,GACd3D,QAAS,EACTqC,OAAS,KACTnC,OAASA,EACTD,OAASA,EACTqE,SAAWC,EAAYlJ,EAAK8B,QAAS8C,EAAQC,IAG3CC,EAAOC,EAAa/E,EAAK8B,QAAS8C,EAAO5D,MACzCgE,EAAOD,EAAa/E,EAAK8B,QAAS+C,EAAO7D,MACxC,OAAQ6D,GAAa,OAAQD,IACjCa,EAAKsE,EAAcjB,EAAOG,SAAUxD,IAGrC,IAAIuE,EAqoBN,SAA8BlI,EAASgD,EAAME,GAC5C,IAAIiF,EAAQnF,EACRoF,EAAQlF,EACZ,KAAQ,WAAYlD,EAAQmI,IAAU,WAAYnI,EAAQoI,MACrD,cAAepI,EAAQmI,OAAa,cAAenI,EAAQoI,KAC/DD,EAAQlF,EAAajD,EAASA,EAAQmI,GAAOrF,QAC7CsF,EAAQnF,EAAajD,EAASA,EAAQoI,GAAOtF,QAE9C,MAAO,CAACE,KAAQmF,EAAOjF,KAAQkF,EAChC,CA9oBWC,CAAqBnK,EAAK8B,QAASgD,EAAME,GAC/CgF,EAAGhF,KAAOgF,EAAGlF,MACfD,EAAOY,GAAKA,IACZuB,EAAOvB,GAAKA,IACZb,EAAOa,GAAKA,MAEZb,EAAOa,GAAKA,IACZuB,EAAOvB,GAAKA,IACZZ,EAAOY,GAAKA,KAEbA,EAAK2E,EAAaxF,EAAQoC,EAAQvB,EAAI0D,EAAOnJ,GAC7CyF,EAAK2E,EAAavF,EAAQmC,EAAQvB,EAAI0D,EAAOnJ,GAC7C8I,EAAOG,SAASxH,KAAKuF,EACtB,IACAvB,EAAKsE,EAAcjB,EAAOG,SAAUxD,GAEpCP,EAAEgB,KAAK4C,EAAOG,UAAU,SAASK,EAAI5E,GACpCe,EAAKoD,EAAU7I,EAAM0E,EAAGqE,EAAMC,EAAcvD,GAAI,EACjD,IACO,CAACuD,EAAcvD,EACvB,CAIA,SAAS2E,EAAa1F,EAAGsC,EAAQvB,EAAI0D,EAAOnJ,GAQ3C,GANG,gBAAiB0E,EACnBA,EAAE2F,YAAY5I,KAAKuF,GAEnBtC,EAAE2F,YAAc,CAACrD,GAGftC,EAAE4F,QAAU5F,EAAE6F,QAAS,CACzB,IAAIC,EAAQC,EAASzK,EAAK8B,QAAS4C,GACnC,IAAI,IAAIrD,EAAE,EAAGA,EAAEmJ,EAAMlJ,OAAQD,IAAK,CACjC,IAAIqJ,EAAOhB,GAAcP,EAAOqB,EAAMnJ,GAAGL,MACtC0J,IACFA,EAAKjF,GAAKA,IACZ,CACD,CACA,OAAOA,CACR,CAEA,SAASsE,EAAcd,EAAUxD,GAehC,OAbAwD,EAASvD,MAAK,SAASC,EAAGC,GACzB,OAAGD,EAAE2E,QAAU1E,EAAE0E,QAAU3E,EAAE2E,SAAW1E,EAAE0E,QAElC3E,EAAEgF,QAAU/E,EAAE+E,QAAUhF,EAAEgF,SAAW/E,EAAE+E,OADvC,EAGAhF,EAAE2E,QAAU1E,EAAE0E,QAAU3E,EAAEgF,QAAU/E,EAAE+E,OACtC,EACD,CACR,IAEAzF,EAAEgB,KAAK+C,GAAU,SAASK,EAAI5E,QACjBxE,IAATwE,EAAEe,KAAkBf,EAAEe,GAAKA,IAC/B,IACOA,CACR,CAEO,SAASmF,EAAU7E,GACzB,YAAyC,IAA3Bb,EAAEa,GAAK8E,KAAK,aAA8D,IAA3B3F,EAAEa,GAAK8E,KAAK,UAC1E,CAYA,SAASC,EAAcC,EAAMC,GAC5B,IAAI,IAAI3J,EAAE,EAAGA,EAAE2J,EAAK1J,OAAQD,KACQ,IAAhC6D,EAAEC,QAAS6F,EAAK3J,GAAI0J,IAAeA,EAAKtJ,KAAKuJ,EAAK3J,GACvD,CAEA,SAAS4J,EAAiBC,EAAWxG,EAAG5C,GACvC,IAAuC,IAApCoD,EAAEC,QAAST,EAAE1D,KAAMkK,GACrB,OACDJ,EAAcI,EAAWC,EAAarJ,EAAS4C,IAC/C,IAAIuE,EAAWmC,EAAetJ,EAAS4C,GACvCQ,EAAEgB,KAAK+C,GAAU,SAAUoC,EAAY9B,IACK,IAAxCrE,EAAEC,QAASoE,EAAMvI,KAAMkK,KACzBA,EAAUzJ,KAAK8H,EAAMvI,MACrB8J,EAAcI,EAAWC,EAAarJ,EAASyH,IAEjD,GACD,CAGO,SAAS4B,EAAarJ,EAASwJ,GACrC,IAAIC,EAAO,GACX,IAAI,IAAIlK,EAAE,EAAGA,EAAES,EAAQR,OAAQD,IAAK,CACnC,IAAImK,EAAQ1J,EAAQT,GACjBiK,EAAMtK,OAASwK,EAAM5G,SAA6C,IAAnCM,EAAEC,QAAQqG,EAAM3G,OAAQ0G,GACzDA,EAAK9J,KAAK+J,EAAM3G,QACTyG,EAAMtK,OAASwK,EAAM3G,SAA6C,IAAnCK,EAAEC,QAAQqG,EAAM5G,OAAQ2G,IAC9DA,EAAK9J,KAAK+J,EAAM5G,OAClB,CACA,OAAO2G,CACR,CAGO,SAAShG,EAAYzD,GAC3B,IAAI2J,EAAS3J,EAAS4J,EAAgB5J,IACtC,IAAI2J,EAAO,CAEV,GADAxJ,QAAQC,KAAK,qBACS,IAAnBJ,EAAQR,OACV,MAAM,IAAI0C,MAAM,2BAEjByH,EAAS3J,EAAQ,EAClB,CACA,IAAIoJ,EAAY,CAACO,EAAOzK,MACpB2K,GAAS,EACTC,EAAK,EACT,KAAMD,GAAUC,EAAK,KAAK,CACzBA,IACA,IAAIC,EAAWX,EAAU5J,OACzB4D,EAAEgB,KAAKpE,GAAS,SAAUgK,EAAMpH,GAC/B,IAAuC,IAApCQ,EAAEC,QAAST,EAAE1D,KAAMkK,GAAoB,CAEzC,IAAIK,EAAOJ,EAAarJ,EAAS4C,GAC7BqH,EAAcrH,EAAE1D,OAASyK,EAAOzK,OAAS0D,EAAEsH,UAC/C,IAAI,IAAI3K,EAAE,EAAGA,EAAEkK,EAAKjK,OAAQD,IACvBqI,GAAc5H,EAASyJ,EAAKlK,IAAI2K,YACnCD,GAAa,GAGZA,IACCrH,EAAEE,SAAgD,IAAtCM,EAAEC,QAAST,EAAEE,OAAQsG,IACnCA,EAAUzJ,KAAKiD,EAAEE,QACfF,EAAEG,SAAgD,IAAtCK,EAAEC,QAAST,EAAEG,OAAQqG,IACnCA,EAAUzJ,KAAKiD,EAAEG,QAEpB,MAAYH,EAAEsH,YACRtH,EAAEE,SAAgD,IAAtCM,EAAEC,QAAST,EAAEE,OAAQsG,IACjCxG,EAAEG,SAAgD,IAAtCK,EAAEC,QAAST,EAAEG,OAAQqG,KACtCA,EAAUzJ,KAAKiD,EAAE1D,MAGlBiK,EAAiBC,EAAWxG,EAAG5C,EAChC,IACA6J,EAAUE,IAAaX,EAAU5J,MAClC,CACA,IAAI2K,EAAQ/G,EAAEgH,IAAIpK,GAAS,SAASqK,EAAK7C,GAAI,OAAO6C,EAAInL,IAAK,IAC7D,OAAOkE,EAAEgH,IAAID,GAAO,SAASjL,EAAMsI,GAAI,OAAuC,IAAhCpE,EAAEC,QAAQnE,EAAMkK,GAAoBlK,EAAO,IAAK,GAC/F,CAEO,SAAS0K,EAAgB5J,GAC/B,IAAIsK,EAOJ,OANAlH,EAAEgB,KAAKpE,GAAS,SAAST,EAAG8K,GAC3B,GAAIvB,EAAUuB,GAEb,OADAC,EAAU/K,EACH+K,CAET,IACOA,CACR,CAEO,SAASlD,EAAYpH,EAAS8C,EAAQC,GAC5C,IAAIoE,EAAW,GACXgD,EAAQ,GAWZ,MAVkB,MAAfrH,EAAOK,KACTC,EAAEgB,KAAKpE,GAAS,SAASwH,EAAI5E,GACzBE,EAAO5D,OAAS0D,EAAEE,SAChBC,GAAUA,EAAO7D,OAAS0D,EAAEG,SACE,IAA9BK,EAAEC,QAAQT,EAAE1D,KAAMiL,KACpBhD,EAASxH,KAAKiD,GACduH,EAAMxK,KAAKiD,EAAE1D,OAGjB,IACMiI,CACR,CAUO,SAASwB,EAAS3I,EAASgH,GACjC,IAAIuD,EAAOC,EAAYxK,EAASgH,GAC5ByD,EAAazD,EAAOwB,OAAS,SAAW,SAC5C,OAAOpF,EAAEgH,IAAIG,GAAM,SAAS3H,EAAG4E,GAC9B,OAAO5E,EAAE1D,OAAS8H,EAAO9H,MAAQ0D,EAAE6H,KAAezD,EAAOyD,GAAa7H,EAAI,IAC3E,GACD,CAIO,SAAS4H,EAAYxK,EAASgH,EAAQ7D,GAC5C,YAAc/E,IAAX4I,IAAyBA,EAAOlE,QAAUkE,EAAOkD,UAC5C,GAED9G,EAAEgH,IAAIpK,GAAS,SAAS4C,EAAG4E,GACjC,OAAQ5E,EAAE1D,OAAS8H,EAAO9H,MAAU,cAAe0D,IAAMA,EAAEE,QACtDF,EAAEE,SAAWkE,EAAOlE,QAAUF,EAAEG,SAAWiE,EAAOjE,QACjDI,GAAOP,EAAEO,MAAQA,EAAW,KAAJP,CAC/B,GACD,CAIO,SAAS8H,EAAe1K,EAASgH,EAAQ7D,GAC/C,OAAOC,EAAEgH,IAAIpK,GAAS,SAAS4C,EAAG4E,GACjC,OAAQ5E,EAAE1D,OAAS8H,EAAO9H,MAAU,cAAe0D,IAAMA,EAAEE,QACtDF,EAAEE,SAAWkE,EAAOlE,QAAUF,EAAEG,SAAWiE,EAAOjE,QACjDI,GAAOP,EAAEO,MAAQA,EAAW,KAAJP,CAC/B,GACD,CAGO,SAAS+H,EAAmB3K,EAASgH,GAC3C,OAAO5D,EAAEgH,IAAIpK,GAAS,SAAS4C,EAAG4E,GACjC,OAAQ5E,EAAE1D,OAAS8H,EAAO9H,MAAQ,cAAe0D,GAC5CA,EAAEE,SAAWkE,EAAOlE,QAAUF,EAAEG,SAAWiE,EAAOjE,OAAUH,EAAI,IACtE,GACD,CAEO,SAAS0G,EAAetJ,EAASgH,EAAQ7D,GAC/C,OAAOC,EAAEgH,IAAIpK,GAAS,SAAS4C,EAAG4E,GACjC,MAAS,cAAe5E,GACnBA,EAAEE,SAAWkE,EAAO9H,MAAQ0D,EAAEG,SAAWiE,EAAO9H,MAC/CiE,GAAOP,EAAEO,MAAQA,EAAW,KAAJP,CAC/B,GACD,CAGO,SAASgI,EAAS5K,EAASd,GACjC,IAAI2L,EAAM5H,EAAajD,EAASd,GAC5B4L,EAAQ,EAEZ,KAAMD,GAAO,IAAM,WAAY7K,EAAQ6K,IAAQ7K,EAAQ6K,GAAKE,YAC3DF,EAAM5H,EAAajD,EAASA,EAAQ6K,GAAK/H,QACzCgI,IAED,OAAOA,CACR,CAGO,SAAS7H,EAAa1B,EAAKrC,GACjC,IAAI2L,GAAO,EAOX,OANAzH,EAAEgB,KAAK7C,GAAK,SAAShC,EAAGqD,GACvB,GAAI1D,IAAS0D,EAAE1D,KAEd,OADA2L,EAAMtL,EACCsL,CAET,IACOA,CACR,CAGO,SAASG,EAAgBC,EAAQH,EAAOI,GAC9C,OAAO9H,EAAEgH,IAAIa,GAAQ,SAASrI,EAAG4E,GAChC,OAAO5E,EAAEkI,QAAUA,GAAUlI,EAAEuI,KAAKtI,SAAqD,IAA3CO,EAAEC,QAAQT,EAAEuI,KAAKjM,KAAMgM,GAA4B,KAAJtI,CAC7F,IAAEgB,MAAK,SAAUC,EAAEC,GAAI,OAAOD,EAAE9C,EAAI+C,EAAE/C,CAAE,GAC1C,CAGO,SAASqK,EAAUC,EAAc9D,GACvC,IAAI+D,EAAQ,GACZ,IAAI,IAAI/L,EAAE,EAAGA,EAAGgI,EAAS/H,OAAQD,IAChC+L,EAAM3L,KAAK,CAACmD,OAAU8E,GAAcyD,EAAc9D,EAAShI,GAAGuD,OAAO5D,MAClE6D,OAAU6E,GAAcyD,EAAc9D,EAAShI,GAAGwD,OAAO7D,QAC7D,OAAOoM,CACR,CAGO,SAASC,EAAUvL,EAASwL,GAClC,IAAID,EAAY,GAUhB,OATA,SAASE,EAAQD,GACbA,EAAKL,OAAMK,EAAOA,EAAKL,MACvB,WAAYK,GAAQ,WAAYA,KAAU,cAAeA,KAC3DC,EAAQ7D,GAAc5H,EAASwL,EAAK1I,SACpC2I,EAAQ7D,GAAc5H,EAASwL,EAAKzI,UAErCwI,EAAU5L,KAAK6L,EAChB,CACAC,CAAQD,GACDD,CACR,CAGO,SAASG,EAAYC,EAAOC,EAAO1N,GACzC,GAAGyN,EAAMb,QAAUc,EAAMd,MACxB,OAAO,EACR,IAAIe,EAAaN,EAAUrN,EAAK8B,QAAS2L,GACrCG,EAAaP,EAAUrN,EAAK8B,QAAS4L,GACrCG,EAAS3I,EAAEgH,IAAIyB,GAAY,SAASG,EAAUxE,GAAI,OAAOwE,EAAS9M,IAAK,IACvE+M,EAAS7I,EAAEgH,IAAI0B,GAAY,SAASE,EAAUxE,GAAI,OAAOwE,EAAS9M,IAAK,IACvEwM,GAAc,EAOlB,OANAtI,EAAEgB,KAAK2H,GAAQ,SAAUG,EAAQhN,GAChC,IAAgC,IAA7BkE,EAAEC,QAAQnE,EAAM+M,GAElB,OADAP,GAAc,GACP,CAET,IACOA,CACR,CAGO,SAASpE,EAAQL,GACvB,IAAIkF,EAAO,GAOX,OANA,SAASV,EAAQD,GACbA,EAAKrE,UACPqE,EAAKrE,SAASiF,QAAQX,GACvBU,EAAKxM,KAAK6L,EACX,CACAC,CAAQxE,GACDkF,CACR,CAKO,SAASE,EAAcnO,EAAM+I,EAAMoE,GACzC,SAASI,EAAQD,GAChB,GAAIA,EAAKrE,WACRqE,EAAKrE,SAASiF,QAAQX,QAEErN,IAArBoN,EAAKL,KAAKpI,QAAsB,EAUrC,SAA0ByI,EAAMzI,EAAQD,GAOrC,IAAIwJ,EAAS,EACTC,EAAQ,EACZf,EAAKrE,SAASiF,SAAS3E,IAClBA,EAAM0D,KAAKtI,QAAW4E,EAAM0D,KAAKjB,YACpCoC,GAAgB7E,EAAM1G,EACtBwL,IACD,IAED,IAAIC,EAAOF,EAAMC,EAWbE,EAAc1J,EAAOhC,EAAI+B,EAAO/B,EAAIgC,EAASD,EAC7C4J,EAAe3J,EAAOhC,EAAI+B,EAAO/B,EAAIgC,EAASD,EAC9C6J,EAAwB,GAC5B,GAAGH,GAAOC,EAAY1L,GAAKyL,EAAOC,EAAY1L,GAAI4L,EAAuB,CACxE,IAAIC,EAAYC,GAAuB3O,EAAM,CAAC4E,OAAUA,EAAQC,OAAUA,IACtE+J,EAA+B,OAAdF,EAAqB,EAAIA,EAAUpN,OACpDuN,EAAaL,EAAa3L,EAAI0L,EAAY1L,EAC9C0L,EAAY1L,EAAIyL,EAAOE,EAAa3L,EAAIyL,EACxC,IAAIQ,EAAQH,GAAuB3O,EAAM,CAAC4E,OAAUA,EAAQC,OAAUA,IAClEkK,EAAsB,OAAVD,EAAiB,EAAIA,EAAMxN,QACxC0N,GAAQhP,EAAM+I,EAAKkG,cAAeV,EAAY1L,EAAG0L,EAAY3B,MAAO,CAAC2B,EAAYtB,KAAKjM,QAAW+N,EAAYH,EAAgB,KAC/HL,EAAY1L,EAAE2L,EAAa3L,EAAIgM,EAC/BP,GAAQC,EAAY1L,EAAE2L,EAAa3L,GAAG,EAIxC,MAAO,GAAIyL,GAAOE,EAAa3L,GAAK2L,EAAa3L,EAAIyL,GAAOG,EAAsB,CACjF,IAAIC,EAAYC,GAAuB3O,EAAM,CAAC4E,OAAUA,EAAQC,OAAUA,IACtE+J,EAA+B,OAAdF,EAAqB,EAAIA,EAAUpN,OACpDuN,EAAaL,EAAa3L,EAAI0L,EAAY1L,EAC9C2L,EAAa3L,EAAIyL,EAAOC,EAAY1L,EAAIyL,EACxC,IAAIQ,EAAQH,GAAuB3O,EAAM,CAAC4E,OAAUA,EAAQC,OAAUA,IAClEkK,EAAsB,OAAVD,EAAiB,EAAIA,EAAMxN,QACxC0N,GAAQhP,EAAM+I,EAAKkG,cAAeT,EAAa3L,EAAG2L,EAAa5B,MAAO,CAAC4B,EAAavB,KAAKjM,QAAW+N,EAAYH,EAAgB,KAClIJ,EAAa3L,EAAE0L,EAAY1L,EAAEgM,EAC7BP,GAAQC,EAAY1L,EAAE2L,EAAa3L,GAAG,EAIxC,CAGA,GAAImM,GAAQhP,EAAM+I,EAAKkG,cAAeX,EAAMhB,EAAKV,MAAO,CAACU,EAAKL,KAAKjM,QA8BxDsM,EAAKzK,EAAIgC,EAAOhC,GAAKyK,EAAKzK,EAAI+B,EAAO/B,GAAOyK,EAAKzK,EAAIgC,EAAOhC,GAAKyK,EAAKzK,EAAI+B,EAAO/B,KAC1FyK,EAAKzK,EAAIyL,OA/BgE,CAC1EhB,EAAKzK,EAAIyL,EACT,IAAIY,EAAO5B,EAAKzK,EAAIyL,EACpB,GAA4B,IAAzBhB,EAAKrE,SAAS3H,SAAiBgM,EAAKrE,SAAS,GAAGgE,KAAKtI,QAAU2I,EAAKrE,SAAS,GAAGgE,KAAKtI,SACvF,IAAK2I,EAAKrE,SAAS,GAAGgE,KAAKtI,SAAU2I,EAAKrE,SAAS,GAAGgE,KAAKtI,OAAS,CACnE,IAAIwK,EAAU7B,EAAKrE,SAAS,GAAGgE,KAAKtI,OAAS2I,EAAKrE,SAAS,GAAKqE,EAAKrE,SAAS,GAC1EmG,EAAU9B,EAAKrE,SAAS,GAAGgE,KAAKtI,OAAS2I,EAAKrE,SAAS,GAAKqE,EAAKrE,SAAS,IACxEkG,EAAOtM,EAAIuM,EAAOvM,GAAKyL,EAAOc,EAAOvM,GAAOsM,EAAOtM,EAAIuM,EAAOvM,GAAKyL,EAAOc,EAAOvM,KACrFmM,GAAQhP,EAAM+I,EAAKkG,cAAeX,EAAMa,EAAOvC,MAAO,CAACuC,EAAOlC,KAAKjM,SACpEmO,EAAOtM,EAAIyL,EAEb,OACM,GAA4B,IAAzBhB,EAAKrE,SAAS3H,QAAiBgM,EAAKrE,SAAS,GAAGgE,KAAKtI,QAI9D,GAAY,IAATuK,IA4LT,SAAsBlP,EAAMsN,EAAM4B,EAAMnG,GACvC,IAAIkG,EAAc3B,EAAK2B,cACnBI,EAAmBnK,EAAEgH,IAAI+C,GAAa,SAASK,EAAYhG,GAAI,OAAOgG,EAAWrC,KAAKjM,IAAK,IAC3FmI,EAAQJ,EAAKkG,cACjB,IAAI,IAAI5N,EAAE,EAAGA,EAAE4N,EAAY3N,OAAQD,IAAI,CACtC,IAAIiO,EAAaL,EAAY5N,GAC7B,GAAGiM,EAAKL,KAAKjM,OAASsO,EAAWrC,KAAKjM,KAAK,CAE1C,GAAGgO,GAAQhP,EAAMmJ,EADNmG,EAAWzM,EAAIqM,EACII,EAAW1C,MAAOyC,GAC/C,OAAO,CACT,CACD,CACA,OAAO,CACR,CAzMwBE,CAAavP,EAAMsN,EAAM4B,EAAMnG,GAChD,GAA4B,IAAzBuE,EAAKrE,SAAS3H,OAChBgM,EAAKrE,SAAS,GAAGpG,EAAIyL,MACf,CACN,IAAIW,EAAc3B,EAAK2B,cACpBjP,EAAKmE,OACPlC,QAAQmC,IAAI,aAAakJ,EAAKL,KAAKjM,KAAK,oBAAoBiO,EAAY3N,OAAO,SAAS4N,GACzF,IAAI,IAAI7N,EAAE,EAAGA,EAAE4N,EAAY3N,OAAQD,IAC/BiM,EAAKL,KAAKjM,OAASiO,EAAY5N,GAAG4L,KAAKjM,OACzCiO,EAAY5N,GAAGwB,GAAKqM,EAEvB,OAdGF,GAAQhP,EAAM+I,EAAKkG,cAAeX,EAAMhB,EAAKrE,SAAS,GAAG2D,MAAO,CAACU,EAAKrE,SAAS,GAAGgE,KAAKjM,SAC1FsM,EAAKrE,SAAS,GAAGpG,EAAIyL,EAgBxB,CAIH,CAlGGkB,CAAiBlC,EAHJ5D,GAAcyD,EAAcG,EAAKL,KAAKpI,OAAO7D,MAC7C0I,GAAcyD,EAAcG,EAAKL,KAAKrI,OAAO5D,MAG3D,CAGF,CA+FAuM,EAAQxE,GACRwE,EAAQxE,EAET,CAEO,SAAS0G,EAAiBzP,EAAMqJ,GAGtCA,EAAS6E,SAAQwB,IAEhB,IAAIhF,EAAOgF,EAAQ9K,OAAO0F,OAASoF,EAAQ9K,OAAU8K,EAAQ7K,OAAOyF,OAASoF,EAAQ7K,OAAS,KAC3F6F,GAWJ,SAAmBgF,EAAShF,GAC3B,IAAIsB,EACA2D,EACDD,EAAQ9K,OAAOoH,WACjBA,EAAY0D,EAAQ9K,OACpB+K,EAAeD,EAAQ7K,QACb6K,EAAQ7K,OAAOmH,YACzBA,EAAY0D,EAAQ7K,OACpB8K,EAAeD,EAAQ9K,QAExB,GAAIoH,GAAa2D,EAAa,CAE7B,IAAIC,EAAe5D,EAAUvG,GAAKkK,EAAalK,GAAKuG,EAAY2D,EAC5DE,EAAgB7D,EAAUvG,GAAKkK,EAAalK,GAAKuG,EAAY2D,EACjE,GAAGE,EAAcpK,GAAKmK,EAAanK,GAAK,EAAE,CACzC,IAOIqK,EAPAC,EAAaF,EAAcxF,YAAY2F,QAAOhJ,GAC1CA,EAAOnC,SAAW+K,GAAgB5I,EAAOpC,SAAWgL,IAGxDK,EAAoBJ,EAAcxF,YAAY2F,QAAOhJ,KAC/CA,EAAOnC,SAAW+K,GAAgB5I,EAAOpC,SAAWgL,KAG9D,GAAGG,EAAWzO,OAAO,EAAE,CACtBwO,EAAWC,EAAW,GAAGtK,GACzB,IAAIyK,EAAWzF,EAASzK,EAAK8B,QAAS4I,GAAM,GAC5CzI,QAAQmC,IAAI8L,GACZ,IAAIC,EAAaD,EAAUzK,GAAKiF,EAAKjF,GAGrC,GAFAxD,QAAQmC,IAAI+L,GAETP,EAAanK,GAAKqK,GAAa,GAAoB,IAAfK,IAAoC,IAAhBA,GAE1D,GADAN,EAAcpK,GAAKmK,EAAanK,GAAK,EAClCwK,EAAkB3O,OAAO,EAAE,CAC7B,IAAI8O,EAAwBP,IAAkBI,EAAkB,GAAGrL,OAASqL,EAAkB,GAAGpL,OAASoL,EAAkB,GAAGrL,OAC5HuL,EAAa,GAEfF,EAAkB,GAAGxK,GAAKoK,EAAcpK,GAAI,EAC5C2K,EAAsB3K,GAAKoK,EAAcpK,KAEzCwK,EAAkB,GAAGxK,GAAKmK,EAAanK,GAAI,EAC3C2K,EAAsB3K,GAAKmK,EAAanK,GAG1C,OAEM,GAAGmK,EAAanK,GAAKqK,IAAc,GAAoB,IAAfK,IAAoC,IAAhBA,IAClEN,EAAcpK,GAAKmK,EAAanK,GAAK,EAClCwK,EAAkB3O,OAAO,GAAE,CAC7B,IAAI8O,EAAwBP,IAAkBI,EAAkB,GAAGrL,OAASqL,EAAkB,GAAGpL,OAASoL,EAAkB,GAAGrL,OAC5HuL,EAAa,GACfF,EAAkB,GAAGxK,GAAKmK,EAAanK,GAAI,EAC3C2K,EAAsB3K,GAAKmK,EAAanK,GAAK,IAE7CwK,EAAkB,GAAGxK,GAAKoK,EAAcpK,GAAI,EAC5C2K,EAAsB3K,GAAKoK,EAAcpK,GAAK,EAEhD,CAEF,CAMD,CACF,CACA,CA5EE4K,CAAUX,EAAShF,EACpB,IAIDrB,EAAS6E,SAAQwB,KAwEjB,SAAwBA,GAEvB,IAAI1D,EACA2D,EACDD,EAAQ9K,OAAOoH,WACjBA,EAAY0D,EAAQ9K,OACpB+K,EAAeD,EAAQ7K,QACb6K,EAAQ7K,OAAOmH,YACzBA,EAAY0D,EAAQ7K,OACpB8K,EAAeD,EAAQ9K,QAExB,GAAIoH,GAAa2D,IAAkBA,EAAa9C,UAAW,CAE1D,IAGIyD,EAHS5G,GAAc1J,EAAK8B,QAAQ6N,EAAa9K,QAE/BwF,YAAY,GAAGpB,SACN+G,QAAOO,KACnCA,EAAQ5L,QAAU4L,EAAQvE,YAAcuE,IAAUvE,GAAauE,IAAUZ,GAAgBY,EAAQ3L,SAAS+K,EAAa/K,QAAU2L,EAAQ1L,SAAS8K,EAAa9K,SAI9J2L,EAAYF,EAAgBN,QAAOO,GAAWA,EAAQ9K,GAAKkK,EAAalK,KAAInE,OAE5EmP,EAAsBD,EADTF,EAAgBhP,OAASkP,EACS,OAAS,QAGxDE,EAAmBrH,EAAS2G,QAAOtL,KACrCA,EAAEE,SAAWoH,GAAatH,EAAEG,SAAWmH,GACtCtH,EAAEE,SAAWoH,GAAatH,EAAEG,SAAW8K,GACvCjL,EAAEG,SAAWmH,GAAatH,EAAEE,SAAW+K,KACxCzD,KAAIxH,GAAKA,EAAEE,SAAWoH,EAAYtH,EAAEG,OAASH,EAAEE,SAAQ,GAErD+L,EAAsBtH,EAAS2G,QAAOtL,KACxCA,EAAEE,SAAW+K,GAAgBjL,EAAEG,SAAW8K,GACzCjL,EAAEE,SAAWoH,GAAatH,EAAEG,SAAW8K,GACvCjL,EAAEG,SAAWmH,GAAatH,EAAEE,SAAW+K,KACxCzD,KAAIxH,GAAKA,EAAEE,SAAW+K,EAAejL,EAAEG,OAASH,EAAEE,SAAQ,GAExDgM,GAAO,EAwBX,GAtBIF,GAAqBC,GAGfA,GACT3E,EAAUvG,GAAKkK,EAAalK,IAAMkL,EAAoBlL,GAAKkK,EAAalK,IAG9DkL,GACV3E,EAAUvG,GAAKkK,EAAalK,IAAMkL,EAAoBlL,GAAKkK,EAAalK,IAG7DiL,GACXf,EAAalK,GAAKuG,EAAUvG,IAAMiL,EAAiBjL,GAAKuG,EAAUvG,IAGvDiL,GACXf,EAAalK,GAAKuG,EAAUvG,IAAMiL,EAAiBjL,GAAKuG,EAAUvG,MAVlEmL,GAAO,GALPA,EAAgC,SAAxBH,GAAkCzE,EAAUvG,GAAKkK,EAAalK,IAC9C,UAAxBgL,GAAmCzE,EAAUvG,GAAKkK,EAAalK,GAoB5DmL,EAAM,CAGT,IAAIC,EAAS7E,EAAUvG,GACvBuG,EAAUvG,GAAKkK,EAAalK,GAC5BkK,EAAalK,GAAKoL,CAEnB,CAID,CACD,CAhJEC,CAAepB,EAAQ,GAkJ1B,CAoBO,SAASV,GAAQhP,EAAMmJ,EAAO4H,EAAMnE,EAAOI,GACjD,IAAI,IAAIgE,EAAE,EAAGA,EAAE7H,EAAM7H,OAAQ0P,IAC5B,GAAGpE,IAAUzD,EAAM6H,GAAGpE,QAA2D,IAAlD1H,EAAEC,QAAQgE,EAAM6H,GAAG/D,KAAKjM,KAAMgM,IACzDtE,KAAKuI,IAAIF,EAAO5H,EAAM6H,GAAGnO,GAAuB,KAAjB7C,EAAKkR,YACtC,OAAO,EAGV,OAAO,CACR,CAGO,SAASxH,GAAcP,EAAOnI,GACpC,IAAK,IAAIK,EAAI,EAAGA,EAAI8H,EAAM7H,OAAQD,IAAK,CACtC,GAAG8H,EAAM9H,GAAG4L,MAAQjM,IAASmI,EAAM9H,GAAG4L,KAAKjM,KAC1C,OAAOmI,EAAM9H,GACT,GAAIL,IAASmI,EAAM9H,GAAGL,KAC1B,OAAOmI,EAAM9H,EACf,CACD,CA6BO,SAAS8P,GAAWnR,GAG1B,IAAIuB,EAFJ2D,EAAE,kBAAkBkM,SACpBlM,EAAE,QAAQmM,OAAO,kCAEjB,IAAI,IAAIhQ,EAAE,EAAGA,EAAErB,EAAK8B,QAAQR,OAAQD,IAAK,CACxC,IAAIyH,EAAS,wDAAwD9I,EAAK8B,QAAQT,GAAGL,KAAK,mCAC1F,IAAIO,KAAOvB,EAAK8B,QAAQT,GACZ,SAARE,IACQ,WAARA,EACFuH,GAAU,SAASvH,EAAM,IAAMvB,EAAK8B,QAAQT,GAAGE,GAAKP,KAAK,YACzC,aAARO,OACwBrB,IAA5BF,EAAK8B,QAAQT,GAAGE,GAAK,KACxBuH,GAAU,SAASvH,EAAM,IAAMvB,EAAK8B,QAAQT,GAAGE,GAAK,GAAGP,KAAK,aAE7D8H,GAAU,SAASvH,EAAM,IAAMvB,EAAK8B,QAAQT,GAAGE,GAAK,aAEtD2D,EAAE,kBAAkBmM,OAAOvI,EAAS,eAErC,CAEA,IAAIvH,KADJ2D,EAAE,kBAAkBmM,OAAO,gBAChBrR,EACC,YAARuB,GACH2D,EAAE,kBAAkBmM,OAAO,SAAS9P,EAAM,IAAMvB,EAAKuB,GAAK,YAE5D,CAEO,SAAS+P,KACf,OAAQ7J,SAAS8J,mBAAqB9J,SAAS+J,sBAAwB/J,SAASgK,yBAA2BhK,SAASiK,mBACrH,CAGO,SAASC,GAAmB3R,GAClC,MAAO,CAAC2G,MAAW2K,KAAiBM,OAAOC,WAAc7R,EAAK2G,MAC5DmL,OAAWR,KAAiBM,OAAOG,YAAc/R,EAAK8R,OACzD,CAEO,SAASE,GAAoBhS,GAEnC,IAAIiS,EAAiBN,GAAmB3R,GACpCkS,EAAW,EACXC,EAAa,CAAA,EACjB,IAAI,IAAI9Q,EAAE,EAAGA,EAAErB,EAAK8B,QAAQR,OAAQD,IAAK,CACxC,IAAIuL,EAAQF,EAAS1M,EAAK8B,QAAS9B,EAAK8B,QAAQT,GAAGL,MAC/CiI,EAAWmC,EAAepL,EAAK8B,QAAS9B,EAAK8B,QAAQT,IAGrD+Q,EAAQ,GAAKnJ,EAAS3H,OAAS,EAAI,IAAsB,IAAhB2H,EAAS3H,OAAe,IAAMtB,EAAK8B,QAAQT,GAAGwD,OAAS,IAAO,GACxG+H,KAASuF,EACXA,EAAWvF,IAAUwF,EAErBD,EAAWvF,GAASwF,EAElBD,EAAWvF,GAASsF,IACtBA,EAAWC,EAAWvF,GACxB,CAEA,IAAIyF,EAAYC,OAAOC,KAAKJ,GAAY7Q,OAAOtB,EAAKkR,YAAY,IAKhE,MAAO,CAACvK,MAJWsL,EAAetL,MAAQ3G,EAAKkR,YAAcgB,EAASlS,EAAKkR,YAAY,KAChFe,EAAetL,MAAQ3G,EAAKkR,YAAcgB,EAASlS,EAAKkR,YAAY,KAG9CY,OAFVG,EAAeH,OAAS9R,EAAKkR,YAAcmB,EACvDJ,EAAeH,OAAS9R,EAAKkR,YAAcmB,EAEnD,uHA9wBO,SAA+BG,GACrC,OAAOA,EAAO/J,OAAO,GAAGgK,cAAgBD,EAAOE,MAAM,EACtD,mDAysBO,SAAgB1S,EAAMgB,GAC5B,YAAuDd,IAAhDwJ,GAAciJ,EAAiB3S,GAAOgB,EAC9C,6GA3zBO,SAA0B4R,GAChC,IAAIC,EAAI,IAAIC,KACZ,OAAGF,GACM,IAAMC,EAAEE,YAAYL,OAAO,GAAK,KAAO,IAAMG,EAAEG,cAAcN,OAAO,GAAK,KAAO,IAAMG,EAAEI,cAAcP,OAAO,GAE9GG,EAAEK,cAAgB,KAAO,KAAOL,EAAEM,WAAa,IAAIT,OAAO,GAAK,KAAO,IAAMG,EAAEO,WAAWV,OAAO,GAAK,KAAO,IAAMG,EAAEE,YAAYL,OAAO,GAAK,KAAO,IAAMG,EAAEG,cAAcN,OAAO,GAAK,KAAO,IAAMG,EAAEI,cAAcP,OAAO,EACjO,kSAmOM,SAAoB5Q,EAASd,EAAMqS,GACzCnO,EAAEgB,KAAKpE,GAAS,SAASwH,EAAI5E,GACxB1D,IAAS0D,EAAE1D,KACd0D,EAAE0H,QAAUiH,SAEL3O,EAAE0H,OACX,GACD,yBAojBO,SAAkBpL,GACxB,IAAIsS,EAAU,IAAIC,OAAO,OAASvS,EAAO,aAAawS,KAAK5B,OAAO6B,SAASC,MAC3E,OAAc,OAAVJ,EACM,KAEAA,EAAQ,IAAM,CACzB,mBAzsBO,SAA0BK,EAAKC,EAAKC,GAC1C,IAAIC,GAAO,IAAIhB,MAAOI,cAClBa,EAAMtR,SAASkR,GAAOlR,SAASmR,GAEnC,OAAe,MAAXC,GAA6B,MAAXA,MAGR,MAAXA,GAGInL,KAAKuI,IAAI6C,EAAOC,IAAQ,IAFvBD,GAAQC,EAGjB,wBCnOA,IAAIC,GAGG,SAASC,GAAUjU,EAAMkU,GAE/B,IAAIC,EAAKnU,EAAKkR,YAAY,EACtBkD,EAAuB,KAAjBpU,EAAKkR,YAEf8C,GAAKK,GAAGtR,OACLuR,YAAY,CAACtU,EAAKuU,OAAQvU,EAAKwU,UAC/BxE,QAAO,SAASzP,GACjB,UAAIP,EAAKyU,UAA8C,IAAnCzU,EAAKyU,QAAQjT,QAAQ,WACrCjB,EAAEmU,MAAmB,UAAXnU,EAAEmU,QAGG,aAAXnU,EAAEmU,OAAyBnU,EAAEoU,OAAO,IAC3C5M,GAAG,QAAQ,SAASxH,IAmCxB,SAAiBA,EAAGP,GAClBA,EAAKmE,OAASlC,QAAQmC,IAAI,OAAQ7D,EAAEqU,WACrC,IAAIC,EAAItU,EAAEqU,UACNzO,EAAK0O,EAAE1O,GAAa,IAAR0O,EAAE1O,EAAU0O,EAAE1O,OAAIjG,EAClC0C,EAAY5C,EAAM6U,EAAEhS,EAAGgS,EAAE/R,EAAGqD,GAC5B,IAAI2O,EAAMT,GAAGU,OAAO,IAAI/U,EAAKgV,WAAWD,OAAO,YAC/CD,EAAIjK,KAAK,YAAa,aAAegK,EAAEhS,EAAI,IAAMgS,EAAE/R,EAAI,KAAOqD,EAAI,UAAYA,EAAI,IAAM,IACzF,CA1C6B8O,CAAQ1U,EAAGP,EAAO,IAC9CkU,EAAI7P,KAAK2P,IAGT,IAAIkB,EAAMjS,EAAYjD,GAClBmG,EAAoB,IAAf+O,EAAI5T,OAAe4T,EAAI,GAAK,EACjCrS,EAAgB,OAAXqS,EAAI,GAAcA,EAAI,GAAG/O,EAAIgO,EAAGhO,EACrCrD,EAAgB,OAAXoS,EAAI,GAAcA,EAAI,GAAG/O,EAAIiO,EAAGjO,EAEzC,IAAIyO,EAAYP,GAAGc,aACbC,MAAMjP,GACNkP,UAAUxS,EAAGC,GAChBoR,EAAI7P,KAAK2P,GAAGY,UAAWA,EAC3B,CAGO,SAASU,GAAStV,EAAMoV,GACpBf,GAAGU,OAAO,IAAI/U,EAAKgV,WAAWD,OAAO,OAC3CQ,aAAaC,SAAS,IAAInR,KAAK2P,GAAGyB,QAASL,EAChD,CAEO,SAASM,GAAa1V,GAC5B,IAAI6S,EA4BL,SAAwB7S,GACvB,IAAI4F,EAAI+P,GAAW3V,GACnB,MAAO,CAAC4V,IAAKlN,KAAKuI,IAAIrL,EAAEiQ,KAAKjQ,EAAEkQ,MAAOC,IAAKrN,KAAKuI,IAAIrL,EAAEoQ,KAAKpQ,EAAEqQ,MAC9D,CA/BSC,CAAelW,GACnBkU,EAAMG,GAAGU,OAAO,IAAI/U,EAAKgV,WAAWD,OAAO,OAC3CoB,EAmGL,SAAsBjC,GACrB,MAAO,CAACkC,EAAGlC,EAAI5G,OAAO+I,YAAaC,EAAEpC,EAAI5G,OAAOiJ,aACjD,CArGYC,CAAatC,GAEpB/N,EADI,EACKuC,KAAK+N,IAAI5D,EAAE+C,IAAIO,EAAKC,EAAGvD,EAAEkD,IAAII,EAAKG,GAE5CnQ,EAAInG,EAAKuU,QAAQP,GAAGM,YAAY,CAACnO,EAAGnG,EAAKwU,UAE5C,IAAIM,EAcL,SAA6B9U,GAC5B,IAAI4F,EAAI+P,GAAW3V,GACnB,MAAO,CAAC6C,EAAG+C,EAAEkQ,MAAOlQ,EAAEiQ,KAAKjQ,EAAEkQ,MAAM,EAAIhT,EAAG8C,EAAEqQ,MAAOrQ,EAAEoQ,KAAKpQ,EAAEqQ,MAAM,EACnE,CAjBWS,CAAoB1W,GAC9BkU,EAAI7P,KAAK2P,GAAG2C,YAAa7B,EAAIjS,EAAI7C,EAAKkR,YAAa4D,EAAIhS,EAAI9C,EAAKkR,aAChEgD,EAAIqB,aAAalR,KAAK2P,GAAG4C,QAASzQ,EACnC,CAyBO,SAASwP,GAAW3V,GAC1B,IAAI8U,EAAMT,GAAGU,OAAO,IAAI/U,EAAKgV,WAAWD,OAAO,YAC3Ce,EAAOe,OAAOC,UACdjB,GAAQ,IACRI,EAAOY,OAAOC,UACdd,GAAQ,IACRe,EAAM/W,EAAKkR,YAUf,OATA4D,EAAIkC,UAAU,KAAK9Q,MAAK,SAAS2M,EAAGvJ,GACnC,GAAGuJ,EAAEhQ,GAAqB,gBAAhBgQ,EAAE5F,KAAKjM,OAA2B6R,EAAE5F,KAAKtI,OAAQ,CAC1D,IAAIqM,EAaP,SAAqBhR,EAAMiX,EAAOF,GACjC,IACIG,EADO7C,GAAGU,OAAOkC,GAAO3J,OACd6J,UACVf,EAAIc,EAAGvQ,MACP2P,EAAIY,EAAGpF,OACX,GAAS,IAANsE,GAAiB,IAANE,EACb,IACCF,EAAQ,EAAJW,EACJT,EAAQ,EAAJS,EACJ,IAAIK,EAAgB/C,GAAGU,OAAOkC,GAAOD,UAAU,iBAC/C,IAAI,IAAI3V,EAAE,EAAGA,EAAE+V,EAAcC,QAAQ,GAAG/V,OAAQD,IAAK,CACpD,IACIiW,EAAUC,GADJH,EAAcC,QAAQ,GAAGhW,GAAGmW,WAAWC,UAClBzX,EAAK0X,YAAa1X,EAAK2X,WAEtDvB,EAAI1N,KAAK+N,IAAIa,EAAQlB,EAAGW,EAAI,EAAIX,GAChCE,EAAI5N,KAAK+N,IAAS,EAAJM,EAAQ1V,EAAEiW,EAAQhB,EAAIA,EACrC,CACA,CAAC,MAAMxS,GACP7B,QAAQ8B,MAAMD,GACdsS,EAAQ,EAAJW,EACJT,EAAQ,EAAJS,CACL,CAED,MAAO,CAACX,EAAEA,EAAGE,EAAEA,EAChB,CArCWsB,CAAY5X,EAAMsE,KAAMyS,GAC7BlE,EAAEhQ,EAAEkU,EAAMjB,IAAMA,EAAOjD,EAAEhQ,EAAEkU,GAC3BlE,EAAEhQ,EAAEmO,EAAEoF,EAAEW,EAAMlB,IAAMA,EAAOhD,EAAEhQ,EAAEmO,EAAEoF,EAAEW,GACnClE,EAAE/P,EAAImT,IAAMA,EAAOpD,EAAE/P,GACrB+P,EAAE/P,EAAEkO,EAAEsF,EAAES,EAAMf,IAAMA,EAAOnD,EAAE/P,EAAEkO,EAAEsF,EAAES,EACvC,CACD,IACO,CAACjB,KAAKA,EAAMD,KAAKA,EAAMI,KAAKA,EAAMD,KAAKA,EAC/C,CAkCA,SAASuB,GAAYM,EAAKC,EAAMC,GAC7B,IAAIC,EAAI9S,EAAE,eACCoC,KAAKuQ,GACL3Q,IACT,CAAC+Q,SAAY,WACZC,MAAS,OAAQ,cAAe,SAAUC,WAAc,SACxDL,KAAQA,GAAQ,YAChBC,SAAYA,GAAY,QAChBK,SAASlT,EAAE,SAClBmT,EAAI,CAACjC,EAAG4B,EAAErR,QAAS2P,EAAE0B,EAAElG,UAE3B,OADAkG,EAAE5G,SACKiH,CACV,+FCtIO,SAASC,GAAWC,GAC1B,IAAIvY,EAAOkF,EAAEsT,OAAO,CAEnB/X,WAAY,oBACP8X,GAEFE,EAAO,CAAC,CAACC,GAAM,gBAAiBpS,MAAS,sBAC1C,CAACoS,GAAM,UAAWpS,MAAS,QAC3B,CAACoS,GAAM,UAAWpS,MAAS,QAC3B,CAACoS,GAAM,aAAcpS,MAAS,UAEjCmS,EAAKhX,KAAK,CAACiX,GAAM,gBAAiBpS,MAAS,iBACxCtG,EAAKyU,SAAYzU,EAAKyU,QAAQjT,QAAQ,WAAa,IACjC,IAAjBxB,EAAKwU,SACPiE,EAAKhX,KAAK,CAACiX,GAAM,kBAAmBpS,MAAS,aAC3B,IAAhBtG,EAAKuU,QACPkE,EAAKhX,KAAK,CAACiX,GAAM,iBAAkBpS,MAAS,aAE9CmS,EAAKhX,KAAK,CAACiX,GAAM,gBAAiBpS,MAAS,eAE3C,IAAIqS,EAAM,GACV,IAAI,IAAItX,EAAE,EAAGA,EAAEoX,EAAKnX,OAAQD,IAC3BsX,GAAO,SACPA,GAAO,sBAAwBF,EAAKpX,GAAGqX,GAAK,oCAAqCD,EAAKpX,GAAGiF,MAAQ,KACjF,kBAAfmS,EAAKpX,GAAGqX,GAAyB,mBAAqB,IACvD,QAEAC,GAAO,UAERzT,EAAG,IAAIlF,EAAKS,YAAa4Q,OAAOsH,GAIjC,SAA0B3Y,GAEtBkF,EAAEuC,UAAUM,GAAG,kFAAkF,SAAS6Q,GAC5G,IAAIC,EAAgBlG,EAAiB3S,GACjC6Y,UACH7Y,EAAK8B,QAAU+W,GAEhB3T,EAAEuC,UAAUqR,QAAQ,UAAW,CAAC9Y,IAChC+Y,YAAW,WAAYrD,GAAa1V,EAAQ,GAAE,IAC5C,IAEHkF,EAAE,eAAe6C,GAAG,SAAS,SAAS6Q,GAErC,GAAKtH,KAYS7J,SAASuR,eACTvR,SAASuR,iBACFvR,SAASwR,iBAChBxR,SAASwR,mBACFxR,SAASyR,oBAChBzR,SAASyR,sBACFzR,SAAS0R,sBAChB1R,SAAS0R,2BAnBD,CACrB,IAAI1N,EAASvG,EAAE,IAAIlF,EAAKgV,WAAW,GAC/BvJ,EAAO2N,kBACE3N,EAAO2N,oBACA3R,SAAS4R,gBAAgBC,qBAC5C7N,EAAO6N,uBACY7R,SAAS4R,gBAAgBE,wBAChC9N,EAAO8N,wBAAwBC,QAAQC,sBAChChS,SAAS4R,gBAAgBK,qBAChCjO,EAAOiO,qBAErB,CAWD,IAGA,IAAIC,EAAY,EAChB,SAASpF,IAAUe,GAAStV,EAAM,KAAM,CACxC,SAASwU,IAAWc,GAAStV,EAAM,IAAM,CACzCkF,EAAE,qCAAqC6C,GAAG,aAAa,WACnD4R,EAAYC,YAAa1U,EAAGZ,MAAO4D,SAAU,kBAAqBqM,EAASC,EAAU,GACzF,IAAGzM,GAAG,sBAAsB,WACxB8R,cAAcF,EAClB,IAGAzU,EAAG,IAAIlF,EAAKS,YAAasH,GAAI,SAAS,SAASxH,GAE9C,GADAA,EAAEuZ,kBACC5U,EAAE3E,EAAEkL,QAAQvD,SAAS,YACvB,OAAO,EAER,GAAGhD,EAAE3E,EAAEkL,QAAQvD,SAAS,WACvBlI,EAAK8B,QAAU6Q,EAAkB3S,GACjCkF,EAAE,IAAIlF,EAAKgV,WAAW+E,QACtB7U,EAAEuC,UAAUqR,QAAQ,QAAS,CAAC9Y,SACxB,GAAIkF,EAAE3E,EAAEkL,QAAQvD,SAAS,WAC/BlI,EAAK8B,QAAU6Q,EAAc3S,GAC7BkF,EAAE,IAAIlF,EAAKgV,WAAW+E,QACtB7U,EAAEuC,UAAUqR,QAAQ,QAAS,CAAC9Y,SACxB,GAAIkF,EAAE3E,EAAEkL,QAAQvD,SAAS,cAC/B7B,EAAS,iBACA,mDACA2T,GAAOha,QACV,GAAIkF,EAAE3E,EAAEkL,QAAQvD,SAAS,iBAC/BwN,GAAa1V,QACP,GAAIkF,EAAE3E,EAAEkL,QAAQvD,SAAS,iBAC/B,OAIDhD,EAAEuC,UAAUqR,QAAQ,WAAY,CAAC9Y,GAClC,GACD,CA7ECia,CAAiBja,EAClB,CA+EA,SAASga,GAAMha,GACd,IAAIoM,EACJ,GAAGpM,EAAKka,sBAAuB,CAC9B,IACIpU,EAAcN,EADEmN,EAAiB3S,IAErCoM,EAAUtG,EAAW4F,EAAgB5F,IAErCsG,EAAQpL,KAAO,MACfoL,EAAQxH,OAAS,MACjBwH,EAAQvH,OAAS,MAEjB8N,EAA6B3S,EAC9B,MACCoM,EAAU,CACTpL,KAAO,MAAMiE,IAAM,IAAIL,OAAS,MAAMC,OAAS,MAAMuH,SAAU,EAAKyH,OAAS,IAAItP,aAAe,MAEjGoO,EAAe3S,UAGTA,EAAK8B,QAEZ,IAAIqY,EAAWjV,EAAE,qCACdiV,EAAS7Y,OAAS,GAAwB,cAAnB6Y,EAAShO,MAClCnM,EAAK8B,QAAU,CACd,CAACd,KAAO,MAAMiE,IAAM,IAAI4H,WAAY,EAAKgH,OAAS,IAAItP,aAAe,wBACrE,CAACvD,KAAO,MAAMiE,IAAM,IAAI4H,WAAY,EAAKgH,OAAS,IAAItP,aAAe,wBACrE,CAACvD,KAAO,MAAMiE,IAAM,IAAI4H,WAAY,EAAKgH,OAAS,IAAItP,aAAe,wBACrE,CAACvD,KAAO,MAAMiE,IAAM,IAAI4H,WAAY,EAAKgH,OAAS,IAAItP,aAAe,wBACrE,CAACvD,KAAO,MAAMiE,IAAM,IAAIL,OAAS,MAAMC,OAAS,MAAMgP,OAAS,IAAItP,aAAe,iBAClF,CAACvD,KAAO,MAAMiE,IAAM,IAAIL,OAAS,MAAMC,OAAS,MAAMgP,OAAS,IAAItP,aAAe,kBAClF,CAACvD,KAAO,MAAMiE,IAAM,IAAIL,OAAS,MAAMC,OAAS,MAAMgP,OAAS,IAAItP,aAAe,UAClF,CAACvD,KAAO,MAAMiE,IAAM,IAAIL,OAAS,MAAMC,OAAS,MAAMgP,OAAS,IAAItP,aAAe,UAClF,CAACvD,KAAO,MAAMiE,IAAM,IAAIL,OAAS,MAAMC,OAAS,MAAMgP,OAAS,IAAItP,aAAe,UAClF,CAACvD,KAAO,MAAMiE,IAAM,IAAIL,OAAS,MAAMC,OAAS,MAAMgP,OAAS,IAAItP,aAAe,WAClF,CAACvD,KAAO,MAAMiE,IAAM,IAAIL,OAAS,MAAMC,OAAS,MAAMmH,WAAY,EAAK6H,OAAS,IAAItP,aAAe,WACnG6H,EACA,CAACpL,KAAO,MAAMiE,IAAM,IAAIL,OAAS,MAAMC,OAAS,MAAMgP,OAAS,IAAItP,aAAe,YAClF,CAACvD,KAAO,MAAMuD,aAAe,MAAMU,IAAM,IAAIL,OAAS,MAAMC,OAAS,MAAMgP,OAAS,KACpF,CAAC7S,KAAO,MAAMuD,aAAe,gBAAgBU,IAAM,IAAIL,OAAS,MAAMC,OAAS,MAAMgP,OAAS,KAC9F,CAAC7S,KAAO,MAAMuD,aAAe,iBAAiBU,IAAM,IAAIL,OAAS,MAAMC,OAAS,MAAMgP,OAAS,MACvFsG,EAAS7Y,OAAS,GAAwB,cAAnB6Y,EAAShO,MACzCnM,EAAK8B,QAAU,CACd,CAACd,KAAO,MAAMiE,IAAM,IAAIL,OAAS,KAAKC,OAAS,KAAKgP,OAAS,IAAItP,aAAe,SAASyH,WAAY,GACrG,CAAChL,KAAO,MAAMiE,IAAM,IAAIL,OAAS,KAAKC,OAAS,KAAKgP,OAAS,IAAItP,aAAe,SAASyH,WAAY,GACrG,CAAChL,KAAO,MAAMiE,IAAM,IAAIL,OAAS,MAAMC,OAAS,MAAMgP,OAAS,IAAItP,aAAe,UAClF,CAACvD,KAAO,MAAMiE,IAAM,IAAIL,OAAS,MAAMC,OAAS,MAAMgP,OAAS,IAAItP,aAAe,WAClF,CAACvD,KAAO,MAAMiE,IAAM,IAAIL,OAAS,MAAMC,OAAS,MAAMmH,WAAY,EAAK6H,OAAS,IAAItP,aAAe,WACnG6H,EACA,CAACpL,KAAO,MAAMiE,IAAM,IAAIL,OAAS,MAAMC,OAAS,MAAMgP,OAAS,IAAItP,aAAe,YAClF,CAACvD,KAAO,MAAMuD,aAAe,MAAMU,IAAM,IAAIL,OAAS,MAAMC,OAAS,MAAMgP,OAAS,MAErF7T,EAAK8B,QAAU,CACd,CAACd,KAAQ,MAAOuD,aAAgB,SAAUU,IAAO,IAAK4H,WAAa,GACnE,CAAC7L,KAAQ,MAAOuD,aAAgB,SAAUU,IAAO,IAAK4H,WAAa,GACnET,GAEFlH,EAAEuC,UAAUqR,QAAQ,UAAW,CAAC9Y,GACjC,CCzKO,IAAIoa,GAAU,CACnBC,cAAiB,8BACjBC,eAAkB,+BAClBC,eAAkB,+BAClBC,gBAAmB,gCACnBC,kBAAqB,mCAEZC,GAAgB,CAAC,QAAS,QAAS,QAAS,MAAO,QAAS,SAAU,SAAU,SAChFC,GAAgB,CAAC,QAAS,QAAS,QAAS,MAAO,QAAS,QAAS,SAAU,SAAU,SACzFC,GAAgB,CAAC,QAAS,QAAS,QAAS,MAAO,QAAS,QAAS,SAAU,SAAU,QAAS,UAElGC,GAAkB,CAAC,KAAM,KAAM,OAAQ,OAAQ,QAGtDC,GAAoB,CAAA,EA6BjB,SAASC,GAAStV,GACxB,OAA0C,IAAnCP,EAAE8V,KAAK9V,EAAE,IAAIO,GAAI0G,OAAO7K,MAChC,CAGA,IAAI2Z,GAAU,SAASC,GACtB,IAAI,IAAI3Z,KAAO2Z,EACd,GAAI5I,OAAO6I,UAAUC,eAAe/W,KAAK6W,EAAO3Z,GAC/C,OAAO,EAGT,OAAO,CACR,EAGO,SAAS8Z,KACf,IAAIC,EAAM,CAAA,EAuBV,OAtBGP,GAAS,iBAAmBA,GAAS,kBACvCO,EAAuB,kBAAI,CAC1BC,MAASpY,WAAW+B,EAAE,iBAAiBiH,OACvCqP,OAAUrY,WAAW+B,EAAE,iBAAiBiH,OACxCsP,QAAWtY,WAAW+B,EAAE,uBAAuBiH,SAG9C4O,GAAS,kBAAoBA,GAAS,mBACxCO,EAAwB,mBAAI,CAC3BC,MAASpY,WAAW+B,EAAE,kBAAkBiH,OACxCqP,OAAUrY,WAAW+B,EAAE,kBAAkBiH,OACzCsP,QAAWtY,WAAW+B,EAAE,wBAAwBiH,SAG/C4O,GAAS,mBAAqBA,GAAS,oBACzCO,EAAyB,oBAAI,CAC5BC,MAASpY,WAAW+B,EAAE,mBAAmBiH,OACzCqP,OAAUrY,WAAW+B,EAAE,mBAAmBiH,OAC1CsP,QAAWtY,WAAW+B,EAAE,yBAAyBiH,SAGnDlK,QAAQmC,IAAIkX,GACJL,GAAQK,GAAO,EAAIA,CAC5B,CAgBA,SAASI,GAAeC,GAEvB,OAAe,KADfA,EAAUlZ,SAASkZ,IAEXjB,GACY,IAAZiB,GAEY,IAAZA,EADAhB,GAGDC,EACR,CAEO,SAASgB,GAAYC,GAC3B,IAAIC,EAAQD,EAAeb,OAAOe,MAAM,MACpCjH,EAAM,GACNkH,EAAM,GACV,MAAMC,EAAS,UACf,IAAIN,EAAU,EACVO,EAAKR,GAAeC,GACpBQ,EAAO,CAAC,GAAI,GAAI,GAAI,IAExB,IAAI,IAAI9a,EAAI,EAAEA,EAAIya,EAAMxa,OAAOD,IAAI,CAClC,IAAI+a,EAAKN,EAAMza,GAAG2Z,OAClB,GAAwB,IAArBoB,EAAG5a,QAAQ,MAAa,CAC1B,GAA+B,IAA5B4a,EAAG5a,QAAQ,aAAoB,CACjC,MAAMoC,EAAQwY,EAAGxY,MAAMqY,GAKvB,GAJAN,EAAUlZ,SAASmB,EAAM,IACzBsY,EAAKR,GAAeC,GACpB1Z,QAAQmC,IAAI,+BAA+BuX,GAExCS,EAAG5a,QAAQ,MAAQ,EAAG,CACxB,IAAI6a,EAAMD,EAAGL,MAAM,KACnB,IAAI,IAAIO,EAAE,EAAGA,EAAED,EAAI/a,OAAQgb,IAAK,CAEV,IADRD,EAAIC,GAAGP,MAAM,KAChBza,QACT0a,EAAIva,KAAK4a,EAAIC,GAEf,CACD,CACD,EAC8B,IAA3BF,EAAG5a,QAAQ,YAA+C,IAA1B4a,EAAG5a,QAAQ,YAC7Cwa,EAAIva,KAAK2a,EAAGG,QAAQ,KAAM,KAE3B,QACD,CAEA,IAAIC,EAAQ,KACTJ,EAAG5a,QAAQ,MAAQ,IACrBgb,EAAQ,MACRva,QAAQmC,IAAI,kBAEb,IAAIyG,EAAO3F,EAAEgH,IAAIkQ,EAAGL,MAAMS,IAAQ,SAASrQ,EAAK7C,GAAI,OAAO6C,EAAI6O,MAAO,IAEtE,GAAGnQ,EAAKvJ,OAAS,EAAG,CACnB,GAAGuJ,EAAKvJ,SAAW6a,EAAKR,EAAQ,GAE/B,MADA1Z,QAAQ8B,MAAMqY,EAAIvR,GACZ,IAAI7G,MAAM,2BAA2B6G,EAAKvJ,OAAO,cAAc6a,EAAKR,EAAQ,GAAG,wBAAwBA,GAE9G,IAAIc,EAAO,CACVrX,MAASyF,EAAK,GACdtG,aAAgBsG,EAAK,GACrB7J,KAAQ6J,EAAK,GACb5F,IAAO4F,EAAK,GACZgJ,OAAUhJ,EAAK,IAED,MAAZA,EAAK,KAAY4R,EAAKrQ,SAAU,GACpB,MAAZvB,EAAK,KAAY4R,EAAK5X,OAASgG,EAAK,IACxB,MAAZA,EAAK,KAAY4R,EAAK7X,OAASiG,EAAK,IACxB,MAAZA,EAAK,KAAY4R,EAAKnS,OAASO,EAAK,IACxB,MAAZA,EAAK,KAAY4R,EAAK9I,IAAM9I,EAAK,IACpB,MAAbA,EAAK,MAAa4R,EAAK7I,IAAM/I,EAAK,KAErC,IAAI8B,EAAM,GACVzH,EAAEgB,KAAKkU,IAAS,SAASsC,EAAQC,GAEf,MAAd9R,EAAK8B,KACP8P,EAAKE,GAAiB9R,EAAK8B,IAE5BA,GACD,IAEmB,MAAhB9B,EAAK8B,OAAgB8P,EAAKG,UAAY,GAIzC,IAAI,IAAIN,EAAE,EAAGA,EAAEJ,EAAG5a,OAAQgb,IAAK,CAC9B,IAAIO,EAAYhS,EAAK8B,GAAKoP,MAAM,KACZ,MAAjBc,EAAU,GACS,MAAjBA,EAAU,IAA+B,MAAjBA,EAAU,IAAiC,MAAjBA,EAAU,IAA+B,MAAjBA,EAAU,GAGvF5a,QAAQC,KAAK,mCAAoCb,EAAE,GAAK,KAAOwb,EAAU,GAAK,IAAMA,EAAU,IAF9FJ,EAAKP,EAAGI,GAAK,cAAgB,CAAC5H,KAAQmI,EAAU,GAAIC,OAAUD,EAAU,IAIrD,MAAjBA,EAAU,IAA+B,MAAjBA,EAAU,KACpCJ,EAAKP,EAAGI,GAAK,cAAgB,CAAC5H,KAAQmI,EAAU,GAAIC,OAAUD,EAAU,KAE1ElQ,GACD,CAEA,IAAIoQ,EAAYlS,EAAK8B,GAAKoP,MAAM,KAChC,IAAI,IAAIO,EAAE,EAAGA,EAAES,EAAUzb,OAAQgb,IACZ,MAAjBS,EAAUT,KACQ,MAAjBS,EAAUT,IAA+B,MAAjBS,EAAUT,GACpCG,EAAK5B,GAAgByB,GAAK,iBAAmBS,EAAUT,GAEvDra,QAAQC,KAAK,mCAAoCb,EAAE,GAAK,KAAMwZ,GAAgByB,GAAK,IAAKS,EAAUT,KAGrGxH,EAAIkI,QAAQP,EACb,CACD,CAOA,OAJA3H,EAAIpP,MAAK,SAASC,EAAGC,GACpB,YAAoB1F,IAAbyF,EAAE2E,OAAuB3E,EAAE2E,OAAO2S,cAAcrX,EAAE0E,QAAU,CACpE,IAEO,CAAC0R,EAAKlH,EACd,CAKO,SAASoI,GAAaC,GAE5B,GADe,8BACLC,KAAKD,GACd,MAAO,OAAOA,EAGf,MADe,uBACLC,KAAKD,GACP,cAAcA,GAEtBlb,QAAQ8B,MAAM,+CAAiDoZ,GACxD,GACR,CAKO,SAASE,GAAavb,EAASsD,EAAOkY,EAAMC,GAAwC,IAAhC5B,EAAO6B,UAAAlc,OAAA,QAAApB,IAAAsd,UAAA,GAAAA,UAAA,GAAC,EAAGC,EAASD,UAAAlc,OAAA,QAAApB,IAAAsd,UAAA,GAAAA,UAAA,QAACtd,EAE3EqG,EAAM,cADDsQ,OAAO6G,UAAU/B,GAAWA,EAAQ,KAAOA,EAAQgC,YAExDvY,IACHA,EAAQ,QAENkY,IACF/W,GAAO+W,QAEa,IAAXC,IACTA,GAAS,GAGV,IAAIK,EAAO1Y,EAAEgH,IAAIpK,GAAS,SAAS4C,EAAG4E,GAAI,MAAO,YAAa5E,GAAKA,EAAEmZ,QAAUnZ,EAAE1D,KAAO,IAAK,IAGzF8c,EAAcC,EAA8Bjc,GAC5CmD,EAAM,IAKV,GAJG6Y,IACF7Y,EAAMnD,EAAQgc,GAAY7Y,KAGhB,MAARA,EAAa,CACf,IAAI+Y,EAAcC,GAAgB,gBAC9BC,EAAcD,GAAgB,UAC9BE,EAAcF,GAAgB,2BAC9BG,EAAcH,GAAgB,sBAC9BI,EAAcJ,GAAgB,OAC9BK,EAAcL,GAAgB,OAC9BM,EAAcN,GAAgB,kBAC9BO,EAAcP,GAAgB,oBAC9Bd,EAAcc,GAAgB,wBAC9BlI,EAAckI,GAAgB,UAC9BQ,EAAcR,GAAgB,sBAC9BS,EAAcT,GAAgB,sBAElB/d,IAAb8d,IACFzX,GAAO,gBAAgByX,QACV9d,IAAXge,IACF3X,GAAO,cAAc2X,QACHhe,IAAhBie,IACF5X,GAAO,wBAAwB4X,QAClBje,IAAXke,IACF7X,GAAO,cAAc6X,QACPle,IAAZme,IACF9X,GAAO,eAAe8X,QACZne,IAARoe,IACF/X,GAAO,WAAW+X,QACJpe,IAAZqe,IACFhY,GAAO,eAAegY,QACNre,IAAdse,IACFjY,GAAO,iBAAiBiY,QACTte,IAAbid,IACF5W,GAAO2W,GAAaC,SACVjd,IAAR6V,IACFxP,GAAO,cAAcwP,QACZ7V,IAAPue,IAEDlY,GADS,MAAPkY,GAAqB,MAAPA,EACT,WAEA,iBAEGve,IAATwe,IACFnY,GAAO,YAAYmY,EACrB,CAEG/C,EAAU,QAAmBzb,IAAdud,IACjBlX,GAAO,iBAAiBkX,GAEzBlX,GAAO,+GAEP,IAAI2V,EAAKR,GAAeC,GACxB,IAAI,IAAIta,EAAE,EAAGA,EAAE6a,EAAG5a,OAAQD,IACzBkF,GAAO,KAAK2V,EAAG7a,GAAGoR,cAEnBlM,GAAO,yBAEP,IAAI,IAAIlF,EAAE,EAAGA,EAAES,EAAQR,OAAQD,IAAK,CACnC,IAAIqD,EAAI5C,EAAQT,GAChB,IAAgC,IAA7B6D,EAAEC,QAAQT,EAAE1D,KAAM4c,GAAc,CAClC3b,QAAQmC,IAAI,YAAYM,EAAE1D,MAC1B,QACD,CAEAuF,GAAO,KAAKnB,EAAM,KAEjBmB,GADEgX,EACKlc,EAAE,MAEDqD,EAAEH,aAAeG,EAAEH,aAAe,MAAM,KACjDgC,IAAQ,YAAa7B,EAAI,IAAM,GAAG,KAClC6B,GAAO7B,EAAE1D,KAAK,KACduF,IAAQ,WAAY7B,KAAO,cAAeA,KAAsC,IAA/BQ,EAAEC,QAAQT,EAAEE,OAAQgZ,GAAelZ,EAAEG,OAAS,GAAG,KAClG0B,IAAQ,WAAY7B,KAAO,cAAeA,KAAsC,IAA/BQ,EAAEC,QAAQT,EAAEE,OAAQgZ,GAAelZ,EAAEE,OAAS,GAAG,KAClG2B,GAAO7B,EAAEO,IAAI,KACbsB,IAAQ,WAAY7B,EAAIA,EAAE4F,OAAS,GAAG,KACtC/D,IAAQ,WAAY7B,EAAIA,EAAEmP,OAAS,GAAG,KACtCtN,IAAQ,QAAS7B,EAAIA,EAAEiP,IAAM,GAAG,KAChCpN,IAAQ,QAAS7B,EAAIA,EAAEkP,IAAM,GAAG,KAEhC,IAAI+K,EAAO,GACXzZ,EAAEgB,KAAKkU,IAAS,SAASsC,EAAQC,GAG/BgC,GADEhC,KAAiBjY,GACViY,KAAiBjY,EAAIA,EAAEiY,GAAiB,MAAM,KAE/C,KACV,IACApW,GAAKoY,EAGLpY,IAAQ,cAAe7B,EAAIA,EAAEkY,UAAY,GAAG,KAE5C,IAAI,IAAIN,EAAE,EAAGA,EAAEJ,EAAG5a,OAAQgb,IACtBJ,EAAGI,GAAG,eAAgB5X,GACY,MAAlCA,EAAEwX,EAAGI,GAAG,cAAoB,MACQ,MAApC5X,EAAEwX,EAAGI,GAAG,cAAsB,QAChC/V,GAAO7B,EAAEwX,EAAGI,GAAG,cAAoB,KAAI,IACvC/V,GAAO7B,EAAEwX,EAAGI,GAAG,cAAsB,OAAI,MAEzC/V,GAAO,QAKT,IAAI,IAAI+V,EAAE,EAAGA,EAAEzB,GAAgBvZ,OAAQgb,IAEnCzB,GAAgByB,GAAG,kBAAmB5X,GACxC6B,GAAO7B,EAAEmW,GAAgByB,GAAG,iBAC5Bra,QAAQmC,IAAI,aAAaM,EAAEmW,GAAgByB,GAAG,iBAAiB,QAAQ5X,EAAEH,eAEzEgC,GAAO,IAEL+V,EAAGzB,GAAgBvZ,OAAO,IAC5BiF,GAAO,IAEV,CAEA,OADAtE,QAAQmC,IAAImC,EAAKuU,IACVvU,CACR,CAaO,SAAS0X,GAAgBW,GAC/B,IAAIrd,EAAMsd,GAAWD,GACrB,GAAGrd,KAAOuZ,GACT,OAAOA,GAAkBvZ,EAG3B,CAQO,SAASsd,GAAWD,GAC1B,OAAOhN,OAAO6B,SAASqL,SAAS/C,MAAM,KAAK/L,QAAO,SAAS+O,GAAK,QAASA,CAAK,IAAEC,MACzE,KAAOJ,CACf,6HApYO,WACN,IACItD,EADAgC,EAmEL,WACC,IAAIA,EAAO,GACPpY,EAAE,iBAAiB8B,SAASkB,SAAS,SACxCoV,GAAQ,aAELpY,EAAE,iBAAiB8B,SAASkB,SAAS,SACxCoV,GAAQ,YAET,OAAOA,CACR,CA5EY2B,GAEX,IACC3D,EAAMD,KACHC,EAAI4D,mBAAqD,IAAhC5D,EAAI4D,kBAAkB3D,OAAgD,IAAjCD,EAAI4D,kBAAkB1D,SACtF8B,GAAQ,oBAAoBhC,EAAI4D,kBAAkB3D,MAAM,WAAWD,EAAI4D,kBAAkB1D,QAGvFF,EAAI6D,oBAAuD,IAAjC7D,EAAI6D,mBAAmB5D,OAAiD,IAAlCD,EAAI6D,mBAAmB3D,SACzF8B,GAAQ,oBAAoBhC,EAAI6D,mBAAmB5D,MAAM,WAAWD,EAAI6D,mBAAmB3D,QAGzFF,EAAI8D,qBAAyD,IAAlC9D,EAAI8D,oBAAoB7D,OAAkD,IAAnCD,EAAI8D,oBAAoB5D,SAC5F8B,GAAQ,oBAAoBhC,EAAI8D,oBAAoB7D,MAAM,WAAWD,EAAI8D,oBAAoB5D,OAE9F,CAAC,MAAM1X,GAAO7B,QAAQC,KAAK,MAAOoZ,EAAM,CACzC,OAAOgC,CACR,wBAGO,SAA+Bxb,EAASwb,GAC9C,OAAOD,GAAavb,OAAS5B,EAAWod,GAAM,EADaE,UAAAlc,OAAA,QAAApB,IAAAsd,UAAA,GAAAA,UAAA,GAAC,EAAYA,UAAAlc,OAAA,QAAApB,IAAAsd,UAAA,GAAAA,UAAA,QAACtd,EAE1E,wHAqWO,SAA4B0e,UAC3B9D,GAAkB+D,GAAWD,GACrC,mBAfO,SAA0BA,EAAkBzS,GAClD2O,GAAkB+D,GAAWD,IAAqBzS,CACnD,yBATO,WACNlK,QAAQmC,IAAI,uBACZc,EAAEgB,KAAK4U,IAAmB,SAAS9Z,EAAMmL,GACxClK,QAAQmC,IAAIpD,EAAO,MAAQmL,EAC5B,GACD,kBC1XO,SAASkT,GAAMrf,GACrBkF,EAAE,SAASyG,QAAO,SAASpL,IAwX5B,SAAcA,EAAGP,GAChB,IAAI2J,EAAIpJ,EAAEkL,OAAO6T,MAAM,GACvB,GAAG3V,EAAG,CACL,IAAI4V,EAAS,IAAIC,WACjBD,EAAOE,OAAS,SAASlf,GACxBmf,GAAUnf,EAAEkL,OAAOqR,OAAQ9c,IAE5Buf,EAAOI,QAAU,SAASC,GACzBC,EAAe,aAAc,gCAAkCD,EAAMnU,OAAO1H,MAAM+b,OAEnFP,EAAOQ,WAAWpW,EACnB,MACC1H,QAAQ8B,MAAM,2BAEfmB,EAAE,SAAS,GAAG8a,MAAQ,EACvB,CAtYEC,CAAK1f,EAAGP,EACT,IAEAkF,EAAE,SAASqC,OAAM,SAASqR,IAsS3B,SAAc5Y,GACb,IAAIkgB,EAAUne,KAAKC,UAAU2Q,EAAiB3S,IAC9CmgB,GAAUngB,EAAMkgB,EACjB,CAxSEE,CAAKpgB,EACN,IAEAkF,EAAE,UAAUqC,OAAM,SAASqR,GAC1ByH,GAAMC,GAAkBtgB,GACzB,IAEAkF,EAAE,iBAAiBqC,OAAM,SAASqR,GACjC2H,GAAaD,GAAkBtgB,GAChC,IAEAkF,EAAE,iCAAiCqC,OAAM,SAASqR,GAEjD4H,GAAaxgB,EADI,EACc,YAChC,GACD,CAYA,SAASygB,GAAiBC,EAAiBC,GAC1C,IAAIC,EAAoB,CAAC,MAAM,KAC/B,IAAK,IAAIC,EAAK,EAAGA,EAAKH,EAAgBI,WAAWxf,OAAQuf,IAAM,CAC9D,IAAItX,EAAQmX,EAAgBI,WAAWD,GACvC,IAAkD,IAA9CD,EAAkBpf,QAAQ+H,EAAMwX,SAIpC,IACC,IAAIC,EAAQL,EAAWG,WAAWD,GAAII,cAAgBrP,OAAOsP,iBAAiBP,EAAWG,WAAWD,IACpG,GAAc,cAAVG,GAAmC,OAAVA,EAAgB,SAE7C,IAAK,IAAIG,EAAK,EAAGA,EAAKH,EAAM1f,OAAQ6f,KAChCH,EAAMG,GAAI3f,QAAQ,SAAW,GAAKwf,EAAMG,GAAI3f,QAAQ,SAAW,IAAG+H,EAAMyX,MAAMI,YAAYJ,EAAMG,GAAKH,EAAMK,iBAAiBL,EAAMG,IAEtI,CAAC,MAAMrd,GAAO,QAAU,MAVxB2c,GAAiBlX,EAAOoX,EAAWG,WAAWD,GAW9C,CACH,CAKO,SAASL,GAAaxgB,EAAMshB,EAAYC,GAC9C,IAAIC,EAAWC,GAAQvc,EAAE,IAAIlF,EAAKgV,WAAW/N,KAAK,OAAQ,WAAY,CAACqa,WAAYA,EAAYC,SAAUA,IACzGrc,EAAEwc,KAAKC,MAAMzc,EAAE,CAACsc,IAAWI,MAAK,WAC/B,IAAI7b,GAhCa1C,EAgCGma,UAhCExc,EAgCS,WA/BzBkE,EAAE2c,KAAKxe,GAAK,SAAS2U,GAAI,OAAOA,GAAKA,EAAEhX,OAASA,KAAS,IADjE,IAAmBqC,EAAKrC,EAiCtB,GAAG6e,KAAkBA,IAAc,CAClC,IAAIiC,EAAK,aAAa/b,EAAIgc,IAAI,yBACjBnQ,OAAO7K,OACbU,SAASua,MAAMF,EACvB,KAAO,CACN,IAAInc,EAAM8B,SAASwa,cAAc,KACjCtc,EAAE+N,KAAQ3N,EAAIgc,IACdpc,EAAEuc,SAAW,WACbvc,EAAE8F,OAAW,SACbhE,SAAS0a,KAAKC,YAAYzc,GAAIA,EAAE4B,QAASE,SAAS0a,KAAKE,YAAY1c,EACpE,CACD,GACD,CAKO,SAAS8b,GAAQvN,EAAKoO,EAAe/J,GAC3C,IAAIgK,EAAW,CAACC,SAAS,EAAOlB,WAAY,EAAGC,SAAU,aACrDhJ,IAASA,EAAUgK,GACvBrd,EAAEgB,KAAKqc,GAAU,SAAShhB,EAAKye,GACzBze,KAAOgX,IAAWA,EAAQhX,GAAOye,EACvC,IAEA,IAAIyC,EAAOvO,EAAIwO,IAAI,GAAGC,WAAU,GAChClC,GAAiBgC,EAAMvO,EAAIwO,IAAI,IAC/B,IAAIlB,EAAWtc,EAAE0d,WACbC,GAAU,IAAIC,eAAiBC,kBAAkBN,GAEjDO,EAAS,6BAA8BpR,OAAOqR,KAAKC,SAASC,mBAAmBN,KAC/EO,EAAS3b,SAASwa,cAAc,UACpCmB,EAAOzc,MAAQuN,EAAIvN,QAAQ4R,EAAQ+I,WACnC8B,EAAOtR,OAASoC,EAAIpC,SAASyG,EAAQ+I,WACrC,IAAI+B,EAAUD,EAAOE,WAAW,MAEhCD,EAAQE,UAAY,QACpBF,EAAQG,SAAS,EAAG,EAAGJ,EAAOzc,MAAOyc,EAAOtR,QAE5C,IAAIiQ,EAAMta,SAASwa,cAAc,OAajC,OAZAF,EAAItC,OAAS,WACZ4D,EAAQI,UAAU1B,EAAK,EAAG,EAAGqB,EAAOzc,MAAOyc,EAAOtR,QAClD7P,QAAQmC,IAAIke,EAAe/J,EAAQgJ,UACnCC,EAASkC,QACR,CAAC1iB,KAAQshB,EACThB,WAAc/I,EAAQ+I,WACtBS,IAAMqB,EAAOO,UAAUpL,EAAQgJ,SAAU,GACzCnL,EAAIgN,EAAOzc,MACX2P,EAAI8M,EAAOtR,SACZuR,EAAQO,UAAU,EAAG,EAAGR,EAAOzc,MAAOyc,EAAOtR,SAE9CiQ,EAAI8B,IAAMb,EACHxB,EAASsC,SACjB,CA2DA,SAASC,GAAYC,GACpB,IAAIC,EAtBL,SAAoBC,EAAKC,GACxB,IAAIF,EAAU,GACVG,EAAI,EACRD,EAASE,UAAY,EACrB,IAAIzgB,EAAQugB,EAAS3Q,KAAK0Q,GAC1B,KAAOtgB,GAAO,CAEb,GADAwgB,IACGA,EAAI,IAEN,OADAniB,QAAQ8B,MAAM,qCACN,EAETkgB,EAAQxiB,KAAKmC,GACTugB,EAASE,YAAczgB,EAAM0gB,OAChCH,EAASE,YAEVzgB,EAAQugB,EAAS3Q,KAAK0Q,EACvB,CACA,OAAOD,CACR,CAIeM,CAAWP,EAAU,oDACnC,OAAgB,IAAbC,EACK,6BAER/e,EAAEgB,KAAK+d,GAAS,SAASjW,EAAQpK,GAChC,IAAI4gB,EAAS5gB,EAAM,GAAKA,EAAM,GAAK,GAC/BuI,EAAMvI,EAAM,GACZ6gB,EAAK,OAAUtY,EAAM,IACrBuY,EAAK,SAAWF,EAAQ,IAAMrY,EAAMqY,EAAQ,MAE5CG,EAASxY,EAAI0T,EAAa,GAE9BmE,GADAA,EAAWA,EAASzH,QAAQ,IAAIhJ,OAAOkR,EAAI,KAAM,OAAQE,EAAO,MAC5CpI,QAAQ,IAAIhJ,OAAOmR,EAAI,KAAM,QAAQC,EAAO,IAC/D,IACKX,EACR,CAiBA,SAAS1D,GAAkBtgB,GAC1B,IAAI6Y,EAAgBlG,EAAiB3S,GACjC6Y,UACH7Y,EAAK8B,QAAU+W,GAGhB,IAAI+L,EAAU1f,EAAE,eACZgP,EAAMhP,EAAE,IAAIlF,EAAKgV,WAAW/N,KAAK,OAAO4d,QAAQzM,SAASwM,GAEzDE,EAAU,IAAVA,EAAuB,IAEvBlf,EAAI+P,GAAW3V,GACf6S,EAAQnK,KAAKuI,IAAIrL,EAAEiQ,KAAKjQ,EAAEkQ,MAA1BjD,EAAoCnK,KAAKuI,IAAIrL,EAAEoQ,KAAKpQ,EAAEqQ,MAEtD9P,EADI,EACKuC,KAAK+N,IAAI5D,EAAIiS,EAAMjS,EAAIiS,GAEhC3Q,IAAOvO,EAAEkQ,KAAM9V,EAAKkR,aAAc/K,EAClCiO,IAAOxO,EAAEqQ,KAAMjW,EAAKkR,aAAc/K,EAMtC,OAJA+N,EAAIrJ,KAAK,QAASia,GAClB5Q,EAAIrJ,KAAK,SAAUgI,EAAI1M,GAEvB+N,EAAIjN,KAAK,YAAY4D,KAAK,YAAa,aAAasJ,EAAG,KAAKC,EAAG,WAAWjO,EAAE,KACrEye,CACR,CAGO,SAASrE,GAAarM,GAC5B,IAAIvO,EAAM8B,SAASwa,cAAc,KACjCtc,EAAE+N,KAAQ,6BAA8BuP,KAAMC,SAAUC,mBAAoBjP,EAAI4N,UAChFnc,EAAEuc,SAAW,WACbvc,EAAE8F,OAAW,SACbhE,SAAS0a,KAAKC,YAAYzc,GAAIA,EAAE4B,QAASE,SAAS0a,KAAKE,YAAY1c,EACpE,CAGO,SAAS0a,GAAMtB,EAAItZ,GACtBsZ,EAAGgG,cAAgBC,QACrBjG,EAAK,CAACA,IAEP,IAAIpY,EAA0B,GAAlBzB,EAAE0M,QAAQjL,QAClBmL,EAAS5M,EAAE0M,QAAQE,SAAS,GAC5BmT,EAAW,CACd,0BACA,4EAEGC,EAActT,OAAO7K,KAAK,GAAI,WAAY,SAAWJ,EAAQ,WAAamL,GAC1EqT,EAAc,GAClB,IAAI,IAAI9jB,EAAE,EAAGA,EAAE4jB,EAAS3jB,OAAQD,IAC/B8jB,GAAe,eAAeF,EAAS5jB,GAAG,kDAC3C8jB,GAAe,2BAA6BjgB,EAAE,QAAQgC,IAAI,aAAe,aAEzE,IAAI4a,EAAO,GACX,IAAI,IAAIzgB,EAAE,EAAGA,EAAE0d,EAAGzd,OAAQD,IAChB,IAANA,GAAWoE,IACbqc,GAAQrc,GACTqc,GAAQ5c,EAAE6Z,EAAG1d,IAAIygB,OACdzgB,EAAI0d,EAAGzd,OAAO,IAChBwgB,GAAQ,mCAGVoD,EAAYzd,SAASua,MAAMmD,GAC3BD,EAAYzd,SAASua,MAAMF,GAC3BoD,EAAYzd,SAAS2d,QAErBF,EAAYG,QACZtM,YAAW,WACVmM,EAAY7E,QACZ6E,EAAYE,OACZ,GAAE,IACJ,CAGO,SAASjF,GAAUngB,EAAMkgB,EAASoF,EAAU5Q,GAC/C1U,EAAKmE,OACPlC,QAAQmC,IAAI8b,GACToF,IAAUA,EAAW,WACrB5Q,IAAMA,EAAO,cAEf,IAAI6Q,EAAO,IAAIC,KAAK,CAACtF,GAAU,CAACxL,KAAMA,IACtC,GAAI9C,OAAOnO,UAAUgiB,iBACpB7T,OAAOnO,UAAUgiB,iBAAiBF,EAAMD,OACpC,CACJ,IAAI3f,EAAI8B,SAASwa,cAAc,KAC3ByD,EAAMC,IAAIC,gBAAgBL,GAC9B5f,EAAE+N,KAAOgS,EACT/f,EAAEuc,SAAWoD,EACb7d,SAAS0a,KAAKC,YAAYzc,GAC1BA,EAAE4B,QACFwR,YAAW,WACVtR,SAAS0a,KAAKE,YAAY1c,GAC1BiM,OAAO+T,IAAIE,gBAAgBH,EAC7B,GAAE,EACJ,CACD,CAOA,SAASI,GAAmB9lB,GAC3BkF,EAAEgB,KAAKlG,EAAK8B,SAAS,SAASgK,EAAMpH,GACnC,IAAIA,EAAEC,QAAoB,MAAVD,EAAEO,MAAgB4a,EAAgBnb,IAC9CA,EAAE0V,GAAwB,gBAAI,CAChC,IAAI7T,EAAM,uBAAuB7B,EAAEH,aAAzB,mJAGVtC,QAAQ8B,MAAMwC,UACP7B,EAAE0V,GAAwB,gBACjCyF,EAAe,UAAWtZ,EAC3B,CAEF,GACD,CAGO,SAASmZ,GAAU7M,EAAG7S,GAE5B,IAAI+lB,EADD/lB,EAAKmE,OAAOlC,QAAQmC,IAAIyO,GAE3B,IACC,GAA6D,IAA1DA,EAAErR,QAAQ,4CACZxB,EAAK8B,QAAUkkB,GAAenT,EAAG,GACjCiT,GAAmB9lB,QACb,GAA6D,IAA1D6S,EAAErR,QAAQ,4CACnBxB,EAAK8B,QAAUkkB,GAAenT,EAAG,GACjCiT,GAAmB9lB,QACb,GAAuB,IAApB6S,EAAErR,QAAQ,QAAyC,IAA1BqR,EAAErR,QAAQ,WAAmB,CAC/D,IAAIykB,EAAeC,GAAgBrT,GACnCkT,EAAeE,EAAa,GAC5BjmB,EAAK8B,QAAUmkB,EAAa,GAC5BH,GAAmB9lB,EACpB,MACC,IACC,IAAI8U,EAAM/S,KAAKM,MAAMwQ,GACjBsT,GAAa,EACjB,IAAI,IAAI9kB,EAAE,EAAEA,EAAEyT,EAAIxT,OAAOD,IACrByT,EAAIzT,GAAGwL,YACTsZ,GAAa,GAGfnmB,EAAK8B,QAAWqkB,EAAaC,GAAYtR,GAAOA,CAChD,CAAC,MAAMhR,GACP9D,EAAK8B,QAAUukB,GAAYxT,EAC5B,CAEDgN,EAAwB7f,EACxB,CAAC,MAAMsmB,GAGP,OAFArkB,QAAQ8B,MAAMuiB,EAAMzT,QACpBgN,EAAe,aAAgByG,EAAKC,QAAUD,EAAKC,QAAUD,EAE9D,CACGtmB,EAAKmE,OAAOlC,QAAQmC,IAAIpE,EAAK8B,SAChC,IACC6Q,EAAqB3S,GACrBkF,EAAEuC,UAAUqR,QAAQ,UAAW,CAAC9Y,IAChCiC,QAAQmC,IAAI2hB,GAEZ7gB,EAAEuC,UAAUqR,QAAQ,mBAAoB,CAAC9Y,EAAM+lB,IAC/C7gB,EAAEuC,UAAUqR,QAAQ,WAAY,CAAC9Y,IAEjC,IAECwmB,qBACAC,oBACAC,OAAOC,mBAAoB,CAC3B,CAAC,MAAMC,GACP,CAED,CAAC,MAAMC,GACPhH,EAAe,aAAgBgH,EAAKN,QAAUM,EAAKN,QAAUM,EAC9D,CACD,CA8BO,SAASR,GAAYxK,GAC3B,IAEIzW,EAFA0W,EAAQD,EAAeb,OAAOe,MAAM,MACpCjH,EAAM,GAEV,IAAI,IAAIzT,EAAI,EAAEA,EAAIya,EAAMxa,OAAOD,IAAI,CAChC,IAAIwJ,EAAO3F,EAAEgH,IAAI4P,EAAMza,GAAG2Z,OAAOe,MAAM,QAAQ,SAAS5P,EAAK7C,GAAI,OAAO6C,EAAI6O,MAAO,IACnF,GAAGnQ,EAAKvJ,OAAS,EAChB,MAAM,IAAI0C,MAAM,kBACjB,IAAIiB,EAAmB,MAAZ4F,EAAK,GAAa,IAAmB,MAAZA,EAAK,GAAa,IAAM,IACxD4R,EAAO,CACZrX,MAASyF,EAAK,GACdtG,aAAgBsG,EAAK,GACrB7J,KAAQ6J,EAAK,GACb5F,IAAOA,GAKR,GAHe,MAAZ4F,EAAK,KAAY4R,EAAK5X,OAASgG,EAAK,IACxB,MAAZA,EAAK,KAAY4R,EAAK7X,OAASiG,EAAK,SAEnB,IAATzF,GAAwBA,IAAUqX,EAAKrX,MAAO,CACxDnD,QAAQ8B,MAAM,gDAAgDqB,GAC9D,KACD,CAGA,GAFe,MAAZyF,EAAK,KAAY4R,EAAKqK,SAAW,GAEjCjc,EAAKvJ,OAAS,EAAG,CACnBmb,EAAKsK,QAAU,GACf,IAAI,IAAIzK,EAAE,EAAGA,EAAEzR,EAAKvJ,OAAQgb,GAAG,EAC9BG,EAAKsK,SAAWlc,EAAKyR,GAAK,IAAMzR,EAAKyR,EAAE,GAAK,GAE9C,CAEAxH,EAAIkI,QAAQP,GACZrX,EAAQyF,EAAK,EACd,CACA,OAAOub,GAAYtR,EACpB,CAEO,SAASoR,GAAgBrK,GAC/B,IAAKG,EAAKlH,GAAO8G,GAAYC,GAC7B,IACC,MAAO,CAACG,EAAKoK,GAAYtR,GACzB,CAAC,MAAMvU,GAEP,OADA0B,QAAQ8B,MAAMxD,GACP,CAACyb,EAAKlH,EACd,CACD,CAGO,SAASkR,GAAenK,EAAgBF,GAC9C,IAAIG,EAAQD,EAAeb,OAAOe,MAAM,MACpCjH,EAAM,GAEV,IAAI,IAAIzT,EAAI,EAAEA,EAAIya,EAAMxa,OAAOD,IAAI,CAChC,IAAIwJ,EAAO3F,EAAEgH,IAAI4P,EAAMza,GAAG2Z,OAAOe,MAAM,QAAQ,SAAS5P,EAAK7C,GAAI,OAAO6C,EAAI6O,MAAO,IACrF,GAAGnQ,EAAKvJ,OAAS,EAAG,CACnB,IAAImb,EAAO,CACVrX,MAASyF,EAAK,GACdtG,aAAgBsG,EAAK,GACrB7J,KAAQ6J,EAAK,GACb5F,IAAO4F,EAAK,GACZgJ,OAAUhJ,EAAK,IAED,MAAZA,EAAK,KAAY4R,EAAKrQ,SAAU,GACpB,MAAZvB,EAAK,KAAY4R,EAAK5X,OAASgG,EAAK,IACxB,MAAZA,EAAK,KAAY4R,EAAK7X,OAASiG,EAAK,IACxB,MAAZA,EAAK,KAAY4R,EAAKnS,OAASO,EAAK,IACxB,MAAZA,EAAK,KAAY4R,EAAK9I,IAAM9I,EAAK,IACpB,MAAbA,EAAK,MAAa4R,EAAK7I,IAAM/I,EAAK,KAErC,IAAI8B,EAAM,GASV,GARAzH,EAAEgB,KAAKkU,IAAS,SAAS4M,EAASrK,GAEhB,MAAd9R,EAAK8B,KACP8P,EAAKE,GAAiB9R,EAAK8B,IAE5BA,GACD,IAEe,IAAZgP,EAAe,CACE,MAAhB9Q,EAAK8B,OAAgB8P,EAAKG,UAAY,GAIzC,IAAI,IAAIN,EAAE,EAAGA,EAAE,EAAGA,IACjB3P,GAAK,EACc,MAAhB9B,EAAK8B,EAAI,KACS,MAAhB9B,EAAK8B,EAAI,IAA8B,MAAhB9B,EAAK8B,EAAI,IAAgC,MAAhB9B,EAAK8B,EAAI,IAA8B,MAAhB9B,EAAK8B,EAAI,GAGnF1K,QAAQC,KAAK,mCAAoCb,EAAE,GAAK,KAAOwJ,EAAK8B,EAAI,GAAK,IAAM9B,EAAK8B,EAAI,IAF5F8P,EAAK/B,GAAc4B,GAAK,cAAgB,CAAC5H,KAAQ7J,EAAK8B,EAAI,GAAImQ,OAAUjS,EAAK8B,EAAI,IAKrF,MAAuB,IAAZgP,IAIVhP,GAAK,EACc,MAAhB9B,EAAK8B,EAAI,KACS,MAAhB9B,EAAK8B,EAAI,IAA8B,MAAhB9B,EAAK8B,EAAI,GAChB,MAAhB9B,EAAK8B,EAAI,IACX8P,EAAsB,gBAAI,CAAC/H,KAAQ7J,EAAK8B,EAAI,GAAImQ,OAAU,KAC1DL,EAAsB,gBAAI,CAAC/H,KAAQ7J,EAAK8B,EAAI,GAAImQ,OAAU,MACjC,MAAhBjS,EAAK8B,EAAI,IAClB8P,EAAsB,gBAAI,CAAC/H,KAAQ7J,EAAK8B,EAAI,GAAImQ,OAAU,KAC1DL,EAAsB,gBAAI,CAAC/H,KAAQ7J,EAAK8B,EAAI,GAAImQ,OAAU,MACjC,MAAhBjS,EAAK8B,EAAI,IAClB8P,EAAsB,gBAAI,CAAC/H,KAAQ7J,EAAK8B,EAAI,GAAImQ,OAAU,KAC1DL,EAAsB,gBAAI,CAAC/H,KAAQ7J,EAAK8B,EAAI,GAAImQ,OAAU,MACjC,MAAhBjS,EAAK8B,EAAI,KAClB8P,EAAsB,gBAAI,CAAC/H,KAAQ7J,EAAK8B,EAAI,GAAImQ,OAAU,KAC1DL,EAAsB,gBAAI,CAAC/H,KAAQ7J,EAAK8B,EAAI,GAAImQ,OAAU,MAG3D7a,QAAQC,KAAK,mCAAoCb,EAAE,GAAK,KAAOwJ,EAAK8B,EAAI,GAAK,IAAM9B,EAAK8B,EAAI,KAG3E,MAAhB9B,EAAK8B,OAAgB8P,EAAKG,UAAY,IAI1C,IAAI,IAAIN,EAAE,EAAGA,EAAEzB,GAAgBvZ,OAAQgb,IACrB,MAAdzR,EAAK8B,KACU,MAAd9B,EAAK8B,IAA8B,MAAd9B,EAAK8B,GAC5B8P,EAAK5B,GAAgByB,GAAK,iBAAmBzR,EAAK8B,GAElD1K,QAAQC,KAAK,mCAAoCb,EAAE,GAAK,KAAMwZ,GAAgByB,GAAK,IAAKzR,EAAK8B,KAE/FA,IAEDmI,EAAIkI,QAAQP,EACb,CACD,CAEA,IACC,OAAO2J,GAAYtR,EACnB,CAAC,MAAMvU,GAEP,OADA0B,QAAQ8B,MAAMxD,GACPuU,CACR,CACD,CAEA,SAASsR,GAAYtR,GAEpB,IAAI,IAAIwH,EAAE,EAAEA,EAAE,EAAEA,IACf,IAAI,IAAIjb,EAAE,EAAEA,EAAEyT,EAAIxT,OAAOD,IACxB4lB,GAASnS,EAAKA,EAAIzT,GAAGL,OA+FxB,SAA8B8T,GAC7B,IAAIoS,GAAU,EACVC,EAAIrS,EAAIxT,OAEZ,IAAI,IAAID,EAAE,EAAEA,EAAE8lB,EAAE9lB,IAAK,CACpB,IAAI4H,EAAW4W,EAAkB/K,EAAKA,EAAIzT,IACtC+lB,EAAUtS,EAAIzT,GAAGgmB,MACrB,IAAI,IAAI/K,EAAE,EAAEA,EAAErT,EAAS3H,OAAOgb,IAC7B,GAAG8K,EAAUne,EAASqT,GAAG+K,MAAQ,EAAG,CACnCpe,EAASqT,GAAG+K,MAAQD,EAAQ,EAC5B,IAAI7b,EAAOsU,EAAmB/K,EAAK7L,EAASqT,IAE5C,IAAI,IAAInW,EAAE,EAAEA,EAAEoF,EAAKjK,OAAO6E,IAAI,CAC7B,IAAIzB,EAAImb,GAAoB/K,EAAKvJ,EAAKpF,IACtCzB,EAAE2iB,MAAQD,EAAQ,EAElB,IAAI3d,EAAIoW,GAAoB/K,EAAKpQ,EAAEE,QAC/B+E,EAAIkW,GAAoB/K,EAAKpQ,EAAEG,QAChC4E,IAAGA,EAAE4d,MAAQD,GACbzd,IAAGA,EAAE0d,MAAQD,EACjB,CACAF,GAAU,CACX,CAEF,CAED,CArHCI,CAAqBxS,GAGrB,IAAIyS,EAAY,EAChB,IAAI,IAAIlmB,EAAE,EAAEA,EAAEyT,EAAIxT,OAAOD,IACrByT,EAAIzT,GAAGgmB,OAASvS,EAAIzT,GAAGgmB,MAAQE,IACjCA,EAAYzS,EAAIzT,GAAGgmB,OAIrB,IAAI,IAAIhmB,EAAE,EAAEA,EAAEyT,EAAIxT,OAAOD,IACxB,GAAwC,IAArCwe,EAAe/K,EAAKA,EAAIzT,GAAGL,MAC7B,GAAG8T,EAAIzT,GAAGgmB,OAASvS,EAAIzT,GAAGgmB,QAAUE,EACnCzS,EAAIzT,GAAGwL,WAAY,MACb,CACNiI,EAAIzT,GAAG2K,WAAY,EAGnB,IAAIwb,EAAOC,GAAc3S,EAAKA,EAAIzT,IASlC,GARGmmB,GAAQ,GACP1S,EAAI0S,GAAM5iB,SACZkQ,EAAIzT,GAAGuD,OAASkQ,EAAI0S,GAAM5iB,OAC1BkQ,EAAIzT,GAAGwD,OAASiQ,EAAI0S,GAAM3iB,SAKxBiQ,EAAIzT,GAAGuD,OACV,IAAI,IAAI0X,EAAE,EAAGA,EAAExH,EAAIxT,OAAQgb,IAC1B,GAAGxH,EAAIzT,GAAGgmB,QAAWvS,EAAIwH,GAAG+K,MAAM,IACjCG,EAAOC,GAAc3S,EAAKA,EAAIwH,IAC3BkL,GAAQ,GAAKnmB,IAAMmmB,GAAM,CAC3B1S,EAAIzT,GAAGuD,OAAyB,MAAfkQ,EAAIwH,GAAGrX,IAAc6P,EAAIwH,GAAGtb,KAAO8T,EAAI0S,GAAMxmB,KAC9D8T,EAAIzT,GAAGwD,OAAyB,MAAfiQ,EAAIwH,GAAGrX,IAAc6P,EAAIwH,GAAGtb,KAAO8T,EAAI0S,GAAMxmB,KAC9D,KACD,CAIJ,aAEO8T,EAAIzT,GAAGwL,UAGhB,OAAOiI,CACR,CAGA,SAAS2S,GAAc3lB,EAASwJ,GAC/B,IAAI,IAAIjK,EAAE,EAAGA,EAAES,EAAQR,OAAQD,IAAK,CACnC,IAAImK,EAAQ1J,EAAQT,GACpB,GAAGiK,EAAMtK,OAASwK,EAAM5G,OACvB,OAAOib,EAAmB/d,EAAS0J,EAAM3G,QACrC,GAAGyG,EAAMtK,OAASwK,EAAM3G,OAC5B,OAAOgb,EAAmB/d,EAAS0J,EAAM5G,OAC3C,CACA,OAAQ,CACT,CAGA,SAASqiB,GAASnlB,EAASd,GAC1B,IAAI2L,EAAMkT,EAAmB/d,EAASd,GAEtC0mB,GAAqB/a,EADR7K,EAAQ6K,GAAK0a,MAAQvlB,EAAQ6K,GAAK0a,MAAQ,EACtBvlB,EAClC,CAGA,SAAS4lB,GAAqB/a,EAAK0a,EAAOvlB,GACzC,IAAI6lB,EAAU,CAAC,SAAU,UACzBN,IACA,IAAI,IAAIhmB,EAAE,EAAGA,EAAEsmB,EAAQrmB,OAAQD,IAAK,CACnC,IAAImmB,EAAO3H,EAAmB/d,EAASA,EAAQ6K,GAAKgb,EAAQtmB,KAC5D,GAAGmmB,GAAQ,EAAG,CACb,IAAII,EAAK9lB,EAAQ+d,EAAmB/d,EAASA,EAAQ6K,GAAK/H,SACtDijB,EAAK/lB,EAAQ+d,EAAmB/d,EAASA,EAAQ6K,GAAK9H,WACtD/C,EAAQ0lB,GAAMH,OAASvlB,EAAQ0lB,GAAMH,MAAQA,KAChDO,EAAGP,MAAQA,EACXQ,EAAGR,MAAQA,GAGTO,EAAGP,MAAQQ,EAAGR,MAChBO,EAAGP,MAAQQ,EAAGR,MACLQ,EAAGR,MAAQO,EAAGP,QACvBQ,EAAGR,MAAQO,EAAGP,OAEfK,GAAqBF,EAAMH,EAAOvlB,EACnC,CACD,CACD,wDArcO,SAAkB9B,GACxB,IAAI8nB,EAAWxH,GAAkBtgB,GAC7B+nB,EAAQ1T,GAAGU,OAAO+S,EAASpF,IAAI,IAQnC,OALAqF,EAAM/Q,UAAU,iHAAiH5F,SACjI2W,EAAM/Q,UAAU,QACbhH,QAAO,WACR,OAAyC,IAAlCqE,GAAGU,OAAOzQ,MAAMgD,OAAOhG,MAC9B,IAAG8P,SACElM,EAAE6e,GAAY+D,EAAShG,QAC/B,sIC9LO,SAASkG,GAAgBlmB,EAASyK,GACxC,IAAI0b,EAAK,CAAC,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,KACrC,IAAI,IAAI5mB,EAAE,EAAGA,EAAES,EAAQR,OAAQD,IAC9B,GAAGS,EAAQT,GAAGkL,GAAY,CACzB,IAAII,EAAMsb,EAAGzmB,QAAQM,EAAQT,GAAGkL,IAC5BI,GAAO,GACVsb,EAAGC,OAAOvb,EAAK,EACjB,CAED,GAAGsb,EAAG3mB,OAAS,EACd,OAAO2mB,EAAG,EAEZ,CAGO,SAASE,GAAUrmB,EAASsmB,GAClC,IAAIA,EAAG9d,SAAW8d,EAAGzd,OACpB,OACD,IAAI4B,EAAa6b,EAAG9d,OAAS,SAAW,SACxC,IAAI,IAAIjJ,EAAE,EAAGA,EAAES,EAAQR,OAAQD,IAAK,CACnC,IAAIgnB,EAAKvmB,EAAQT,GACdgnB,EAAG9b,IAAc6b,EAAG7b,KAAe8b,EAAG9b,IAAc8b,EAAGrnB,OAASonB,EAAGpnB,OACpD,WAAduL,IACD8b,EAAGpjB,IAAMmjB,EAAGnjB,KACXmjB,EAAGxU,MACLyU,EAAGzU,IAAMwU,EAAGxU,MACVwU,EAAGzU,KAAsB,IAAdyU,EAAGvU,QAAiBuU,EAAGvU,SACpCwU,EAAG1U,IAAMyU,EAAGzU,KAEf,CACD,CC1BO,SAAS2U,GAAazU,GAC5B3O,EAAE,iBAAiB4C,YAAY,yBACnB,MAAX+L,EAAiB3O,EAAE,iBAAiBiD,SAAS,iBAAmBjD,EAAE,iBAAiBiD,SAAS,WAC7FjD,EAAE,WAAW2O,GAAQ/L,YAAY,UACjC5C,EAAE,YAAuB,MAAX2O,EAAiB,IAAM,MAAM1L,SAAS,SACrD,CA2FA,SAASogB,GAAaziB,GAElBZ,EAAE,cAAcsjB,GAAG,YACrBtjB,EAAEgB,KAAKJ,GAAY,SAASwD,EAAI5E,GAC5BA,EAAE0H,UACJ1H,EAAEkY,UAAY,EAChB,IAEA1X,EAAEgB,KAAKJ,GAAY,SAASwD,EAAI5E,UACxBA,EAAEkY,SACV,GAEF,CAWO,SAASwD,GAAKpgB,GACpB,IAAI8B,EAAU2mB,EAAiBzoB,GAC3BgB,EAAOkE,EAAE,YAAYiH,MACrBrG,EAAaN,EAAa1D,GAC1BgH,EAASY,GAAc5D,EAAY9E,GACvC,IAAI8H,EAEH,YADA7G,QAAQC,KAAK,wCAGdgD,EAAE,IAAIlF,EAAKgV,WAAW+E,QAGtB,IAAInG,EAAM1O,EAAE,aAAaiH,MACtByH,GAAe,KAARA,EACT9K,EAAO8K,IAAMA,SAEN9K,EAAO8K,IAIf,IAAIC,EAAS3O,EAAE,cAAc+B,KAAK,+BAC/B4M,EAAOvS,OAAS,IAClBwH,EAAO+K,OAASA,EAAO1H,OAIxB,IAAIuc,EAAW,CAAC,cAAe,aAAc,cAAe,cAAe,cAC3E,IAAI,IAAIC,EAAQ,EAAGA,EAAQD,EAASpnB,OAAQqnB,IAAU,CACrD,IAAI9d,EAAO6d,EAASC,GAChBtQ,EAAInT,EAAE,OAAO2F,GACdwN,EAAE/W,OAAS,IACbW,QAAQmC,IAAIiU,EAAEmQ,GAAG,aACdnQ,EAAEmQ,GAAG,YACP1f,EAAO+B,IAAQ,SAER/B,EAAO+B,GAEjB,CAGA,IAAI5F,EAAMC,EAAE,WAAW+B,KAAK,+BACzBhC,EAAI3D,OAAS,IACfwH,EAAO7D,IAAMA,EAAIkH,MACjByc,GAAqB9f,IAItByf,GAAaziB,GAEVZ,EAAE,cAAcsjB,GAAG,YACrB1f,EAAO+f,sBAAuB,SAEvB/f,EAAO+f,qBAEf3jB,EAAE,gJAAgJgB,MAAK,WACtJ,IAAIlF,EAAQsD,KAAKtD,KAAKQ,QAAQ,mBAAmB,EAAI8C,KAAKtD,KAAK8nB,UAAU,EAAGxkB,KAAKtD,KAAKM,OAAO,GAAIgD,KAAKtD,KAEtG,GAAGkE,EAAEZ,MAAM6H,MAAO,CACjB,IAAIA,EAAMjH,EAAEZ,MAAM6H,MACfnL,EAAKQ,QAAQ,mBAAqB,GAAK0D,EAAE,cAAcsjB,GAAG,cAC5Drc,EAAM4c,GAAO5c,IACdrD,EAAO9H,GAAQmL,CAChB,aACQrD,EAAO9H,EAEhB,IAGAkE,EAAE,kGAAkGgB,MAAK,WACrG5B,KAAK0kB,QACPlgB,EAAO5D,EAAEZ,MAAMuG,KAAK,UAAW,SAExB/B,EAAO5D,EAAEZ,MAAMuG,KAAK,QAC7B,IAGA3F,EAAE,iDAAiDgB,MAAK,WAClC,MAAlBhB,EAAEZ,MAAM6H,MACVrD,EAAO5D,EAAEZ,MAAMuG,KAAK,SAAW3F,EAAEZ,MAAM6H,aAEhCrD,EAAO5D,EAAEZ,MAAMuG,KAAK,QAE7B,IAGA3F,EAAE,8CAA8CgB,MAAK,WACpD,GAAqB,MAAlBhB,EAAEZ,MAAM6H,MAAe,CACzB,IAAI8c,EAAO/jB,EAAE,gBAAgBA,EAAEZ,MAAMuG,KAAK,QAAQ,aAClD/B,EAAO5D,EAAEZ,MAAMuG,KAAK,SAAW,CAAC6J,KAAQxP,EAAEZ,MAAM6H,MAAO2Q,OAAU5X,EAAE+jB,GAAM9c,MAC1E,aACQrD,EAAO5D,EAAEZ,MAAMuG,KAAK,QAE7B,IAGA,IAAIqe,EAAgBhkB,EAAE,0DAA0DiH,WAC3DjM,IAAlBgpB,GAAiD,MAAlBA,EACjCpgB,EAAyB,iBAAI,CAAC4L,KAAQ,IAAKoI,OAAUoM,UAE9CpgB,EAAyB,iBAGjC,IACC5D,EAAE,mBAAmB+B,KAAK,QAAQkiB,OAClC,CAAC,MAAMrlB,GACP7B,QAAQC,KAAK,oBACd,CAEAimB,GAAUriB,EAAYgD,GACtB9I,EAAK8B,QAAUgE,EACfZ,EAAEuC,UAAUqR,QAAQ,UAAW,CAAC9Y,GACjC,CAEO,SAASopB,KACZlkB,EAAE,cAAcsjB,GAAG,aACrBtjB,EAAE,4BAA4BgB,MAAK,SAAUoD,GAC5C,GAAqB,KAAlBpE,EAAEZ,MAAM6H,MAAc,CACxB,IAAInL,EAAOsD,KAAKtD,KAAK8nB,UAAU,EAAGxkB,KAAKtD,KAAKM,OAAO,GACnD4D,EAAE,OAAOlE,EAAK,MAAMmL,IAAI4c,GAAO7jB,EAAEZ,MAAM6H,QAAQkd,KAAK,YAAY,EACjE,CACD,IAEAnkB,EAAE,4BAA4BokB,OAC9BpkB,EAAE,4BAA4BqkB,SAE9BrkB,EAAE,4BAA4BgB,MAAK,SAAUoD,GAC5C,GAAqB,KAAlBpE,EAAEZ,MAAM6H,MAAc,CACxB,IAAInL,EAAOsD,KAAKtD,KAAK8nB,UAAU,EAAGxkB,KAAKtD,KAAKM,OAAO,GACnD4D,EAAE,OAAOlE,EAAK,MAAMmL,IAAIjH,EAAEZ,MAAM6H,MACjC,CACD,IAEAjH,EAAE,4BAA4BqkB,OAC9BrkB,EAAE,4BAA4BokB,OAEhC,CAGA,SAASV,GAAqBtb,GAC7BpI,EAAE,gBAAgBqkB,OACF,MAAbjc,EAAKrI,YACAqI,EAAKkc,6BACZtkB,EAAE,2CAA2CukB,QAAQ,QAAQH,OAC7DpkB,EAAE,2CAA2CmkB,KAAK,YAAY,IACxC,MAAb/b,EAAKrI,aACPqI,EAAKoc,8BACZxkB,EAAE,4CAA4CukB,QAAQ,QAAQH,OAC9DpkB,EAAE,2CAA2CmkB,KAAK,YAAY,GAEhE,CAGA,SAASN,GAAOY,GACf,IAAIC,EAAgC,GAA1BlhB,KAAKmhB,OAAOF,EAAG,GAAK,IAC9B,OAAQA,EAAKC,EAAKA,EAAK,EAAIA,EAAK,CACjC,CAhSA1kB,EAAEuC,UAAUM,GAAG,YAAY,SAASxH,EAAGP,GACtC,IACC,IAAIyF,EAAKP,EAAE,YAAYiH,WAEXjM,IADDwJ,GAAc+e,EAAiBzoB,GAAOyF,GAEhDP,EAAE,mBAAmBmkB,KAAK,YAAY,GAEtCnkB,EAAE,mBAAmBmkB,KAAK,YAAY,EACvC,CAAC,MAAMvlB,GACP7B,QAAQC,KAAK4B,EACd,CACD,mDAUO,SAAmBwJ,GACzBpI,EAAE,mBAAmBmkB,KAAK,YAAY,GAEtCnkB,EAAE,mBAAmB+B,KAAK,wCAAwCkF,IAAI,IACtEjH,EAAE,0BAA0BiH,IAAI,IAAIkd,KAAK,YAAY,GAGrC,MAAb/b,EAAKrI,KAA4B,MAAbqI,EAAKrI,IAC3BC,EAAE,0BAA0BoI,EAAKrI,IAAI,MAAMokB,KAAK,WAAW,GAE3DnkB,EAAE,mBAAmBmkB,KAAK,WAAW,GACtCT,GAAqBtb,GAEhB,WAAYA,IAChBA,EAAKuG,OAAS,GACf3O,EAAE,6BAA6BoI,EAAKuG,OAAO,MAAMwV,KAAK,WAAW,GAEjEf,GAAahb,EAAKuG,QAEf,YAAavG,GACfpI,EAAE,eAAemkB,KAAK,UAAW/b,EAAKlB,SACtClH,EAAE,eAAemkB,KAAK,YAAY,KAElCnkB,EAAE,eAAemkB,KAAK,WAAW,GACjCnkB,EAAE,eAAemkB,KAAK,aAAc,QAAS/b,KAG3C,YAAaA,EACfpI,EAAE,eAAemkB,KAAK,UAAW/b,EAAKuQ,SAEtC3Y,EAAE,eAAemkB,KAAK,WAAW,GAU/B,QAAS/b,EACXpI,EAAE,aAAaiH,IAAImB,EAAKsG,KAExB1O,EAAE,aAAaiH,IAAI,KAIpBjH,EAAE,iCAAiCiH,IAAI,KAEvCjH,EAAE,8BAA8BiH,IAAI,KAGpCjH,EAAE,wBAAwBmkB,KAAK,cAAa/b,EAAKjD,aAA4B,MAAbiD,EAAKrI,MAIrEC,EAAE,+BAA+BmkB,KAAK,WACtB,MAAb/b,EAAKrI,KAA6B,MAAbqI,EAAKrI,OAAiB,gCAAiCqI,IAG/EpI,EAAE,cAAcmkB,KAAK,YAAY/b,EAAKub,sBACtCO,KAEA,IAAI,IAAI7nB,KAAO+L,EACH,YAAR/L,GAA6B,QAARA,IACpB2D,EAAE,OAAO3D,GAAKD,QACmB,IAAhCC,EAAIC,QAAQ,eAAuC,OAAd8L,EAAK/L,IAAsC,iBAAd+L,EAAK/L,IACzE2D,EAAE,OAAO3D,GAAK4K,IAAImB,EAAK/L,GAAKmT,MAC5BxP,EAAE,OAAO3D,EAAI,WAAW4K,IAAImB,EAAK/L,GAAKub,SAEtC5X,EAAE,OAAO3D,GAAK4K,IAAImB,EAAK/L,KAEoB,IAAnCA,EAAIC,QAAQ,oBAClB0D,EAAE,cAAcsjB,GAAG,YACrBtjB,EAAE,OAAO3D,EAAI,MAAM4K,IAAI4c,GAAOzb,EAAK/L,KAAO8nB,KAAK,YAAY,GAE3DnkB,EAAE,OAAO3D,EAAI,MAAM4K,IAAImB,EAAK/L,MAMhC,IACC2D,EAAE,mBAAmB+B,KAAK,QAAQkiB,OAClC,CAAC,MAAMrlB,GACP7B,QAAQC,KAAK,oBACd,CACD,qBAiBO,SAAoBlC,GAC1B,IACI8F,EAAaN,EADHijB,EAAiBzoB,IAE/BuoB,GAAaziB,GACb9F,EAAK8B,QAAUgE,EACfZ,EAAEuC,UAAUqR,QAAQ,UAAW,CAAC9Y,GACjC,mDCnIA,IAAI8pB,GACAC,GAGG,SAASC,GAAWhqB,EAAMsN,GAGhC,IAAIqK,EAAYlV,SAASyC,EAAE,QAAQgC,IAAI,cACnC+iB,EAAkB5V,GAAGU,OAAO,YAChCkV,EAAgB5Y,OAAO,QAAQxG,KAAK,QAAS,mBACtCA,KAAK,KAAM,GACXA,KAAK,KAAM,GACXA,KAAK,YAAa,yBAClBmW,MAAM,UAAW,GACjBnW,KAAK,QAAoB,IAAV8M,GACf9M,KAAK,SAAoB,EAAV8M,GACfqJ,MAAM,SAAU,YAChBnW,KAAK,OAAQ,SAEpB,IASIqf,EATSD,EAAgB5Y,OAAO,QAClCxG,KAAK,cAAe,eACpBmW,MAAM,UAAW,GACjBA,MAAM,YAAa,SACnBnW,KAAK,QAAS,wCACdA,KAAK,YAAa,yBAClBA,KAAK,IAAK8M,EAAU,GACpB9M,KAAK,IAAe,IAAV8M,GACVrQ,KAAK,MACmB+J,OAAO,aAAa/J,KAAK,YAW/C6iB,EATSF,EAAgB5Y,OAAO,QAClCxG,KAAK,cAAe,eACpBmW,MAAM,UAAW,GACjBA,MAAM,YAAa,SACnBnW,KAAK,QAAS,wCACdA,KAAK,YAAa,yBAClBA,KAAK,IAAe,KAAV8M,GACV9M,KAAK,IAAe,IAAV8M,GACVrQ,KAAK,MACmB+J,OAAO,aAAa/J,KAAK,cAEjC2iB,EAAgB5Y,OAAO,QACvCxG,KAAK,cAAe,eACpBmW,MAAM,UAAW,GACjBA,MAAM,YAAa,SACnBnW,KAAK,YAAa,yBAClBA,KAAK,IAAe,KAAV8M,GACV9M,KAAK,IAAgB,MAAV8M,GACX9M,KAAK,QAAS,sEACdvD,KAAK,MACK+J,OAAO,aAAa/J,KAAK,mBAExB2iB,EAAgB5Y,OAAO,QAClCxG,KAAK,cAAe,eACpBmW,MAAM,UAAW,GACjBA,MAAM,YAAa,SACnBnW,KAAK,YAAa,yBAClBA,KAAK,QAAS,iDACdA,KAAK,IAAe,KAAV8M,GACV9M,KAAK,IAAe,IAAV8M,GACVrQ,KAAK,MACA+J,OAAO,aAAa/J,KAAK,iCAEnB2iB,EAAgB5Y,OAAO,QACnCxG,KAAK,cAAe,eACpBmW,MAAM,UAAW,GACjBA,MAAM,YAAa,SACnBnW,KAAK,YAAa,yBAClBA,KAAK,QAAS,iDACdA,KAAK,IAAe,IAAV8M,GACV9M,KAAK,IAAe,IAAV8M,GACVrQ,KAAK,MACC+J,OAAO,aAAa/J,KAAK,mCAEhC,IAAI8iB,EAAa,CAAA,EAEjB/V,GAAG2C,UAAU,eACVjP,GAAG,SAAS,WACd,IAGIwE,EACAtH,EAJAa,EAAa+Z,EAAmB4I,EAAiBzoB,IACjDsK,EAAS+J,GAAGU,OAAOzQ,MAAM+lB,QAAQ,UACjC1f,EAAS0J,GAAGU,OAAOzQ,MAAM+lB,QAAQ,UAUrC,GAPG/f,GAAUK,GACZ1F,EAAMmlB,EAAW9c,KAAKgd,QAAQrd,KAAKhI,IACnCsH,EAAajC,EAAS,SAAW,UAEjCrF,EAAMoP,GAAGU,OAAOzQ,MAAM+lB,QAAQ,aAAe,IAAOhW,GAAGU,OAAOzQ,MAAM+lB,QAAQ,aAAe,IAAM,IAG3E,eAApBD,EAAW1V,KACb6V,GAAWzkB,EAAYskB,EAAW9c,KAAKgd,QAAQrd,KAAMhI,GAAK,EAAOsH,OAC7D,IAAuB,aAApB6d,EAAW1V,KAGlB,OAFA8V,GAAS1kB,EAAYskB,EAAW9c,KAAKgd,QAAQrd,KAAOV,EAAY,IAAMtH,EAAOsH,EAAY,EAAI,EAAIA,EAEjG,CACDvM,EAAK8B,QAAUgE,EACfZ,EAAEuC,UAAUqR,QAAQ,UAAW,CAAC9Y,IAChCqU,GAAG2C,UAAU,oBAAoBgK,MAAM,UAAW,GAClDoJ,EAAa,CAAA,CACZ,IACCriB,GAAG,aAAa,WACbqiB,EAAW9c,MACb8c,EAAW9c,KAAKyH,OAAO,QAAQiM,MAAM,UAAW,IACjD3M,GAAG2C,UAAU,oBAAoBgK,MAAM,UAAW,GAE3B,eAApBoJ,EAAW1V,KACXL,GAAGU,OAAOzQ,MAAM+lB,QAAQ,aACzBH,EAAa5iB,KAAK,eAElB6iB,EAAa7iB,KAAK,cACU,aAApB8iB,EAAW1V,OACjBL,GAAGU,OAAOzQ,MAAM+lB,QAAQ,aAC1BH,EAAa5iB,KAAK,WAElB6iB,EAAa7iB,KAAK,gBAErB,IAGF+M,GAAG2C,UAAU,oBAAoBjP,GAAG,YAAY,gBAExB7H,IAApBkqB,EAAW9c,OAAsE,IAAhDmd,EAAUjpB,QAAQ4oB,EAAW9c,KAAKgd,UACrEF,EAAW9c,KAAKyH,OAAO,QAAQiM,MAAM,UAAW,GACjD3M,GAAG2C,UAAU,oBAAoBgK,MAAM,UAAW,EACnD,IAkMD,SAAqBhhB,GAcpB,SAAS0qB,IACRZ,GAAWC,GACX1V,GAAG2C,UAAU,wBACXnM,KAAK,SAAS,UACjB,CAEA,SAAS8f,EAASC,GACjB,GAAGb,IACAD,GAAS7c,KAAKjM,OAAS+oB,GAAe9c,KAAKjM,MAC3C8oB,GAAS7c,KAAKhI,MAAS8kB,GAAe9c,KAAKhI,IAAK,CAClD,IAAIsE,EAAQ,CAACvI,KAAQ6e,EAAa,GAAI5a,IAAO,IAAIN,QAAS,EACpDC,OAAiC,MAAtBklB,GAAS7c,KAAKhI,IAAc6kB,GAAS7c,KAAKjM,KAAO+oB,GAAe9c,KAAKjM,KAC7E6D,OAAiC,MAAtBilB,GAAS7c,KAAKhI,IAAc8kB,GAAe9c,KAAKjM,KAAO8oB,GAAS7c,KAAKjM,MACrF8E,EAAa+Z,EAAmB7f,EAAK8B,SACzC9B,EAAK8B,QAAUgE,EAEf,IAAI6G,EAAMkT,EAAmB7f,EAAK8B,QAASgoB,GAAS7c,KAAKjM,MAAM,EAC/DhB,EAAK8B,QAAQomB,OAAOvb,EAAK,EAAGpD,GAC5BrE,EAAEuC,UAAUqR,QAAQ,UAAW,CAAC9Y,GACjC,CACA6qB,GAAoB,EAAG,EAAG,EAAG,GAC7BxW,GAAG2C,UAAU,wBACXnM,KAAK,SAAS,SAChBif,QAAW5pB,CAEZ,CAEA,SAAS4qB,EAAKvqB,GACbA,EAAEwqB,YAAYjR,kBACd,IAAIkR,EAAKzqB,EAAEyqB,GACPC,EAAK1qB,EAAE0qB,GACPla,EAAO5N,WAAWkR,GAAGU,OAAOzQ,MAAMuG,KAAK,OAAQmgB,EACzCE,EAAO/nB,WAAWkR,GAAGU,OAAOzQ,MAAMuG,KAAK,OAAQogB,EACnDJ,GAAoB7qB,EAAKkR,YAAY,GAAI,EAAGH,EAAMma,EACzD,CA/C0B7W,GAAGU,OAAO,YACJ1D,OAAO,QAAQxG,KAAK,QAAS,uBACrDA,KAAK,eAAgB,GACrBmW,MAAM,mBAAqB,QAC3BnW,KAAK,SAAS,SACdxG,KAAKgQ,GAAGyW,OACA/iB,GAAG,QAAS2iB,GACZ3iB,GAAG,OAAQ+iB,GACX/iB,GAAG,MAAO4iB,IACpBtZ,OAAO,aAAa/J,KAAK,0CAE/BujB,GAAoB,EAAG,EAAG,EAAG,EAqC9B,CA/OCM,CAAYnrB,GAGZsN,EAAK0C,QAAO,SAAU6C,GACjB,QAAOA,EAAE5F,KAAKtI,SAAW3E,EAAKmE,MAClC,IACCkN,OAAO,QACPxG,KAAK,QAAS,aACdA,KAAK,KAAM,GACXA,KAAK,KAAM,GACXA,KAAK,KAAK,SAAS+f,GAAM,OAAS,IAAK5qB,EAAKkR,WAAc,IAC1DrG,KAAK,KAAK,SAAS+f,GAAM,OAAS5qB,EAAKkR,WAAc,IACrDrG,KAAK,QAAW,IAAM7K,EAAKkR,YAAa,MACxCrG,KAAK,SAAW,EAAI7K,EAAKkR,YAAa,MACtC8P,MAAM,SAAU,SAChBA,MAAM,eAAgB,IACtBA,MAAM,UAAW,GACjBnW,KAAK,OAAQ,QAGf,IAAIugB,EAAK,SAASR,GAAK,OAAO5iB,EAAO,IAAKhI,EAAKkR,aAC3Cma,EAAKrrB,EAAKkR,YAAa,EACvBlJ,EAAM,EACNsjB,EAAU,CACbd,SAAc,CAACljB,KAAQ,IAAUhB,MAAS,YAAe8kB,GAAMA,EAAIC,GAAMA,GACzEd,WAAc,CAACjjB,KAAQ,IAAUhB,MAAS,cAAe8kB,GAAMA,EAAIC,GAAMA,GACzEE,WAAc,CAACjkB,KAAQ,IAAUhB,MAAS,cAAe8kB,GAAMA,EAAIC,GAAMA,GACzEG,WAAc,CACblkB,KAAQ,IAAUhB,MAAS,cAC3B8kB,IAAQ,IAAKprB,EAAKkR,YAClBma,GAA2B,GAAnBrrB,EAAKkR,aAEdua,OAAU,CACTnkB,KAAQ,IAAKhB,MAAS,SACtB8kB,GAAOprB,EAAKkR,YAAY,EAAK,EAC7Bma,GAA2B,GAAnBrrB,EAAKkR,YACbwa,OAAU,CAAC,cAAe,OAAQC,KAAQ,UAAW,cAAe,eAInE3rB,EAAK4rB,OACPN,EAAQO,SAAW,CAACvkB,KAAQ,IAAUhB,MAAS,WAAY8kB,IAAQzT,EAAU,EAAG,EAAG0T,GAA0B,GAAnBrrB,EAAKkR,cAGhG,IAAI,IAAI3P,KAAO+pB,EAAS,CACvB,IAAIQ,EAASxe,EAAK0C,QAAO,SAAU6C,GACjC,QAASA,EAAE5F,KAAKtI,SAAW3E,EAAKmE,aACTjE,IAAlB2S,EAAE5F,KAAKrI,QAAwBiO,EAAE5F,KAAKjB,YAAsB,eAARzK,QAC9BrB,IAAvB2S,EAAE5F,KAAK5C,aAA6BwI,EAAE5F,KAAK5C,YAAY/I,OAAS,GAAa,eAARC,QAC9CrB,IAAvB2S,EAAE5F,KAAK5C,aAAqC,aAAR9I,QACdrB,IAArB2S,EAAE5F,KAAKjB,gBAAgD9L,IAArB2S,EAAE5F,KAAKJ,WAAoC,eAARtL,EAC3E,IACC8P,OAAO,QACPxG,KAAK,QAAStJ,GACdyf,MAAM,UAAW,GACjBnW,KAAK,cAAe,eACpBA,KAAK,MAAM,SAASgI,GAAG,OAAOA,EAAEhQ,CAAG,IACnCgI,KAAK,MAAM,SAASgI,GAAG,OAAOA,EAAE/P,CAAE,IAClC+H,KAAK,IAAKygB,EAAQ/pB,GAAK6pB,IACvBvgB,KAAK,IAAKygB,EAAQ/pB,GAAK8pB,IACvBxgB,KAAK,YAAa,UAClBvD,KAAKgkB,EAAQ/pB,GAAK+F,MAEpB,GAAG,WAAYgkB,EAAQ/pB,GACtB,IAAI,IAAIyf,KAASsK,EAAQ/pB,GAAKmqB,OAC7BI,EAAOjhB,KAAKmW,EAAOsK,EAAQ/pB,GAAKmqB,OAAO1K,IAGzC8K,EAAOza,OAAO,aAAa/J,KAAKgkB,EAAQ/pB,GAAK+E,OAC7C0B,GAAO,EACR,CAGAqM,GAAG2C,UAAU,0BACVjP,GAAG,aAAa,WAChB,IAAI2M,EAAOL,GAAGU,OAAOzQ,MAAMuG,KAAK,SAChCwJ,GAAG2C,UAAU,oBAAoBgK,MAAM,UAAW,GAClDoJ,EAAa,CAAC9c,KAAQ+G,GAAGU,OAAOzQ,KAAKyL,YAAa2E,KAAQA,GAG1D,IAAI7R,EAAIJ,SAAS4R,GAAGU,OAAOzQ,MAAMuG,KAAK,OAASpI,SAAS4R,GAAGU,OAAOzQ,MAAMuG,KAAK,MACzE/H,EAAIL,SAAS4R,GAAGU,OAAOzQ,MAAMuG,KAAK,OAASpI,SAAS4R,GAAGU,OAAOzQ,MAAMuG,KAAK,MAC7EwJ,GAAG2C,UAAU,oBAAoBnM,KAAK,YAAa,aAAahI,EAAE,KAAKC,EAAE,GAAG,KAC5EuR,GAAG2C,UAAU,6BACbnM,KAAK,YAAa,cAAchI,EAAG,EAAE8U,GAAY,KAAK7U,EAAa,IAAV6U,GAAgB,eAC1E,IAGFtD,GAAG2C,UAAU,2DACVjP,GAAG,SAAS,SAAUxH,GACtBA,EAAEuZ,kBACJ,IAMIhU,EANAimB,EAAM1X,GAAGU,OAAOzQ,MAAMuG,KAAK,SAC3BgI,EAAIwB,GAAGU,OAAOzQ,KAAKyL,YAAYua,QAChCtqB,EAAKmE,OACPlC,QAAQmC,IAAI2nB,GAIF,aAARA,EACsB,mBAAd/rB,EAAK4rB,KACd5rB,EAAK4rB,KAAK5rB,EAAM6S,GAmKpB,SAAwB7S,EAAM6S,GAC5B,IAAImZ,GAAa,EAyBjB,SAASC,IACND,EACF9mB,EACD,uKAIGuB,OAAO,CACVC,OAAO,EACPJ,MAAO,GACP4lB,SAAU,IACVvlB,MAAyD,IAAlDzB,EAAE,oBAAoBuB,OAAO,SAAU,SAC9CM,KAAM,WAEL7B,EAAEZ,MAAM0C,SAASC,KAAK,uBAAuBmK,QAC3C,EACHxK,QAAS,CACP,CACDU,KAAM,MACN6kB,MAAO,gBACP5kB,MAAO,WACLrC,EAAEZ,MAAMmC,OAAO,SACfvB,EAAE,oBAAoBuB,OAAO,QAC/B,GAEC,CACDa,KAAM,KACN6kB,MAAO,eACP5kB,MAAO,WACLrC,EAAEZ,MAAMmC,OAAO,QACjB,MAKAvB,EAAE,oBAAoBuB,OAAO,QAE9B,CA7DAvB,EAAE,oBAAoBuB,OAAO,CAC3B2lB,UAAU,EACV9lB,MAAOuM,EAAE5F,KAAK1I,aACdmC,OAAO,EACPC,MAAOzB,EAAE0M,QAAQjL,QAAU,IAAM,IAAMzB,EAAE0M,QAAQjL,QAAU,GAC3DC,QAAS,CACT,CACIU,KAAM,SACN6kB,MAAO,mBACP5kB,MAAO,WACZ0kB,GACD,GAED,CACO3kB,KAAM,OACN6kB,MAAO,iBACP5kB,MAAO,WACL6Y,GAAKpgB,GACLkF,EAAEZ,MAAMmC,OAAO,QACjB,MA6CN,IAAI4lB,EACF,4KACFA,GACE,qGACCxZ,EAAE5F,KAAKjM,KAAO6R,EAAE5F,KAAKjM,KAAO,IAC7B,cACFqrB,GACE,sHACCxZ,EAAE5F,KAAK1I,aAAesO,EAAE5F,KAAK1I,aAAe,IAC7C,+IACCsO,EAAE5F,KAAKqf,UAAYzZ,EAAE5F,KAAKqf,UAAY,IACvC,cACFD,GACE,6JACCxZ,EAAE5F,KAAK2G,IAAMf,EAAE5F,KAAK2G,IAAM,IAC3B,+KACCf,EAAE5F,KAAK0G,IAAMd,EAAE5F,KAAK0G,IAAM,IAC3B,cACF0Y,GACE,6JACCxZ,EAAE5F,KAAKsf,IAAM1Z,EAAE5F,KAAKsf,IAAM,IAC3B,8MACC1Z,EAAE5F,KAAKuf,aAAe3Z,EAAE5F,KAAKuf,aAAe,IAC7C,cACFH,GACE,sHAEgB,MAAfxZ,EAAE5F,KAAKhI,IAAc,UAAY,IAFlC,yJAKgB,MAAf4N,EAAE5F,KAAKhI,IAAc,UAAY,IALlC,8OAUFonB,GACE,yIAE6B,IAA5B5pB,SAASoQ,EAAE5F,KAAK4G,QAAgB,UAAY,IAF7C,gKAK6B,IAA5BpR,SAASoQ,EAAE5F,KAAK4G,QAAgB,UAAY,IAL7C,wFAQF3O,EAAE,2BAA6B2N,EAAE5F,KAAK4G,OAAS,MAAMwV,KAAK,WAAW,GAGrEgD,GACE,wHACCxZ,EAAE5F,KAAKpI,OAASgO,EAAE5F,KAAKpI,OAAS,IADjC,yJAICgO,EAAE5F,KAAKrI,OAASiO,EAAE5F,KAAKrI,OAAS,IACjC,eACFynB,GACE,kIACCxZ,EAAE5F,KAAKjB,UAAY6G,EAAE5F,KAAKjB,UAAY,IACvC,eACF,IAAI0c,EAAW,CACb,aACA,cACA,cACA,cACA,cACA,YAEF2D,GACE,oFACA3D,EACGxc,KACC,CAACrB,EAAMxJ,KACE,IAANA,EAAU,iCAAmC,IAC9C,6JACAwJ,EACA,WACAA,EACA,gBACCgI,EAAE5F,KAAKpC,GAAQ,UAAY,IAC5B,YACA4hB,GAAsB5hB,EAAK0R,QAAQ,IAAK,MACxC,aAEHlX,KAAK,IACR,aACFgnB,GAAS,aAGT,IAAIxO,EAAU,CACZ,WACA,OACA,cACA,YACA,KACA,YACA,QACA,MACA,MACA,SACA,eACA,SACA,SACA,MACA,SACA,UAEF3Y,EAAE2E,MAAMgU,EAAS6K,GACjB2D,GAAS,mEACTnnB,EAAEgB,KAAKlG,EAAK0sB,UAAU,SAAUvmB,EAAGwmB,GACjC9O,EAAQpc,KAAKkrB,EAAEjY,KAAO,kBACtB,IAAIkY,EACF,oDACA5sB,EAAK0sB,SAASvmB,GAAG0mB,OACjB,YACElQ,EAAgB9J,EAAE5F,KAAK0f,EAAEjY,KAAO,kBACpC2X,GACE,4DACAI,GAAsBE,EAAEjY,KAAK6H,QAAQ,IAAK,MAC1CqQ,EAFA,qDAKAD,EAAEjY,KACF,6CACAiY,EAAEjY,KACF,kEACmBxU,IAAlByc,EAA8BA,EAAgB,IAC/C,cACJ,IACA0P,GAAS,0DACTA,GACE,8QACCxZ,EAAE5F,KAAK6f,uBAAyBja,EAAE5F,KAAK6f,uBAAyB,IACjE,2BACFT,GAAS,WACTnnB,EAAE,oBAAoB4c,KAAKuK,GAC3BnnB,EAAE,oBAAoBuB,OAAO,QAC7BvB,EACE,qJACAyG,QAAO,WACPqgB,GAAa,CACf,GAEF,CAhXIe,CAAe/sB,EAAM6S,GAEL,WAARkZ,GACTjmB,EAAa+Z,EAAmB4I,EAAiBzoB,IACjDgtB,GAAoBlnB,EAAY+M,EAAE5F,KAAMjN,EAAMitB,KAC7B,eAARlB,GACTjmB,EAAa+Z,EAAmB4I,EAAiBzoB,IACjDA,EAAK8B,QAAUgE,EACf0lB,GAAWxrB,EAAM8F,EAAY+M,EAAE5F,KAAKjM,MACpCkE,EAAEuC,UAAUqR,QAAQ,UAAW,CAAC9Y,KACf,eAAR+rB,IACTjmB,EAAa+Z,EAAmB4I,EAAiBzoB,IACjDurB,GAAWvrB,EAAM8F,EAAY+M,EAAE5F,KAAKjM,MACpChB,EAAK8B,QAAUgE,EACfZ,EAAEuC,UAAUqR,QAAQ,UAAW,CAAC9Y,KAGjCkF,EAAEuC,UAAUqR,QAAQ,WAAY,CAAC9Y,GAClC,IAGA,IAAIyqB,EAAY,GAEhBnd,EAAK0C,QAAO,SAAU6C,GAAK,OAAQA,EAAE5F,KAAKtI,MAAS,IAClDoD,GAAG,SAAS,SAAUxH,EAAGsS,GACrBtS,EAAE2sB,SACwB,IAA1BzC,EAAUjpB,QAAQqR,GACpB4X,EAAUhpB,KAAKoR,GAEf4X,EAAUvC,OAAOuC,EAAUjpB,QAAQqR,GAAI,GAExC4X,EAAY,CAAC5X,GAEX,cAAe7S,IACjBA,EAAKmtB,UAAUta,EAAE5F,MACjBoH,GAAG2C,UAAU,cAAcgK,MAAM,UAAW,GAC5C3M,GAAG2C,UAAU,cAAchH,QAAO,SAAS6C,GAAI,OAAiC,IAA1B4X,EAAUjpB,QAAQqR,EAAW,IAAEmO,MAAM,UAAW,IAEvG,IACAjZ,GAAG,aAAa,SAASxH,EAAGsS,GAC5BtS,EAAEuZ,kBACFiQ,GAAiBlX,EACdiX,GACCA,GAAS7c,KAAKjM,OAAS+oB,GAAe9c,KAAKjM,MAC3C8oB,GAAS7c,KAAKhI,MAAQ8kB,GAAe9c,KAAKhI,KAC5CoP,GAAGU,OAAOzQ,MAAMyQ,OAAO,QAAQiM,MAAM,UAAW,KAIlD3M,GAAGU,OAAOzQ,MAAMyQ,OAAO,QAAQiM,MAAM,UAAW,IAChD3M,GAAGU,OAAOzQ,MAAM0S,UAAU,wEAAwEgK,MAAM,UAAW,GACnH3M,GAAGU,OAAOzQ,MAAM0S,UAAU,iBAAiBgK,MAAM,UAAW,GAC5D3M,GAAGU,OAAOzQ,MAAM0S,UAAU,cAAcgK,MAAM,UAAW,GAEzD6J,GAAoB7qB,EAAKkR,YAAY,GAAI,EAAGlR,EAAKkR,YAAY,EAAG,EAAG2B,EAAEhQ,EAAE,KAAKgQ,EAAE/P,EAAE,IAChF,IACAiF,GAAG,YAAY,SAAS8K,GACxB,GAAGiX,GACF,OAEDzV,GAAGU,OAAOzQ,MAAM0S,UAAU,wEAAwEgK,MAAM,UAAW,IACtF,IAA1ByJ,EAAUjpB,QAAQqR,IACpBwB,GAAGU,OAAOzQ,MAAMyQ,OAAO,QAAQiM,MAAM,UAAW,GACjD3M,GAAGU,OAAOzQ,MAAM0S,UAAU,iBAAiBgK,MAAM,UAAW,GAC5D3M,GAAGU,OAAOzQ,MAAM0S,UAAU,cAAcgK,MAAM,UAAW,GAEzD,IAAIoM,EAAS/Y,GAAGgZ,QAAQxa,GAAG,GACvBya,EAASjZ,GAAGgZ,QAAQxa,GAAG,GACxBya,EAAS,GAAIttB,EAAKkR,aACpBmD,GAAG2C,UAAU,oBAAoBgK,MAAM,UAAW,GAC/C8I,KAECphB,KAAKuI,IAAIqc,GAAU,IAAKttB,EAAKkR,aAChCxI,KAAKuI,IAAIqc,IAAW,IAAKttB,EAAKkR,aAC9Bkc,EAAS,GAAIptB,EAAKkR,cACjB2Z,GAAoB,EAAG,EAAG,EAAG,EAGjC,GACD,CAEA,SAASoC,GAAOjtB,EAAM8B,GAErB9B,EAAK8B,QAAUA,EACfoD,EAAEuC,UAAUqR,QAAQ,UAAW,CAAC9Y,GACjC,CAyDA,SAAS6qB,GAAoBlB,EAAI4D,EAAI3D,EAAI4D,EAAInY,GACzCA,GACFhB,GAAG2C,UAAU,wBAAwBnM,KAAK,YAAa,aAAawK,EAAU,KAE/EhB,GAAG2C,UAAU,wBACXnM,KAAK,KAAM8e,GACX9e,KAAK,KAAM0iB,GACX1iB,KAAK,KAAM+e,GACX/e,KAAK,KAAM2iB,EACd,CAEA,SAASf,GAAsBja,GAC7B,OAAOA,EAAO/J,OAAO,GAAGgK,cAAgBD,EAAOE,MAAM,EACvD,CA0NO,SAAS8X,GAAS1oB,EAASwL,EAAMrI,EAAKwoB,EAAQlhB,GACpD,GAAGA,IAAgE,IAAnDrH,EAAEC,QAAQoH,EAAW,CAAE,SAAU,WAChD,OAAO,IAAIvI,MAAM,0BAA0BuI,QAEtB,IAAXkhB,IACVA,EAAS,GACV,IACIC,EAAU/gB,EAYVghB,EAbA1kB,EAAW4W,EAAqB/d,EAASwL,GAE7C,GAAwB,IAApBrE,EAAS3H,OAAc,CAC1B,IAAIoO,EAAU6a,GAAWzoB,EAASwL,EAAmB,MAAbA,EAAKrI,IAAc,IAAK,IAAkB,MAAbqI,EAAKrI,KAC1EyK,EAAQ1D,WAAY,EACpB0hB,EAAWhe,EAAQ1O,KACnB2L,EAAMkT,EAAmB/d,EAASwL,EAAKtM,MAAM,CAC9C,KAAO,CACN,IAAIojB,EAAInb,EAAS,GACjBykB,EAAYtJ,EAAEvf,SAAWyI,EAAKtM,KAAOojB,EAAExf,OAASwf,EAAEvf,OAClD8H,EAAMkT,EAAmB/d,EAASsiB,EAAEpjB,KACrC,CAGGuL,IACFohB,EAAU3F,GAAgBlmB,EAASyK,IACpC,IAAIqhB,EAAc,GAClB,IAAK,IAAIvsB,EAAI,EAAGA,EAAIosB,EAAQpsB,IAAK,CAChC,IAAIkI,EAAQ,CAACvI,KAAQ6e,EAAa,GAAI5a,IAAOA,EACzCL,OAAwB,MAAb0I,EAAKrI,IAAcqI,EAAKtM,KAAO0sB,EAC1C7oB,OAAwB,MAAbyI,EAAKrI,IAAcyoB,EAAWpgB,EAAKtM,MAClDc,EAAQomB,OAAOvb,EAAK,EAAGpD,GAEpBgD,IACFhD,EAAMgD,GAAaohB,GACpBC,EAAYnsB,KAAK8H,EAClB,CACA,OAAOqkB,CACR,CAGO,SAASrD,GAAWzoB,EAASwL,EAAMrI,EAAK4oB,EAASthB,GACvD,GAAGA,IAAgE,IAAnDrH,EAAEC,QAAQoH,EAAW,CAAE,SAAU,WAChD,OAAO,IAAIvI,MAAM,0BAA0BuI,GAE5C,IAAIuhB,EAAS,CAAC9sB,KAAQ6e,EAAa,GAAItb,aAAc,OAAQU,IAAOA,GACjEqI,EAAKT,UACPihB,EAAOjhB,WAAY,GAEnBihB,EAAOlpB,OAAS0I,EAAK1I,OACrBkpB,EAAOjpB,OAASyI,EAAKzI,QAEtB,IAAI8H,EAAMkT,EAAmB/d,EAASwL,EAAKtM,MAU3C,OARGuL,GFnpBG,SAAmBzK,EAASsmB,EAAIC,EAAI9b,IACtC6b,EAAG7b,KACN6b,EAAG7b,GAAayb,GAAgBlmB,EAASyK,IACrC6b,EAAG7b,MAGR8b,EAAG9b,GAAa6b,EAAG7b,GAChB6b,EAAGxU,MACLyU,EAAGzU,IAAMwU,EAAGxU,MACVwU,EAAGzU,KAAsB,MAAdyU,EAAGvU,QAAmBuU,EAAGvU,SACtCwU,EAAG1U,IAAMyU,EAAGzU,KAEd,CEwoBEoa,CAAUjsB,EAASA,EAAQ6K,GAAMmhB,EAAQvhB,GAGtCshB,GACHlhB,IAED7K,EAAQomB,OAAOvb,EAAK,EAAGmhB,GAChBA,CACR,CAGO,SAAStC,GAAWxrB,EAAM8B,EAASd,GACzC,IAAI4D,EAAQC,EAQR6oB,EAOArsB,EAbA2sB,EAAYnO,EADLA,EAAY7f,EAAKgV,YAExBiZ,EAAYpO,GAAoBmO,EAAWhtB,GAC3CsM,EAAQ2gB,EAAUhhB,KAClBL,EAAQqhB,EAAUrhB,MAElBshB,GAAO,IAEPjlB,EAAW4W,EAAqB/d,EAASwL,GAO7C,GANGrE,EAAS3H,OAAS,IACpBosB,EAAWzkB,EAAS,GAAGrE,SAAW0I,EAAKtM,KAAOiI,EAAS,GAAGpE,OAASoE,EAAS,GAAGrE,OAC/EspB,EAAMrO,GAAoBmO,EAAWN,GAAUzgB,KAAKxH,IAIxC,IAAVmH,EAMF,IALAhI,EAAS,CAAC5D,KAAQ6e,EAAa,GAAI5a,IAAO,IAAK4H,WAAa,GAC5DhI,EAAS,CAAC7D,KAAQ6e,EAAa,GAAI5a,IAAO,IAAK4H,WAAa,GAC5D/K,EAAQomB,OAAO,EAAG,EAAGtjB,GACrB9C,EAAQomB,OAAO,EAAG,EAAGrjB,GAEjBxD,EAAE,EAAGA,EAAES,EAAQR,OAAQD,KACrBS,EAAQT,GAAGwL,WAA0D,IAA7CgT,EAAe/d,EAASA,EAAQT,GAAGL,OAC3Dc,EAAQT,GAAGL,OAAS4D,EAAO5D,MAAQc,EAAQT,GAAGL,OAAS6D,EAAO7D,cAC3Dc,EAAQT,GAAGwL,UAClB/K,EAAQT,GAAG2K,WAAY,EACvBlK,EAAQT,GAAGuD,OAASA,EAAO5D,KAC3Bc,EAAQT,GAAGwD,OAASA,EAAO7D,UAGvB,CACN,IAAImtB,EAActO,GAAoBmO,EAAWC,EAAUhhB,KAAKrI,QAC5DwpB,EAAcvO,GAAoBmO,EAAWC,EAAUhhB,KAAKpI,QAC5DwpB,EAAYxO,EAAqB/d,EAASwL,GAG1CghB,EAAM,IACNC,EAAMN,EAAUhhB,KAAKxH,GACzB,IAAIpE,EAAE,EAAGA,EAAEgtB,EAAU/sB,OAAQD,IAAI,CAChC,IAAImtB,EAAM3O,GAAoBmO,EAAWK,EAAUhtB,GAAGL,MAAMiM,KAAKxH,GAC9D+oB,EAAMF,GAAOE,EAAMP,EAAUhhB,KAAKxH,KACpC6oB,EAAME,GACJA,EAAMD,IACRA,EAAMC,EACR,CACA,IAGI1pB,EAHA+oB,EAAWU,GAAON,EAAUhhB,KAAKxH,IAAOyoB,IAAQK,GAAOD,EAAM,IAC9DtuB,EAAKmE,OACPlC,QAAQmC,IAAI,OAAOmqB,EAAI,QAAQD,EAAI,QAAQL,EAAUhhB,KAAKxH,GAAG,YAAYooB,GAIzE/oB,GAFK+oB,GAAWO,EAAYnhB,KAAKxH,GAAK0oB,EAAYlhB,KAAKxH,IACtDooB,GAAWO,EAAYnhB,KAAKxH,GAAK0oB,EAAYlhB,KAAKxH,GAC5Coa,EAAmB/d,EAASwL,EAAKzI,QAEjCgb,EAAmB/d,EAASwL,EAAK1I,QAEzC,IAAIoC,EAASlF,EAAQgD,GACrBD,EAAS0lB,GAAWzoB,EAASkF,EAAQ,IAAK6mB,GAC1CjpB,EAAS2lB,GAAWzoB,EAASkF,EAAQ,IAAK6mB,GAE1C,IAAIY,EAAQ5O,EAAmB/d,EAAS+C,EAAO7D,MAC3C0tB,EAAQ7O,EAAmB/d,EAAS8C,EAAO5D,MAC/C,GAAGytB,EAAQC,EAAO,CACjB,IAAIC,EAAQ7sB,EAAQ2sB,GACpB3sB,EAAQ2sB,GAAS3sB,EAAQ4sB,GACzB5sB,EAAQ4sB,GAASC,CAClB,CAEA,IAAIC,EAAU/O,EAAyB/d,EAASwL,GAC5CuhB,EAAMZ,EAAUhhB,KAAKxH,GACzB,IAAIpE,EAAE,EAAGA,EAAEutB,EAAQttB,OAAQD,IAAI,CAC9B,IAAIytB,EAAMjP,GAAoBmO,EAAWY,EAAQvtB,GAAGL,MAAMiM,KAAKxH,GAG/D,GAFGzF,EAAKmE,OACPlC,QAAQmC,IAAI,UAAU/C,EAAE,IAAIutB,EAAQvtB,GAAGL,KAAK,KAAK6tB,EAAMC,GAAOA,EAAMR,GAAK,QAAQO,EAAI,QAAQC,EAAI,QAAQR,IACtGT,GAAWgB,EAAMC,IAAQA,EAAMR,EAAI,CACtC,IAAIS,EAAOlP,EAAmB/d,EAAS8sB,EAAQvtB,GAAGL,MAClDc,EAAQitB,GAAMnqB,OAASA,EAAO5D,KAC9Bc,EAAQitB,GAAMlqB,OAASA,EAAO7D,IAC/B,CACD,CACD,CAEa,IAAV4L,GACFhI,EAAOiI,WAAY,EACnBhI,EAAOgI,WAAY,GACVD,EAAQ,IACjBhI,EAAOoH,WAAY,EACnBnH,EAAOmH,WAAY,GAEpB,IAAIW,EAAMkT,EAAmB/d,EAASwL,EAAKtM,MAK3C,GAJAc,EAAQ6K,GAAK/H,OAASA,EAAO5D,KAC7Bc,EAAQ6K,GAAK9H,OAASA,EAAO7D,YACtBc,EAAQ6K,GAAKX,UAEjB,gBAAiBsB,EAAM,CACzB,IAAI0hB,EAAWltB,EAAQ+d,EAAmB/d,EAAS4rB,IAChD,cAAesB,IACjBA,EAASpqB,OAASA,EAAO5D,KACzBguB,EAASnqB,OAASA,EAAO7D,KAE3B,CACD,CAGO,SAASuqB,GAAWvrB,EAAM8B,EAASd,GACzC,IACIgtB,EAAYnO,EADLA,EAAY7f,EAAKgV,YAExBiZ,EAAYpO,GAAoBmO,EAAWhtB,GAM3CiuB,EAAepP,EAAmB/d,EAASmsB,EAAUhhB,MAGrDiiB,EADWjB,EAAUjnB,OAAOiC,SACb3H,OAAS,EAE5B,GAAG2tB,EAAa3tB,OAAQ,EAAE,CAGzB4tB,EAFcrP,EAAmBmO,EAAUhtB,GAC1B6e,EAAmBmO,EAAUiB,EAE/C,CAEA,IAAIvf,EAAU6a,GAAWzoB,EAASmsB,EAAUhhB,KAA6B,MAAvBghB,EAAUhhB,KAAKhI,IAAc,IAAM,IAAKiqB,GAE1Fxf,EAAQ1D,WAAY,EAEpB,IAAIzC,EAAQ,CAACvI,KAAQ6e,EAAa,GAAI5a,IAAO,IAAKN,QAAQ,GAC1D4E,EAAM3E,OAAiC,MAAvBqpB,EAAUhhB,KAAKhI,IAAcgpB,EAAUhhB,KAAKjM,KAAO0O,EAAQ1O,KAC3EuI,EAAM1E,OAAiC,MAAvBopB,EAAUhhB,KAAKhI,IAAcyK,EAAQ1O,KAAOitB,EAAUhhB,KAAKjM,KAE3E,IAAI2L,EAAMkT,EAAmB/d,EAASmsB,EAAUhhB,KAAKjM,MAAM,EAC3Dc,EAAQomB,OAAOvb,EAAK,EAAGpD,EACxB,CAGA,SAAS4lB,GAAepmB,EAAMuE,EAAM8hB,GACnC,IACIC,EAAUC,EADVC,EAAS1P,EAAsBA,EAAc9W,GAAOuE,EAAKV,MAAOwiB,GAEpE,IAAI,IAAI/tB,EAAE,EAAGA,EAAEkuB,EAAOjuB,OAAQD,IAC1BkuB,EAAOluB,GAAGwB,EAAIyK,EAAKzK,IACrBwsB,EAAWE,EAAOluB,KACfiuB,GAAYC,EAAOluB,GAAGwB,EAAIyK,EAAKzK,IAClCysB,EAAWC,EAAOluB,IAEpB,MAAO,CAACguB,EAAUC,EACnB,CAGO,SAAStC,GAAoBlrB,EAASwL,EAAMtN,EAAMitB,GACxD,IAGI5rB,EAAGib,EAyEHhX,EA5EAyD,EAAO8W,EAAY7f,EAAKgV,WACxBjI,EAAS8S,EAAc9W,GACvBymB,EAAU,GAId,QAAetvB,IAAZoN,EAAK7H,GAAkB,CACzB,IAAIgqB,EAAS5P,GAAoB9S,EAAQO,EAAKtM,WAChCd,IAAXuvB,IACFniB,EAAOmiB,EAAOxiB,KAChB,CAEA,GAAGK,EAAKjD,YACP,IAAIhJ,EAAE,EAAGA,EAAEiM,EAAKjD,YAAY/I,OAAQD,IAAI,CACvC,IAAI2F,EAASsG,EAAKjD,YAAYhJ,GAC1BquB,EAAK,CAAC7P,GAAoB/d,EAASkF,EAAOpC,OAAO5D,MACjD6e,GAAoB/d,EAASkF,EAAOnC,OAAO7D,OAE/C,IAAIsb,EAAE,EAAGA,EAAEoT,EAAGpuB,OAAQgb,KAClBoT,EAAGpT,GAAGtb,OAASsM,EAAKtM,WAA4Bd,IAApBwvB,EAAGpT,GAAGtQ,WAA2B0jB,EAAGpT,GAAGzP,aACrE/K,EAAQomB,OAAOrI,EAAmB/d,EAAS4tB,EAAGpT,GAAGtb,MAAO,GACxDwuB,EAAQ/tB,KAAKiuB,EAAGpT,KAIlB,IAAIrT,EAAWjC,EAAOiC,SAClB0mB,EAAiBzqB,EAAEgH,IAAIjD,GAAU,SAASvE,EAAG4E,GAAI,OAAO5E,EAAE1D,IAAK,IACnE,IAAIsb,EAAE,EAAGA,EAAErT,EAAS3H,OAAQgb,IAAK,CAChC,IAAI/S,EAAQsW,GAAoB/d,EAASmH,EAASqT,GAAGtb,MACrD,GAAGuI,EAAM,CACRA,EAAMyC,WAAY,EAClB,IACIlC,EADAyB,EAAOsU,EAAmB/d,EAASyH,GAIvC,GAFGgC,EAAKjK,OAAS,IAChBwI,EAAM+V,GAAoB/d,EAASyJ,EAAK,KACtCzB,GAAOA,EAAIlF,SAAW2E,EAAM3E,OAC9B2E,EAAM3E,OAASkF,EAAIlF,OACnB2E,EAAM1E,OAASiF,EAAIjF,YACb,GAAGiF,EAAK,CACd,IACI8lB,EAAMT,GAAepmB,EADP8W,GAAoB9S,EAAQxD,EAAMvI,MACT2uB,GAC3CpmB,EAAM3E,OAASgrB,EAAI,GAAKA,EAAI,GAAG3iB,KAAKrI,OAAUgrB,EAAI,GAAKA,EAAI,GAAG3iB,KAAKrI,OAAS,KAC5E2E,EAAM1E,OAAS+qB,EAAI,GAAKA,EAAI,GAAG3iB,KAAKpI,OAAU+qB,EAAI,GAAKA,EAAI,GAAG3iB,KAAKpI,OAAS,IAC7E,MACC/C,EAAQomB,OAAOrI,EAAmB/d,EAASyH,EAAMvI,MAAO,EAE1D,CACD,CACD,MAEAc,EAAQomB,OAAOrI,EAAmB/d,EAASwL,EAAKtM,MAAO,GAKxD,IADAiB,QAAQmC,IAAIorB,GACRnuB,EAAE,EAAGA,EAAEmuB,EAAQluB,OAAQD,IAAK,CAC/B,IAAIwuB,EAAML,EAAQnuB,GACdgL,EAAOwT,EAAqB/d,EAAS+tB,GAEzC,GADA5tB,QAAQmC,IAAI,MAAOyrB,EAAI7uB,KAAMqL,GAC1BA,EAAK/K,OAAS,EAAG,CACnBW,QAAQmC,IAAI,WAAYyrB,EAAI7uB,KAAMqL,GAClC,IACIgB,EADawS,GAAoB9S,EAAQ8iB,EAAI7uB,MACvBqM,YAC1B,IAAIiP,EAAE,EAAGA,EAAEjP,EAAU/L,OAAQgb,IAC5Bra,QAAQmC,IAAIiJ,EAAUhM,IACnBgM,EAAUiP,GAAGrP,KAAKrI,SACpB3C,QAAQmC,IAAI,UAAWiJ,EAAUiP,GAAGrP,KAAKrI,OAAQyI,EAAUiP,GAAGrP,KAAKpI,QACnE/C,EAAQomB,OAAOrI,EAAmB/d,EAASuL,EAAUiP,GAAGrP,KAAKrI,OAAO5D,MAAO,GAC3Ec,EAAQomB,OAAOrI,EAAmB/d,EAASuL,EAAUiP,GAAGrP,KAAKpI,OAAO7D,MAAO,GAG9E,CACD,EF/0BM,SAAoBc,GAC1B,IAAIguB,EAAa,CAAC,SAAU,UAC5B,IAAI,IAAIzuB,EAAE,EAAGA,EAAES,EAAQR,OAAQD,IAC9B,IAAI,IAAIib,EAAE,EAAGA,EAAEwT,EAAWxuB,OAAQgb,IAAK,CACtC,IAAI/P,EAAYujB,EAAWxT,GAC3B,GAAGxa,EAAQT,GAAGkL,GAAY,CACzB,IAAI5K,EAAQ,EACZ,IAAI,IAAI2a,EAAE,EAAGA,EAAExa,EAAQR,OAAQgb,IAC3Bxa,EAAQwa,GAAG/P,KAAezK,EAAQT,GAAGkL,IACvC5K,IAECA,EAAQ,UACHG,EAAQT,GAAG,CAACkL,GACrB,CACD,CAEF,CEi0BCwjB,CAAWjuB,GAGX,IAEC,IAAIkuB,EAAU9qB,EAAEsT,OAAO,CAAE,EAAExY,GAC3BgwB,EAAQluB,QAAU+d,EAAmB/d,GACrC+d,EAAwBmQ,GAExB1qB,EAAKua,EAAkB/d,EACvB,CAAC,MAAMgC,GAEP,MADA+b,EAAe,UAAW,mDACpB/b,CACP,CACA,OAAGwB,EAAGhE,OAAS,GAEgC,IAA3Cue,EAAkB7f,EAAK8B,SAASR,QAClCW,QAAQ8B,MAAM,uCAAwCuB,QACtDua,EAAe,UAAW,kEAAmEoN,EAAQjtB,EAAM8B,KAK1GmrB,GACFA,EAAOjtB,EAAM8B,GAEPA,EACR,mIC55BO,SAASmuB,GAAUjwB,EAAMsN,GAE/B4iB,GAASlwB,EAAMsN,GAAQ,IAAOtN,EAAKkR,YAAe,GAAMlR,EAAKkR,aAC3D,SAAS2B,GACR,OAAG7S,EAAKmE,OACC,iBAAkB0O,EAAE5F,KAAO4F,EAAE5F,KAAK1I,aAAesO,EAAE5F,KAAKjM,MAAQ,KAAO6R,EAAE5F,KAAKxH,GAChF,iBAAkBoN,EAAE5F,KAAO4F,EAAE5F,KAAK1I,aAAe,EAAG,QAAGrE,EAAW,CAAC,iBAE7EgwB,GAASlwB,EAAMsN,GAAQ,GAAMtN,EAAKkR,cAAiB,GAAMlR,EAAKkR,YAAa,KAC1E,SAAS2B,GACT,OAAG7S,EAAKmE,OACC,cAAe0O,EAAE5F,KAAO4F,EAAE5F,KAAKqf,UAAYzZ,EAAE5F,KAAKjM,MAAQ,KAAO6R,EAAE5F,KAAKxH,GACzE,cAAeoN,EAAE5F,KAAO4F,EAAE5F,KAAKqf,UAAY,EAAG,QAAGpsB,EAAW,CAAC,cACtE,IAAIyX,EAAYlV,SAuGjB,SAAezC,GACd,IAAImwB,EAAQnwB,EAAK2X,UACjB,GAAIwY,IAAU1tB,SAAS0tB,EAAO,IAC7B,OAAOA,EAER,GAAGA,EAAM3uB,QAAQ,OAAS,EACzB,OAAO2uB,EAAM5T,QAAQ,KAAM,IACvB,IAA4B,IAAzB4T,EAAM3uB,QAAQ,MACrB,OAAO2uB,EAER,OADAA,EAAQhtB,WAAWgtB,EAAM5T,QAAQ,KAAM,KAC/BpZ,WAAW+d,iBAAiBhc,EAAE,IAAIlF,EAAKgV,WAAW0N,IAAI,IAAI3K,UAAUoY,EAAO,CACpF,CAlH0BC,CAAMpwB,IAAS,EAExC,IAAI,IAAIqwB,EAAK,EAAGA,EAAKrwB,EAAKswB,OAAOhvB,OAAQ+uB,IAAQ,CAChD,IAAIE,EAAQvwB,EAAKswB,OAAOD,GACpBhtB,EAAO2hB,MAAMwL,QAAQD,GAASA,EAAQ,CAACA,IACxCltB,EAAI7B,QAAQ,QAAU,GAAK6B,EAAI7B,QAAQ,QAAU,IACnD0uB,GAASlwB,EAAMsN,GAAOtN,EAAKkR,aAC1B,SAAS2B,GAAK,OAAO4d,GAAK5d,EAAGxP,EAAKsU,EAAa,IAC/C,SAAS9E,GAAK,OAAO6d,GAAS7d,EAAGxP,EAAM,GAAG,eAAgBA,EAE7D,CAGA,IAAI,IAAIhC,EAAE,EAAEA,EAAErB,EAAK0sB,SAASprB,OAAQD,IAAK,CACxC,IAAIsvB,EAAU3wB,EAAK0sB,SAASrrB,GAAGqT,KAC/Bwb,GAASlwB,EAAMsN,GAAOtN,EAAKkR,aACzB,SAAS2B,GAAK,OAAO4d,GAAK5d,EAAG,CAAC8d,GAAUhZ,EAAa,IACrD,SAAS9E,GACR,IAAI+d,EAAMD,EAAQpU,QAAQ,IAAK,KAAKA,QAAQ,SAAU,OACtD,OAAOoU,EAAQ,mBAAoB9d,EAAE5F,KAAO2jB,EAAK,KAAM/d,EAAE5F,KAAK0jB,EAAQ,kBAAoB,EAC3F,GAAG,eAAgB,CAACA,GACvB,CAGA,IAAI,IAAIN,EAAK,EAAGA,EAAKrwB,EAAKswB,OAAOhvB,OAAQ+uB,IAAQ,CAChD,IAAIE,EAAQvwB,EAAKswB,OAAOD,GACpBhtB,EAAO2hB,MAAMwL,QAAQD,GAASA,EAAQ,CAACA,IAChB,IAAxBltB,EAAI7B,QAAQ,SAAyC,IAAxB6B,EAAI7B,QAAQ,QAC3C0uB,GAASlwB,EAAMsN,GAAOtN,EAAKkR,aAC1B,SAAS2B,GAAK,OAAO4d,GAAK5d,EAAGxP,EAAKsU,EAAa,IAC/C,SAAS9E,GAAK,OAAO6d,GAAS7d,EAAGxP,EAAM,GAAG,eAAgBA,EAE7D,CACD,CAEA,SAASqtB,GAAS7d,EAAGxP,GACpB,IAAIwU,EAAM,GACV,IAAI,IAAIsP,EAAE,EAAGA,EAAE9jB,EAAI/B,OAAQ6lB,IAAK,CAC/B,IAAI0J,EAAaxtB,EAAI8jB,GACrB,GAAGtU,EAAE5F,KAAK4jB,GACT,GAAkB,YAAfA,EAA0B,CAC5B,IAAIC,EAAOje,EAAE5F,KAAK8Z,QAAQhL,MAAM,KAChC,IAAI,IAAIgV,EAAO,EAAEA,EAAOD,EAAKxvB,OAAOyvB,IACjB,KAAfD,EAAKC,KAAclZ,GAAOiZ,EAAKC,GAAQ,IAE5C,MAAO,GAAkB,QAAfF,EACThZ,GAAOhF,EAAE5F,KAAK4jB,GAAa,UACrB,GAAkB,eAAfA,EACThZ,GAAO,UACD,GAAGgZ,EAAWjtB,MAAM,gBAAkB,WAAYiP,EAAE5F,KAAK4jB,GAAa,CAC5E,IAAIG,EAAIne,EAAE5F,KAAK4jB,GAAoB,OAAEpe,cAE5B,MAANue,IACFnZ,GAAOgZ,EAAWtU,QAAQ,aAAc,IAAI9J,cAC5CoF,GAAc,MAANmZ,EAAY,KAAc,MAANA,EAAY,KAAO,IAEhD,MAAM,GAAGH,EAAWjtB,MAAM,kBAAmB,CAC7C,IAAIotB,EAAIne,EAAE5F,KAAK4jB,GAAYpe,cAC3BoF,GAAOgZ,EAAWtU,QAAQ,gBAAiB,IAAI9J,cAC/CoF,GAAc,MAANmZ,EAAY,KAAc,MAANA,EAAY,KAAO,GAChD,MACEnZ,GAAOhF,EAAE5F,KAAK4jB,EAGlB,CACA,GAAW,KAARhZ,EAAY,OAAOA,CACvB,CAEA,SAAS4Y,GAAK5d,EAAGxP,EAAKsU,GACrB,GAAIsZ,GAAepe,EAAGxP,GAEtB,OADAwP,EAAEqe,SAAare,EAAEqe,SAA4Bre,EAAEqe,SAASvZ,EAAlB,KAAVA,EACrB9E,EAAEqe,QACV,CAEA,SAASD,GAAepe,EAAGyd,GAC1B,IAAI,IAAInJ,EAAE,EAAGA,EAAEmJ,EAAOhvB,OAAQ6lB,IAC7B,GAAGnhB,EAAYsqB,EAAOnJ,GAAItU,EAAE5F,MAAO,OAAO,EAE3C,OAAO,CACR,CAGA,SAASijB,GAASlwB,EAAMsN,EAAM8d,EAAIC,EAAI8F,EAAOC,EAAad,GACzDhjB,EAAK0C,QAAO,SAAU6C,GACrB,OAAQA,EAAE5F,KAAKtI,UAAY2rB,GAAUW,GAAepe,EAAGyd,GACxD,IAAGjf,OAAO,QACTxG,KAAK,QAAUumB,EAAcA,EAAc,aAAe,aAG1DvmB,KAAK,KAAK,WACJ,MAAuB,iBAAhBumB,EAAiChG,EAAG,GAAKA,EAAG,CACvD,IACCvgB,KAAK,KAAK,WACP,MAAuB,iBAAhBumB,EAAkC,GAAK/F,EAAG,EACpD,IACHxgB,KAAK,cAAe7K,EAAK0X,aAEzB7M,KAAK,YAAa,UAClBA,KAAK,cAAe7K,EAAKqxB,aACzB/pB,KAAK6pB,EACP,CCjCA,SAASG,GAAQjuB,EAAKkuB,EAAWC,GAC7B,GAAIA,GAAanuB,EAAI/B,OAEjB,IADA,IAAI6E,EAAIqrB,EAAYnuB,EAAI/B,OAAS,EAC1B6E,KACH9C,EAAI5B,UAAKvB,GAIjB,OADAmD,EAAI6kB,OAAOsJ,EAAW,EAAGnuB,EAAI6kB,OAAOqJ,EAAW,GAAG,IAC3CluB,CACX,CChFO,SAASouB,GAAMlZ,GACrB,IAAIvY,EAAOkF,EAAEsT,OAAO,CACnBxD,UAAW,gBACXlT,QAAS,CAAE,CAACd,KAAQ,MAAOuD,aAAgB,SAAUU,IAAO,IAAK4H,WAAa,GACzE,CAAC7L,KAAQ,MAAOuD,aAAgB,SAAUU,IAAO,IAAK4H,WAAa,GACnE,CAAC7L,KAAQ,MAAOuD,aAAgB,KAAMU,IAAO,IAAKL,OAAU,MAAOC,OAAU,MAAOuH,SAAW,IACpGzF,MAAO,IACPmL,OAAQ,IACRZ,YAAa,GACbuD,QAAS,CAAC,QAAS,UACnBF,OAAQ,EACRC,QAAS,EACTkd,UAAU,EACVC,aAAa,EACbjF,SAAU,CAAE,CAAChY,KAAQ,gBAAiBmY,OAAU,WAC7C,CAACnY,KAAQ,iBAAkBmY,OAAU,QACrC,CAACnY,KAAQ,iBAAkBmY,OAAU,WACrC,CAACnY,KAAQ,oBAAqBmY,OAAU,WACxC,CAACnY,KAAQ,kBAAmBmY,OAAU,YACzCyD,OAAQ,CAAC,aAAc,CAAC,MAAO,OAAQ,UAC/B,CAAC,kBAAmB,kBAAmB,kBAAmB,kBAAmB,iBAC7E,CAAC,mBAAoB,mBAAoB,kBAAmB,oBAC5D,CAAC,kBAAmB,kBAAmB,oBAAqB,oBAAqB,sBACzFpW,uBAAuB,EACvBvC,UAAW,QACXD,YAAa,YACb2Z,YAAa,IACblqB,WAAY,UACZyqB,gBAAiB,UACjB1tB,UAAU,EACVC,OAAO,GAAQoU,GAEmB,IAA9BrT,EAAG,eAAgB5D,SAEvBuwB,GAAoB7xB,GACpB8xB,GAAS9xB,KAGoB,IAA3B2S,EAAgB3S,IAClB2S,EAAoB3S,GR4Hf,SAAuBA,GAC7B,IAAIoC,EAAUuQ,EAAmB3S,GAC7BmC,EAASwQ,EAAgB3S,GACzByF,EAAK,IAAIzF,EAAKS,WACf0B,GAAUC,EACZ8C,EAAEO,EAAG,aAAa0C,SAAS,YAE3BjD,EAAEO,EAAG,aAAaqC,YAAY,YAE5B1F,EAAU,EACZ8C,EAAEO,EAAG,aAAaqC,YAAY,YAE9B5C,EAAEO,EAAG,aAAa0C,SAAS,WAC7B,CQvIC0pB,CAAuB7xB,GAGvB6f,EAAwB7f,GAExBA,EAAK8B,QAgeN,SAAyBA,GAGxB,IAAI,IAAIT,EAAE,EAAEA,EAAES,EAAQR,OAAOD,IACoB,IAA7Cwe,EAAe/d,EAASA,EAAQT,GAAGL,QACrCc,EAAQT,GAAGwL,WAAY,GAGzB,IAAIA,EAAY,GACZklB,EAAiB,GACrB,IAAI,IAAI1wB,EAAE,EAAEA,EAAES,EAAQR,OAAOD,IAAK,CACjC,IAAIiM,EAAOxL,EAAQT,GACnB,GAAG,cAAeiM,IAAkD,IAA1CpI,EAAEC,QAAQmI,EAAKtM,KAAM+wB,GAAuB,CACrEA,EAAetwB,KAAK6L,EAAKtM,MACzB6L,EAAUpL,KAAK6L,GACf,IAAI/B,EAAOsU,EAAmB/d,EAASwL,GACvC,IAAI,IAAIgP,EAAE,EAAGA,EAAE/Q,EAAKjK,OAAQgb,KACgB,IAAxCpX,EAAEC,QAAQoG,EAAK+Q,GAAIyV,KACrBA,EAAetwB,KAAK8J,EAAK+Q,IACzBzP,EAAUpL,KAAKoe,GAAoB/d,EAASyJ,EAAK+Q,KAGpD,CACD,CAEA,IAAIxW,EAAaZ,EAAEgH,IAAIpK,GAAS,SAASqK,EAAK7C,GAAI,MAAO,cAAe6C,GAAOA,EAAIU,UAAY,KAAOV,CAAI,IAC1G,IAAK,IAAI9K,EAAIwL,EAAUvL,OAAQD,EAAI,IAAKA,EACvCyE,EAAWkX,QAAQnQ,EAAUxL,EAAE,IAChC,OAAOyE,CACR,CA7fgBksB,CAAgBhyB,EAAK8B,SAEjC9B,EAAKmE,OACP0b,GAAiB7f,GAClB,IAAIiS,EAAiB4N,GAAyB7f,GAC1CkU,EAAMG,GAAGU,OAAO,IAAI/U,EAAKgV,WACxB3D,OAAO,WACPxG,KAAK,QAASoH,EAAetL,OAC7BkE,KAAK,SAAUoH,EAAeH,QAEnCoC,EAAI7C,OAAO,QACTxG,KAAK,QAAS,QACdA,KAAK,SAAU,QACfA,KAAK,KAAM,GACXA,KAAK,KAAM,GACXmW,MAAM,SAAU,SAChBA,MAAM,OAAQ,SACdA,MAAM,eAAgB,GAExB,IAAIlM,EAAMZ,EAAI7C,OAAO,KACjBxG,KAAK,QAAS,WAGdonB,EAAc,CACjBjxB,KAAO,cACPyE,GAAK,EACLd,QAAS,EACTsE,SALe/D,EAAEgH,IAAIlM,EAAK8B,SAAS,SAASqK,EAAK7C,GAAI,MAAO,cAAe6C,GAAOA,EAAIU,UAAYV,EAAM,IAAK,KAQ1G9C,EAAWwW,EAAgB7f,EAAMiyB,EAAaA,GAAa,GAW/DpS,EAAuB7f,EAAMqJ,GAE7B,IAAIN,EAAOsL,GAAG6d,UAAUD,GACxBpS,EAAY7f,EAAKgV,WAAajM,EAG9B,IAAIopB,EAAkBtS,GAA0B7f,GAC7CA,EAAKmE,OACPlC,QAAQmC,IAAI,cAAc6N,EAAetL,MAAM,UAAUwrB,EAAgBxrB,MACtE,gBAAgBsL,EAAeH,OAAO,WAAWqgB,EAAgBrgB,QAErE,IAII3I,EAJUkL,GAAG+d,OAAOvjB,YAAW,SAASlJ,EAAGC,GAC9C,OAAOD,EAAEqB,SAAWpB,EAAEoB,QAAUrB,EAAEsH,KAAKtI,QAAUiB,EAAEqH,KAAKtI,OAAS,IAAM,GACxE,IAAGwR,KAAK,CAACgc,EAAgBxrB,MAAOwrB,EAAgBrgB,QAEpCugB,CAAQtpB,EAAKrD,MAAK,SAASC,EAAGC,GAAK,OAAOD,EAAEsH,KAAKxH,GAAKG,EAAEqH,KAAKxH,EAAK,KAC1E0H,EAAehE,EAAM8F,cASzB4Q,EAAoB7f,EAAMmJ,EAAOgE,GAEjC,IAAImlB,EAAezS,EAAgB1S,EAAc9D,IAsXlD,SAAyBrJ,EAAMsyB,GAC9B,IAAI,IAAI3sB,EAAE,EAAGA,EAAE2sB,EAAahxB,OAAQqE,IAAK,CACxC,IAAImJ,EAAQH,GAAuB3O,EAAMsyB,EAAa3sB,IACnDmJ,GACF7M,QAAQmC,IAAI,YAAYkuB,EAAa3sB,GAAGf,OAAOqI,KAAKjM,KAAK,IAAIsxB,EAAa3sB,GAAGd,OAAOoI,KAAKjM,KAAM8N,EACjG,CACD,CA3XCyjB,CAAgBvyB,EAAMsyB,GAEtB,IAAIhlB,EAAOwH,EAAIkC,UAAU,SACnB/J,KAAK9D,EAAM8F,eACXujB,QACAnhB,OAAO,KACRxG,KAAK,aAAa,SAASgI,EAAGvJ,GAC9B,MAAO,aAAeuJ,EAAEhQ,EAAI,IAAMgQ,EAAE/P,EAAI,GACzC,IAEA,MAAM2vB,EAAmB,CACxBC,IAAAA,CAAKrP,GAEJA,EAAQsP,OAAO,EAAG,GAClBtP,EAAQuP,QAAO,GAAW,GAC1BvP,EAAQuP,OAAOtxB,GAAU,EACzB,GAENgM,EAAK0C,QAAO,SAAU6C,GAAI,OAAQA,EAAE5F,KAAKtI,MAAQ,IAC/C0M,OAAO,QACPxG,KAAK,kBAAmB,sBACxBA,KAAK,aAAa,SAASgI,GAAI,OAAQggB,GAAWhgB,EAAE5F,KAAKhI,MAAU4N,EAAE5F,KAAK6lB,aAAejgB,EAAE5F,KAAK8lB,YAA8B,GAAf,YAAkB,IACjIloB,KAAK,IAAKwJ,GAAG2e,SAAS7c,MAAK,SAASyU,GAAM,OAAQ5qB,EAAKkR,YAAclR,EAAKkR,YAAe,CAAE,IACzFwD,MAAK,SAAS7B,GACd,OAAGA,EAAE5F,KAAKgmB,QACgBR,EAEvB5f,EAAE5F,KAAK6lB,aAAejgB,EAAE5F,KAAK8lB,YACxB1e,GAAG6e,eACW,MAAfrgB,EAAE5F,KAAKhI,IAAcoP,GAAG8e,aAAe9e,GAAG+e,YAAc,KACjEpS,MAAM,UAAU,SAAUnO,GAC1B,OAAOA,EAAE5F,KAAK0G,KAAOd,EAAE5F,KAAK2G,MAAQf,EAAE5F,KAAK4Q,QAAU,UAAY,OACjE,IACAmD,MAAM,gBAAgB,SAAUnO,GAChC,OAAGA,EAAE5F,KAAKb,QACF,QAEDyG,EAAE5F,KAAK0G,KAAOd,EAAE5F,KAAK2G,MAAQf,EAAE5F,KAAK4Q,QAAU,OAAS,MAC9D,IACAmD,MAAM,oBAAoB,SAAUnO,GAAI,OAAQA,EAAE5F,KAAK4Q,QAAkB,OAAR,IAAiB,IAClFmD,MAAM,OAAQ,QAGhB1T,EAAK0C,QAAO,SAAU6C,GAAI,QAASA,EAAE5F,KAAKtI,SAAW3E,EAAKmE,MAAO,IAC/DkN,OAAO,YACPxG,KAAK,MAAM,SAAUgI,GAAI,OAAOA,EAAE5F,KAAKjM,IAAM,IAAEqQ,OAAO,QACtDxG,KAAK,QAAS,QACdA,KAAK,aAAa,SAASgI,GAAI,OAAQggB,GAAWhgB,EAAE5F,KAAKhI,MAAU4N,EAAE5F,KAAK6lB,aAAejgB,EAAE5F,KAAK8lB,YAA8B,GAAf,YAAkB,IACjIloB,KAAK,IAAKwJ,GAAG2e,SAAS7c,MAAK,SAAStD,GACnC,OAAIA,EAAE5F,KAAKtI,OACH3E,EAAKkR,YAAclR,EAAKkR,YAAc,EACvClR,EAAKkR,YAAclR,EAAKkR,WAChC,IACCwD,MAAK,SAAS7B,GACd,OAAGA,EAAE5F,KAAKgmB,QACFR,EAEL5f,EAAE5F,KAAK6lB,aAAejgB,EAAE5F,KAAK8lB,YACxB1e,GAAG6e,eACW,MAAfrgB,EAAE5F,KAAKhI,IAAcoP,GAAG8e,aAAc9e,GAAG+e,YAAc,KAGjE,IAAIC,EAAU/lB,EAAK0C,QAAO,SAAU6C,GAAI,QAASA,EAAE5F,KAAKtI,SAAW3E,EAAKmE,MAAQ,IAAE6S,UAAU,WACxF/J,MAAK,SAAS4F,GACd,IAAIygB,EAAW,EACXlZ,EAAUlV,EAAEgH,IAAIlM,EAAK0sB,UAAU,SAAS6G,EAAMlyB,GACjD,OAAGwe,EAAkB7f,EAAK0sB,SAASrrB,GAAGqT,KAAM7B,EAAE5F,OAAQqmB,IAAmB,GAAgB,CAC1F,IAEA,OADgB,IAAbA,IAAgBlZ,EAAU,CAAC,IACvB,CAAClV,EAAEgH,IAAIkO,GAAS,SAASjO,EAAK7C,GACpC,MAAO,CAACoT,OAAUvQ,EAAKmnB,SAAYA,EAAU7tB,GAAMoN,EAAE5F,KAAKjM,KAC1DiE,IAAO4N,EAAE5F,KAAKhI,IAAKmH,QAAWyG,EAAE5F,KAAKb,QAASzH,OAAUkO,EAAE5F,KAAKtI,OAC/DmiB,SAAYjU,EAAE5F,KAAK6Z,SACnBjJ,QAAWhL,EAAE5F,KAAK4Q,QAAU,IAC7B,IACA2U,QACFnhB,OAAO,KAETgiB,EAAQrc,UAAU,QAChB/J,KAAKoH,GAAGmf,MAAMxT,OAAM,SAASnN,GAAI,OAAOA,EAAE6J,MAAO,KACjD8V,QAAQnhB,OAAO,QACdxG,KAAK,aAAa,SAASgI,GAAI,MAAO,QAAQA,EAAE5F,KAAKxH,GAAG,GAAI,IAC5DoF,KAAK,QAAS,WACdA,KAAK,IAAKwJ,GAAGof,MAAMC,YAAY,GAAGC,YAAY3zB,EAAKkR,cACnD8P,MAAM,QAAQ,SAASnO,EAAGxR,GAC1B,OAAGwR,EAAE5F,KAAK4Q,QACF,YACe,IAApBhL,EAAE5F,KAAKqmB,SACNzgB,EAAE5F,KAAK6Z,SACF,WACD9mB,EAAK4xB,gBAEN5xB,EAAK0sB,SAASrrB,GAAGwrB,MACzB,IAGFvf,EAAK0C,QAAO,SAAU6C,GAAI,OAAQA,EAAE5F,KAAKtI,SAAWkO,EAAE5F,KAAK2mB,YAAc/gB,EAAE5F,KAAK4mB,YAAa,IAC3FxiB,OAAO,QACPxG,KAAK,KAAK,SAAS+f,GACnB,IAAII,GAA0B,IAAnBhrB,EAAKkR,YACZ+Z,GAA0B,IAAnBjrB,EAAKkR,YACZ4iB,EAAS9zB,EAAKkR,YAAY,EAC9B,OAAO6iB,GAAY/I,EAAIC,EAAI6I,EAAQ9zB,GAAM+zB,IAAa/I,EAAIC,GAAK6I,EAAQ9zB,EACtE,IACDghB,MAAM,UAAU,SAAUnO,GAC1B,OAAOA,EAAE5F,KAAK0G,KAAOd,EAAE5F,KAAK2G,MAAQf,EAAE5F,KAAK4Q,QAAU,UAAY,MACjE,IACAmD,MAAM,gBAAgB,SAAU4J,GAChC,MAAO,MACP,IACA5J,MAAM,oBAAoB,SAAUnO,GAAI,OAAQA,EAAE5F,KAAK4Q,QAAkB,OAAR,IAAiB,IAClFmD,MAAM,OAAQ,QAIhB1T,EAAK0C,QAAO,SAAU6C,GAAI,MAAyB,MAAlBA,EAAE5F,KAAK4G,QAAoC,IAAlBhB,EAAE5F,KAAK4G,MAAa,IAC5ExC,OAAO,QACN2P,MAAM,SAAU,SAChBA,MAAM,eAAgB,UACtBnW,KAAK,MAAM,SAAS+f,EAAIthB,GAAK,OAAQ,GAAItJ,EAAKkR,WAAa,IAC3DrG,KAAK,MAAM,SAAS+f,EAAIthB,GAAK,MAAO,GAAItJ,EAAKkR,WAAa,IAC1DrG,KAAK,MAAM,SAAS+f,EAAIthB,GAAK,MAAO,GAAItJ,EAAKkR,WAAa,IAC1DrG,KAAK,MAAM,SAAS+f,EAAIthB,GAAK,OAAQ,GAAItJ,EAAKkR,WAAY,IAO7D+e,GAAUjwB,EAAMsN,GAGbtN,EAAK2xB,aAAa3H,GAAWhqB,EAAMsN,GAGtC,IAAI0mB,EAAc,CAAA,EAGdC,EAAY,SAASnlB,EAAOkc,EAAIkJ,EAAKC,EAAK9pB,EAAa+pB,GAC1D,IAAI5b,EAAS,SAASnX,EAAG8lB,GACxB,OAAG9lB,EAAE,EAAI8lB,EACD3O,IAASnX,GACVA,GAEJgzB,EAAO,GACX,IAAI,IAAI/X,EAAE,EAAGA,EAAExN,EAAMxN,OAAQgb,IAAK,CACjC,IAAInW,EAAIqS,EAAO8D,EAAGxN,EAAMxN,QACpBgzB,EAAMxlB,EAAMwN,GAAK0O,EAAKoJ,EACtBG,EAAMzlB,EAAM3I,GAAK6kB,EAAKoJ,EACvB/pB,EAAYxH,EAAIyxB,GAAOjqB,EAAYxH,EAAI0xB,IACzClqB,EAAYvH,EAAIqxB,GAEjBE,GACS,KAAOC,EAAM,IAAM,KAAOJ,EAAME,GAChC,KAAOE,EAAM,GAAK,KAAOJ,EAAME,GAAU,KAAOE,EAAM,GAAK,KAAOH,EAAMC,GACxE,KAAOE,EAAM,GAAK,KAAOH,EAAMC,EAAS,IACxC,KAAOE,EAAM,GAAK,KAAOH,EAAMC,EAAS,IAAM,KAAOE,EAAM,GAAK,KAAOH,EAAMC,EAAS,IACtF,KAAOG,EAAM,GAAK,KAAOJ,EAAMC,EAAS,IACxC,KAAOG,EAAM,GAAK,KAAOJ,EAAMC,EAAS,IAAM,KAAOG,EAAM,GAAK,KAAOJ,EAAMC,EAAS,IACtF,KAAOG,EAAM,GAAK,KAAOJ,EAAMC,GAC/B,KAAOG,EAAM,GAAK,KAAOL,EAAME,GAAU,KAAOG,EAAM,IAAM,KAAOL,EAAME,GACzE,KAAOG,EAAM,IAAM,KAAOL,EAAME,GAEzC9X,EAAInW,CACL,CACA,OAAOkuB,GAIRhrB,EAAWyL,EAAIkC,UAAU,YACvB/J,KAAKqlB,GACLE,QACCgC,OAAO,OAAQ,KACf3pB,KAAK,OAAQ,QACbA,KAAK,SAAU,QACfA,KAAK,eAAgB,SACrBA,KAAK,kBAAmB,QACxBA,KAAK,KAAK,SAASgI,EAAGvJ,GACtB,IAQI6qB,EAAKnJ,EAAI3gB,EANTmD,EAAcqS,EAFNA,GAAoB1S,EAAc0F,EAAEjO,OAAOqI,KAAKjM,MAChD6e,GAAoB1S,EAAc0F,EAAEhO,OAAOoI,KAAKjM,MACVhB,GAC9Cy0B,EAAY5hB,EAAEjO,OAAOqI,KAAKwnB,UAAa5hB,EAAEjO,OAAOqI,KAAKwnB,WAAa5hB,EAAEhO,OAAOoI,KAAKjM,KAEhF2oB,EAAM9W,EAAEjO,OAAO/B,EAAIgQ,EAAEhO,OAAOhC,EAAIgQ,EAAEjO,OAAO/B,EAAIgQ,EAAEhO,OAAOhC,EACtD+mB,EAAM/W,EAAEjO,OAAO/B,EAAIgQ,EAAEhO,OAAOhC,EAAIgQ,EAAEhO,OAAOhC,EAAIgQ,EAAEjO,OAAO/B,EACtDqxB,EAAMrhB,EAAEjO,OAAO9B,EAIfgM,EAAQH,GAAuB3O,EAAM6S,GACrCwhB,EAAO,GACX,GAAGvlB,EAAO,CACN+D,EAAEjO,OAAOgI,SAASonB,EACpBA,EAAYnhB,EAAEjO,OAAOgI,QAAU,EAE/BonB,EAAYnhB,EAAEjO,OAAOgI,OAAS,EAE/BsnB,GAAOF,EAAYnhB,EAAEjO,OAAOgI,OAC5Boe,EAAKgJ,EAAYnhB,EAAEjO,OAAOgI,OAAU5M,EAAKkR,YAAY,EAAK,EAE1D,IAAIwjB,EAAe7hB,EAAEjO,OAAOqI,KAAK5C,YAC7BsqB,EAAmBD,EAAa,GACpC,IAAI,IAAI9oB,EAAG,EAAGA,EAAG8oB,EAAapzB,OAAQsK,IAClC8oB,EAAa9oB,GAAI/G,OAAO7D,OAAS6R,EAAEhO,OAAOoI,KAAKjM,MAC/C0zB,EAAa9oB,GAAIhH,OAAO5D,OAAS6R,EAAEjO,OAAOqI,KAAKjM,OACjD2zB,EAAmBD,EAAa9oB,GAAI5K,MAEtCqJ,EAAcwV,GAAoB1S,EAAcwnB,GAChDtqB,EAAYvH,EAAIoxB,EAChBplB,EAAMpJ,MAAK,SAAUC,EAAEC,GAAI,OAAOD,EAAIC,CAAE,IAExCuuB,EAAOD,EAAKl0B,EAAKkR,YAAY,EAAG,EAChCmjB,EAAOJ,EAAUnlB,EAAOkc,EAAIkJ,EAAKC,EAAK9pB,EAAa,EACpD,CAEA,IAAIuqB,EAAe,GAMnB,GALGH,IAAa3lB,IACf8lB,EAAe,KAAOjL,EAAY,KAAPC,EAAGD,GAAS,GAAK,KAAOuK,EAAI,IACjD,KAAOvK,EAAY,KAAPC,EAAGD,GAAS,GAAK,KAAOuK,EAAI,IACxC,KAAOvK,EAAY,KAAPC,EAAGD,GAAS,IAAM,KAAOuK,EAAI,IACzC,KAAOvK,EAAY,KAAPC,EAAGD,GAAS,GAAM,KAAOuK,EAAI,KAC7C1mB,EAAa,CACf0mB,EAAOrhB,EAAEjO,OAAO/B,EAAIgQ,EAAEhO,OAAOhC,EAAIgQ,EAAEjO,OAAO9B,EAAI+P,EAAEhO,OAAO/B,EACvDqxB,EAAOthB,EAAEjO,OAAO/B,EAAIgQ,EAAEhO,OAAOhC,EAAIgQ,EAAEhO,OAAO/B,EAAI+P,EAAEjO,OAAO9B,EAEvD,IAAIsxB,EAAS,EACb,GAAG1rB,KAAKuI,IAAIijB,EAAIC,GAAO,GACtB,MAAO,IAAMxK,EAAK,IAAMuK,EAAM,IAAMtK,EAAK,IAAMuK,EAC7C,IAAMxK,EAAK,KAAOuK,EAAME,GAAU,IAAMxK,EAAK,KAAOuK,EAAMC,GAG5D,MAAO,IAAMzK,EAAK,IAAMuK,EAAMG,EAAO,IAAMzK,EAAK,IAAMsK,EACpD,IAAMvK,EAAK,KAAOuK,EAAME,IAFbtlB,EAAQmlB,EAAUnlB,EAAOkc,EAAIkJ,EAAKC,EAAK9pB,EAAa+pB,GAAU,IAE/B,IAAMxK,EAAK,KAAOsK,EAAME,GAAUQ,CAEhF,CACA,MAAO,IAAMjL,EAAK,IAAMuK,EAAMG,EAAO,IAAMzK,EAAK,IAAMsK,EAAMU,CAC7D,IAGF9f,EAAIkC,UAAU,SACZ/J,KAAKlE,EAAKqE,MAAMjE,EAAM8F,gBACtBujB,QACCxiB,QAAO,SAAU6C,GAEjB,OAAQ7S,EAAKmE,YACkBjE,IAA5B2S,EAAEpH,OAAOwB,KAAKjB,WAA+C,OAApB6G,EAAEgiB,OAAO7tB,SAAoB6L,EAAEpH,OAAOwB,KAAKtI,MACvF,IACA6vB,OAAO,OAAQ,KACf3pB,KAAK,OAAQ,QACbA,KAAK,gBAAgB,SAASgI,EAAGvJ,GACjC,YAA+BpJ,IAA5B2S,EAAEpH,OAAOwB,KAAKjB,WAA+C,OAApB6G,EAAEgiB,OAAO7tB,QAAmB6L,EAAEpH,OAAOwB,KAAKtI,OAC9E,EACA3E,EAAKmE,MAAQ,EAAI,CACzB,IACA0G,KAAK,UAAU,SAASgI,EAAGvJ,GAC3B,YAA+BpJ,IAA5B2S,EAAEpH,OAAOwB,KAAKjB,WAA+C,OAApB6G,EAAEgiB,OAAO7tB,QAAmB6L,EAAEpH,OAAOwB,KAAKtI,OAC9E,OACD,MACP,IACAkG,KAAK,oBAAoB,SAASgI,EAAGvJ,GACrC,IAAIuJ,EAAEpH,OAAOwB,KAAK2mB,WAAY,OAAO,KACrC,IAAIkB,EAAWpsB,KAAKuI,IAAI4B,EAAEgiB,OAAO/xB,GAAI+P,EAAEgiB,OAAO/xB,EAAI+P,EAAEpH,OAAO3I,GAAK,GAC5DiyB,EAAa,CAACD,EAAU,EAAGpsB,KAAKuI,IAAI4B,EAAEgiB,OAAOhyB,EAAEgQ,EAAEpH,OAAO5I,GAAI,GACpDgd,EAAe7f,EAAK8B,QAAS+Q,EAAEpH,OAAOwB,MACzC3L,QAAU,IAAGwzB,GAAsB,GAC5C,IAAI,IAAIE,EAAU,EAAGA,EAAUF,EAAUE,GAAW,GACnD9vB,EAAE2E,MAAMkrB,EAAY,CAAC,EAAG,IACzB,OAAOA,CACP,IACAlqB,KAAK,mBAAmB,SAASgI,EAAGvJ,GACpC,OAAGuJ,EAAEpH,OAAOwB,KAAK3C,QAAUuI,EAAEpH,OAAOwB,KAAKtC,OACjC,qBACD,MACP,IACAE,KAAK,KAAK,SAASgI,EAAGvJ,GACtB,GAAGuJ,EAAEpH,OAAOwB,KAAK3C,QAAUuI,EAAEpH,OAAOwB,KAAKtC,OAAQ,CAEhD,IAAIH,EAAQqV,EAAe7f,EAAK8B,QAAS+Q,EAAEpH,OAAOwB,MAClD,GAAGzC,EAAMlJ,QAAU,EAAG,CACrB,IAAI2zB,EAAQ,EACRnf,EAAOjD,EAAEpH,OAAO5I,EAEpB,IAAI,IAAIgS,EAAE,EAAGA,EAAErK,EAAMlJ,OAAQuT,IAAK,CACjC,IAAIqgB,EAAQrV,GAAoB1S,EAAc3C,EAAMqK,GAAG7T,MAAM6B,EAC1DiT,EAAOof,IAAOpf,EAAOof,GAExBD,GAASC,CACV,CAEA,IAAI5mB,GAASuE,EAAEpH,OAAO5I,EAAIoyB,IAAUzqB,EAAMlJ,OAAO,GAC7C6zB,GAAStiB,EAAEgiB,OAAO/xB,EAAI+P,EAAEpH,OAAO3I,GAAK,EAEpCsyB,EAAQ,GACZ,GAAGtf,IAASjD,EAAEpH,OAAO5I,GAAKgQ,EAAEpH,OAAOwB,KAAK3C,OAAQ,CAE/C,IAAI+qB,GAAM/mB,EAAOuE,EAAEpH,OAAO5I,GAAG,EACzByyB,GAAMH,GAAQtiB,EAAEpH,OAAO3I,EAAG9C,EAAKkR,YAAY,IAAK,EACpDkkB,EAAQ,IAAMC,EAAK,IAAMC,EACvB,KAAOhnB,GAAQA,EAAK+mB,IAAO,IAAMC,CACpC,CAEA,MAAO,IAAOziB,EAAEgiB,OAAOhyB,EAAK,IAAOgQ,EAAEgiB,OAAO/xB,EACxC,IAAMqyB,EACN,IAAM7mB,EACN,IAAOuE,EAAEpH,OAAO5I,EAAK,KAAOgQ,EAAEpH,OAAO3I,EAAG9C,EAAKkR,YAAY,GACzDkkB,CACL,CACD,CAEA,GAAGviB,EAAEgiB,OAAO5nB,KAAKrI,OAAQ,CACxB,IAAIgjB,EAAK/H,GAAoB1S,EAAc0F,EAAEgiB,OAAO5nB,KAAKrI,OAAO5D,MAC5D6mB,EAAKhI,GAAoB1S,EAAc0F,EAAEgiB,OAAO5nB,KAAKpI,OAAO7D,MAEhE,GAAG4mB,EAAGhb,QAAUib,EAAGjb,MAClB,MAAO,IAAOiG,EAAEgiB,OAAOhyB,EAAK,KAAQ+kB,EAAG9kB,EAAI+kB,EAAG/kB,GAAK,EAC/C,IAAO+P,EAAEpH,OAAO5I,EAChB,IAAOgQ,EAAEpH,OAAO3I,CAEtB,CAEA,MAAO,IAAO+P,EAAEgiB,OAAOhyB,EAAK,IAAOgQ,EAAEgiB,OAAO/xB,EACxC,KAAQ+P,EAAEgiB,OAAO/xB,EAAI+P,EAAEpH,OAAO3I,GAAK,EACnC,IAAO+P,EAAEpH,OAAO5I,EAChB,IAAOgQ,EAAEpH,OAAO3I,CACrB,IAGF,IAAIgb,EAAc+B,EAAsB7f,EAAK8B,SAC7C,QAAyB,IAAfgc,EAA4B,CACrC,IAAIyX,EAAc1V,GAAoB1S,EAAcnN,EAAK8B,QAAQgc,GAAY9c,MACzEw0B,EAAQ,WAAW3V,EAAa,GACpC/K,EAAIzD,OAAO,YAAYA,OAAO,cAC5BxG,KAAK,KAAM2qB,GACX3qB,KAAK,OAAQ,GACbA,KAAK,OAAQ,GACbA,KAAK,cAAe,IACpBA,KAAK,eAAgB,IACrBA,KAAK,SAAU,QACfwG,OAAO,QACPxG,KAAK,IAAK,uBACVmW,MAAM,OAAQ,SAEhBlM,EAAIzD,OAAO,QACTxG,KAAK,KAAM0qB,EAAY1yB,EAAG7C,EAAKkR,YAAY,IAC3CrG,KAAK,KAAM0qB,EAAYzyB,EAAG9C,EAAKkR,YAAY,KAC3CrG,KAAK,KAAM0qB,EAAY1yB,EAAG7C,EAAKkR,YAAY,KAC3CrG,KAAK,KAAM0qB,EAAYzyB,EAAG9C,EAAKkR,YAAY,GAC3CrG,KAAK,eAAgB,GACrBA,KAAK,SAAU,SACfA,KAAK,aAAc,QAAQ2qB,EAAM,IACpC,CAMA,OAHAvhB,GAAUjU,EAAMkU,GAEblU,EAAK0xB,UDleF,SAAuB1xB,EAAMsN,GAWnC,IAAImoB,EACA1kB,EAVJzD,EAAK0C,QAAO,SAAU6C,GAAI,OAAQA,EAAE5F,KAAKtI,MAAO,IAC3CN,KAAKgQ,GAAGyW,OACT9a,QAAO,SAAgB4P,GACvB,OAAQA,EAAMsN,UAAYtN,EAAMjL,QAAUiL,EAAM8V,QAChD,IACY3tB,GAAG,SAOhB,WACF0tB,EAASphB,GAAGU,OAAOzQ,MAAMyQ,OAAO,cAAclK,KAAK,IACpD,IARgB9C,GAAG,QAUnB,SAAcxH,GACbA,EAAEwqB,YAAYjR,kBACd,IAAIkR,EAAKzqB,EAAEyqB,GACP2K,EAAQthB,GAAGU,OAAOzQ,MAAMyQ,OAAO,cACnChE,EAAO5N,WAAWwyB,EAAM9qB,KAAK,MAAOmgB,EAC9B2K,EAAM9qB,KAAK,IAAKkG,EACvB,IAfgBhJ,GAAG,OAiBnB,SAAkB6iB,GACjB,IAAIgL,EAAKvhB,GAAGU,OAAOzQ,MAAMgmB,QAAQrd,KAE7B4oB,EAA2B,IADpBhW,EAAmB7f,EAAK8B,QAAS8zB,GACxBt0B,OAAeue,EAAmB7f,EAAK8B,QAAS8zB,GAAI,IAAM,EAGlEvhB,GAAGU,OAAOzQ,MAAMyQ,OAAO,cAC7BlK,KAAK,IAAK4qB,GAEhB,MAAMK,EAAiB/kB,EAAK0kB,EAG5B,IAQIM,EAAUC,EAAUC,EARpBltB,EAAO8W,EAAY7f,EAAKgV,WAExBkhB,EAASrW,GADGA,EAAc9W,GACc6sB,EAAG50B,MAG3CuuB,EAAS1P,EAAsBA,EAAc9W,GAAOmtB,EAAOtpB,OAI/DmE,GAAQmlB,EAAOrzB,EACf,IAYIszB,EAZAC,GAAQvf,OAAOC,UACfuf,EAAQxf,OAAOC,UACnB,IAAI,IAAIzV,EAAE,EAAGA,EAAEkuB,EAAOjuB,OAAQD,IAC1BkuB,EAAOluB,GAAGwB,EAAIkO,GAAQwe,EAAOluB,GAAGwB,EAAIuzB,GACtCL,EAAWxG,EAAOluB,GAClB+0B,EAAO7G,EAAOluB,GAAGwB,GACR0sB,EAAOluB,GAAGwB,EAAIkO,GAAQwe,EAAOluB,GAAGwB,EAAIwzB,IAC7CL,EAAWzG,EAAOluB,GAClBg1B,EAAO9G,EAAOluB,GAAGwB,GAGnB,QAAgB3C,IAAb61B,QAAuC71B,IAAb81B,EAAwB,OAElDF,GACFK,EAAStW,EAAmB7f,EAAK8B,QAASi0B,EAAS9oB,KAAKjM,MACxDi1B,EAAWF,IAEXI,EAAStW,EAAmB7f,EAAK8B,QAASk0B,EAAS/oB,KAAKjM,MACxDi1B,EAAWD,GAIN,IAAIlwB,EAAa+Z,EAAmB4I,EAAiBzoB,IACjD2M,EAAMkT,EAAmB7f,EAAK8B,QAAS8zB,EAAG50B,MAC9CswB,GAAQxrB,EAAY6G,EAAKwpB,IACT,IAAbN,GAAkBA,IAAYI,EAAShpB,KAAKjM,OACpD2L,EAAMkT,EAAmB/Z,EAAY+vB,GACrCvE,GAAQxrB,EAAY6G,EAAKwpB,IAEpBn2B,EAAK8B,QAAUgE,EACfZ,EAAEuC,UAAUqR,QAAQ,UAAW,CAAC9Y,GACvC,IACD,CCkZmBs2B,CAAct2B,EAAMsN,GAC/BtN,CACR,CAEA,SAAS6yB,GAAW5tB,GACnB,MAAe,MAARA,GAAuB,MAARA,CACvB,CAGA,SAAS8uB,GAAY/I,EAAIC,EAAI6I,EAAQ9zB,GACpC,MAAQ,KAAOgrB,EAAG8I,GAAU,IAAM7I,EAChC,IAAMD,EAAK,IAAMC,EACjB,IAAMD,EAAK,KAAOC,EAAwB,KAApBjrB,EAAKkR,aAC3B,IAAM8Z,EAAK,KAAOC,EAAwB,KAApBjrB,EAAKkR,aAC3B,KAAO8Z,EAAG8I,GAAU,KAAO7I,EAAwB,KAApBjrB,EAAKkR,YACvC,CAYO,SAASvC,GAAuB3O,EAAMsL,GAC5C,IAEI1G,EAAQC,EADRsI,EAAe0S,EADRA,EAAY7f,EAAKgV,YAG5B,GAAG,SAAU1J,EAAO,CAEnB,KAAK,WADLA,EAAQuU,GAAoB1S,EAAc7B,EAAMtK,OACzBiM,MACtB,OAAO,KACRrI,EAASib,GAAoB1S,EAAc7B,EAAM2B,KAAKrI,QACtDC,EAASgb,GAAoB1S,EAAc7B,EAAM2B,KAAKpI,OACvD,MACCD,EAAS0G,EAAM1G,OACfC,EAASyG,EAAMzG,OAGhB,IAAI8kB,EAAM/kB,EAAO/B,EAAIgC,EAAOhC,EAAI+B,EAAO/B,EAAIgC,EAAOhC,EAC9C+mB,EAAMhlB,EAAO/B,EAAIgC,EAAOhC,EAAIgC,EAAOhC,EAAI+B,EAAO/B,EAC9CooB,EAAKrmB,EAAO9B,EAGZgM,EAAQ5J,EAAEgH,IAAIiB,GAAc,SAAS3B,EAAOlC,GAC/C,OAAQkC,EAAMyB,KAAKtI,QACjB6G,EAAMyB,KAAKjM,OAAS4D,EAAOqI,KAAKjM,MAASwK,EAAMyB,KAAKjM,OAAS6D,EAAOoI,KAAKjM,MACzEwK,EAAM1I,IAAMmoB,GAAMzf,EAAM3I,EAAI8mB,GAAMne,EAAM3I,EAAI+mB,EAAKpe,EAAM3I,EAAI,IAC9D,IACA,OAAOiM,EAAMxN,OAAS,EAAIwN,EAAQ,IACnC,CAkCO,SAASynB,GAAQv2B,GACvBkF,EAAE,IAAIlF,EAAKgV,WAAW+E,QACtBpH,EAAoB3S,GACpBA,EAAKw2B,aAAc,EACnB,IACC/E,GAAMzxB,EACN,CAAC,MAAMO,GAEP,MADA0B,QAAQ8B,MAAMxD,GACRA,CACP,CAEA,IACCk2B,UAAUC,OAAO12B,EACjB,CAAC,MAAMO,GACP,CAEF,CAEA2E,EAAEuC,UAAUM,GAAG,WAAW,SAAS6Q,EAAI5Y,GACtCu2B,GAAQv2B,EACT,IAEAkF,EAAEuC,UAAUM,GAAG,SAAS,SAAS6Q,EAAI5Y,GACpCyxB,GAAMzxB,EACP,yFCnkBO,SAAS22B,GAAU32B,EAAMgB,EAAMuR,EAAMyN,GAC3C,IAAIla,EAAaN,EAAamN,EAAiB3S,IAC3CsN,EAAO5D,GAAc5D,EAAY9E,GACrC,GAAIsM,EAAJ,CASA,GAJIpI,EAAEsrB,QAAQje,KACbA,EAAO,CAACA,IAGNyN,EACF,IAAI,IAAI3e,EAAE,EAAGA,EAAEkR,EAAKjR,OAAQD,IAAK,CAChC,IAAI8E,EAAIoM,EAAKlR,GAEb,GAAG8E,KAAKmH,GAAwB,IAAhBiF,EAAKjR,OAAc,CAClC,GAAGgM,EAAKnH,KAAO6Z,EACd,OACD,IACG,GAAGje,KAAKC,UAAUsL,EAAKnH,MAAQpE,KAAKC,UAAUge,GAC7C,MACH,CAAC,MAAMzf,GACP,CAEF,CACA+M,EAAKnH,GAAK6Z,CACX,KACM,CACN,IAAI/Z,GAAQ,EACZ,IAAI,IAAI5E,EAAE,EAAGA,EAAEkR,EAAKjR,OAAQD,IAAK,CAChC,IAAI8E,EAAIoM,EAAKlR,GAEV8E,KAAKmH,WACAA,EAAKnH,GACZF,GAAQ,EAEV,CACA,IAAIA,EACH,MACF,CACAkiB,GAAUriB,EAAYwH,GACtBtN,EAAK8B,QAAUgE,EACfywB,GAAQv2B,EArCR,MAFCiC,QAAQC,KAAK,oBAwCf,0DA6BO,SAA6BlC,EAAMgB,GAMzC,IAAI8E,EAAaN,EAAamN,EAAiB3S,IAC3CsN,EAAO5D,GAAciJ,EAAiB3S,GAAOgB,GAC7CsM,EAIJ0f,GAAoBlnB,EAAYwH,EAAMtN,GAXtC,SAAgBA,EAAM8B,GAErB9B,EAAK8B,QAAUA,EACfy0B,GAAQv2B,EACT,IAICiC,QAAQC,KAAK,kBAIf,iCA/BO,SAA2BlC,EAAMiF,EAAK0O,EAAKC,EAAKgjB,GACtD,IAAI9wB,EAAaN,EAAamN,EAAiB3S,IAC3CoM,EAAUtG,EAAY4F,EAAgB5F,IAC1C,IAAIsG,EAEH,YADAnK,QAAQC,KAAK,sBAGd,IAAI20B,EAAWrM,GAAS1kB,EAAYsG,EAASnH,EAAK,GAAG,GAOrD,OANA4xB,EAASljB,IAAMA,EACfkjB,EAASjjB,IAAMA,OACM1T,IAAlB02B,IACFC,EAASD,cAAgBA,GAC1B52B,EAAK8B,QAAUgE,EACfywB,GAAQv2B,GACD62B,EAAS71B,IACjB,eArBO,SAAsBhB,EAAMuS,EAAMyN,GAExC2W,GAAU32B,EADIA,EAAK8B,QAAS4J,EAAgB1L,EAAK8B,UACzBd,KAAMuR,EAAMyN,EACrC"}